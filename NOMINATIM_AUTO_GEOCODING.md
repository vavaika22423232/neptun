# Автоматичне розпізнавання міст через Nominatim API

## Як це працює

Система автоматично знаходить координати будь-якого міста України через OpenStreetMap Nominatim API:

1. **Спочатку перевіряється локальна база** (`CITY_COORDS`)
2. **Потім кеш з попередніх запитів** (`nominatim_cache.json`)
3. **Якщо не знайдено - запит до Nominatim API**
4. **Результат зберігається в кеш** для майбутнього використання

## Переваги

✅ **Не потрібно вручну додавати міста** - система знайде їх автоматично
✅ **Постійний кеш** - знайдені міста зберігаються між перезапусками
✅ **Rate limiting** - дотримання політики Nominatim (1 запит/секунду)
✅ **Валідація координат** - перевірка що місто в межах України

## Файли

- `nominatim_geocoder.py` - API клієнт
- `nominatim_cache.py` - управління постійним кешем
- `nominatim_cache.json` - файл кешу (створюється автоматично)

## Використання

### Автоматично в app.py

Вже інтегровано! При обробці повідомлень:

```python
# 1. Пошук в локальній базі
coords = CITY_COORDS.get(city_name)

# 2. Якщо не знайдено - пошук через Nominatim API
if not coords and NOMINATIM_AVAILABLE:
    coords = get_coordinates_nominatim(city_name, region=region)
    if coords:
        CITY_COORDS[city_name] = coords  # Додається в локальну базу
```

### Експорт знайдених міст

Щоб додати знайдені міста в постійну базу `CITY_COORDS`:

```bash
python3 -c 'from nominatim_cache import export_to_python_dict; export_to_python_dict()'
```

Це виведе словник Python який можна скопіювати в app.py.

## Приклад

**Повідомлення:** "4х БПЛА в напрямку Буялика"

1. Система шукає "буялик" в `CITY_COORDS` - не знайдено
2. Система шукає в `nominatim_cache.json` - не знайдено
3. Запит до Nominatim API: "буялик, Одеська область, Ukraine"
4. Отримано: (46.7167, 30.4167)
5. Збережено в кеш
6. Створено мітку на карті

**Наступного разу "буялик" береться з кешу - без запиту до API!**

## Статистика кешу

```bash
python3 nominatim_cache.py
```

Покаже:
- Скільки міст в кеші
- Останні знайдені міста
- Команду для експорту

## Обмеження Nominatim

- Максимум 1 запит в секунду
- Безкоштовний публічний сервіс
- Потрібен User-Agent в запитах

Система автоматично дотримується цих правил!
