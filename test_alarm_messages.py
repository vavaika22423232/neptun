#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from app import process_message
import json

# –¢–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Ç—Ä–µ–≤–æ–≥–∞—Ö –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
alarm_messages = [
    "**üö® –í—ñ–Ω–Ω–∏—Ü—å–∫–∏–π —Ä–∞–π–æ–Ω (–í—ñ–Ω–Ω–∏—Ü—å–∫–∞ –æ–±–ª.)** –ü–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞. –ü—Ä—è–º—É–π—Ç–µ –≤ —É–∫—Ä–∏—Ç—Ç—è!",
    "**üü¢ –ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª.** –í—ñ–¥–±—ñ–π —Ç—Ä–∏–≤–æ–≥–∏. –ë—É–¥—å—Ç–µ –æ–±–µ—Ä–µ–∂–Ω—ñ!",
    "**üö® –•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π —Ä–∞–π–æ–Ω (–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.)** –ü–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞. –ü—Ä—è–º—É–π—Ç–µ –≤ —É–∫—Ä–∏—Ç—Ç—è!",
    "**üö® –ó–≤–µ–Ω–∏–≥–æ—Ä–æ–¥—Å—å–∫–∏–π —Ä–∞–π–æ–Ω (–ß–µ—Ä–∫–∞—Å—å–∫–∞ –æ–±–ª.)** –ü–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞. –ü—Ä—è–º—É–π—Ç–µ –≤ —É–∫—Ä–∏—Ç—Ç—è!",
    "**üö® –£–º–∞–Ω—Å—å–∫–∏–π —Ä–∞–π–æ–Ω (–ß–µ—Ä–∫–∞—Å—å–∫–∞ –æ–±–ª.)** –ü–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞. –ü—Ä—è–º—É–π—Ç–µ –≤ —É–∫—Ä–∏—Ç—Ç—è!",
    "**üü¢ –•–º—ñ–ª—å–Ω–∏—Ü—å–∫–∏–π —Ä–∞–π–æ–Ω (–í—ñ–Ω–Ω–∏—Ü—å–∫–∞ –æ–±–ª.)** –í—ñ–¥–±—ñ–π —Ç—Ä–∏–≤–æ–≥–∏. –ë—É–¥—å—Ç–µ –æ–±–µ—Ä–µ–∂–Ω—ñ!",
    "**üö® –ë–æ–≥–æ–¥—É—Ö—ñ–≤—Å—å–∫–∏–π —Ä–∞–π–æ–Ω (–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.)** –ü–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞. –ü—Ä—è–º—É–π—Ç–µ –≤ —É–∫—Ä–∏—Ç—Ç—è!",
    "**üö® –î–Ω—ñ–ø—Ä–æ–≤—Å—å–∫–∏–π —Ä–∞–π–æ–Ω (–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª.)** –ü–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞. –ü—Ä—è–º—É–π—Ç–µ –≤ —É–∫—Ä–∏—Ç—Ç—è!"
]

def test_alarm_messages():
    print("=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ —Ç—Ä–µ–≤–æ–≥–∞—Ö ===\n")
    
    should_be_events = 0  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–±—ã—Ç–∏—è–º–∏
    actual_filtered = 0   # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    created_markers = 0   # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
    
    for i, message in enumerate(alarm_messages, 1):
        print(f"–°–æ–æ–±—â–µ–Ω–∏–µ {i}: {message[:60]}...")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —á—Ç–æ —ç—Ç–æ —Ç—Ä–µ–≤–æ–≥–∞ –∏–ª–∏ –æ—Ç–±–æ–π
        if "–ü–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞" in message or "üö®" in message:
            message_type = "üö® –¢–†–ï–í–û–ì–ê"
            should_be_events += 1
        elif "–í—ñ–¥–±—ñ–π —Ç—Ä–∏–≤–æ–≥–∏" in message or "üü¢" in message:
            message_type = "üü¢ –û–¢–ë–û–ô"
            should_be_events += 1
        else:
            message_type = "‚ùì –î–†–£–ì–û–ï"
        
        try:
            mid = f"alarm_test_{i}"
            date_str = "2025-09-29 20:00:00"
            channel = "UkraineAlarmSignal"
            
            result = process_message(message, mid, date_str, channel)
            
            if result is None or (isinstance(result, list) and len(result) == 0):
                print(f"   ‚úÖ {message_type} - –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–æ–±—ã—Ç–∏–µ–º)")
                actual_filtered += 1
            elif isinstance(result, list) and len(result) > 0:
                print(f"   ‚ùå {message_type} - –°–æ–∑–¥–∞–µ—Ç {len(result)} –º–µ—Ç–æ–∫ (–ù–ï –¥–æ–ª–∂–Ω–æ!)")
                created_markers += len(result)
                for marker in result:
                    place = marker.get('place', 'Unknown')
                    print(f"      üìç {place}")
            else:
                print(f"   ‚ùì {message_type} - –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {type(result)}")
                
        except Exception as e:
            print(f"   ‚ùå –û—à–∏–±–∫–∞: {e}")
        
        print()
    
    print("=== –ò–¢–û–ì–ò ===")
    print(f"–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –æ —Ç—Ä–µ–≤–æ–≥–∞—Ö: {len(alarm_messages)}")
    print(f"–î–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–æ–±—ã—Ç–∏–π: {should_be_events}")
    print(f"–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: {actual_filtered}")
    print(f"–°–æ–∑–¥–∞–Ω–æ –º–µ—Ç–æ–∫: {created_markers}")
    
    if actual_filtered == should_be_events and created_markers == 0:
        print("üéâ –í–°–ï –°–û–û–ë–©–ï–ù–ò–Ø –û –¢–†–ï–í–û–ì–ê–• –ü–†–ê–í–ò–õ–¨–ù–û –§–ò–õ–¨–¢–†–£–Æ–¢–°–Ø!")
    else:
        print("‚ö†Ô∏è  –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Ç—Ä–µ–≤–æ–≥–∞—Ö —Å–æ–∑–¥–∞—é—Ç –º–µ—Ç–∫–∏ –≤–º–µ—Å—Ç–æ —Å–æ–±—ã—Ç–∏–π")

if __name__ == "__main__":
    test_alarm_messages()
