"""
Geographic data module for Ukraine settlements and cities.

Provides:
- CITY_COORDS: Major Ukrainian cities with coordinates
- UKRAINE_ALL_SETTLEMENTS: 25K+ settlements (loaded from file)
- UKRAINE_SETTLEMENTS_BY_OBLAST: Oblast-aware settlement lookup
- REGIONAL_CITY_COORDS: Cities grouped by oblast
"""
import os
import json
from typing import Dict, Tuple, Optional

# Base directory
_BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

# ============================================================================
# MAJOR CITIES - Always available
# ============================================================================

CITY_COORDS: Dict[str, Tuple[float, float]] = {
    # Обласні центри
    "київ": (50.4501, 30.5234),
    "харків": (49.9935, 36.2304),
    "одеса": (46.4825, 30.7233),
    "дніпро": (48.4647, 35.0462),
    "донецьк": (48.0159, 37.8029),
    "запоріжжя": (47.8388, 35.1396),
    "львів": (49.8397, 24.0297),
    "кривий ріг": (47.9105, 33.3918),
    "миколаїв": (46.9750, 31.9946),
    "маріуполь": (47.0958, 37.5493),
    "луганськ": (48.5740, 39.3078),
    "вінниця": (49.2331, 28.4682),
    "полтава": (49.5883, 34.5514),
    "чернігів": (51.4982, 31.2893),
    "херсон": (46.6354, 32.6169),
    "черкаси": (49.4285, 32.0621),
    "хмельницький": (49.4230, 26.9871),
    "житомир": (50.2547, 28.6587),
    "суми": (50.9077, 34.7981),
    "рівне": (50.6199, 26.2516),
    "івано-франківськ": (48.9226, 24.7111),
    "тернопіль": (49.5535, 25.5948),
    "луцьк": (50.7472, 25.3254),
    "кропивницький": (48.5079, 32.2623),
    "ужгород": (48.6208, 22.2879),
    "чернівці": (48.2920, 25.9358),
    
    # Великі міста
    "кременчук": (49.0669, 33.4202),
    "біла церква": (49.7983, 30.1073),
    "мелітополь": (46.8489, 35.3675),
    "нікополь": (47.5699, 34.3923),
    "сєвєродонецьк": (48.9484, 38.4937),
    "слов'янськ": (48.8510, 37.6159),
    "краматорськ": (48.7384, 37.5717),
    "бердянськ": (46.7586, 36.7980),
    "павлоград": (48.5222, 35.8747),
    "кам'янське": (48.5205, 34.6139),
    "олександрія": (48.6690, 33.1133),
    "сміла": (49.2206, 31.8692),
    "умань": (48.7476, 30.2218),
    "шостка": (51.8652, 33.4696),
    "ізюм": (49.2105, 37.2571),
    "куп'янськ": (49.7071, 37.6145),
    "лозова": (48.8892, 36.3132),
    "первомайськ": (48.0456, 30.8519),
    "южноукраїнськ": (47.8191, 31.1760),
    "енергодар": (47.4989, 34.6561),
    "бровари": (50.5116, 30.7904),
    "бориспіль": (50.3521, 30.9575),
    "фастів": (50.0747, 29.9180),
    "буча": (50.5436, 30.2128),
    "ірпінь": (50.5203, 30.2475),
    "васильків": (50.1747, 30.3172),
    "обухів": (50.1167, 30.6167),
    "вишгород": (50.5844, 30.4869),
    "славутич": (51.5213, 30.7485),
    
    # Міста Донецької області
    "горлівка": (48.3358, 38.0550),
    "макіївка": (48.0556, 37.9416),
    "єнакієве": (48.2326, 38.2125),
    "торецьк": (48.4039, 37.8506),
    "покровськ": (48.2836, 37.1819),
    "бахмут": (48.5946, 38.0005),
    "костянтинівка": (48.5256, 37.7025),
    "дружківка": (48.6204, 37.5227),
    "лиман": (48.9886, 37.8156),
    "мирноград": (48.2973, 37.2617),
    "вугледар": (47.7839, 37.2542),
    "курахове": (47.9836, 37.2589),
    "селидове": (48.1503, 37.3006),
    "авдіївка": (48.1339, 37.7467),
    "світлодарськ": (48.4356, 38.2219),
    "часів яр": (48.5936, 37.8481),
    "соледар": (48.6833, 38.0833),
    "сіверськ": (48.8672, 38.0939),
    
    # Міста Харківської області  
    "лубни": (50.0167, 32.9833),
    "богодухів": (50.1596, 35.5241),
    "валки": (49.8354, 35.6177),
    "чугуїв": (49.8372, 36.6879),
    "вовчанськ": (50.2881, 36.9403),
    "балаклія": (49.4571, 36.8536),
    "барвінкове": (48.9064, 37.0128),
    "первомайський": (49.4013, 36.2478),
    "дергачі": (50.1064, 36.1139),
    "мерефа": (49.8233, 36.0506),
    "зміїв": (49.6786, 36.3492),
    "красноград": (49.3693, 35.4346),
    
    # Міста Запорізької області
    "токмак": (47.2544, 35.7019),
    "оріхів": (47.5673, 35.7864),
    "гуляйполе": (47.6544, 36.2608),
    "пологи": (47.4847, 36.2531),
    "васильівка": (47.4361, 35.2506),
    "кам'янка-дніпровська": (47.4819, 34.4144),
    "вільнянськ": (47.9397, 35.4350),
    
    # Міста Сумської області
    "конотоп": (51.2397, 33.2031),
    "охтирка": (50.3119, 34.8878),
    "ромни": (50.7506, 33.4769),
    "глухів": (51.6783, 33.9072),
    "лебедин": (50.5858, 34.4831),
    "тростянець": (50.4833, 34.9667),
    "путивль": (51.3378, 33.8669),
    "буринь": (51.1978, 34.0569),
    "кролевець": (51.5486, 33.3825),
    "білопілля": (51.1467, 34.3097),
    
    # Міста Чернігівської області
    "ніжин": (51.0489, 31.8867),
    "прилуки": (50.5894, 32.3856),
    "бахмач": (51.1803, 32.8325),
    "борзна": (51.2522, 32.4264),
    "новгород-сіверський": (52.0003, 33.2669),
    "городня": (51.8867, 31.6017),
    "щорс": (51.8178, 31.9439),
    "семенівка": (52.1831, 32.5683),
    
    # Крим (окуповані території)
    "сімферополь": (44.9521, 34.1024),
    "севастополь": (44.6054, 33.5221),
    "ялта": (44.4952, 34.1663),
    "євпаторія": (45.1903, 33.3669),
    "керч": (45.3531, 36.4747),
    "феодосія": (45.0317, 35.3827),
    "алушта": (44.6763, 34.4097),
    "джанкой": (45.7098, 34.3935),
    "армянськ": (46.1057, 33.6920),
    "красноперекопськ": (45.9522, 33.7747),
}

# ============================================================================
# REGIONAL CITY COORDS - Grouped by oblast
# ============================================================================

REGIONAL_CITY_COORDS: Dict[str, Dict[str, Tuple[float, float]]] = {
    "київська область": {
        "бровари": (50.5116, 30.7904),
        "бориспіль": (50.3521, 30.9575),
        "фастів": (50.0747, 29.9180),
        "буча": (50.5436, 30.2128),
        "ірпінь": (50.5203, 30.2475),
        "васильків": (50.1747, 30.3172),
        "обухів": (50.1167, 30.6167),
        "вишгород": (50.5844, 30.4869),
        "біла церква": (49.7983, 30.1073),
    },
    "харківська область": {
        "харків": (49.9935, 36.2304),
        "ізюм": (49.2105, 37.2571),
        "куп'янськ": (49.7071, 37.6145),
        "лозова": (48.8892, 36.3132),
        "чугуїв": (49.8372, 36.6879),
        "вовчанськ": (50.2881, 36.9403),
        "балаклія": (49.4571, 36.8536),
    },
    "донецька область": {
        "донецьк": (48.0159, 37.8029),
        "маріуполь": (47.0958, 37.5493),
        "краматорськ": (48.7384, 37.5717),
        "слов'янськ": (48.8510, 37.6159),
        "бахмут": (48.5946, 38.0005),
        "покровськ": (48.2836, 37.1819),
        "авдіївка": (48.1339, 37.7467),
        "вугледар": (47.7839, 37.2542),
        "лиман": (48.9886, 37.8156),
        "торецьк": (48.4039, 37.8506),
    },
    "запорізька область": {
        "запоріжжя": (47.8388, 35.1396),
        "мелітополь": (46.8489, 35.3675),
        "бердянськ": (46.7586, 36.7980),
        "енергодар": (47.4989, 34.6561),
        "токмак": (47.2544, 35.7019),
        "оріхів": (47.5673, 35.7864),
        "гуляйполе": (47.6544, 36.2608),
        "пологи": (47.4847, 36.2531),
    },
    "херсонська область": {
        "херсон": (46.6354, 32.6169),
        "нова каховка": (46.7553, 33.3481),
        "каховка": (46.8172, 33.4831),
        "олешки": (46.6172, 32.7747),
        "скадовськ": (46.1167, 32.9167),
        "генічеськ": (46.1731, 34.8142),
    },
    "миколаївська область": {
        "миколаїв": (46.9750, 31.9946),
        "первомайськ": (48.0456, 30.8519),
        "южноукраїнськ": (47.8191, 31.1760),
        "вознесенськ": (47.5667, 31.3167),
        "очаків": (46.6194, 31.5375),
    },
    "одеська область": {
        "одеса": (46.4825, 30.7233),
        "ізмаїл": (45.3492, 28.8414),
        "чорноморськ": (46.3061, 30.6589),
        "білгород-дністровський": (46.1917, 30.3456),
        "подільськ": (47.7411, 29.5319),
    },
}

# ============================================================================
# SETTLEMENTS - Loaded from file
# ============================================================================

UKRAINE_ALL_SETTLEMENTS: Dict[str, Tuple[float, float]] = {}
UKRAINE_SETTLEMENTS_BY_OBLAST: Dict[str, Dict[str, Tuple[float, float]]] = {}

def load_settlements() -> None:
    """Load settlements from ukraine_all_settlements.py if available."""
    global UKRAINE_ALL_SETTLEMENTS, UKRAINE_SETTLEMENTS_BY_OBLAST
    
    try:
        # Try to import from existing file
        from ukraine_all_settlements import UKRAINE_ALL_SETTLEMENTS as _all
        from ukraine_all_settlements import UKRAINE_SETTLEMENTS_BY_OBLAST as _by_oblast
        
        UKRAINE_ALL_SETTLEMENTS = _all
        UKRAINE_SETTLEMENTS_BY_OBLAST = _by_oblast
        print(f"INFO: Ukraine ALL settlements loaded: {len(_all)} simple + {len(_by_oblast)} oblast-aware entries")
    except ImportError:
        print("WARNING: ukraine_all_settlements.py not found, using only CITY_COORDS")
    except Exception as e:
        print(f"WARNING: Failed to load settlements: {e}")

# Load on module import
load_settlements()

# ============================================================================
# HELPER FUNCTIONS
# ============================================================================

def get_coords(name: str, oblast: Optional[str] = None) -> Optional[Tuple[float, float]]:
    """
    Get coordinates for a settlement name.
    
    Args:
        name: Settlement name (case insensitive)
        oblast: Optional oblast name for disambiguation
        
    Returns:
        (lat, lon) tuple or None if not found
    """
    name_lower = name.lower().strip()
    
    # 1. Try major cities first
    if name_lower in CITY_COORDS:
        return CITY_COORDS[name_lower]
    
    # 2. Try oblast-specific lookup
    if oblast and oblast.lower() in UKRAINE_SETTLEMENTS_BY_OBLAST:
        oblast_settlements = UKRAINE_SETTLEMENTS_BY_OBLAST[oblast.lower()]
        if name_lower in oblast_settlements:
            return oblast_settlements[name_lower]
    
    # 3. Try all settlements
    if name_lower in UKRAINE_ALL_SETTLEMENTS:
        return UKRAINE_ALL_SETTLEMENTS[name_lower]
    
    return None


def get_regional_cities(oblast: str) -> Dict[str, Tuple[float, float]]:
    """Get all major cities in an oblast."""
    return REGIONAL_CITY_COORDS.get(oblast.lower(), {})


def stats() -> Dict:
    """Return statistics about loaded data."""
    return {
        "city_coords": len(CITY_COORDS),
        "all_settlements": len(UKRAINE_ALL_SETTLEMENTS),
        "oblasts_with_settlements": len(UKRAINE_SETTLEMENTS_BY_OBLAST),
        "regional_city_groups": len(REGIONAL_CITY_COORDS),
    }
