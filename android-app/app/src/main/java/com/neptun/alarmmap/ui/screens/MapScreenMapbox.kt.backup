package com.neptun.alarmmap.ui.screens

import android.content.Context
import android.graphics.Bitmap
import android.graphics.Canvas
import android.view.View
import android.view.ViewTreeObserver
import androidx.compose.animation.*
import androidx.compose.animation.core.*
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Refresh
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.scale
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.ui.viewinterop.AndroidView
import androidx.core.content.ContextCompat
import androidx.lifecycle.viewmodel.compose.viewModel
import com.neptun.alarmmap.R
import com.neptun.alarmmap.data.PreferencesManager
import com.neptun.alarmmap.data.model.AlarmTrack
import com.neptun.alarmmap.ui.theme.NeptunBlue
import com.neptun.alarmmap.ui.viewmodel.MapViewModel
import com.mapbox.maps.MapView
import com.mapbox.maps.CameraOptions
import com.mapbox.maps.plugin.annotation.annotations
import com.mapbox.maps.plugin.annotation.generated.PointAnnotationOptions
import com.mapbox.maps.plugin.annotation.generated.createPointAnnotationManager
import com.mapbox.geojson.Point
import kotlinx.coroutines.delay
import kotlinx.coroutines.launch
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext
import java.net.HttpURLConnection
import java.net.URL

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun MapScreenMapbox(viewModel: MapViewModel = viewModel()) {
    val context = LocalContext.current
    val prefsManager = remember { PreferencesManager.getInstance(context) }
    val coroutineScope = rememberCoroutineScope()
    
    val uiState by viewModel.uiState.collectAsState()
    val autoRefreshEnabled by prefsManager.autoRefreshEnabled.collectAsState(initial = true)
    val refreshInterval by prefsManager.refreshInterval.collectAsState(initial = 60)
    
    var mapView by remember { mutableStateOf<MapView?>(null) }
    var styleLoaded by remember { mutableStateOf(false) }
    var webVisitors by remember { mutableStateOf(0) }
    var androidVisitors by remember { mutableStateOf(0) }
    
    // Animation states
    val infiniteTransition = rememberInfiniteTransition(label = "pulse")
    val pulseScale by infiniteTransition.animateFloat(
        initialValue = 1f,
        targetValue = 1.08f,
        animationSpec = infiniteRepeatable(
            animation = tween(800, easing = FastOutSlowInEasing),
            repeatMode = RepeatMode.Reverse
        ),
        label = "pulse"
    )
    
    // Track Android visit and load visitor counts
    LaunchedEffect(Unit) {
        // Track this Android app visit
        launch(Dispatchers.IO) {
            try {
                val url = URL("https://neptun.in.ua/api/track_android_visit")
                val connection = url.openConnection() as HttpURLConnection
                connection.requestMethod = "POST"
                connection.doOutput = true
                connection.connectTimeout = 5000
                connection.readTimeout = 5000
                connection.setRequestProperty("Content-Type", "application/json")
                connection.outputStream.write("{}".toByteArray())
                val responseCode = connection.responseCode
                connection.disconnect()
                android.util.Log.d("MapScreenMapbox", "Android visit tracked: response=$responseCode")
            } catch (e: Exception) {
                android.util.Log.e("MapScreenMapbox", "Error tracking visit: ${e.message}")
            }
        }
        
        // Load visitor counts periodically
        delay(2000) // Wait 2 seconds before first load
        while (true) {
            launch(Dispatchers.IO) {
                try {
                    // Get total web visitors
                    val webUrl = URL("https://neptun.in.ua/api/visitor_count")
                    val webConnection = webUrl.openConnection() as HttpURLConnection
                    webConnection.connectTimeout = 5000
                    webConnection.readTimeout = 5000
                    val webResponse = webConnection.inputStream.bufferedReader().use { it.readText().trim() }
                    val webCount = webResponse.toIntOrNull() ?: 0
                    android.util.Log.d("MapScreenMapbox", "Web visitors: $webCount (raw: '$webResponse')")
                    
                    // Get Android app visitors
                    val androidUrl = URL("https://neptun.in.ua/api/android_visitor_count")
                    val androidConnection = androidUrl.openConnection() as HttpURLConnection
                    androidConnection.connectTimeout = 5000
                    androidConnection.readTimeout = 5000
                    val androidResponse = androidConnection.inputStream.bufferedReader().use { it.readText().trim() }
                    val androidCount = androidResponse.toIntOrNull() ?: 0
                    android.util.Log.d("MapScreenMapbox", "Android visitors: $androidCount (raw: '$androidResponse')")
                    
                    withContext(Dispatchers.Main) {
                        webVisitors = webCount
                        androidVisitors = androidCount
                        android.util.Log.d("MapScreenMapbox", "Counts updated: web=$webVisitors, android=$androidVisitors")
                    }
                    
                    webConnection.disconnect()
                    androidConnection.disconnect()
                } catch (e: java.io.FileNotFoundException) {
                    // API endpoint returns 404 - this shouldn't happen now
                    android.util.Log.w("MapScreenMapbox", "API returned 404, keeping current values")
                } catch (e: Exception) {
                    android.util.Log.e("MapScreenMapbox", "Error loading counts: ${e.message}", e)
                }
            }
            delay(30000) // Update every 30 seconds
        }
    }
    
    LaunchedEffect(Unit) {
        viewModel.loadEvents()
    }
    
    LaunchedEffect(autoRefreshEnabled, refreshInterval) {
        if (autoRefreshEnabled) {
            while (true) {
                kotlinx.coroutines.delay((refreshInterval * 1000).toLong())
                viewModel.loadEvents()
            }
        }
    }
    
    // Update markers when tracks change and style is loaded
    LaunchedEffect(uiState.tracks, styleLoaded) {
        if (styleLoaded) {
            mapView?.let { mv ->
                updateMarkers(mv, uiState.tracks, context)
            }
        }
    }
    
    Box(modifier = Modifier.fillMaxSize()) {
        // Map
        Card(
            modifier = Modifier.fillMaxSize(),
            shape = RoundedCornerShape(0.dp),
            elevation = CardDefaults.cardElevation(defaultElevation = 0.dp)
        ) {
            AndroidView(
                modifier = Modifier.fillMaxSize(),
                factory = { ctx ->
                    MapView(ctx).apply {
                        // Hide Mapbox logo and attribution properly
                        viewTreeObserver.addOnGlobalLayoutListener(object : ViewTreeObserver.OnGlobalLayoutListener {
                            override fun onGlobalLayout() {
                                // Remove the listener to avoid multiple calls
                                viewTreeObserver.removeOnGlobalLayoutListener(this)
                                
                                // Hide logo
                                try {
                                    val logoView = this@apply.findViewById<View>(
                                        resources.getIdentifier("mapbox_logoView", "id", context.packageName)
                                    )
                                    logoView?.visibility = View.GONE
                                } catch (e: Exception) {
                                    android.util.Log.e("MapScreenMapbox", "Could not hide logo: ${e.message}")
                                }
                                
                                // Hide attribution
                                try {
                                    val attributionView = this@apply.findViewById<View>(
                                        resources.getIdentifier("mapbox_attributionView", "id", context.packageName)
                                    )
                                    attributionView?.visibility = View.GONE
                                } catch (e: Exception) {
                                    android.util.Log.e("MapScreenMapbox", "Could not hide attribution: ${e.message}")
                                }
                            }
                        })
                        
                        // Use Bright style from MapTiler (light theme, matches iOS)
                        mapboxMap.loadStyle("https://api.maptiler.com/maps/bright/style.json?key=m8zW2kq1Ta7cw9nODPXo") { style ->
                            android.util.Log.d("MapScreenMapbox", "Style loaded, adding icons...")
                            try {
                                addIconsToStyle(style, ctx)
                                styleLoaded = true
                                android.util.Log.d("MapScreenMapbox", "Icons added successfully")
                            } catch (e: Exception) {
                                android.util.Log.e("MapScreenMapbox", "Error adding icons: ${e.message}", e)
                            }
                        }
                        
                        // Set camera to Ukraine center
                        mapboxMap.setCamera(
                            CameraOptions.Builder()
                                .center(Point.fromLngLat(31.1656, 48.3794))
                                .zoom(5.5)
                                .build()
                        )
                        
                        mapView = this
                    }
                }
            )
        }
        
        // Compact gradient overlay
        Box(
            modifier = Modifier
                .fillMaxWidth()
                .height(100.dp)
                .align(Alignment.TopCenter)
                .background(
                    Brush.verticalGradient(
                        colors = listOf(
                            Color(0xCC0f172a),
                            Color.Transparent
                        )
                    )
                )
        )
        
        // Ultra Compact Header - Single Row Design
        Card(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 12.dp, vertical = 12.dp)
                .align(Alignment.TopCenter),
            shape = RoundedCornerShape(16.dp),
            colors = CardDefaults.cardColors(
                containerColor = Color(0xEE0f172a)
            ),
            elevation = CardDefaults.cardElevation(defaultElevation = 8.dp)
        ) {
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(horizontal = 10.dp, vertical = 8.dp),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                // Left: Logo + Title
                Row(
                    horizontalArrangement = Arrangement.spacedBy(6.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    // Animated pulse effect
                    Box {
                        Surface(
                            shape = CircleShape,
                            color = NeptunBlue.copy(alpha = 0.25f),
                            modifier = Modifier
                                .size(30.dp)
                                .scale(pulseScale)
                        ) {}
                        
                        Text(
                            text = "\u26A1", // âš¡
                            fontSize = 18.sp,
                            modifier = Modifier.align(Alignment.Center)
                        )
                    }
                    
                    Column(verticalArrangement = Arrangement.spacedBy(0.dp)) {
                        Text(
                            text = "NEPTUN",
                            style = MaterialTheme.typography.titleMedium,
                            fontWeight = FontWeight.ExtraBold,
                            color = Color.White,
                            fontSize = 16.sp,
                            letterSpacing = 0.3.sp
                        )
                        Text(
                            text = "ÐšÐ°Ñ€Ñ‚Ð° Ñ‚Ñ€Ð¸Ð²Ð¾Ð³",
                            style = MaterialTheme.typography.bodySmall,
                            color = Color.White.copy(alpha = 0.6f),
                            fontSize = 8.sp
                        )
                    }
                }
                
                // Center: Stat Pills (all green)
                Row(
                    horizontalArrangement = Arrangement.spacedBy(5.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    // Threats pill (green)
                    Surface(
                        shape = RoundedCornerShape(10.dp),
                        color = Color(0xFF10b981).copy(alpha = 0.15f),
                        border = androidx.compose.foundation.BorderStroke(
                            1.dp,
                            Color(0xFF10b981).copy(alpha = 0.3f)
                        )
                    ) {
                        Row(
                            modifier = Modifier.padding(horizontal = 8.dp, vertical = 5.dp),
                            horizontalArrangement = Arrangement.spacedBy(3.dp),
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            Text(text = "\uD83C\uDFAF", fontSize = 12.sp) // ðŸŽ¯
                            Text(
                                text = "${uiState.tracks.size}",
                                style = MaterialTheme.typography.labelLarge,
                                fontWeight = FontWeight.Bold,
                                color = Color(0xFF10b981),
                                fontSize = 13.sp
                            )
                        }
                    }
                    
                    // Web visitors pill (green)
                    Surface(
                        shape = RoundedCornerShape(10.dp),
                        color = Color(0xFF10b981).copy(alpha = 0.15f),
                        border = androidx.compose.foundation.BorderStroke(
                            1.dp,
                            Color(0xFF10b981).copy(alpha = 0.3f)
                        )
                    ) {
                        Row(
                            modifier = Modifier.padding(horizontal = 7.dp, vertical = 5.dp),
                            horizontalArrangement = Arrangement.spacedBy(3.dp),
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            Text(text = "\uD83C\uDF10", fontSize = 12.sp) // ðŸŒ
                            Text(
                                text = formatNumber(webVisitors),
                                style = MaterialTheme.typography.labelMedium,
                                fontWeight = FontWeight.Bold,
                                color = Color(0xFF10b981),
                                fontSize = 12.sp
                            )
                        }
                    }
                    
                    // Android pill (red as in screenshot)
                    Surface(
                        shape = RoundedCornerShape(10.dp),
                        color = Color(0xFFef4444).copy(alpha = 0.15f),
                        border = androidx.compose.foundation.BorderStroke(
                            1.dp,
                            Color(0xFFef4444).copy(alpha = 0.3f)
                        )
                    ) {
                        Row(
                            modifier = Modifier.padding(horizontal = 7.dp, vertical = 5.dp),
                            horizontalArrangement = Arrangement.spacedBy(3.dp),
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            Text(text = "\uD83D\uDCF1", fontSize = 12.sp) // ðŸ“±
                            Text(
                                text = formatNumber(androidVisitors),
                                style = MaterialTheme.typography.labelMedium,
                                fontWeight = FontWeight.Bold,
                                color = Color(0xFFef4444),
                                fontSize = 12.sp
                            )
                        }
                    }
                }
                
                // Right: Refresh button
                Surface(
                    shape = CircleShape,
                    color = if (uiState.isLoading) Color(0xFF1e293b) else NeptunBlue,
                    modifier = Modifier.size(32.dp),
                    shadowElevation = 4.dp
                ) {
                    IconButton(
                        onClick = { viewModel.loadEvents() },
                        enabled = !uiState.isLoading,
                        modifier = Modifier.size(32.dp)
                    ) {
                        Icon(
                            imageVector = Icons.Default.Refresh,
                            contentDescription = "Refresh",
                            tint = Color.White,
                            modifier = Modifier.size(16.dp)
                        )
                    }
                }
            }
        }
        
        // Loading indicator with blur effect
        if (uiState.isLoading) {
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .background(Color.Black.copy(alpha = 0.3f)),
                contentAlignment = Alignment.Center
            ) {
                Surface(
                    shape = RoundedCornerShape(16.dp),
                    color = Color(0xDD0f172a),
                    shadowElevation = 16.dp
                ) {
                    Row(
                        modifier = Modifier.padding(24.dp),
                        horizontalArrangement = Arrangement.spacedBy(16.dp),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        CircularProgressIndicator(
                            modifier = Modifier.size(32.dp),
                            color = NeptunBlue,
                            strokeWidth = 3.dp
                        )
                        Text(
                            text = "ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ð´Ð°Ð½Ð¸Ñ…...",
                            color = Color.White,
                            style = MaterialTheme.typography.bodyLarge,
                            fontWeight = FontWeight.Medium
                        )
                    }
                }
            }
        }
    }
}

fun formatNumber(number: Int): String {
    return when {
        number >= 1000000 -> "${number / 1000000}.${(number % 1000000) / 100000}M"
        number >= 1000 -> "${number / 1000}.${(number % 1000) / 100}K"
        else -> number.toString()
    }
}

private fun addIconsToStyle(style: com.mapbox.maps.Style, context: Context) {
    android.util.Log.d("MapScreenMapbox", "addIconsToStyle called")
    val iconTypes = mapOf(
        "shahed" to R.drawable.shahed,
        "raketa" to R.drawable.raketa,
        "artillery" to R.drawable.artillery,
        "avia" to R.drawable.avia,
        "fpv" to R.drawable.fpv,
        "kab" to R.drawable.kab,
        "rszv" to R.drawable.rszv,
        "pusk" to R.drawable.pusk,
        "obstril" to R.drawable.obstril,
        "vibuh" to R.drawable.vibuh,
        "vidboi" to R.drawable.vidboi,
        "rozved" to R.drawable.rozved,
        "trivoga" to R.drawable.trivoga,
        "threat_default" to R.drawable.threat_default_icon
    )
    
    iconTypes.forEach { (name, resId) ->
        try {
            val bitmap = createIconBitmap(context, resId)
            style.addImage(name, bitmap)
            android.util.Log.d("MapScreenMapbox", "Added icon: $name (${bitmap.width}x${bitmap.height})")
        } catch (e: Exception) {
            android.util.Log.e("MapScreenMapbox", "Failed to add icon $name: ${e.message}")
        }
    }
    android.util.Log.d("MapScreenMapbox", "All icons added")
}

private fun updateMarkers(mapView: MapView, tracks: List<AlarmTrack>, context: Context) {
    android.util.Log.d("MapScreenMapbox", "updateMarkers called with ${tracks.size} tracks")
    val annotationApi = mapView.annotations
    val pointAnnotationManager = annotationApi.createPointAnnotationManager()
    
    // Clear existing annotations
    pointAnnotationManager.deleteAll()
    
    // Add each track as a marker
    tracks.forEach { track ->
        val iconName = determineIconName(track.markerIcon, track.threatType)
        
        android.util.Log.d("MapScreenMapbox", "Creating marker: ${track.place} type=${track.threatType} icon=$iconName at ${track.latitude},${track.longitude}")
        
        val pointAnnotationOptions = PointAnnotationOptions()
            .withPoint(Point.fromLngLat(track.longitude, track.latitude))
            .withIconImage(iconName)
            .withIconSize(1.0)
        
        pointAnnotationManager.create(pointAnnotationOptions)
    }
    android.util.Log.d("MapScreenMapbox", "All ${tracks.size} markers created")
}

private fun determineIconName(markerIcon: String?, threatType: String?): String {
    // Priority 1: marker_icon (if provided)
    if (!markerIcon.isNullOrBlank()) {
        // Remove .png extension if present
        val iconName = markerIcon.removeSuffix(".png")
        return when {
            iconName == "shahed" -> "shahed"
            iconName == "raketa" -> "raketa"
            iconName == "fpv" -> "fpv"
            iconName == "obstril" -> "obstril"
            iconName == "avia" -> "avia"
            iconName == "pusk" -> "pusk"
            iconName == "artillery" -> "artillery"
            iconName == "kab" -> "kab"
            iconName == "rszv" -> "rszv"
            iconName == "rozved" -> "rozved"
            iconName == "vibuh" -> "vibuh"
            iconName == "vidboi" -> "vidboi"
            iconName == "trivoga" -> "trivoga"
            else -> iconName
        }
    }
    
    // Priority 2: threat_type
    if (!threatType.isNullOrBlank()) {
        val type = threatType.lowercase()
        return when {
            type.contains("shahed") || type.contains("ÑˆÐ°Ñ…ÐµÐ´") -> "shahed"
            type.contains("raketa") || type.contains("Ñ€Ð°ÐºÐµÑ‚Ð°") || type.contains("missile") -> "raketa"
            type.contains("fpv") || type.contains("Ñ„Ð¿Ð²") -> "fpv"
            type.contains("obstril") || type.contains("Ð¾Ð±ÑÑ‚Ñ€Ñ–Ð»") || type.contains("artillery") -> "obstril"
            type.contains("avia") || type.contains("Ð°Ð²Ñ–Ð°Ñ†Ñ–Ñ") -> "avia"
            type.contains("pusk") || type.contains("Ð¿ÑƒÑÐº") -> "pusk"
            type.contains("kab") || type.contains("ÐºÐ°Ð±") -> "kab"
            type.contains("rszv") || type.contains("Ñ€ÑÐ·Ð²") -> "rszv"
            type.contains("rozved") || type.contains("Ñ€Ð¾Ð·Ð²Ñ–Ð´") -> "rozved"
            type.contains("vibuh") || type.contains("Ð²Ð¸Ð±ÑƒÑ…") -> "vibuh"
            type.contains("vidboi") || type.contains("Ð²Ñ–Ð´Ð±Ñ–Ð¹") -> "vidboi"
            else -> "trivoga"
        }
    }
    
    // Default
    return "threat_default"
}

private fun createIconBitmap(context: Context, iconResId: Int): Bitmap {
    val iconSize = 48
    
    val bitmap = Bitmap.createBitmap(iconSize, iconSize, Bitmap.Config.ARGB_8888)
    val canvas = Canvas(bitmap)
    
    // Draw icon
    val drawable = ContextCompat.getDrawable(context, iconResId)
    drawable?.setBounds(0, 0, iconSize, iconSize)
    drawable?.draw(canvas)
    
    return bitmap
}
