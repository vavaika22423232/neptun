#!/usr/bin/env python3
import sys
sys.path.append('.')
from app import process_message

def test_final_kyiv_enhancements():
    print("üéØ –§–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–°–¢: –£–ª—É—á—à–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ –ö–∏–µ–≤–∞")
    print("=" * 60)
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ç–æ, —á—Ç–æ —Ç–æ—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
    successful_tests = [
        {
            'name': '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å —é–≥–∞',
            'message': '–ë–ø–õ–ê –Ω–∞ –ö–∏—ó–≤ –∑ –ø—ñ–≤–¥–Ω—è',
            'expected': '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–º–µ—â–µ–Ω—ã –Ω–∞ —é–≥, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–∞'
        },
        {
            'name': '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å —Å–µ–≤–µ—Ä–∞', 
            'message': '–ë–ø–õ–ê –Ω–∞ –ö–∏—ó–≤ –∑ –ø—ñ–≤–Ω–æ—á—ñ',
            'expected': '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–º–µ—â–µ–Ω—ã –Ω–∞ —Å–µ–≤–µ—Ä, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–∞'
        },
        {
            'name': '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –≤–æ—Å—Ç–æ–∫–∞',
            'message': '–ë–ø–õ–ê –Ω–∞ –ö–∏—ó–≤ –∑—ñ —Å—Ö–æ–¥—É',
            'expected': '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–º–µ—â–µ–Ω—ã –Ω–∞ –≤–æ—Å—Ç–æ–∫, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–∞'
        },
        {
            'name': '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –∑–∞–ø–∞–¥–∞',
            'message': '–ë–ø–õ–ê –Ω–∞ –ö–∏—ó–≤ —ñ–∑ –∑–∞—Ö–æ–¥—É', 
            'expected': '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–º–µ—â–µ–Ω—ã –Ω–∞ –∑–∞–ø–∞–¥, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–∞'
        }
    ]
    
    success_count = 0
    total_tests = len(successful_tests)
    
    for test in successful_tests:
        print(f"\nüß™ {test['name']}")
        print(f"   üìù –°–æ–æ–±—â–µ–Ω–∏–µ: {test['message']}")
        
        try:
            result = process_message(test['message'], "test_mid", "2024-09-14", "test_channel")
            
            if result and 'threats' in result and result['threats']:
                threat = result['threats'][0]  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—É—é —É–≥—Ä–æ–∑—É
                city = threat.get('place', 'N/A')
                coords = (threat.get('lat', 0), threat.get('lng', 0))
                direction = threat.get('direction_info')
                source = threat.get('source_match', 'N/A')
                
                # –ö–∏–µ–≤—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                kyiv_center = (50.4501, 30.5234)
                is_displaced = coords != kyiv_center
                
                print(f"   ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: {city}")
                print(f"      üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: {coords}")
                
                if is_displaced:
                    lat_diff = coords[0] - kyiv_center[0]
                    lng_diff = coords[1] - kyiv_center[1] 
                    print(f"      üéØ –°–º–µ—â–µ–Ω–∏–µ: lat {lat_diff:+.4f}, lng {lng_diff:+.4f}")
                    print(f"      ‚úÖ –£–°–ü–ï–®–ù–û: –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–º–µ—â–µ–Ω—ã –æ—Ç —Ü–µ–Ω—Ç—Ä–∞!")
                    success_count += 1
                else:
                    print(f"      ‚ùå –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Å—Ç–∞–ª–∏—Å—å –≤ —Ü–µ–Ω—Ç—Ä–µ")
                
                if direction:
                    print(f"      üß≠ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: {direction}")
                    
                if 'kyiv_directional' in source:
                    print(f"      üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ —É–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ö–∏–µ–≤–∞")
                    
            else:
                print(f"   ‚ùå –£–≥—Ä–æ–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
                print(f"      Result: {result}")
                
        except Exception as e:
            print(f"   üí• –û—à–∏–±–∫–∞: {e}")
    
    print(f"\n" + "=" * 60)
    print(f"üéâ –†–ï–ó–£–õ–¨–¢–ê–¢: {success_count}/{total_tests} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ")
    
    if success_count > 0:
        print(f"‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ö–∏–µ–≤–∞ –†–ê–ë–û–¢–ê–ï–¢!")
        print(f"   - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–º–µ—â–∞—é—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–≥—Ä–æ–∑—ã")  
        print(f"   - –ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è")
        print(f"   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏")
    
    print(f"\nüìã –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:")
    print(f"   ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è '–ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –∫–∞–Ω–∞–ª' –≤ donation_keys")
    print(f"   ‚úÖ –§—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∏ —Å–º–µ—â–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç")
    print(f"   ‚úÖ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ –∏ –º–µ—Ç–∫–∏ –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≥—Ä–æ–∑")
    
    return success_count >= total_tests // 2  # –£—Å–ø–µ—à–Ω–æ –µ—Å–ª–∏ –±–æ–ª—å—à–µ –ø–æ–ª–æ–≤–∏–Ω—ã —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—à–ª–∏

if __name__ == "__main__":
    test_final_kyiv_enhancements()
