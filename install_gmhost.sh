#!/bin/bash

# –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è NEPTUN –Ω–∞ GMhost
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —á–µ—Ä–µ–∑ SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ GMhost

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è NEPTUN –Ω–∞ GMhost..."
echo "üìç –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é Python
echo "üêç –ü—Ä–æ–≤–µ—Ä—è–µ–º Python..."
python3 --version || { echo "‚ùå Python3 –Ω–µ –Ω–∞–π–¥–µ–Ω!"; exit 1; }
pip3 --version || { echo "‚ùå pip3 –Ω–µ –Ω–∞–π–¥–µ–Ω!"; exit 1; }

# –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
echo "üìÅ –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏..."
mkdir -p logs
mkdir -p data
mkdir -p tmp

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º pip –ø–∞–∫–µ—Ç—ã –ª–æ–∫–∞–ª—å–Ω–æ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –ø–∞–∫–µ—Ç—ã..."
packages=(
    "flask==3.0.3"
    "telethon==1.35.0" 
    "pytz==2024.1"
    "requests==2.32.3"
    "spacy==3.8.7"
)

for package in "${packages[@]}"; do
    echo "  ‚¨áÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º $package..."
    pip3 install --user "$package" || {
        echo "  ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å $package, –ø—Ä–æ–±—É–µ–º –±–µ–∑ –≤–µ—Ä—Å–∏–∏..."
        pip3 install --user "${package%%==*}" || echo "  ‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ $package"
    }
done

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–∫—Ä–∞–∏–Ω—Å–∫—É—é –º–æ–¥–µ–ª—å SpaCy
echo "üá∫üá¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–∫—Ä–∞–∏–Ω—Å–∫—É—é –º–æ–¥–µ–ª—å SpaCy..."
SPACY_MODEL_URL="https://github.com/explosion/spacy-models/releases/download/uk_core_news_sm-3.8.0/uk_core_news_sm-3.8.0-py3-none-any.whl"
pip3 install --user "$SPACY_MODEL_URL" || {
    echo "  ‚ö†Ô∏è –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ SpaCy –º–æ–¥–µ–ª–∏..."
    python3 -m spacy download uk_core_news_sm || echo "  ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SpaCy –º–æ–¥–µ–ª—å"
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞..."
required_files=("app.py" "index.py" ".htaccess")
for file in "${required_files[@]}"; do
    if [[ -f "$file" ]]; then
        echo "  ‚úÖ $file –Ω–∞–π–¥–µ–Ω"
    else
        echo "  ‚ùå $file –ù–ï –ù–ê–ô–î–ï–ù!"
        echo "  üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
    fi
done

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
echo "üîê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
chmod 755 index.py 2>/dev/null && echo "  ‚úÖ index.py - 755" || echo "  ‚ö†Ô∏è index.py –Ω–µ –Ω–∞–π–¥–µ–Ω"  
chmod 755 app.py 2>/dev/null && echo "  ‚úÖ app.py - 755" || echo "  ‚ö†Ô∏è app.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
chmod 644 .htaccess 2>/dev/null && echo "  ‚úÖ .htaccess - 644" || echo "  ‚ö†Ô∏è .htaccess –Ω–µ –Ω–∞–π–¥–µ–Ω"
chmod 600 .env 2>/dev/null && echo "  ‚úÖ .env - 600" || echo "  üí° .env –Ω–µ –Ω–∞–π–¥–µ–Ω (—Å–æ–∑–¥–∞–π—Ç–µ –∏–∑ env_example.txt)"
chmod 755 templates/ 2>/dev/null && echo "  ‚úÖ templates/ - 755" || echo "  üí° templates/ –Ω–µ –Ω–∞–π–¥–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã..."
python3 -c "import flask; print('  ‚úÖ Flask –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è')" || echo "  ‚ùå Flask –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç"
python3 -c "import telethon; print('  ‚úÖ Telethon –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è')" || echo "  ‚ùå Telethon –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç" 
python3 -c "import spacy; print('  ‚úÖ SpaCy –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è')" || echo "  ‚ùå SpaCy –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç"
python3 -c "import spacy; nlp=spacy.load('uk_core_news_sm'); print('  ‚úÖ –£–∫—Ä–∞–∏–Ω—Å–∫–∞—è –º–æ–¥–µ–ª—å SpaCy —Ä–∞–±–æ—Ç–∞–µ—Ç')" || echo "  ‚ö†Ô∏è –£–∫—Ä–∞–∏–Ω—Å–∫–∞—è –º–æ–¥–µ–ª—å SpaCy –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç"

echo ""
echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "ÔøΩ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –∏–∑ env_example.txt"
echo "2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤–∞—à–∏ Telegram API –¥–∞–Ω–Ω—ã–µ –≤ .env"  
echo "3. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏"
echo ""
echo "üÜò –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö:"
echo "- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: tail -20 ~/logs/error.log"
echo "- –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π GMhost: support@gmhost.com.ua"
echo ""
