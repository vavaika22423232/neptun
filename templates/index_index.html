<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes, viewport-fit=cover, shrink-to-fit=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0a0e17">
  <meta name="format-detection" content="telephone=no">
  
  <!-- PRIMARY SEO - OPTIMIZED FOR #1 RANKING -->
  <title>Карта тривог України в реальному часі — повітряна тривога онлайн | NEPTUN</title>
  <meta name="description" content="Карта тривог України онлайн — відстежуйте повітряні тривоги, шахеди та ракети в реальному часі. Інтерактивна карта тривог з радаром загроз 24/7. Завантажте безкоштовний додаток NEPTUN для миттєвих сповіщень.">
  <meta name="keywords" content="карта тривог, карта тривог україни, карта тривог онлайн, повітряна тривога карта, мапа тривог, тривога україна онлайн, карта шахедів, радар шахедів, карта повітряних тривог, тривога зараз, карта загроз україна, neptun карта тривог">
  <meta name="author" content="NEPTUN">
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
  <meta name="googlebot" content="index, follow">
  <link rel="canonical" href="https://neptun.in.ua/">
  
  <!-- OPEN GRAPH / FACEBOOK -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://neptun.in.ua/">
  <meta property="og:title" content="Карта тривог України онлайн — повітряна тривога в реальному часі">
  <meta property="og:description" content="Офіційна карта тривог України. Відстежуйте повітряні тривоги, шахеди та ракети онлайн 24/7. Безкоштовний додаток з push-сповіщеннями.">
  <meta property="og:image" content="https://neptun.in.ua/static/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:site_name" content="NEPTUN - Карта тривог України">
  <meta property="og:locale" content="uk_UA">
  
  <!-- TWITTER -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://neptun.in.ua/">
  <meta name="twitter:title" content="Карта тривог України онлайн — NEPTUN">
  <meta name="twitter:description" content="Карта тривог України в реальному часі. Повітряні тривоги, шахеди, ракети онлайн 24/7.">
  <meta name="twitter:image" content="https://neptun.in.ua/static/og-image.png">
  
  <!-- GEO & LANGUAGE -->
  <meta name="geo.region" content="UA">
  <meta name="geo.placename" content="Ukraine">
  <meta name="language" content="Ukrainian">
  <meta http-equiv="content-language" content="uk">
  <link rel="alternate" hreflang="uk" href="https://neptun.in.ua/">
  <link rel="alternate" hreflang="x-default" href="https://neptun.in.ua/">
  
  <!-- STRUCTURED DATA - JSON-LD -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Карта тривог України — NEPTUN",
    "alternateName": ["Карта тривог", "Мапа тривог", "Карта тривог онлайн", "NEPTUN"],
    "description": "Карта тривог України в реальному часі. Відстежуйте повітряні тривоги, шахеди та ракети онлайн на інтерактивній карті.",
    "url": "https://neptun.in.ua",
    "applicationCategory": "UtilitiesApplication",
    "operatingSystem": "Web, Android, iOS",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "UAH"
    },
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "4.9",
      "ratingCount": "2847"
    },
    "author": {
      "@type": "Organization",
      "name": "NEPTUN",
      "url": "https://neptun.in.ua"
    },
    "inLanguage": "uk",
    "isAccessibleForFree": true,
    "keywords": "карта тривог, карта тривог україни, повітряна тривога онлайн, мапа тривог"
  }
  </script>
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
      {
        "@type": "Question",
        "name": "Де подивитися карту тривог України онлайн?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Карта тривог України доступна на сайті neptun.in.ua. Це інтерактивна карта повітряних тривог в реальному часі з відстеженням шахедів та ракет."
        }
      },
      {
        "@type": "Question",
        "name": "Як працює карта тривог NEPTUN?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Карта тривог NEPTUN відображає активні повітряні тривоги по всіх областях України в реальному часі. Дані оновлюються кожні кілька секунд."
        }
      },
      {
        "@type": "Question",
        "name": "Чи є мобільний додаток карти тривог?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Так, додаток NEPTUN з картою тривог доступний безкоштовно в Google Play. Він надсилає push-сповіщення про тривоги у вашому регіоні."
        }
      },
      {
        "@type": "Question",
        "name": "Яка карта тривог найточніша?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "NEPTUN — одна з найточніших карт тривог України. Дані надходять з офіційних джерел та оновлюються в реальному часі 24/7."
        }
      }
    ]
  }
  </script>
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Головна",
        "item": "https://neptun.in.ua"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "Карта тривог",
        "item": "https://neptun.in.ua/#map"
      }
    ]
  }
  </script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600&family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MW867VP8WK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-MW867VP8WK');
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      /* Disable all selection and tap highlight */
      -webkit-tap-highlight-color: transparent !important;
      -webkit-touch-callout: none !important;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
      user-select: none !important;
      -webkit-user-drag: none !important;
      outline: none !important;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: linear-gradient(135deg, #0a0e17 0%, #0d1929 50%, #0a192f 100%);
      font-family: 'Inter', 'Exo 2', -apple-system, sans-serif;
      -webkit-tap-highlight-color: transparent !important;
      -webkit-touch-callout: none !important;
      -webkit-user-select: none !important;
      user-select: none !important;
    }
    
    /* SVG elements - disable highlight */
    svg, svg *, img, div, path, g, text {
      -webkit-tap-highlight-color: transparent !important;
      -webkit-touch-callout: none !important;
      -webkit-user-select: none !important;
      user-select: none !important;
      outline: none !important;
      -webkit-user-drag: none !important;
    }
    
    /* Animated background grid */
    #map-container::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
      z-index: 0;
    }
    
    #map-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      touch-action: none; /* Prevent default touch behaviors */
      -webkit-user-select: none;
      user-select: none;
    }
    
    #map-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: none;
      overflow: hidden;
    }
    
    /* Container for SVG layers */
    .svg-container {
      position: absolute;
      /* GPU acceleration */
      will-change: transform;
      transform-origin: center center;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
    }
    
    /* Shadow disabled for performance */
    /* @media (min-width: 769px) {
      .svg-container {
        filter: drop-shadow(0 0 40px rgba(0, 212, 255, 0.15));
      }
    } */
    
    .svg-container.animating {
      transition: transform 0.2s ease-out;
    }
    
    .svg-container svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      /* Vector-crisp rendering at any zoom */
      shape-rendering: crispEdges;
      text-rendering: optimizeLegibility;
      overflow: visible;
    }
    
    /* States (oblasts) layer */
    #states-layer {
      z-index: 1;
      opacity: 0.5;
    }
    
    /* Districts layer */
    #districts-layer {
      z-index: 2;
      opacity: 0.5;
    }
    
    /* Names layer */
    #names-layer {
      z-index: 3;
      pointer-events: none;
    }
    
    #names-layer text {
      fill: rgba(255, 255, 255, 0.9);
      font-family: 'Exo 2', sans-serif;
      font-weight: 400;
      text-shadow: 
        0 0 10px rgba(0, 212, 255, 0.5),
        0 2px 4px rgba(0, 0, 0, 0.8);
    }
    
    /* NEPTUN style - Oblast regions */
    #states-layer .stateObject {
      fill: linear-gradient(180deg, #1a2744 0%, #0f1a2e 100%);
      fill: #162236;
      stroke: #00d4ff;
      stroke-width: 0.4;
      stroke-opacity: 0.3;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    #states-layer .stateObject:hover {
      fill: #1e3050;
      stroke-opacity: 0.6;
    }
    
    #states-layer .stateObject.alarm {
      fill: #7f1d1d;
      stroke: #ff4444;
      stroke-opacity: 0.8;
      /* animation: alarmPulse 2s ease-in-out infinite; - disabled for performance */
    }
    
    /* NEPTUN style - District regions */
    #districts-layer .dist {
      fill: transparent;
      stroke: rgba(0, 212, 255, 0.15);
      stroke-width: 0.1;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: all;
    }
    
    #districts-layer .dist:hover {
      fill: rgba(0, 212, 255, 0.1);
      stroke: rgba(0, 212, 255, 0.4);
      cursor: pointer;
    }
    
    #districts-layer .dist.alarm {
      fill: #dc2626;
      stroke: #ff6b6b;
      stroke-width: 0.2;
      /* animation: districtAlarm 1.5s ease-in-out infinite; - disabled for performance */
    }
    
    @keyframes alarmPulse {
      0%, 100% { fill: #7f1d1d; }
      50% { fill: #991b1b; }
    }    @keyframes districtAlarm {
      0%, 100% { 
        fill: #dc2626;
        opacity: 0.9;
      }
      50% { 
        fill: #ef4444;
        opacity: 1;
      }
    }
    
    /* NEPTUN Logo & Branding */
    .neptun-logo {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1001;
      text-align: center;
    }
    
    .neptun-logo h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 28px;
      font-weight: 900;
      background: linear-gradient(135deg, #00d4ff 0%, #0099cc 50%, #00d4ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 8px;
      text-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
      margin: 0;
    }
    
    .neptun-logo .subtitle {
      font-family: 'Exo 2', sans-serif;
      font-size: 10px;
      color: rgba(0, 212, 255, 0.6);
      letter-spacing: 4px;
      margin-top: 4px;
      text-transform: uppercase;
    }
    
    /* Zoom controls - NEPTUN style */
    .zoom-controls {
      position: fixed;
      bottom: 30px;
      right: 30px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 1000;
    }
    
    .zoom-btn {
      width: 44px;
      height: 44px;
      background: rgba(10, 25, 47, 0.9);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 8px;
      color: #00d4ff;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      /* backdrop-filter: blur(10px); - disabled for performance */
    }
    
    .zoom-btn:hover {
      background: rgba(0, 212, 255, 0.15);
      border-color: #00d4ff;
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
      transform: scale(1.05);
    }
    
    /* Floating Buttons Container - Minimal Style */
    .floating-buttons {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1100;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .floating-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 18px;
      border: none;
      border-radius: 50px;
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 0.3px;
      cursor: pointer;
      transition: all 0.25s ease;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    
    .floating-btn i.material-icons {
      font-size: 20px;
    }
    
    .floating-btn.commercial-btn {
      background: rgba(139, 92, 246, 0.15);
      color: #a78bfa;
      border: 1px solid rgba(139, 92, 246, 0.25);
    }
    
    .floating-btn.commercial-btn:hover {
      background: rgba(139, 92, 246, 0.25);
      color: #c4b5fd;
      transform: translateX(-4px);
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.2);
    }
    
    .floating-btn.map-btn {
      background: rgba(0, 212, 255, 0.1);
      color: #67e8f9;
      border: 1px solid rgba(0, 212, 255, 0.2);
    }
    
    .floating-btn.map-btn:hover {
      background: rgba(0, 212, 255, 0.2);
      color: #a5f3fc;
      transform: translateX(-4px);
      box-shadow: 0 4px 20px rgba(0, 212, 255, 0.15);
    }
    
    @media (max-width: 768px) {
      .floating-buttons {
        bottom: 80px;
        right: 12px;
        gap: 8px;
      }
      
      .floating-btn {
        padding: 10px 14px;
        border-radius: 50px;
        width: auto;
        height: auto;
        font-size: 11px;
      }
      
      .floating-btn .btn-text {
        display: inline;
      }
      
      .floating-btn i.material-icons {
        font-size: 18px;
      }
    }
    
    /* Status panel - NEPTUN style */
    .status-panel {
      position: fixed;
      top: 80px;
      left: 20px;
      background: rgba(10, 25, 47, 0.95);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 12px;
      padding: 16px 20px;
      color: white;
      z-index: 1000;
      /* backdrop-filter removed for performance */
      min-width: 160px;
    }
    
    .status-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, #00d4ff, transparent);
      border-radius: 12px 12px 0 0;
    }
    
    .status-panel h3 {
      font-family: 'Exo 2', sans-serif;
      font-size: 11px;
      font-weight: 400;
      margin-bottom: 8px;
      color: rgba(0, 212, 255, 0.8);
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    
    .alarm-count {
      font-family: 'Orbitron', sans-serif;
      font-size: 36px;
      font-weight: 700;
      color: #ff4444;
      text-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
      line-height: 1;
    }
    
    .alarm-count.safe {
      color: #00ff88;
      text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
    }
    
    .last-update {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 10px;
      font-weight: 300;
    }
    
    .last-update.stale {
      color: #ffaa00;
    }
    
    .last-update.error {
      color: #ff4444;
    }
    
    .api-status {
      font-size: 9px;
      color: rgba(0, 212, 255, 0.5);
      margin-top: 4px;
    }

    /* Trajectory lines layer */
    #trajectories-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9;
      pointer-events: none;
      overflow: visible;
    }
    
    .trajectory-line {
      position: absolute;
      pointer-events: none;
      z-index: 9;
    }
    
    .trajectory-line svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: visible;
    }
    
    .trajectory-line line {
      stroke: #f97316;
      stroke-width: 2;
      stroke-dasharray: 6 3;
      stroke-linecap: round;
      opacity: 0.85;
      filter: drop-shadow(0 0 4px rgba(249, 115, 22, 0.6));
    }
    
    .trajectory-arrow {
      position: absolute;
      transform: translate(-50%, -50%);
      color: #f97316;
      font-size: 14px;
      font-weight: bold;
      text-shadow: 0 0 6px rgba(249, 115, 22, 0.8);
      pointer-events: none;
      z-index: 10;
    }
    
    /* Threat markers layer */
    #markers-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
      pointer-events: none;
    }
    
    .threat-marker {
      position: absolute;
      width: 32px;
      height: 32px;
      transform: translate(-50%, -50%);
      pointer-events: auto;
      cursor: pointer;
      filter: drop-shadow(0 0 4px rgba(255, 100, 100, 0.6));
      /* animation disabled for performance */
      transition: transform 0.15s ease;
    }
    
    .threat-marker:hover {
      transform: translate(-50%, -50%) scale(1.3);
      z-index: 100;
    }
    
    .threat-marker img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    /* Count badge for multiple threats at same location */
    .marker-count-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 5px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
      font-family: 'Inter', system-ui, sans-serif;
      line-height: 1;
      z-index: 10;
      pointer-events: none;
      min-width: 16px;
      text-align: center;
    }
    
    @keyframes markerPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    
    /* Marker tooltip */
    .marker-tooltip {
      position: fixed;
      background: rgba(10, 25, 47, 0.95);
      border: 1px solid rgba(0, 212, 255, 0.4);
      border-radius: 8px;
      padding: 10px 14px;
      color: white;
      font-size: 12px;
      max-width: 280px;
      z-index: 2000;
      pointer-events: none;
      /* backdrop-filter removed for performance */
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }
    
    .marker-tooltip .tooltip-type {
      font-family: 'Orbitron', sans-serif;
      font-size: 11px;
      color: #00d4ff;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 6px;
    }
    
    .marker-tooltip .tooltip-place {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .marker-tooltip .tooltip-time {
      font-size: 10px;
      color: rgba(255, 255, 255, 0.5);
    }
    
    /* Markers counter in status panel */
    .markers-info {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(0, 212, 255, 0.2);
    }
    
    .markers-info h4 {
      font-size: 10px;
      color: rgba(0, 212, 255, 0.7);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 6px;
    }
    
    .marker-type-count {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.8);
      margin: 4px 0;
    }
    
    .marker-type-count img {
      width: 18px;
      height: 18px;
    }
    
    /* ========== MOBILE OPTIMIZATION ========== */
    
    /* Very small phones (320px) */
    @media screen and (max-width: 360px) {
      .status-panel {
        bottom: 65px;
        right: 8px;
        padding: 6px 10px;
      }
      .status-panel h3 {
        font-size: 7px;
      }
      .alarm-count {
        font-size: 20px;
      }
      .last-update {
        font-size: 7px;
      }
      .zoom-controls {
        bottom: 65px;
        left: 8px;
      }
      .zoom-btn {
        width: 34px;
        height: 34px;
        font-size: 16px;
      }
    }
        /* Small phones */
    @media screen and (max-width: 480px) {
      /* Logo smaller on mobile */
      .neptun-logo h1 {
        font-size: 18px;
        letter-spacing: 4px;
      }
      .neptun-logo .subtitle {
        font-size: 8px;
        letter-spacing: 2px;
      }
      .neptun-logo {
        top: 10px;
      }
      
      /* Status panel compact - mobile optimized */
      .status-panel {
        top: auto;
        bottom: 70px;
        left: auto;
        right: 10px;
        padding: 8px 12px;
        min-width: auto;
        border-radius: 12px;
        background: rgba(10, 25, 47, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
      }
      .status-panel::before {
        display: none;
      }
      .status-panel h3 {
        font-size: 8px;
        letter-spacing: 1px;
        margin-bottom: 2px;
        text-align: center;
      }
      .alarm-count {
        font-size: 24px;
        line-height: 1;
      }
      .last-update {
        font-size: 8px;
        margin-top: 4px;
        text-align: center;
      }
      .api-status {
        display: none;
      }
      .markers-info {
        display: none !important;
      }
      
      /* Zoom controls smaller - left bottom */
      .zoom-controls {
        bottom: 70px;
        left: 10px;
        right: auto;
        gap: 6px;
      }
      .zoom-btn {
        width: 38px;
        height: 38px;
        font-size: 18px;
        border-radius: 8px;
      }
      
      /* Map fills screen */
      .svg-container {
        width: 100vw;
        max-width: none;
        filter: none;
      }
      
      /* Smaller markers */
      .threat-marker {
        width: 24px;
        height: 24px;
        /* Disable animations and filters for performance */
        animation: none !important;
        filter: none !important;
      }
      
      /* Simplified trajectory lines on mobile */
      .trajectory-line line {
        filter: none !important;
        stroke-width: 1.5;
      }
      
      .trajectory-arrow {
        text-shadow: none !important;
        font-size: 12px;
      }
      
      /* No hover effects on touch */
      #districts-layer .dist:hover {
        fill: transparent;
        stroke: rgba(0, 212, 255, 0.15);
      }
      
      /* Disable background grid for performance */
      #map-container::before {
        display: none;
      }
      
      /* Tooltip smaller */
      .marker-tooltip {
        font-size: 11px;
        padding: 8px 10px;
        max-width: 200px;
      }
    }
    
    /* Tablets */
    @media screen and (max-width: 768px) and (min-width: 481px) {
      .neptun-logo h1 {
        font-size: 22px;
        letter-spacing: 5px;
      }
      .neptun-logo .subtitle {
        font-size: 9px;
      }
      
      .status-panel {
        top: 70px;
        left: 15px;
        padding: 12px 16px;
      }
      .alarm-count {
        font-size: 32px;
      }
      
      .zoom-controls {
        bottom: 20px;
        right: 15px;
      }
      .zoom-btn {
        width: 40px;
        height: 40px;
      }
      
      .svg-container {
        width: 95vw;
      }
      
      .threat-marker {
        width: 28px;
        height: 28px;
      }
    }
    
    /* Landscape mobile */
    @media screen and (max-height: 500px) and (orientation: landscape) {
      .neptun-logo {
        top: 5px;
      }
      .neptun-logo h1 {
        font-size: 16px;
      }
      .neptun-logo .subtitle {
        display: none;
      }
      
      .status-panel {
        top: auto;
        bottom: 5px;
        left: auto;
        right: 50px;
        padding: 6px 10px;
        flex-direction: row;
        gap: 8px;
        align-items: center;
      }
      .status-panel h3 {
        display: none;
      }
      .alarm-count {
        font-size: 20px;
      }
      .last-update, .api-status, .markers-info {
        display: none !important;
      }
      
      .zoom-controls {
        bottom: 5px;
        right: 5px;
        flex-direction: row;
      }
      .zoom-btn {
        width: 32px;
        height: 32px;
        font-size: 16px;
      }
      
      .svg-container {
        width: 100vw;
        height: 100vh;
        aspect-ratio: auto;
      }
    }
    
    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {
      /* Disable tap highlight on Android/mobile */
      * {
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        tap-highlight-color: transparent;
      }
      
      /* Larger touch targets */
      .zoom-btn {
        min-width: 44px;
        min-height: 44px;
      }
      
      /* Disable hover effects completely on touch */
      .zoom-btn:hover {
        transform: none;
        box-shadow: none;
      }
      
      /* Keep normal state colors on touch - don't change fill */
      #states-layer .stateObject:hover {
        fill: #162236;
        stroke-opacity: 0.3;
      }
      
      #states-layer .stateObject.alarm:hover {
        fill: #7f1d1d;
        stroke-opacity: 0.8;
      }
      
      #districts-layer .dist:hover {
        fill: transparent;
        stroke: rgba(0, 212, 255, 0.15);
      }
      
      #districts-layer .dist.alarm:hover {
        fill: #dc2626;
        stroke: #ff6b6b;
      }
      
      /* Prevent text selection on long press */
      * {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
      }
    }
    
    /* Android-specific optimizations */
    .android-device .svg-container {
      /* Disable transitions completely on Android */
      transition: none !important;
    }
    
    .android-device .svg-container.animating {
      transition: none !important;
    }
    
    .android-device #states-layer .stateObject,
    .android-device #districts-layer .dist {
      /* Disable all transitions on Android */
      transition: none !important;
    }
    
    .android-device #states-layer .stateObject.alarm,
    .android-device #districts-layer .dist.alarm {
      /* Disable pulse animations on Android */
      animation: none !important;
    }
    
    .android-device .threat-marker {
      /* Disable marker pulse on Android */
      animation: none !important;
      filter: none !important;
    }
    
    .android-device .trajectory-line line {
      filter: none !important;
    }
    
    .android-device #map-container::before {
      /* Disable background grid on Android */
      display: none;
    }
    
    /* Touch device optimizations - disable heavy effects */
    @media (hover: none) and (pointer: coarse) {
      .threat-marker {
        animation: none !important;
        filter: drop-shadow(0 0 3px rgba(255, 100, 100, 0.5)) !important;
      }
      
      .trajectory-line line {
        filter: none !important;
        stroke-width: 1.5;
      }
      
      .trajectory-arrow {
        text-shadow: none !important;
      }
    }
    
    /* Safe area for notched phones */
    @supports (padding: max(0px)) {
      .status-panel {
        left: max(10px, env(safe-area-inset-left));
      }
      .zoom-controls {
        right: max(10px, env(safe-area-inset-right));
        bottom: max(10px, env(safe-area-inset-bottom));
      }
    }
    
    /* ========== NAVBAR STYLES - Minimal Glass ========== */
    .navbar {
      width: 100%;
      background: rgba(15, 23, 42, 0.75);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      color: #e2e8f0;
      font-weight: 500;
      font-size: 1rem;
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(103, 232, 249, 0.1);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    
    .navbar::after {
      display: none;
    }
    
    .navbar .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .logo-text {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
      color: #67e8f9;
      letter-spacing: 3px;
    }
    
    .nav-actions {
      display: flex;
      gap: 0.4rem;
      align-items: center;
    }
    
    .nav-links {
      display: flex;
      gap: 0.25rem;
      align-items: center;
    }
    
    .nav-links a, .nav-actions .nav-btn {
      color: #94a3b8;
      text-decoration: none;
      font-weight: 500;
      padding: 0.4rem 0.8rem;
      border-radius: 50px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.35rem;
      transition: all 0.25s ease;
      border: 1px solid transparent;
      background: rgba(103, 232, 249, 0.06);
      cursor: pointer;
    }
    
    .nav-links a:hover, .nav-actions .nav-btn:hover {
      color: #a5f3fc;
      background: rgba(103, 232, 249, 0.12);
      border-color: rgba(103, 232, 249, 0.2);
    }
    
    .nav-links a.active {
      color: #67e8f9;
      background: rgba(103, 232, 249, 0.15);
      border-color: rgba(103, 232, 249, 0.25);
    }
    
    .nav-links a i, .nav-actions .nav-btn i {
      font-size: 1rem;
    }
    
    /* App download button - minimal glass style */
    .nav-actions .app-link {
      background: rgba(61, 220, 132, 0.1);
      color: #4ade80 !important;
      border: 1px solid rgba(61, 220, 132, 0.2);
      text-decoration: none;
    }
    
    .nav-actions .app-link:hover {
      background: rgba(61, 220, 132, 0.18);
      border-color: rgba(61, 220, 132, 0.35);
      transform: translateY(-1px);
    }
    
    /* FAQ button - minimal glass style */
    .nav-actions .faq-btn {
      background: rgba(147, 51, 234, 0.1);
      color: #a78bfa !important;
      border: 1px solid rgba(147, 51, 234, 0.2);
    }
    
    .nav-actions .faq-btn:hover {
      background: rgba(147, 51, 234, 0.18);
      border-color: rgba(147, 51, 234, 0.35);
      transform: translateY(-1px);
    }
    
    /* Support button - minimal glass style */
    .nav-actions .support-btn {
      background: rgba(251, 113, 133, 0.1);
      color: #fb7185 !important;
      border: 1px solid rgba(251, 113, 133, 0.2);
    }
    
    .nav-actions .support-btn:hover {
      background: rgba(251, 113, 133, 0.18);
      border-color: rgba(251, 113, 133, 0.35);
      transform: translateY(-1px);
    }
    
    @keyframes appButtonPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }
    
    /* Navbar stats container - minimal glass */
    .navbar-stats {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 10px;
      background: rgba(103, 232, 249, 0.06);
      border: 1px solid rgba(103, 232, 249, 0.12);
      border-radius: 50px;
    }
    
    /* Live users counter */
    .live-users {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.65rem;
    }
    
    .live-label {
      color: #64748b;
      font-weight: 500;
      font-size: 0.55rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .live-count {
      color: #4ade80;
      font-weight: 700;
      font-size: 0.8rem;
      font-family: 'Orbitron', sans-serif;
    }
    
    .live-count.updating {
      animation: countUpdate 0.4s ease;
    }
    
    @keyframes countUpdate {
      50% { transform: scale(1.15); }
    }
    
    .live-breakdown {
      display: flex;
      gap: 4px;
    }
    
    .live-chip {
      display: flex;
      align-items: center;
      gap: 2px;
      font-size: 0.55rem;
      color: #64748b;
    }
    
    .live-chip strong {
      color: #94a3b8;
      font-weight: 600;
    }
    
    /* User nickname in navbar */
    .user-nickname {
      display: none;
      align-items: center;
      gap: 4px;
      padding-left: 8px;
      border-left: 1px solid rgba(103, 232, 249, 0.15);
      color: #67e8f9;
      font-size: 0.7rem;
      font-weight: 500;
    }
    
    /* User nickname on the right side (near FAQ) */
    .user-nickname-right {
      display: none;
      align-items: center;
      gap: 4px;
      padding: 0.4rem 0.8rem;
      background: rgba(103, 232, 249, 0.08);
      border: 1px solid rgba(103, 232, 249, 0.15);
      border-radius: 50px;
      color: #67e8f9;
      font-size: 0.7rem;
      font-weight: 500;
      margin-right: 0.25rem;
    }
    
    .nickname-icon {
      font-size: 0.65rem;
    }
    
    @keyframes heartPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .nav-actions .support-btn i {
      animation: heartPulse 2s ease infinite;
    }
    
    /* Donate Modal - Minimal Glass Style */
    .donate-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .donate-modal-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .donate-modal {
      width: min(420px, 92vw);
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(103, 232, 249, 0.15);
      border-radius: 20px;
      padding: 1.75rem;
      position: relative;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      animation: modalSlide 0.3s ease;
    }
    
    @keyframes modalSlide {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .donate-title {
      margin: 0 0 0.75rem;
      font-size: 1.15rem;
      font-weight: 600;
      color: #a5f3fc;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .donate-title i {
      color: #fb7185;
    }
    
    .donate-sub {
      color: #64748b;
      font-size: 0.8rem;
      line-height: 1.5;
      margin-bottom: 1.25rem;
    }
    
    .donate-grid {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }
    
    .donate-card {
      background: rgba(103, 232, 249, 0.05);
      border: 1px solid rgba(103, 232, 249, 0.12);
      border-radius: 12px;
      padding: 0.85rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    
    .donate-label {
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
      color: #67e8f9;
    }
    
    .donate-value {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 500;
      font-size: 0.85rem;
      color: #e2e8f0;
      word-break: break-all;
    }
    
    .donate-actions {
      display: flex;
      gap: 0.4rem;
      margin-top: 0.4rem;
    }
    
    .btn-mini {
      background: rgba(103, 232, 249, 0.12);
      color: #67e8f9;
      border: 1px solid rgba(103, 232, 249, 0.2);
      border-radius: 50px;
      padding: 0.4rem 0.7rem;
      font-size: 0.65rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      transition: all 0.25s ease;
    }
    
    .btn-mini:hover {
      background: rgba(103, 232, 249, 0.2);
      border-color: rgba(103, 232, 249, 0.35);
    }
    
    .btn-mini.alt {
      background: rgba(148, 163, 184, 0.1);
      border-color: rgba(148, 163, 184, 0.15);
      color: #94a3b8;
    }
    
    .donate-close {
      position: absolute;
      top: 0.85rem;
      right: 0.85rem;
      width: 32px;
      height: 32px;
      background: rgba(103, 232, 249, 0.08);
      border: 1px solid rgba(103, 232, 249, 0.15);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.25s ease;
    }
    
    .donate-close:hover {
      background: rgba(251, 113, 133, 0.15);
      border-color: rgba(251, 113, 133, 0.25);
      color: #fb7185;
      transform: rotate(90deg);
    }
    
    .jar-link-button {
      width: 100%;
      background: rgba(103, 232, 249, 0.15);
      color: #67e8f9;
      border: 1px solid rgba(103, 232, 249, 0.3);
      border-radius: 50px;
      padding: 0.85rem;
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: all 0.25s ease;
    }
    
    .jar-link-button:hover {
      background: rgba(103, 232, 249, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(103, 232, 249, 0.2);
    }
    
    .donate-footer {
      font-size: 0.6rem;
      color: #475569;
      margin-top: 0.85rem;
      text-align: center;
    }
    
    /* FAQ Modal - Minimal Glass Style */
    .faq-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }
    
    .faq-modal-overlay.active {
      display: flex;
    }
    
    .faq-modal {
      background: rgba(15, 23, 42, 0.92);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(103, 232, 249, 0.15);
      border-radius: 24px;
      padding: 1.75rem;
      max-width: 520px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    }
    
    .faq-modal::-webkit-scrollbar {
      width: 6px;
    }
    
    .faq-modal::-webkit-scrollbar-track {
      background: rgba(103, 232, 249, 0.05);
      border-radius: 3px;
    }
    
    .faq-modal::-webkit-scrollbar-thumb {
      background: rgba(103, 232, 249, 0.2);
      border-radius: 3px;
    }
    
    .faq-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(103, 232, 249, 0.1);
    }
    
    .faq-header i {
      font-size: 1.5rem;
      color: #67e8f9;
    }
    
    .faq-header h3 {
      color: #e2e8f0;
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0;
    }
    
    .faq-close {
      position: absolute;
      top: 0.85rem;
      right: 0.85rem;
      width: 32px;
      height: 32px;
      background: rgba(103, 232, 249, 0.08);
      border: 1px solid rgba(103, 232, 249, 0.15);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.25s ease;
    }
    
    .faq-close:hover {
      background: rgba(251, 113, 133, 0.15);
      border-color: rgba(251, 113, 133, 0.25);
      color: #fb7185;
      transform: rotate(90deg);
    }
    
    .faq-item {
      background: rgba(103, 232, 249, 0.04);
      border: 1px solid rgba(103, 232, 249, 0.08);
      border-radius: 16px;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    
    .faq-item:last-child {
      margin-bottom: 0;
    }
    
    .faq-question {
      color: #67e8f9;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }
    
    .faq-question i {
      font-size: 1rem;
      margin-top: 2px;
    }
    
    .faq-answer {
      color: #94a3b8;
      font-size: 0.78rem;
      line-height: 1.6;
      padding-left: 1.5rem;
    }
    
    .faq-warning {
      background: rgba(251, 113, 133, 0.08);
      border: 1px solid rgba(251, 113, 133, 0.2);
    }
    
    .faq-warning .faq-question {
      color: #fb7185;
    }
    
    .faq-warning .faq-question i {
      color: #fb7185;
    }
    
    .faq-footer {
      margin-top: 1.25rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(103, 232, 249, 0.1);
      text-align: center;
    }
    
    .faq-footer a {
      color: #67e8f9;
      text-decoration: none;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: color 0.2s ease;
    }
    
    .faq-footer a:hover {
      color: #a5f3fc;
    }
    
    /* Copy toast - minimal glass */
    .copy-toast {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: rgba(103, 232, 249, 0.12);
      border: 1px solid rgba(103, 232, 249, 0.25);
      color: #67e8f9;
      padding: 0.6rem 0.9rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 500;
      display: none;
      z-index: 2100;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    
    .copy-toast.show {
      display: block;
      animation: fadeIn 0.2s ease, fadeOut 0.3s linear 2.4s forwards;
    }
    
    @keyframes fadeOut {
      to { opacity: 0; }
    }
    
    /* Disclaimer bar - minimal glass */
    .disclaimer-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1100;
      display: flex;
      align-items: center;
      gap: 0.85rem;
      padding: 0.75rem 1rem;
      background: rgba(15, 23, 42, 0.85);
      border-top: 1px solid rgba(251, 191, 36, 0.2);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      font-size: 0.7rem;
      color: #94a3b8;
      line-height: 1.5;
    }
    
    .disclaimer-bar.hidden { display: none !important; }
    
    .disclaimer-bar b { color: #fbbf24; font-weight: 600; }
    
    .disclaimer-icon {
      flex: 0 0 auto;
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: linear-gradient(135deg, #f59e0b, #d97706);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #fff;
    }
    
    .disclaimer-text { flex: 1; }
    
    .disclaimer-close {
      background: rgba(148, 163, 184, 0.15);
      border: 1px solid rgba(148, 163, 184, 0.2);
      color: #94a3b8;
      width: 30px;
      height: 30px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .disclaimer-close:hover {
      background: rgba(251, 191, 36, 0.2);
      border-color: rgba(251, 191, 36, 0.3);
      color: #fbbf24;
    }
    
    .disclaimer-actions {
      margin-top: 0.4rem;
      display: flex;
      gap: 0.5rem;
    }
    
    .disclaimer-actions a {
      text-decoration: none;
      background: rgba(148, 163, 184, 0.1);
      color: #e2e8f0;
      font-size: 0.65rem;
      padding: 0.35rem 0.6rem;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      border: 1px solid rgba(148, 163, 184, 0.15);
      transition: all 0.2s;
    }
    
    .disclaimer-actions a:hover {
      background: rgba(251, 191, 36, 0.15);
      border-color: rgba(251, 191, 36, 0.25);
      color: #fbbf24;
    }
    
    /* Telegram Banner - Minimal Glass Style */
    .tg-banner {
      display: flex;
      position: fixed;
      bottom: 80px;
      left: 24px;
      right: auto;
      max-width: 420px;
      background: rgba(0, 136, 204, 0.08);
      border: 1px solid rgba(0, 136, 204, 0.15);
      border-radius: 50px;
      padding: 10px 16px 10px 12px;
      text-decoration: none;
      color: white;
      z-index: 1050;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      align-items: center;
      gap: 12px;
      transition: all 0.25s ease;
    }
    
    .tg-banner:hover {
      background: rgba(0, 136, 204, 0.15);
      transform: translateX(4px);
      box-shadow: 0 4px 20px rgba(0, 136, 204, 0.15);
    }
    
    .tg-banner.hidden { display: none !important; }
    
    .tg-banner-icon {
      width: 36px;
      height: 36px;
      flex-shrink: 0;
      background: rgba(0, 136, 204, 0.15);
      border: 1px solid rgba(0, 136, 204, 0.25);
      border-radius: 50%;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .tg-banner-icon svg {
      width: 18px;
      height: 18px;
      fill: #67e8f9;
    }
    
    .tg-banner-text {
      flex: 1;
      min-width: 0;
    }
    
    .tg-banner-title {
      font-weight: 500;
      font-size: 0.75rem;
      display: block;
      color: #a5f3fc;
    }
    
    .tg-banner-desc {
      font-size: 0.65rem;
      color: rgba(148, 163, 184, 0.7);
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .tg-banner-btn {
      background: rgba(0, 136, 204, 0.2);
      border: 1px solid rgba(0, 136, 204, 0.3);
      padding: 6px 14px;
      border-radius: 50px;
      font-size: 0.7rem;
      font-weight: 500;
      color: #67e8f9;
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }
    
    .tg-banner:hover .tg-banner-btn {
      background: rgba(0, 136, 204, 0.3);
      color: #a5f3fc;
    }
    
    .tg-banner-close {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 22px;
      height: 22px;
      background: rgba(100, 116, 139, 0.3);
      color: #94a3b8;
      border: 1px solid rgba(100, 116, 139, 0.3);
      border-radius: 50%;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      backdrop-filter: blur(8px);
    }
    
    .tg-banner-close:hover {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
      border-color: rgba(239, 68, 68, 0.3);
    }
    
    /* Mobile adjustments */
    @media (max-width: 768px) {
      .navbar {
        padding: 0.5rem 0.8rem;
      }
      
      .logo-text {
        font-size: 1rem;
        letter-spacing: 2px;
      }
      
      .nav-actions {
        gap: 0.3rem;
      }
      
      .nav-links {
        display: none;
      }
      
      .nav-actions .nav-btn {
        padding: 6px 10px;
        font-size: 0.75rem;
        gap: 0.3rem;
      }
      
      .nav-actions .nav-btn i {
        font-size: 16px;
      }
      
      .nav-actions .nav-btn span {
        display: none;
      }
      
      .navbar-stats {
        padding: 4px 8px;
        gap: 6px;
      }
      
      .live-users {
        gap: 4px;
      }
      
      .live-breakdown {
        display: none;
      }
      
      .user-nickname {
        display: none !important;
      }
      
      .tg-banner {
        position: fixed;
        top: 50px;
        bottom: auto;
        left: 0;
        right: 0;
        max-width: none;
        padding: 0.5rem 0.8rem;
        border-radius: 0;
        border-left: none;
        border-right: none;
        border-top: none;
        margin: 0;
      }
      
      .tg-banner-icon {
        width: 32px;
        height: 32px;
        padding: 6px;
        border-radius: 8px;
      }
      
      .tg-banner-title {
        font-size: 0.75rem;
      }
      
      .tg-banner-desc {
        display: none;
      }
      
      .tg-banner-btn {
        padding: 0.4rem 0.6rem;
        font-size: 0.65rem;
        border-radius: 8px;
      }
      
      .tg-banner-close {
        display: none !important;
      }
      
      .tg-banner.hidden {
        display: flex !important;
      }
      
      .disclaimer-bar {
        font-size: 0.7rem;
        padding: 0.6rem 0.8rem;
      }
      
      .disclaimer-icon {
        width: 28px;
        height: 28px;
        font-size: 14px;
      }
    }
    
    /* Adjust map container for navbar */
    #map-container {
      padding-top: 55px;
    }
    
    /* On mobile, account for navbar + tg-banner */
    @media (max-width: 768px) {
      #map-container {
        padding-top: 95px;
      }
    }
    
    /* Desktop status-panel position (below navbar) */
    @media screen and (min-width: 769px) {
      .status-panel {
        top: 70px;
      }
    }
    
    /* Maintenance/502 overlay */
    #maintenance-overlay {
      display: none !important;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(10, 14, 23, 0.98) 0%, rgba(26, 26, 46, 0.98) 50%, rgba(22, 33, 62, 0.98) 100%);
      z-index: 99999;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    #maintenance-overlay.show {
      display: flex !important;
    }
    
    .maintenance-content {
      max-width: 450px;
      padding: 30px;
    }
    
    .maintenance-logo {
      font-size: 42px;
      font-weight: 800;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #00d4ff, #7c3aed);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 3px;
    }
    
    .maintenance-subtitle {
      color: rgba(255, 255, 255, 0.5);
      font-size: 12px;
      margin-bottom: 30px;
      letter-spacing: 2px;
    }
    
    .maintenance-message {
      font-size: 20px;
      margin-bottom: 15px;
      line-height: 1.4;
    }
    
    .maintenance-desc {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      margin-bottom: 25px;
      line-height: 1.5;
    }
    
    .maintenance-loader {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 25px;
    }
    
    .maintenance-loader span {
      width: 10px;
      height: 10px;
      background: #00d4ff;
      border-radius: 50%;
      animation: maintenance-pulse 1.4s ease-in-out infinite;
    }
    
    .maintenance-loader span:nth-child(1) { animation-delay: 0s; }
    .maintenance-loader span:nth-child(2) { animation-delay: 0.2s; }
    .maintenance-loader span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes maintenance-pulse {
      0%, 100% { transform: scale(0.8); opacity: 0.5; }
      50% { transform: scale(1.2); opacity: 1; }
    }
    
    .maintenance-timer {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.4);
    }
    
    .maintenance-timer span {
      color: #00d4ff;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <!-- NICKNAME MODAL - Required on first visit -->
  <div id="nicknameModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:999999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(10px);">
    <div style="background:linear-gradient(135deg, #0a0e17 0%, #0d1929 100%);padding:40px;border-radius:20px;border:2px solid rgba(0,212,255,0.3);box-shadow:0 20px 60px rgba(0,212,255,0.2);max-width:450px;width:90%;animation:slideIn 0.3s ease;">
      <div style="text-align:center;margin-bottom:30px;">
        <div style="color:#00d4ff;font-size:48px;font-weight:900;letter-spacing:2px;text-shadow:0 0 20px rgba(0,212,255,0.5);">NEPTUN</div>
        <div style="color:#64748b;font-size:14px;margin-top:8px;">КАРТА ТРИВОГ УКРАЇНИ</div>
      </div>
      
      <div style="margin-bottom:25px;">
        <label style="display:block;color:#94a3b8;font-size:14px;margin-bottom:10px;font-weight:600;">👤 Введіть ваш нік:</label>
        <input 
          id="nicknameInput" 
          type="text" 
          placeholder="Наприклад: Захисник_UA" 
          maxlength="20"
          style="width:100%;padding:15px 20px;background:rgba(15,23,42,0.8);border:2px solid rgba(0,212,255,0.2);border-radius:12px;color:#e2e8f0;font-size:16px;font-weight:500;outline:none;transition:all 0.3s;box-sizing:border-box;"
          onkeypress="if(event.key==='Enter') saveNickname()"
          onfocus="this.style.borderColor='rgba(0,212,255,0.6)'; this.style.boxShadow='0 0 0 3px rgba(0,212,255,0.1)'"
          onblur="this.style.borderColor='rgba(0,212,255,0.2)'; this.style.boxShadow='none'"
        >
        <div id="nicknameError" style="color:#ef4444;font-size:12px;margin-top:8px;display:none;font-weight:500;">⚠️ Нік повинен містити 3-20 символів</div>
      </div>
      
      <button 
        onclick="saveNickname()" 
        style="width:100%;padding:16px;background:linear-gradient(135deg, #00d4ff 0%, #0891b2 100%);border:none;border-radius:12px;color:#0a0e17;font-size:16px;font-weight:700;cursor:pointer;transition:all 0.3s;text-transform:uppercase;letter-spacing:1px;box-shadow:0 4px 15px rgba(0,212,255,0.4);"
        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,212,255,0.6)'"
        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,212,255,0.4)'"
      >
        🚀 Почати користуватися
      </button>
      
      <div style="text-align:center;margin-top:20px;color:#64748b;font-size:12px;">
        🛡️ Ваш нік буде відображатися в списку активних користувачів
      </div>
    </div>
  </div>

  <style>
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    /* Smooth scroll behavior */
    html {
      scroll-behavior: smooth;
    }
    
    #nicknameInput:focus {
      border-color: rgba(0,212,255,0.6) !important;
      box-shadow: 0 0 0 3px rgba(0,212,255,0.1) !important;
    }
  </style>

  <script>
    // Check if nickname exists on page load
    window.addEventListener('DOMContentLoaded', function() {
      const savedNickname = localStorage.getItem('user_nickname');
      if (savedNickname) {
        document.getElementById('nicknameModal').style.display = 'none';
      } else {
        // Focus input after animation
        setTimeout(() => {
          document.getElementById('nicknameInput').focus();
        }, 300);
      }
    });

    function saveNickname() {
      const input = document.getElementById('nicknameInput');
      const error = document.getElementById('nicknameError');
      const nickname = input.value.trim();
      
      if (nickname.length < 3 || nickname.length > 20) {
        error.style.display = 'block';
        input.style.borderColor = '#ef4444';
        input.focus();
        return;
      }
      
      // Save nickname
      localStorage.setItem('user_nickname', nickname);
      localStorage.setItem('nickname_timestamp', Date.now());
      
      // Animate out
      const modal = document.getElementById('nicknameModal');
      modal.style.animation = 'fadeOut 0.3s ease';
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
      
      // Send analytics
      if (window.gtag) {
        gtag('event', 'nickname_set', {
          'event_category': 'user_engagement',
          'event_label': 'nickname_length_' + nickname.length
        });
      }
      
      console.log('👤 Нік збережено:', nickname);
      
      // Update navbar display
      displayNicknameInNavbar();
    }

    // Display nickname in navbar (both left and right)
    function displayNicknameInNavbar() {
      const nickname = localStorage.getItem('user_nickname');
      if (nickname) {
        // Left side (in stats block)
        const displayElement = document.getElementById('userNicknameDisplay');
        const nicknameText = document.getElementById('navbarNickname');
        if (displayElement && nicknameText) {
          nicknameText.textContent = nickname;
          displayElement.style.display = 'flex';
          displayElement.style.alignItems = 'center';
        }
        
        // Right side (near FAQ button)
        const displayElementRight = document.getElementById('userNicknameDisplayRight');
        const nicknameTextRight = document.getElementById('navbarNicknameRight');
        if (displayElementRight && nicknameTextRight) {
          nicknameTextRight.textContent = nickname;
          displayElementRight.style.display = 'flex';
          displayElementRight.style.alignItems = 'center';
        }
      }
    }

    // Call on page load
    document.addEventListener('DOMContentLoaded', displayNicknameInNavbar);
    // Also call after saving nickname
    window.addEventListener('storage', displayNicknameInNavbar);

    // Add fadeOut animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeOut {
        from { opacity: 1; transform: scale(1); }
        to { opacity: 0; transform: scale(0.95); }
      }
    `;
    document.head.appendChild(style);
  </script>

  <!-- MAINTENANCE OVERLAY for 502 errors -->
  <div id="maintenance-overlay">
    <div class="maintenance-content">
      <div class="maintenance-logo">NEPTUN</div>
      <div class="maintenance-subtitle">КАРТА ТРИВОГ УКРАЇНИ</div>
      <div class="maintenance-message">🔄 Зачекайте, вносимо зміни</div>
      <div class="maintenance-desc">Сервер оновлюється. Сторінка автоматично перезавантажиться через кілька секунд.</div>
      <div class="maintenance-loader">
        <span></span>
        <span></span>
        <span></span>
      </div>
      <div class="maintenance-timer">Автоматичне оновлення через <span id="maintenance-timer">10</span> сек.</div>
    </div>
  </div>
  
  <!-- SEO CONTENT - Visible to search engines -->
  <article id="seo-content" style="position:absolute;left:0;top:60px;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;">
    <h1>Карта тривог України в реальному часі — повітряна тривога онлайн</h1>
    <h2>Карта тривог NEPTUN — відстежуйте повітряні тривоги по всій Україні</h2>
    <p>NEPTUN — найточніша карта тривог України онлайн. Відстежуйте повітряні тривоги, шахеди та ракети в реальному часі на інтерактивній мапі тривог. Карта тривог оновлюється автоматично 24/7.</p>
    
    <h3>Карта тривог України — можливості:</h3>
    <ul>
      <li>Карта тривог онлайн — всі області та райони України</li>
      <li>Карта тривог в реальному часі — миттєве оновлення даних</li>
      <li>Мапа тривог з радаром шахедів та ракет</li>
      <li>Push-сповіщення про тривоги у вашому регіоні</li>
      <li>Мобільний додаток карти тривог для Android</li>
      <li>Історія тривог та аналітика по регіонах</li>
    </ul>
    
    <h3>Де подивитися карту тривог?</h3>
    <p>Карта тривог NEPTUN доступна на сайті neptun.in.ua. Це безкоштовна інтерактивна карта тривог України з відстеженням шахедів, дронів та ракет в реальному часі.</p>
    
    <h3>Карта тривог по областях України</h3>
    <p>Карта тривог охоплює всі 25 областей: Київська, Харківська, Одеська, Дніпропетровська, Запорізька, Львівська, Вінницька, Полтавська, Чернігівська, Сумська, Миколаївська, Херсонська, Житомирська, Рівненська, Волинська, Чернівецька, Закарпатська, Івано-Франківська, Тернопільська, Хмельницька, Черкаська, Кіровоградська та інші.</p>
    
    <h3>Додаток карти тривог NEPTUN</h3>
    <p>Завантажте мобільний додаток карти тривог NEPTUN з Google Play. Отримуйте миттєві push-сповіщення про повітряні тривоги у вашому регіоні.</p>
    
    <h3>Як працює карта тривог?</h3>
    <p>Карта тривог NEPTUN збирає інформацію з офіційних джерел та відображає її на інтерактивній мапі. Ви можете бачити активні повітряні тривоги, напрямок руху шахедів та ракет, а також історію попередніх атак.</p>
    
    <p>Карта тривог NEPTUN — ваш надійний помічник для безпеки. Слідкуйте за повітряними тривогами онлайн 24/7.</p>
  </article>
  
  <!-- NAVBAR -->
  <div class="navbar">
    <div class="logo">
      <span class="logo-text">NEPTUN</span>
      <!-- Combined stats block -->
      <div class="navbar-stats">
        <div class="live-users" id="liveUsers" title="Активні користувачі онлайн">
          <span class="live-label">онлайн</span>
          <span class="live-count" data-role="live-total">0</span>
          <span class="live-breakdown">
            <span class="live-chip">🌐<strong data-role="live-web">0</strong></span>
            <span class="live-chip">📱<strong data-role="live-apps">0</strong></span>
          </span>
        </div>
        <div id="userNicknameDisplay" class="user-nickname">
          <span class="nickname-icon">👤</span>
          <span id="navbarNickname"></span>
        </div>
      </div>
    </div>
    <div class="nav-actions">
      <div id="userNicknameDisplayRight" class="user-nickname-right">
        <span class="nickname-icon">👤</span>
        <span id="navbarNicknameRight"></span>
      </div>
      <button class="nav-btn faq-btn" onclick="toggleFAQ()" title="FAQ та правила">
        <i class="material-icons">help_outline</i>
        <span>FAQ</span>
      </button>
      <a href="https://play.google.com/store/apps/details?id=com.neptunalarm.neptun_alarm_app" target="_blank" class="nav-btn app-link"><i class="material-icons">android</i> Додаток</a>
      <button class="nav-btn support-btn" onclick="toggleDonate()" title="Підтримати проєкт">
        <i class="material-icons">favorite</i>
        <span>Підтримати</span>
      </button>
    </div>
  </div>
  
  <!-- Donate Modal -->
  <div class="donate-modal-overlay" id="donateModal">
    <div class="donate-modal">
      <button class="donate-close" onclick="toggleDonate(false)">×</button>
      <h3 class="donate-title"><i class="material-icons" style="font-size:24px;">favorite</i> Підтримати NEPTUN</h3>
      <p class="donate-sub">Ваша допомога дозволяє нам розвивати карту та робити її ще кращою для всіх українців.</p>
      <div class="donate-grid">
        <div class="donate-card">
          <div class="donate-label">Моно (UAH)</div>
          <div class="donate-value">4441 1111 2110 7290</div>
          <div class="donate-actions">
            <button class="btn-mini" onclick="copyDonate('4441111121107290')"><i class="material-icons" style="font-size:14px;">content_copy</i> Копіювати</button>
          </div>
        </div>
        <div class="donate-card">
          <div class="donate-label">Приват (UAH)</div>
          <div class="donate-value">5168 7451 5313 3886</div>
          <div class="donate-actions">
            <button class="btn-mini" onclick="copyDonate('5168745153133886')"><i class="material-icons" style="font-size:14px;">content_copy</i> Копіювати</button>
          </div>
        </div>
        <div class="donate-card">
          <div class="donate-label">Monobank Банка</div>
          <div class="donate-value" style="font-size:0.8rem;">send.monobank.ua/jar/6Vi9TVzJZQ</div>
          <div class="donate-actions">
            <button class="btn-mini" onclick="openJar()"><i class="material-icons" style="font-size:14px;">open_in_new</i> Відкрити</button>
            <button class="btn-mini alt" onclick="copyDonate('https://send.monobank.ua/jar/6Vi9TVzJZQ')"><i class="material-icons" style="font-size:14px;">content_copy</i></button>
          </div>
        </div>
      </div>
      <button class="jar-link-button" onclick="openJar()"><i class="material-icons">rocket_launch</i> Задонатити зараз</button>
      <div class="donate-footer">Дякуємо за підтримку! 💙💛</div>
    </div>
  </div>
  <div class="copy-toast" id="copyToast">✓ Скопійовано</div>
  
  <!-- FAQ Modal -->
  <div class="faq-modal-overlay" id="faqModal">
    <div class="faq-modal">
      <button class="faq-close" onclick="toggleFAQ(false)">×</button>
      <div class="faq-header">
        <i class="material-icons">help_outline</i>
        <h3>FAQ та правила використання</h3>
      </div>
      
      <div class="faq-item">
        <div class="faq-question">
          <i class="material-icons">map</i>
          Що таке NEPTUN?
        </div>
        <div class="faq-answer">
          NEPTUN — це інтерактивна карта тривог України, яка автоматично збирає дані з відкритих джерел (офіційні телеграм-канали ОВА та інші) та візуалізує їх у реальному часі.
        </div>
      </div>
      
      <div class="faq-item">
        <div class="faq-question">
          <i class="material-icons">verified</i>
          Чи є карта офіційною?
        </div>
        <div class="faq-answer">
          Ні, NEPTUN не є офіційною системою оповіщення. Ми агрегуємо дані з публічних джерел для зручного відображення. Для офіційної інформації використовуйте державні ресурси та додаток "Повітряна тривога".
        </div>
      </div>
      
      <div class="faq-item">
        <div class="faq-question">
          <i class="material-icons">schedule</i>
          Як швидко оновлюються дані?
        </div>
        <div class="faq-answer">
          Дані оновлюються автоматично кожні кілька секунд. Затримка залежить від швидкості публікації інформації в джерелах, які ми моніторимо.
        </div>
      </div>
      
      <div class="faq-item">
        <div class="faq-question">
          <i class="material-icons">smartphone</i>
          Чи є мобільний додаток?
        </div>
        <div class="faq-answer">
          Так! Ви можете завантажити офіційний Android-додаток NEPTUN з Google Play. Додаток для iOS наразі в розробці.
        </div>
      </div>
      
      <div class="faq-item faq-warning">
        <div class="faq-question">
          <i class="material-icons">block</i>
          Що заборонено?
        </div>
        <div class="faq-answer">
          <strong>⛔ Категорично заборонено використовувати карту для переливання аудиторії на власні телеграм-канали чи інші ресурси.</strong><br><br>
          Порушники будуть заблоковані без попередження. Комерційне використання потребує окремої домовленості — зверніться до нас через кнопку "Комерційне використання".
        </div>
      </div>
      
      <div class="faq-item">
        <div class="faq-question">
          <i class="material-icons">business</i>
          Як використовувати карту для бізнесу?
        </div>
        <div class="faq-answer">
          Для комерційного використання (вбудовування на сайт, інтеграція в додатки, використання API) натисніть кнопку "Комерційне використання" в нижньому меню та заповніть заявку.
        </div>
      </div>
      
      <div class="faq-item">
        <div class="faq-question">
          <i class="material-icons">favorite</i>
          Як підтримати проєкт?
        </div>
        <div class="faq-answer">
          Ви можете підтримати нас фінансово через кнопку "Підтримати" у верхньому меню. Також допомагає поширення карти серед знайомих та позитивні відгуки в Google Play.
        </div>
      </div>
      
      <div class="faq-footer">
        <a href="https://t.me/+aBR79kExNQM1ZjZi" target="_blank">
          <i class="material-icons" style="font-size: 16px;">telegram</i>
          Зв'язатися з нами в Telegram
        </a>
      </div>
    </div>
  </div>
  
  <!-- Telegram Banner -->
  <a href="https://t.me/+aBR79kExNQM1ZjZi" target="_blank" class="tg-banner" id="tgBanner">
    <svg class="tg-banner-icon" viewBox="0 0 48 48" fill="white">
      <path d="M41.42 7.31L3.92 22.27c-2.56 1.03-2.55 2.46-.47 3.1l9.62 3 3.72 11.42c.45 1.25.23 1.75 1.52 1.75.99 0 1.43-.45 1.98-1l3.94-3.83 8.2 6.05c1.51.83 2.6.4 2.98-1.4l5.4-25.44c.55-2.2-.84-3.2-2.39-2.61z"/>
    </svg>
    <div class="tg-banner-text">
      <span class="tg-banner-title">📢 Пряме інформування від хлопців в телеграм</span>
      <span class="tg-banner-desc">⚡ Більше інформації • 💬 Пряме спілкування з адміном</span>
    </div>
    <div class="tg-banner-btn">
      <span>Підписатися</span>
      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
      </svg>
    </div>
  </a>
  
  <!-- Disclaimer Bar -->
  <div id="disclaimerBar" class="disclaimer-bar" style="display:none;">
    <div class="disclaimer-icon">!</div>
    <div class="disclaimer-text">
      <div><b>УВАГА:</b> Дані формуються автоматично з відкритих джерел (Telegram тощо) та можуть містити похибки. Сервіс <b>не є</b> офіційною системою оповіщення.</div>
      <div class="disclaimer-actions">
        <a href="#about"><span class="material-icons" style="font-size:13px;">info</span> Докладніше</a>
        <a href="https://t.me/+zFxu_4W_ishiNjli" target="_blank"><span class="material-icons" style="font-size:13px;">group</span> Спільнота</a>
      </div>
    </div>
    <button class="disclaimer-close" onclick="hideDisclaimer()">×</button>
  </div>
  
  <div id="map-container">
    <div id="map-wrapper">
      <div class="svg-container" id="svg-container">
        <!-- States SVG will be loaded here -->
        <div id="states-layer"></div>
        <!-- Districts SVG will be loaded here -->
        <div id="districts-layer"></div>
        <!-- Names SVG will be loaded here -->
        <div id="names-layer"></div>
        <!-- Trajectory lines layer -->
        <div id="trajectories-layer"></div>
        <!-- Threat markers layer -->
        <div id="markers-layer"></div>
      </div>
    </div>
  </div>
  
  <!-- Floating Buttons Container -->
  <div class="floating-buttons">
    <button onclick="document.getElementById('commercialModal').style.display='flex'" class="floating-btn commercial-btn" title="Комерційне використання">
      <i class="material-icons">live_tv</i>
      <span class="btn-text">Для стрімерів</span>
    </button>
    <button class="floating-btn map-btn" onclick="window.location.href='/map-old?from=index'" title="Перемкнути на стару карту">
      <i class="material-icons">map</i>
      <span class="btn-text">Стара карта</span>
    </button>
  </div>


  <script>
    // ===== CONFIG =====
    const ALARM_UPDATE_INTERVAL = 30000; // 30 seconds (was 5s - reduced to save bandwidth)
    const MARKERS_UPDATE_INTERVAL = 30000; // 30 seconds (was 10s - reduced to save bandwidth)
    const MAX_RETRIES = 3;
    
    // timeRange is controlled by server (MONITOR_PERIOD_MINUTES in admin)
    const urlParams = new URLSearchParams(window.location.search);
    
    // SVG map bounds (Ukraine approximate bounds)
    const MAP_BOUNDS = {
      minLat: 44.2,
      maxLat: 52.4,
      minLng: 22.0,
      maxLng: 40.2
    };
    
    let currentScale = 1;
    let currentX = 0;
    let currentY = 0;
    let isDragging = false;
    let startX, startY;
    let lastSuccessfulFetch = null;
    let consecutiveFailures = 0;
    let activeTooltip = null;
    let maintenanceCountdown = 10;
    let maintenanceShowing = false;
    
    // Show maintenance overlay for 502/503 errors
    function showMaintenanceOverlay() {
      if (maintenanceShowing) return;
      maintenanceShowing = true;
      
      const overlay = document.getElementById('maintenance-overlay');
      const timerEl = document.getElementById('maintenance-timer');
      overlay.classList.add('show');
      
      maintenanceCountdown = 60;
      timerEl.textContent = maintenanceCountdown;
      
      const interval = setInterval(() => {
        maintenanceCountdown--;
        timerEl.textContent = maintenanceCountdown;
        
        if (maintenanceCountdown <= 0) {
          clearInterval(interval);
          window.location.reload();
        }
      }, 1000);
      
      // Also try to check if server is back every 3 seconds
      const checkInterval = setInterval(async () => {
        try {
          const response = await fetch('/api/alarms', { cache: 'no-cache' });
          if (response.ok) {
            clearInterval(checkInterval);
            clearInterval(interval);
            overlay.classList.remove('show');
            maintenanceShowing = false;
            fetchAlarms(); // Reload data
          }
        } catch (e) {
          // Still down, keep waiting
        }
      }, 3000);
    }
    
    // Hide maintenance overlay
    function hideMaintenanceOverlay() {
      const overlay = document.getElementById('maintenance-overlay');
      overlay.classList.remove('show');
      maintenanceShowing = false;
    }
    
    // Android detection for performance optimizations
    const isAndroid = /Android/i.test(navigator.userAgent);
    if (isAndroid) {
      document.body.classList.add('android-device');
      console.log('Android detected - applying performance optimizations');
    }
    
    // Icon mapping for threat types
    const THREAT_ICONS = {
      'shahed': 'icon_drone.svg',
      'raketa': 'raketa.png',
      'avia': 'avia.png',
      'artillery': 'artillery.png',
      'obstril': 'obstril.png',
      'fpv': 'fpv.png',
      'pusk': 'pusk.png',
      'kab': 'rszv.png',
      'rszv': 'rszv.png',
      'rozved': 'rozved.png',
      'vibuh': 'vibuh.png',
      'alarm': 'trivoga.png',
      'alarm_cancel': 'vidboi.png',
      'default': 'default.png'
    };
    
    // Threat type names for display
    const THREAT_NAMES = {
      'shahed': '🛩️ Шахеди/БПЛА',
      'raketa': '🚀 Ракети',
      'avia': '✈️ Авіація',
      'artillery': '💥 Артилерія',
      'obstril': '💥 Обстріл',
      'fpv': '🎯 FPV дрони',
      'pusk': '🚀 Пуски',
      'kab': '💣 КАБи',
      'rszv': '💣 РСЗВ',
      'rozved': '🔍 Розвідники',
      'vibuh': '💥 Вибухи',
      'alarm': '🚨 Тривога',
      'alarm_cancel': '✅ Відбій'
    };
    
    // District ID to State ID mapping (for counting oblasts with alarms)
    const DISTRICT_TO_STATE = {
      // Чернігівська область (State ID: 25)
      '140': '25', '141': '25', '142': '25', '143': '25', '144': '25',
      // Донецька область (State ID: 8)
      '49': '8', '50': '8', '51': '8', '52': '8', '53': '8', '54': '8', '55': '8', '56': '8',
      // Запорізька область (State ID: 10)
      '145': '10', '146': '10', '147': '10', '148': '10', '149': '10',
      // Луганська область (State ID: 16)
      '89': '16', '90': '16', '91': '16', '92': '16',
      // Харківська область (State ID: 22)
      '125': '22', '126': '22', '127': '22', '128': '22', '129': '22', '130': '22', '131': '22',
      // Дніпропетровська область (State ID: 7)
      '44': '7', '45': '7', '46': '7', '47': '7', '48': '7',
      // Херсонська область (State ID: 23)
      '132': '23', '133': '23', '134': '23', '135': '23', '136': '23',
      // Миколаївська область (State ID: 17)
      '93': '17', '94': '17', '95': '17', '96': '17',
      // Одеська область (State ID: 18)
      '97': '18', '98': '18', '99': '18', '100': '18', '101': '18', '102': '18', '103': '18',
      // Сумська область (State ID: 21)
      '118': '21', '119': '21', '120': '21', '121': '21', '122': '21', '123': '21',
      // Київська область (State ID: 14)
      '77': '14', '78': '14', '79': '14', '80': '14', '81': '14', '82': '14',
      // Полтавська область (State ID: 19)
      '104': '19', '105': '19', '106': '19', '107': '19',
      // Вінницька область (State ID: 2)
      '27': '2', '28': '2', '29': '2', '30': '2', '31': '2', '32': '2',
      // Черкаська область (State ID: 24)
      '137': '24', '138': '24', '139': '24',
      // Кіровоградська область (State ID: 15)
      '83': '15', '84': '15', '85': '15', '86': '15',
      // Житомирська область (State ID: 9)
      '57': '9', '58': '9', '59': '9', '60': '9',
      // Хмельницька область (State ID: 4)
      '33': '4', '34': '4', '35': '4', '36': '4',
      // Рівненська область (State ID: 20)
      '108': '20', '109': '20', '110': '20', '111': '20',
      // Волинська область (State ID: 3)
      '37': '3', '38': '3', '39': '3', '40': '3',
      // Львівська область (State ID: 5)
      '61': '5', '62': '5', '63': '5', '64': '5', '65': '5', '66': '5', '67': '5',
      // Івано-Франківська область (State ID: 11)
      '68': '11', '69': '11', '70': '11', '71': '11', '72': '11', '73': '11',
      // Тернопільська область (State ID: 6)
      '41': '6', '42': '6', '43': '6',
      // Закарпатська область (State ID: 12)
      '74': '12', '75': '12', '76': '12', '124': '12',
      // Чернівецька область (State ID: 26)
      '150': '26', '151': '26', '152': '26',
      // м. Київ (State ID: 13)
      '87': '13', '88': '13',
      // Крим (State ID: 9999)
      '112': '9999', '113': '9999', '114': '9999', '115': '9999', '116': '9999', '117': '9999'
    };
    
    // Cache buster version - change this to force reload SVG files
    const CACHE_VERSION = 'v4';
    
    // Load both SVG maps
    async function loadMaps() {
      try {
        // Load states (oblasts) SVG
        const statesResponse = await fetch(`/static/ukraine_states.svg?${CACHE_VERSION}`);
        const statesText = await statesResponse.text();
        document.getElementById('states-layer').innerHTML = statesText;
        
        // Load districts SVG
        const districtsResponse = await fetch(`/static/ukraine_districts_detailed.svg?${CACHE_VERSION}`);
        const districtsText = await districtsResponse.text();
        document.getElementById('districts-layer').innerHTML = districtsText;
        
        // Load names SVG (with neptun.in.ua branding)
        const namesResponse = await fetch(`/static/ukraine_names.svg?${CACHE_VERSION}`);
        const namesText = await namesResponse.text();
        document.getElementById('names-layer').innerHTML = namesText;
        
        // Hide all icons initially
        document.querySelectorAll('#names-layer .reasonIcon').forEach(icon => {
          icon.style.display = 'none';
        });
        
        // Setup drag functionality
        setupDrag();
        
        // Fetch alarms immediately
        await fetchAlarms();
        
        // Fetch threat markers immediately
        await fetchThreatMarkers();
        
        // Update alarms every 5 seconds
        setInterval(fetchAlarms, ALARM_UPDATE_INTERVAL);
        
        // Update threat markers every 10 seconds
        setInterval(fetchThreatMarkers, MARKERS_UPDATE_INTERVAL);
        
        console.log('Maps loaded successfully');
      } catch (error) {
        console.error('Error loading maps:', error);
      }
    }
    
    // Fetch alarms from ukrainealarm API via proxy with retry
    async function fetchAlarms(retryCount = 0) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 8000);
        
        const response = await fetch('/api/alarms/all', {
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        
        // Check if we got actual data
        if (!Array.isArray(data)) {
          throw new Error('Invalid data format');
        }
        
        // Success - reset failures counter and hide maintenance overlay
        consecutiveFailures = 0;
        lastSuccessfulFetch = new Date();
        hideMaintenanceOverlay();
        
        // Clear ALL existing alarms
        document.querySelectorAll('.alarm').forEach(el => {
          el.classList.remove('alarm');
        });
        
        // Hide all icons
        document.querySelectorAll('#names-layer .reasonIcon').forEach(icon => {
          icon.style.display = 'none';
        });
        
        // Track alarm counts
        let districtAlarmCount = 0;
        const statesWithAlarm = new Set(); // Track unique states with alarm
        
        // Track threat types per state
        const stateThreatTypes = {};
        
        // Process each alert
        data.forEach(region => {
          if (region.activeAlerts && region.activeAlerts.length > 0) {
            const regionId = region.regionId;
            const regionType = region.regionType;
            
            // Determine threat type from alerts
            region.activeAlerts.forEach(alert => {
              const alertType = alert.type || 'UNKNOWN';
              let stateId = regionId;
              
              // If it's a district, find parent state
              if (regionType === 'District') {
                stateId = DISTRICT_TO_STATE[regionId] || regionId;
              }
              
              // Store threat type for this state
              if (!stateThreatTypes[stateId]) {
                stateThreatTypes[stateId] = new Set();
              }
              stateThreatTypes[stateId].add(alertType);
            });
            
            if (regionType === 'State') {
              // Color the oblast
              const stateElements = document.querySelectorAll(`#states-layer [id="${regionId}"]`);
              stateElements.forEach(el => {
                el.classList.add('alarm');
              });
              statesWithAlarm.add(regionId);
              
              // Show drone icon for this state if applicable
              showThreatIcons(regionId, region.activeAlerts);
            } else if (regionType === 'District') {
              // Color ONLY the specific district
              const districtElements = document.querySelectorAll(`#districts-layer [id="${regionId}"]`);
              districtElements.forEach(el => {
                el.classList.add('alarm');
              });
              districtAlarmCount++;
              
              // Track the parent state (for counting) but do NOT color it
              const parentStateId = DISTRICT_TO_STATE[regionId];
              if (parentStateId) {
                statesWithAlarm.add(parentStateId);
              }
            }
          }
        });
        
        // Update status panel - show unique STATES count (oblasts with any alarm)
        const stateAlarmCount = statesWithAlarm.size;
        const countEl = document.getElementById('alarm-count');
        countEl.textContent = stateAlarmCount;
        countEl.className = stateAlarmCount > 0 ? 'alarm-count' : 'alarm-count safe';
        
        const now = new Date();
        const updateEl = document.getElementById('last-update');
        updateEl.textContent = `Оновлено: ${now.toLocaleTimeString('uk-UA')}`;
        updateEl.className = 'last-update';
        
        document.getElementById('api-status').textContent = '';
        
        console.log(`Alarms: ${stateAlarmCount} oblasts (${Array.from(statesWithAlarm).join(',')}), ${districtAlarmCount} districts`);
        
      } catch (error) {
        consecutiveFailures++;
        console.error(`Error fetching alarms (attempt ${retryCount + 1}):`, error);
        
        // Check for 502/503 errors - show maintenance overlay
        const errorMsg = error.message || '';
        if (errorMsg.includes('502') || errorMsg.includes('503') || errorMsg.includes('504') || consecutiveFailures >= 5) {
          showMaintenanceOverlay();
          return;
        }
        
        // Retry up to MAX_RETRIES times
        if (retryCount < MAX_RETRIES - 1) {
          console.log(`Retrying in ${(retryCount + 1) * 500}ms...`);
          setTimeout(() => fetchAlarms(retryCount + 1), (retryCount + 1) * 500);
          return;
        }
        
        // All retries failed - show warning
        const updateEl = document.getElementById('last-update');
        const statusEl = document.getElementById('api-status');
        
        if (lastSuccessfulFetch) {
          const secondsAgo = Math.round((new Date() - lastSuccessfulFetch) / 1000);
          updateEl.textContent = `Дані: ${secondsAgo}с тому`;
          updateEl.className = 'last-update stale';
        } else {
          updateEl.textContent = 'Не вдалося завантажити';
          updateEl.className = 'last-update error';
          statusEl.textContent = '❌ API недоступний';
          
          // Show maintenance overlay if no data at all
          showMaintenanceOverlay();
        }
      }
    }
    
    // Show threat icons based on alert type
    function showThreatIcons(stateId, alerts) {
      alerts.forEach(alert => {
        const alertType = alert.type || '';
        
        // Determine which icon to show
        // AIR = general air alarm, DRONES = shaheds, ARTILLERY = shelling, etc.
        if (alertType === 'DRONES' || alertType.includes('DRONE')) {
          const droneIcon = document.getElementById(`droneIcon_${stateId}`);
          if (droneIcon) {
            droneIcon.style.display = 'block';
          }
        }
        
        // You can add more icon types here:
        // if (alertType === 'BALLISTIC' || alertType === 'MISSILE') { ... }
      });
    }
    
    // Convert lat/lng to SVG percentage coordinates
    function latLngToSvgPercent(lat, lng) {
      // Ukraine bounds for SVG mapping
      const x = ((lng - MAP_BOUNDS.minLng) / (MAP_BOUNDS.maxLng - MAP_BOUNDS.minLng)) * 100;
      const y = ((MAP_BOUNDS.maxLat - lat) / (MAP_BOUNDS.maxLat - MAP_BOUNDS.minLat)) * 100;
      return { x: Math.max(0, Math.min(100, x)), y: Math.max(0, Math.min(100, y)) };
    }
    
    // Fetch threat markers from /data endpoint
    async function fetchThreatMarkers() {
      try {
        // Don't pass timeRange - server uses MONITOR_PERIOD_MINUTES from admin
        const response = await fetch('/data');
        if (!response.ok) return;
        
        const data = await response.json();
        const markersLayer = document.getElementById('markers-layer');
        
        // Clear existing markers
        markersLayer.innerHTML = '';
        
        // Track marker counts by type
        const markerCounts = {};
        
        // Process markers
        const markers = data.tracks || data.items || data || [];
        
        if (!Array.isArray(markers)) {
          console.log('No markers array found');
          return;
        }
        
        markers.forEach((marker, index) => {
          const lat = parseFloat(marker.lat);
          const lng = parseFloat(marker.lng);
          
          // Skip markers without valid coordinates
          if (isNaN(lat) || isNaN(lng)) return;
          
          // Skip if outside Ukraine bounds
          if (lat < MAP_BOUNDS.minLat || lat > MAP_BOUNDS.maxLat ||
              lng < MAP_BOUNDS.minLng || lng > MAP_BOUNDS.maxLng) return;
          
          // Get threat type and icon
          const threatType = marker.threat_type || 'default';
          const iconFile = marker.marker_icon || THREAT_ICONS[threatType] || 'default.png';
          
          // Count markers by type
          markerCounts[threatType] = (markerCounts[threatType] || 0) + 1;
          
          // Convert to SVG coordinates
          const pos = latLngToSvgPercent(lat, lng);
          
          // Create marker element
          const markerEl = document.createElement('div');
          markerEl.className = 'threat-marker';
          markerEl.style.left = `${pos.x}%`;
          markerEl.style.top = `${pos.y}%`;
          markerEl.dataset.type = threatType;
          markerEl.dataset.place = marker.place || '';
          markerEl.dataset.text = marker.text || '';
          markerEl.dataset.date = marker.date || '';
          
          const img = document.createElement('img');
          img.src = `/static/${iconFile}`;
          img.alt = threatType;
          img.onerror = function() {
            this.src = '/static/default.png';
          };
          
          markerEl.appendChild(img);
          
          // Add count badge for shahed/drone markers with count > 1
          const isShahed = threatType === 'shahed' || /shahed|шахед|бпла/i.test(threatType);
          if (isShahed && marker.count && marker.count > 1) {
            const badge = document.createElement('div');
            badge.className = 'marker-count-badge';
            badge.textContent = `${marker.count}×`;
            markerEl.appendChild(badge);
          }
          
          // Add tooltip on hover
          markerEl.addEventListener('mouseenter', (e) => showMarkerTooltip(e, marker, threatType));
          markerEl.addEventListener('mouseleave', hideMarkerTooltip);
          
          markersLayer.appendChild(markerEl);
        });
        
        // Render trajectory lines
        renderTrajectories(markers);
        
        // Update markers summary
        updateMarkersSummary(markerCounts);
        
        console.log(`Loaded ${markers.length} threat markers`);
        
      } catch (error) {
        console.error('Error fetching threat markers:', error);
      }
    }
    
    // Render trajectory lines from markers with trajectory data
    function renderTrajectories(markers) {
      const trajLayer = document.getElementById('trajectories-layer');
      if (!trajLayer) {
        console.log('trajectories-layer not found');
        return;
      }
      
      // Clear existing trajectories
      trajLayer.innerHTML = '';
      
      let trajCount = 0;
      markers.forEach(marker => {
        const traj = marker.trajectory;
        if (!traj || !traj.start || !traj.end) return;
        
        trajCount++;
        console.log('Drawing trajectory:', traj);
        
        const startLat = parseFloat(traj.start[0]);
        const startLng = parseFloat(traj.start[1]);
        const endLat = parseFloat(traj.end[0]);
        const endLng = parseFloat(traj.end[1]);
        
        if (isNaN(startLat) || isNaN(startLng) || isNaN(endLat) || isNaN(endLng)) return;
        
        // Convert to SVG percent coordinates
        const startPos = latLngToSvgPercent(startLat, startLng);
        const endPos = latLngToSvgPercent(endLat, endLng);
        
        // Create SVG line
        const svgNS = 'http://www.w3.org/2000/svg';
        const svg = document.createElementNS(svgNS, 'svg');
        svg.setAttribute('class', 'trajectory-svg');
        svg.style.position = 'absolute';
        svg.style.top = '0';
        svg.style.left = '0';
        svg.style.width = '100%';
        svg.style.height = '100%';
        svg.style.overflow = 'visible';
        svg.style.pointerEvents = 'none';
        
        const line = document.createElementNS(svgNS, 'line');
        line.setAttribute('x1', `${startPos.x}%`);
        line.setAttribute('y1', `${startPos.y}%`);
        line.setAttribute('x2', `${endPos.x}%`);
        line.setAttribute('y2', `${endPos.y}%`);
        line.setAttribute('stroke', '#f97316');
        line.setAttribute('stroke-width', '2');
        line.setAttribute('stroke-dasharray', '6 3');
        line.setAttribute('stroke-linecap', 'round');
        line.style.filter = 'drop-shadow(0 0 4px rgba(249, 115, 22, 0.6))';
        
        svg.appendChild(line);
        trajLayer.appendChild(svg);
        
        // Add arrow at end point
        const angle = Math.atan2(endPos.y - startPos.y, endPos.x - startPos.x) * 180 / Math.PI;
        const arrow = document.createElement('div');
        arrow.className = 'trajectory-arrow';
        arrow.style.left = `${endPos.x}%`;
        arrow.style.top = `${endPos.y}%`;
        arrow.style.transform = `translate(-50%, -50%) rotate(${angle + 90}deg)`;
        arrow.innerHTML = '▲';
        trajLayer.appendChild(arrow);
      });
      
      const trajRendered = trajLayer.querySelectorAll('.trajectory-svg').length;
      console.log(`Trajectories: found ${trajCount} in data, rendered ${trajRendered} lines`);
    }
    
    // Show tooltip for marker
    function showMarkerTooltip(event, marker, threatType) {
      hideMarkerTooltip();
      
      const tooltip = document.createElement('div');
      tooltip.className = 'marker-tooltip';
      tooltip.id = 'active-tooltip';
      
      const typeName = THREAT_NAMES[threatType] || threatType;
      const place = marker.place || 'Невідомо';
      const date = marker.date || '';
      
      tooltip.innerHTML = `
        <div class="tooltip-type">${typeName}</div>
        <div class="tooltip-place">${place}</div>
        ${date ? `<div class="tooltip-time">${date}</div>` : ''}
      `;
      
      document.body.appendChild(tooltip);
      
      // Position tooltip near cursor
      const rect = tooltip.getBoundingClientRect();
      let x = event.clientX + 15;
      let y = event.clientY + 15;
      
      // Keep tooltip in viewport
      if (x + rect.width > window.innerWidth) {
        x = event.clientX - rect.width - 15;
      }
      if (y + rect.height > window.innerHeight) {
        y = event.clientY - rect.height - 15;
      }
      
      tooltip.style.left = `${x}px`;
      tooltip.style.top = `${y}px`;
    }
    
    // Hide tooltip
    function hideMarkerTooltip() {
      const tooltip = document.getElementById('active-tooltip');
      if (tooltip) {
        tooltip.remove();
      }
    }
    
    // Update markers summary in status panel
    function updateMarkersSummary(counts) {
      const container = document.getElementById('markers-info');
      const summary = document.getElementById('markers-summary');
      
      const totalMarkers = Object.values(counts).reduce((a, b) => a + b, 0);
      
      if (totalMarkers === 0) {
        container.style.display = 'none';
        return;
      }
      
      container.style.display = 'block';
      
      // Sort by count descending
      const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
      
      let html = '';
      sorted.forEach(([type, count]) => {
        const iconFile = THREAT_ICONS[type] || 'default.png';
        const typeName = THREAT_NAMES[type] || type;
        html += `
          <div class="marker-type-count">
            <img src="/static/${iconFile}" alt="${type}">
            <span>${typeName}: ${count}</span>
          </div>
        `;
      });
      
      summary.innerHTML = html;
    }
    
    // Zoom functions
    const BASE_WIDTH = window.innerWidth * 0.9;
    const ASPECT_RATIO = 260 / 175;
    let containerWidth = Math.min(BASE_WIDTH, 1400);
    let containerHeight = containerWidth / ASPECT_RATIO;
    let offsetX = 0;
    let offsetY = 0;
    
    function zoomIn() {
      currentScale = Math.min(currentScale * 1.3, 5);
      updateZoom(true);
    }
    
    function zoomOut() {
      // Minimum scale 1.0 to prevent blurriness on small screens
      currentScale = Math.max(currentScale / 1.3, 1.0);
      updateZoom(true);
    }
    
    function resetZoom() {
      currentScale = 1;
      currentX = 0;
      currentY = 0;
      offsetX = 0;
      offsetY = 0;
      updateZoom(true);
    }
    
    // Use requestAnimationFrame for smooth updates
    let zoomRAF = null;
    
    function updateZoom(animate = false) {
      // Cancel pending frame to avoid multiple updates
      if (zoomRAF) {
        cancelAnimationFrame(zoomRAF);
      }
      
      zoomRAF = requestAnimationFrame(() => {
        const container = document.getElementById('svg-container');
        const wrapper = document.getElementById('map-wrapper');
        if (!container || !wrapper) return;
        
        if (animate && !isAndroid) {
          container.classList.add('animating');
          setTimeout(() => container.classList.remove('animating'), 200);
        } else {
          container.classList.remove('animating');
        }
        
        // Size-based zoom for all devices (markers need correct % positioning)
        const newWidth = containerWidth * currentScale;
        const newHeight = containerHeight * currentScale;
        const wrapperRect = wrapper.getBoundingClientRect();
        const centerX = (wrapperRect.width - newWidth) / 2 + offsetX;
        const centerY = (wrapperRect.height - newHeight) / 2 + offsetY;
        
        container.style.width = newWidth + 'px';
        container.style.height = newHeight + 'px';
        container.style.left = centerX + 'px';
        container.style.top = centerY + 'px';
        container.style.transform = '';
        
        zoomRAF = null;
      });
    }
    
    // Legacy transform function for compatibility
    function updateTransform(animate = false) {
      updateZoom(animate);
    }
    
    // Drag functionality
    let lastTouchDistance = 0;
    let lastTouchCenter = { x: 0, y: 0 };
    let isTouching = false;
    
    function getTouchDistance(touches) {
      if (touches.length < 2) return 0;
      const dx = touches[0].clientX - touches[1].clientX;
      const dy = touches[0].clientY - touches[1].clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }
    
    function getTouchCenter(touches) {
      if (touches.length < 2) {
        return { x: touches[0].clientX, y: touches[0].clientY };
      }
      return {
        x: (touches[0].clientX + touches[1].clientX) / 2,
        y: (touches[0].clientY + touches[1].clientY) / 2
      };
    }
    
    function setupDrag() {
      const wrapper = document.getElementById('map-wrapper');
      let dragStartX, dragStartY, dragStartOffsetX, dragStartOffsetY;
      
      // Mouse events for desktop
      wrapper.addEventListener('mousedown', (e) => {
        isDragging = true;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        dragStartOffsetX = offsetX;
        dragStartOffsetY = offsetY;
        wrapper.style.cursor = 'grabbing';
      });
      
      wrapper.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        offsetX = dragStartOffsetX + (e.clientX - dragStartX);
        offsetY = dragStartOffsetY + (e.clientY - dragStartY);
        updateZoom();
      });
      
      wrapper.addEventListener('mouseup', () => {
        isDragging = false;
        wrapper.style.cursor = 'grab';
      });
      
      wrapper.addEventListener('mouseleave', () => {
        isDragging = false;
        wrapper.style.cursor = 'grab';
      });
      
      // Mouse wheel zoom
      wrapper.addEventListener('wheel', (e) => {
        e.preventDefault();
        if (e.deltaY < 0) {
          zoomIn();
        } else {
          zoomOut();
        }
      }, { passive: false });
      
      // Touch events for mobile
      wrapper.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
          // Single touch - drag
          isTouching = true;
          isDragging = true;
          dragStartX = e.touches[0].clientX;
          dragStartY = e.touches[0].clientY;
          dragStartOffsetX = offsetX;
          dragStartOffsetY = offsetY;
        } else if (e.touches.length === 2) {
          // Two fingers - pinch zoom
          e.preventDefault();
          isDragging = false;
          lastTouchDistance = getTouchDistance(e.touches);
          lastTouchCenter = getTouchCenter(e.touches);
        }
      }, { passive: false });
      
      // No throttling - maximum smoothness on all devices
      wrapper.addEventListener('touchmove', (e) => {
        if (e.touches.length === 1 && isDragging) {
          // Single touch drag
          e.preventDefault();
          offsetX = dragStartOffsetX + (e.touches[0].clientX - dragStartX);
          offsetY = dragStartOffsetY + (e.touches[0].clientY - dragStartY);
          updateZoom();
        } else if (e.touches.length === 2) {
          // Pinch to zoom
          e.preventDefault();
          const newDistance = getTouchDistance(e.touches);
          
          if (lastTouchDistance > 0) {
            const scale = newDistance / lastTouchDistance;
            // Min scale 1.0 to prevent blurriness on small Android screens
            const newScale = Math.min(Math.max(currentScale * scale, 1.0), 5);
            
            // Only update if change is significant (reduces redraws)
            if (Math.abs(newScale - currentScale) > 0.02) {
              currentScale = newScale;
              updateZoom();
            }
          }
          
          lastTouchDistance = newDistance;
        }
      }, { passive: false });
      
      wrapper.addEventListener('touchend', (e) => {
        if (e.touches.length === 0) {
          isDragging = false;
          isTouching = false;
          lastTouchDistance = 0;
        } else if (e.touches.length === 1) {
          // Went from 2 touches to 1 - restart drag
          isDragging = true;
          dragStartX = e.touches[0].clientX;
          dragStartY = e.touches[0].clientY;
          dragStartOffsetX = offsetX;
          dragStartOffsetY = offsetY;
          lastTouchDistance = 0;
        }
      });
      
      wrapper.addEventListener('touchcancel', () => {
        isDragging = false;
        isTouching = false;
        lastTouchDistance = 0;
      });
      
      // Double tap to reset zoom on mobile
      let lastTap = 0;
      wrapper.addEventListener('touchend', (e) => {
        if (e.touches.length !== 0) return;
        
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        
        if (tapLength < 300 && tapLength > 0) {
          // Double tap detected
          e.preventDefault();
          if (currentScale > 1.2) {
            resetZoom();
          } else {
            currentScale = 2;
            updateZoom(true);
          }
        }
        lastTap = currentTime;
      });
      
      wrapper.style.cursor = 'grab';
      
      // Initial positioning
      updateZoom();
    }
    
    // ========== PRESENCE TRACKING & LIVE USERS ==========
    let presenceInterval;
    let uid = localStorage.getItem('neptun_uid');
    if (!uid) {
      uid = 'web_' + Math.random().toString(36).substring(2, 15);
      localStorage.setItem('neptun_uid', uid);
    }
    
    async function pingPresence() {
      try {
        const nickname = localStorage.getItem('user_nickname') || '';
        const response = await fetch('/presence', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: uid,
            platform: 'web',
            nickname: nickname
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          
          // Check if user is blocked
          if (data.status === 'blocked') {
            showBlockedOverlay();
            return;
          }
          
          updateLiveUsers(data);
        }
      } catch (e) {
        console.log('Presence error:', e);
      }
    }
    
    function showBlockedOverlay() {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;inset:0;background:#0a0f1f;display:flex;align-items:center;justify-content:center;z-index:99999;font-family:Inter,sans-serif;color:#fff;padding:2rem;text-align:center;';
      overlay.innerHTML = '<div style="max-width:480px;"><h2 style="color:#ef4444;margin-bottom:1rem;">⛔ Доступ обмежено</h2><p style="color:#94a3b8;">Ваш доступ до NEPTUN тимчасово обмежено адміністратором.</p></div>';
      document.body.appendChild(overlay);
      
      // Stop all intervals
      if (presenceInterval) clearInterval(presenceInterval);
    }
    
    function updateLiveUsers(data) {
      const total = data.visitors || data.total || 0;
      const platforms = data.platforms || {};
      const web = platforms.web || data.web || 0;
      const apps = data.apps || (platforms.android || 0) + (platforms.ios || 0);
      
      const totalEl = document.querySelector('[data-role="live-total"]');
      const webEl = document.querySelector('[data-role="live-web"]');
      const appsEl = document.querySelector('[data-role="live-apps"]');
      
      if (totalEl) {
        totalEl.textContent = total;
        totalEl.classList.add('updating');
        setTimeout(() => totalEl.classList.remove('updating'), 500);
      }
      if (webEl) webEl.textContent = web;
      if (appsEl) appsEl.textContent = apps;
    }
    
    // ========== DONATE FUNCTIONS ==========
    function toggleDonate(show = null) {
      const modal = document.getElementById('donateModal');
      if (modal) {
        if (show === false) {
          modal.classList.remove('active');
        } else if (show === true) {
          modal.classList.add('active');
        } else {
          modal.classList.toggle('active');
        }
      }
    }
    
    // ========== FAQ FUNCTIONS ==========
    function toggleFAQ(show = null) {
      const modal = document.getElementById('faqModal');
      if (modal) {
        if (show === false) {
          modal.classList.remove('active');
        } else if (show === true) {
          modal.classList.add('active');
        } else {
          modal.classList.toggle('active');
        }
      }
    }
    
    // Close FAQ modal on outside click
    document.addEventListener('click', function(e) {
      const faqModal = document.getElementById('faqModal');
      if (e.target === faqModal) {
        toggleFAQ(false);
      }
    });
    
    function copyDonate(text) {
      navigator.clipboard.writeText(text).then(() => {
        const toast = document.getElementById('copyToast');
        if (toast) {
          toast.classList.add('show');
          setTimeout(() => toast.classList.remove('show'), 3000);
        }
      });
    }
    
    function openJar() {
      window.open('https://send.monobank.ua/jar/6Vi9TVzJZQ', '_blank');
    }
    
    // ========== DISCLAIMER & TELEGRAM BANNER ==========
    function hideDisclaimer() {
      const bar = document.getElementById('disclaimerBar');
      if (bar) {
        bar.classList.add('hidden');
        localStorage.setItem('disclaimer_hidden', 'true');
      }
    }
    
    function initBanners() {
      // Show disclaimer if not hidden
      if (!localStorage.getItem('disclaimer_hidden')) {
        const bar = document.getElementById('disclaimerBar');
        if (bar) bar.style.display = 'flex';
      }
    }
    
    // Init
    document.addEventListener('DOMContentLoaded', () => {
      loadMaps();
      initBanners();
      
      // Start presence tracking
      pingPresence();
      presenceInterval = setInterval(pingPresence, 30000);
    });

  </script>

  <script>
    // Handle commercial subscription form submission
    async function handleCommercialSubscription(event) {
      event.preventDefault();
      
      const messageDiv = document.getElementById('commercialFormMessage');
      const submitBtn = event.target.querySelector('button[type="submit"]');
      
      // Get form values
      const name = document.getElementById('commercialName').value.trim();
      const telegram = document.getElementById('commercialTelegram').value.trim();
      const type = document.getElementById('commercialType').value;
      const comment = document.getElementById('commercialComment').value.trim();
      
      // Validate required fields
      if (!name || !telegram || !type) {
        messageDiv.style.background = 'rgba(239,68,68,0.2)';
        messageDiv.style.color = '#fca5a5';
        messageDiv.style.border = '1px solid rgba(239,68,68,0.5)';
        messageDiv.innerHTML = '❌ Будь ласка, заповніть всі обов\'язкові поля';
        messageDiv.style.display = 'block';
        return;
      }
      
      const formData = {
        name: name,
        telegram: telegram,
        type: type,
        comment: comment,
        amount: 1000
      };
      
      // WayForPay payment URL
      const WAYFORPAY_URL = 'https://secure.wayforpay.com/invoice/i8609a370790c';
      
      try {
        // Show loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '⏳ Збереження заявки...';
        messageDiv.style.display = 'none';
        
        // Send to backend to save subscription data
        const response = await fetch('/api/commercial_subscription', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          // Show success and redirect to WayForPay
          messageDiv.style.background = 'rgba(34,197,94,0.2)';
          messageDiv.style.color = '#86efac';
          messageDiv.style.border = '1px solid rgba(34,197,94,0.5)';
          messageDiv.innerHTML = '✅ Заявку збережено! Перенаправлення на WayForPay...';
          messageDiv.style.display = 'block';
          
          // Redirect to WayForPay after 1 second
          setTimeout(() => {
            window.location.href = WAYFORPAY_URL;
          }, 1000);
        } else {
          throw new Error(result.error || 'Помилка збереження заявки');
        }
      } catch (error) {
        console.error('Subscription error:', error);
        messageDiv.style.background = 'rgba(239,68,68,0.2)';
        messageDiv.style.color = '#fca5a5';
        messageDiv.style.border = '1px solid rgba(239,68,68,0.5)';
        messageDiv.innerHTML = `❌ ${error.message}`;
        messageDiv.style.display = 'block';
        
        submitBtn.disabled = false;
        submitBtn.innerHTML = '💳 Перейти до оплати';
      }
    }
  </script>
  </section>

  <!-- COMMERCIAL MODAL - Minimal Glass Style -->
  <div id="commercialModal" class="commercial-modal-overlay">
    <div class="commercial-modal-content">
      
      <!-- Close button -->
      <button onclick="document.getElementById('commercialModal').style.display='none'" class="commercial-modal-close">
        <span class="material-icons">close</span>
      </button>

      <div class="commercial-modal-header">
        <span class="material-icons" style="font-size:32px;color:#67e8f9;">storefront</span>
        <div class="commercial-modal-title">Комерційне використання</div>
        <p class="commercial-modal-subtitle">
          Для TikTok ефірів, YouTube стрімів та Telegram каналів
        </p>
      </div>

      <div class="commercial-features">
        <div class="commercial-feature-card">
          <span class="material-icons">live_tv</span>
          <span>TikTok & YouTube</span>
        </div>
        <div class="commercial-feature-card">
          <span class="material-icons">telegram</span>
          <span>Telegram канали</span>
        </div>
        <div class="commercial-feature-card">
          <span class="material-icons">bolt</span>
          <span>Реальний час</span>
        </div>
      </div>

      <div class="commercial-price-card">
        <div class="commercial-price">1000₴<span>/місяць</span></div>
        <p class="commercial-price-note">WayForPay • Безпечна оплата</p>
      </div>

      <form id="commercialSubscriptionForm" onsubmit="handleCommercialSubscription(event)" class="commercial-form">
        <div class="commercial-form-title">
          <span class="material-icons">edit_note</span>
          Оформлення підписки
        </div>
        
        <div class="commercial-form-group">
          <label>Ваш нік в тіктоці або іншій платформі *</label>
          <input type="text" id="commercialName" required placeholder="@username">
        </div>

        <div class="commercial-form-group">
          <label>Telegram для зв'язку *</label>
          <input type="text" id="commercialTelegram" required placeholder="@username або t.me/username">
        </div>

        <div class="commercial-form-group">
          <label>Тип використання *</label>
          <select id="commercialType" required>
            <option value="">Оберіть тип</option>
            <option value="streaming">📺 Стрімінг</option>
            <option value="media">📰 ЗМІ / Новини</option>
            <option value="business">🏢 Корпоративне</option>
            <option value="other">📌 Інше</option>
          </select>
        </div>

        <div class="commercial-form-group">
          <label>Коментар (опціонально)</label>
          <textarea id="commercialComment" rows="2" placeholder="Додаткова інформація..."></textarea>
        </div>

        <button type="submit" class="commercial-submit-btn">
          <span class="material-icons">credit_card</span>
          Перейти до оплати
        </button>

        <div id="commercialFormMessage" class="commercial-form-message"></div>
      </form>
    </div>
  </div>
  
  <style>
    /* Commercial Modal - Minimal Glass Style */
    .commercial-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-y: auto;
    }
    
    .commercial-modal-content {
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(103, 232, 249, 0.15);
      border-radius: 24px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }
    
    .commercial-modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(103, 232, 249, 0.08);
      border: 1px solid rgba(103, 232, 249, 0.15);
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      cursor: pointer;
      transition: all 0.25s ease;
    }
    
    .commercial-modal-close:hover {
      background: rgba(103, 232, 249, 0.15);
      color: #67e8f9;
      transform: rotate(90deg);
    }
    
    .commercial-modal-close .material-icons {
      font-size: 20px;
    }
    
    .commercial-modal-header {
      text-align: center;
      margin-bottom: 28px;
    }
    
    .commercial-modal-title {
      color: #a5f3fc;
      font-size: 22px;
      font-weight: 600;
      margin: 12px 0 8px;
      letter-spacing: 0.5px;
    }
    
    .commercial-modal-subtitle {
      color: #64748b;
      font-size: 13px;
      margin: 0;
    }
    
    .commercial-features {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .commercial-feature-card {
      background: rgba(103, 232, 249, 0.06);
      border: 1px solid rgba(103, 232, 249, 0.12);
      border-radius: 50px;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #94a3b8;
      font-size: 12px;
      font-weight: 500;
    }
    
    .commercial-feature-card .material-icons {
      font-size: 16px;
      color: #67e8f9;
    }
    
    .commercial-price-card {
      background: rgba(103, 232, 249, 0.08);
      border: 1px solid rgba(103, 232, 249, 0.2);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      margin-bottom: 24px;
    }
    
    .commercial-price {
      color: #67e8f9;
      font-size: 36px;
      font-weight: 700;
    }
    
    .commercial-price span {
      font-size: 14px;
      color: #64748b;
      font-weight: 400;
    }
    
    .commercial-price-note {
      color: #64748b;
      font-size: 11px;
      margin: 8px 0 0;
    }
    
    .commercial-form {
      background: rgba(103, 232, 249, 0.04);
      border: 1px solid rgba(103, 232, 249, 0.1);
      border-radius: 16px;
      padding: 24px;
    }
    
    .commercial-form-title {
      color: #a5f3fc;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .commercial-form-title .material-icons {
      font-size: 20px;
      color: #67e8f9;
    }
    
    .commercial-form-group {
      margin-bottom: 16px;
    }
    
    .commercial-form-group label {
      display: block;
      color: #64748b;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 6px;
    }
    
    .commercial-form-group input,
    .commercial-form-group select,
    .commercial-form-group textarea {
      width: 100%;
      padding: 12px 14px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(103, 232, 249, 0.15);
      border-radius: 10px;
      color: #e2e8f0;
      font-size: 14px;
      outline: none;
      transition: all 0.25s ease;
      box-sizing: border-box;
    }
    
    .commercial-form-group input:focus,
    .commercial-form-group select:focus,
    .commercial-form-group textarea:focus {
      border-color: rgba(103, 232, 249, 0.4);
      background: rgba(15, 23, 42, 0.8);
    }
    
    .commercial-form-group input::placeholder,
    .commercial-form-group textarea::placeholder {
      color: #475569;
    }
    
    .commercial-form-group select option {
      background: #0f172a;
      color: #e2e8f0;
    }
    
    .commercial-form-group textarea {
      resize: vertical;
      min-height: 60px;
    }
    
    .commercial-submit-btn {
      width: 100%;
      padding: 14px;
      background: rgba(103, 232, 249, 0.15);
      border: 1px solid rgba(103, 232, 249, 0.3);
      border-radius: 50px;
      color: #67e8f9;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.25s ease;
      margin-top: 20px;
    }
    
    .commercial-submit-btn:hover {
      background: rgba(103, 232, 249, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(103, 232, 249, 0.2);
    }
    
    .commercial-submit-btn .material-icons {
      font-size: 18px;
    }
    
    .commercial-form-message {
      margin-top: 16px;
      padding: 12px;
      border-radius: 10px;
      display: none;
      text-align: center;
      font-size: 13px;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      .commercial-modal-content {
        padding: 28px 20px;
        border-radius: 20px;
        max-width: 100%;
      }
      
      .commercial-modal-title {
        font-size: 18px;
      }
      
      .commercial-features {
        gap: 8px;
      }
      
      .commercial-feature-card {
        padding: 6px 12px;
        font-size: 11px;
      }
      
      .commercial-price {
        font-size: 28px;
      }
      
      .commercial-form {
        padding: 18px;
      }
      
      .commercial-form-group input,
      .commercial-form-group select,
      .commercial-form-group textarea {
        padding: 10px 12px;
        font-size: 13px;
      }
    }
  </style>

  <style>
    /* Mobile navbar optimizations */
    @media (max-width: 768px) {
      .navbar {
        padding: 8px 12px !important;
        gap: 8px;
      }
      
      .logo {
        flex-shrink: 0;
      }
      
      .logo-text {
        font-size: 0.95rem !important;
        letter-spacing: 1px !important;
      }
      
      .live-users {
        padding: 4px 8px !important;
        font-size: 0.55rem !important;
        gap: 2px !important;
        border-radius: 8px !important;
      }
      
      .live-count {
        font-size: 0.75rem !important;
      }
      
      #userNicknameDisplay {
        display: none !important;
      }
      
      .nav-links {
        display: none !important;
      }
      
      .nav-actions {
        gap: 4px !important;
      }
      
      .nav-actions .nav-btn {
        padding: 5px 10px !important;
        font-size: 0.7rem !important;
        border-radius: 8px !important;
        gap: 4px !important;
      }
      
      .nav-actions .nav-btn i {
        font-size: 16px !important;
      }
      
      .nav-actions .nav-btn span {
        display: none !important;
      }

      #commercialModal > div {
        padding: 25px 20px;
        border-radius: 16px;
      }
    }
    
    /* Extra small screens */
    @media (max-width: 380px) {
      .logo-text {
        font-size: 0.85rem !important;
      }
      
      .live-users {
        padding: 3px 6px !important;
      }
    }
    
    /* SEO Footer mobile */
    @media (max-width: 768px) {
      #seo-footer {
        padding: 6px 10px !important;
      }
      
      #seo-footer nav {
        gap: 6px !important;
        font-size: 9px !important;
      }
      
      #seo-footer .mobile-hidden {
        display: none !important;
      }
    }
  </style>

  <!-- SEO FOOTER - Important for search rankings -->
  <footer id="seo-footer" style="position:fixed;bottom:0;left:0;right:0;background:linear-gradient(180deg, transparent 0%, rgba(10,14,23,0.98) 50%, rgba(10,14,23,1) 100%);padding:12px 20px;z-index:100;pointer-events:none;border-top:1px solid rgba(0,212,255,0.08);">
    <nav style="display:flex;flex-wrap:wrap;justify-content:center;align-items:center;gap:12px;font-size:11px;opacity:0.5;pointer-events:auto;font-weight:500;">
      <span style="color:#00d4ff;font-weight:700;letter-spacing:1px;">© 2026 NEPTUN</span>
      <span style="color:#334155;" class="mobile-hidden">•</span>
      <a href="/" style="color:#64748b;text-decoration:none;transition:color 0.2s;" class="mobile-hidden" title="Карта тривог України в реальному часі">Карта тривог</a>
      <span style="color:#334155;" class="mobile-hidden">•</span>
      <a href="/map-old" style="color:#64748b;text-decoration:none;transition:color 0.2s;" class="mobile-hidden" title="Радар шахедів онлайн">Радар шахедів</a>
      <span style="color:#334155;" class="mobile-hidden">•</span>
      <a href="https://t.me/+aBR79kExNQM1ZjZi" target="_blank" rel="noopener" style="color:#64748b;text-decoration:none;transition:color 0.2s;" class="mobile-hidden" title="Telegram канал NEPTUN">Telegram</a>
      <span style="color:#334155;">•</span>
      <a href="https://play.google.com/store/apps/details?id=com.neptunalarm.neptun_alarm_app" target="_blank" rel="noopener" style="color:#3ddc84;text-decoration:none;transition:color 0.2s;font-weight:600;" title="Додаток карти тривог NEPTUN">📱 Додаток</a>
    </nav>
  </footer>
</body>
</html>
