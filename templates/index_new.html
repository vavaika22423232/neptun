<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–ö–∞—Ä—Ç–∞ —Ç—Ä–∏–≤–æ–≥ –£–∫—Ä–∞—ó–Ω–∏ | NEPTUN</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      /* ukrainealarm.com exact style */
      --main-bg: #1e2433;
      --panel-bg: #2d3748;
      --accent: #4299e1;
      --accent2: #48bb78;
      --text: #ffffff;
      --text2: #a0aec0;
      --text-muted: #718096;
      --border: #4a5568;
      --shadow: rgba(0, 0, 0, 0.5);
      --card-bg: rgba(45, 55, 72, 0.95);
      --danger: #c53030;
      --warning: #dd6b20;
      --success: #48bb78;
      /* Legacy aliases */
      --bg: #1e2433;
      --bg-dark: #171c28;
      --panel: #2d3748;
      --red: #c53030;
      --orange: #dd6b20;
      --yellow: #d69e2e;
      --green: #48bb78;
      --blue: #4299e1;
      --gray: #4a5568;
      /* Map specific - ukrainealarm colors */
      --map-bg: #1e2433;
      --map-region: #3d4a5c;
      --map-border: #4a5568;
      --alarm-red: #9b2c2c;
      --alarm-partial: #dd6b20;
    }
    
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--main-bg);
      color: var(--text);
      min-height: 100vh;
      overflow: hidden;
      line-height: 1.5;
    }
    
    /* ===== NAVBAR - ukrainealarm.com style ===== */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(180deg, rgba(36, 43, 69, 0.98) 0%, rgba(26, 31, 53, 0.98) 100%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(74, 158, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      z-index: 1000;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4), 0 1px 0 rgba(255, 255, 255, 0.03) inset;
    }
    
    .navbar::before {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent 0%, rgba(74, 158, 255, 0.5) 50%, transparent 100%);
      opacity: 0.5;
    }
    
    .nav-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
    }
    
    .logo-text {
      font-size: 1.4rem;
      font-weight: 900;
      letter-spacing: 2px;
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 30%, #8b5cf6 70%, #60a5fa 100%);
      background-size: 200% 200%;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: logoShine 3s ease infinite;
    }
    
    @keyframes logoShine {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    .site-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }
    
    .site-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .nav-links {
      display: flex;
      gap: 0.4rem;
      font-size: 0.875rem;
      align-items: center;
    }
    
    .nav-links a {
      color: rgba(148, 163, 184, 0.9);
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 0.55rem 1rem;
      border-radius: 12px;
      line-height: 1;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      position: relative;
      overflow: hidden;
      border: 1px solid transparent;
    }
    
    .nav-links a::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.1));
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: 12px;
    }
    
    .nav-links a:hover {
      color: #fff;
      transform: translateY(-1px);
      border-color: rgba(59, 130, 246, 0.2);
    }
    
    .nav-links a:hover::before {
      opacity: 1;
    }
    
    .nav-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    /* Live users counter - Premium */
    .live-users {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.9rem;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.9));
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 14px;
      font-size: 0.7rem;
      font-weight: 600;
      position: relative;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.05);
      overflow: hidden;
    }
    
    .live-users::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
      animation: liveShimmer 3s ease infinite;
    }
    
    @keyframes liveShimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    
    .live-count {
      color: #10b981;
      font-weight: 800;
      font-size: 0.85rem;
    }
    
    .live-label {
      color: #94a3b8;
      font-weight: 500;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Threat counter - Premium */
    .threat-counter {
      display: flex;
      align-items: center;
      gap: 12px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.9));
      padding: 8px 16px;
      border-radius: 14px;
      border: 1px solid rgba(59, 130, 246, 0.2);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }
    
    .threat-counter-label {
      font-size: 13px;
      color: var(--text-muted);
    }
    
    .threat-counts {
      display: flex;
      gap: 16px;
    }
    
    .threat-count {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .threat-icon {
      width: 20px;
      height: 20px;
    }
    
    .threat-num {
      font-size: 16px;
      font-weight: 700;
    }
    
    .threat-num.air { color: var(--danger); text-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
    .threat-num.artillery { color: var(--warning); text-shadow: 0 0 10px rgba(245, 158, 11, 0.5); }
    .threat-num.street { color: var(--success); text-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
    
    .sidebar-toggle-btn {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.9));
      border: 1px solid rgba(59, 130, 246, 0.2);
      color: var(--text);
      width: 40px;
      height: 40px;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .sidebar-toggle-btn:hover {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(6, 182, 212, 0.15));
      border-color: rgba(59, 130, 246, 0.4);
      transform: translateY(-1px);
    }
    
    /* ===== MAIN LAYOUT ===== */
    .main-container {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 0;
      display: block;
    }
    
    /* ===== MAP CONTAINER - Leaflet ===== */
    .map-container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--main-bg);
      overflow: hidden;
    }
    
    #map {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--main-bg);
      z-index: 1;
    }
    
    /* Leaflet customization */
    .leaflet-container {
      background: var(--main-bg) !important;
      font-family: 'Inter', system-ui, sans-serif;
    }
    
    .leaflet-control-zoom {
      border: none !important;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4) !important;
      border-radius: 12px !important;
      overflow: hidden;
    }
    
    .leaflet-control-zoom a {
      background: linear-gradient(135deg, rgba(36, 43, 69, 0.95), rgba(26, 31, 53, 0.95)) !important;
      color: var(--text) !important;
      border: 1px solid rgba(74, 158, 255, 0.2) !important;
      width: 40px !important;
      height: 40px !important;
      line-height: 40px !important;
      font-size: 20px !important;
      transition: all 0.2s ease !important;
    }
    
    .leaflet-control-zoom a:hover {
      background: linear-gradient(135deg, rgba(74, 158, 255, 0.3), rgba(46, 213, 115, 0.2)) !important;
      color: #fff !important;
    }
    
    .leaflet-control-attribution {
      background: rgba(26, 31, 53, 0.9) !important;
      color: var(--text-muted) !important;
      border-radius: 8px !important;
      padding: 4px 8px !important;
      font-size: 10px !important;
    }
    
    .leaflet-control-attribution a {
      color: var(--accent) !important;
    }
    
    /* SVG overlay styling */
    .leaflet-image-layer {
      opacity: 1;
    }
    
    /* Marker styles */
    .threat-marker-icon {
      background: transparent !important;
      border: none !important;
    }
    
    .threat-marker-icon img {
      width: 36px;
      height: 36px;
      filter: drop-shadow(0 3px 8px rgba(220, 38, 38, 0.6));
      animation: marker-pulse 2s ease-in-out infinite;
    }
    
    .threat-marker-icon.shahed img {
      width: 40px;
      height: 40px;
    }
    
    .threat-marker-icon.rocket img {
      width: 42px;
      height: 42px;
      filter: drop-shadow(0 3px 8px rgba(249, 115, 22, 0.7));
    }
    
    @keyframes marker-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    /* Leaflet popup styling - ukrainealarm.com style */
    .leaflet-popup-content-wrapper {
      background: linear-gradient(145deg, rgba(36, 43, 69, 0.98), rgba(26, 31, 53, 0.98)) !important;
      color: var(--text) !important;
      border: 1px solid rgba(74, 158, 255, 0.25) !important;
      border-radius: 12px !important;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5) !important;
    }
    
    .leaflet-popup-tip {
      background: rgba(36, 43, 69, 0.98) !important;
      border: 1px solid rgba(74, 158, 255, 0.25) !important;
    }
    
    .leaflet-popup-content {
      margin: 12px 16px !important;
      font-size: 13px;
    }
    
    /* City labels - prevent offset issues on zoom */
    .city-label {
      background: transparent !important;
      border: none !important;
      transform: translateX(-50%);
    }
    
    .city-dot {
      background: transparent !important;
      border: none !important;
    }

    .popup-title {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 6px;
      color: var(--text);
    }
    
    .popup-text {
      color: var(--text-muted);
      font-size: 12px;
      line-height: 1.4;
    }
    
    .popup-time {
      color: var(--accent);
      font-size: 11px;
      margin-top: 6px;
    }
    
    /* ===== LEGEND - ukrainealarm.com style ===== */
    .legend {
      position: absolute;
      bottom: 24px;
      left: 24px;
      background: linear-gradient(145deg, rgba(36, 43, 69, 0.95), rgba(26, 31, 53, 0.95));
      border: 1px solid rgba(74, 158, 255, 0.2);
      border-radius: 16px;
      padding: 16px 20px;
      backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.03);
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      font-size: 13px;
      color: var(--text2);
      transition: color 0.2s;
    }
    
    .legend-item:hover {
      color: var(--text);
    }
    
    .legend-item:last-child {
      margin-bottom: 0;
    }
    
    .legend-color {
      width: 18px;
      height: 18px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .legend-color.air { background: linear-gradient(135deg, #ff4757, #c0392b); box-shadow: 0 2px 8px rgba(255, 71, 87, 0.5); }
    .legend-color.artillery { background: linear-gradient(135deg, #ff7f50, #e67e22); box-shadow: 0 2px 8px rgba(255, 127, 80, 0.5); }
    .legend-color.street { background: linear-gradient(135deg, #2ed573, #27ae60); box-shadow: 0 2px 8px rgba(46, 213, 115, 0.5); }
    .legend-color.none { background: linear-gradient(135deg, #3d4663, #2a3352); }
    .legend-color.partial { background: linear-gradient(135deg, #ffc107, #f39c12); box-shadow: 0 2px 8px rgba(255, 193, 7, 0.5); }
    
    /* ===== BOTTOM CONTROLS - ukrainealarm.com style ===== */
    .bottom-controls {
      position: absolute;
      bottom: 24px;
      right: 24px;
      display: flex;
      gap: 12px;
    }
    
    .control-btn {
      background: linear-gradient(135deg, rgba(36, 43, 69, 0.95), rgba(26, 31, 53, 0.95));
      border: 1px solid rgba(74, 158, 255, 0.2);
      color: var(--text);
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .control-btn:hover {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(6, 182, 212, 0.15));
      border-color: rgba(59, 130, 246, 0.4);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
    }
    
    .theme-toggle {
      width: 48px;
      height: 28px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 14px;
      position: relative;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .theme-toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
      border-radius: 50%;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 8px rgba(74, 158, 255, 0.4);
    }
    
    .theme-toggle.light::after {
      transform: translateX(20px);
    }
    
    /* ===== SIDEBAR - ukrainealarm.com style ===== */
    .sidebar {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: 380px;
      background: linear-gradient(180deg, rgba(36, 43, 69, 0.98) 0%, rgba(26, 31, 53, 0.98) 100%);
      backdrop-filter: blur(20px);
      border-left: 1px solid rgba(74, 158, 255, 0.15);
      display: flex;
      flex-direction: column;
      transform: translateX(0);
      transition: transform 0.3s ease;
      z-index: 100;
      box-shadow: -8px 0 32px rgba(0, 0, 0, 0.4);
    }
    
    .sidebar.collapsed {
      transform: translateX(100%);
    }
    
    .sidebar-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(74, 158, 255, 0.15);
      display: flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(180deg, rgba(42, 51, 82, 0.5) 0%, transparent 100%);
    }
    
    .sidebar-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text);
    }
    
    .pulse-dot {
      width: 8px;
      height: 8px;
      background: var(--danger);
      border-radius: 50%;
      animation: pulse 2s infinite;
      box-shadow: 0 0 10px rgba(255, 71, 87, 0.6);
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 10px rgba(255, 71, 87, 0.6); }
      50% { opacity: 0.5; box-shadow: 0 0 20px rgba(255, 71, 87, 0.8); }
    }
    
    .sidebar-counts {
      display: flex;
      gap: 16px;
      margin-left: auto;
    }
    
    .sidebar-count {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }
    
    .sidebar-count-icon {
      font-size: 16px;
    }
    
    .sidebar-count-num {
      font-weight: 700;
      color: var(--text);
    }
    
    /* Events list - Premium */
    .events-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      scrollbar-width: thin;
      scrollbar-color: rgba(59, 130, 246, 0.3) transparent;
    }
    
    .events-list::-webkit-scrollbar {
      width: 6px;
    }
    
    .events-list::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .events-list::-webkit-scrollbar-thumb {
      background: rgba(59, 130, 246, 0.3);
      border-radius: 3px;
    }
    
    .event-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px;
      border-radius: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(30, 41, 59, 0.3);
      border: 1px solid transparent;
    }
    
    .event-item:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.2);
      transform: translateX(-4px);
    }
    
    .event-icon {
      width: 32px;
      height: 32px;
      flex-shrink: 0;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }
    
    .event-content {
      flex: 1;
      min-width: 0;
    }
    
    .event-place {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text);
    }
    
    .event-type {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    
    .event-time {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .event-time::before {
      content: '';
      width: 6px;
      height: 6px;
      background: var(--accent);
      border-radius: 50%;
      opacity: 0.7;
    }
    
    .event-duration {
      font-size: 12px;
      color: var(--text-muted);
      text-align: right;
      white-space: nowrap;
    }
    
    /* TG Banner - Premium */
    .tg-banner {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 16px;
      background: linear-gradient(135deg, #0088cc 0%, #006bb3 100%);
      color: white;
      text-decoration: none;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .tg-banner::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .tg-banner:hover::before {
      left: 100%;
    }
    
    .tg-banner:hover {
      background: linear-gradient(135deg, #0099dd 0%, #0077cc 100%);
    }
    
    /* Map info - Premium */
    .map-info {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.8), rgba(30, 41, 59, 0.8));
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid rgba(59, 130, 246, 0.15);
      backdrop-filter: blur(10px);
    }
    
    .map-info a {
      color: var(--accent);
      text-decoration: none;
      transition: color 0.2s;
    }
    
    .map-info a:hover {
      color: #60a5fa;
    }
    
    /* Mobile */
    @media (max-width: 900px) {
      .nav-links {
        display: none;
      }
      
      .sidebar {
        position: fixed;
        top: 60px;
        right: 0;
        bottom: 0;
        width: 100%;
        max-width: 400px;
        z-index: 100;
      }
      
      .threat-counter {
        display: none;
      }
    }
    
    @media (max-width: 600px) {
      .navbar {
        padding: 0 12px;
      }
      
      .site-subtitle {
        display: none;
      }
      
      .legend {
        left: 12px;
        bottom: 12px;
        padding: 12px;
        font-size: 11px;
      }
      
      .bottom-controls {
        right: 12px;
        bottom: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar - Premium Design -->
  <nav class="navbar">
    <div class="nav-left">
      <div class="logo">üõ°Ô∏è</div>
      <div>
        <span class="logo-text">NEPTUN</span>
        <div class="site-subtitle">–ö–∞—Ä—Ç–∞ —Ç—Ä–∏–≤–æ–≥ –£–∫—Ä–∞—ó–Ω–∏</div>
      </div>
    </div>
    
    <div class="nav-links">
      <a href="#">–ö–∞—Ä—Ç–∞</a>
      <a href="#">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
      <a href="#">API</a>
      <a href="#">–ö–æ–Ω—Ç–∞–∫—Ç–∏</a>
    </div>
    
    <div class="nav-right">
      <!-- Live users counter -->
      <div class="live-users">
        <span class="live-label">Online</span>
        <span class="live-count" id="liveCount">...</span>
      </div>
      
      <div class="threat-counter">
        <span class="threat-counter-label">–ó–∞–≥—Ä–æ–∑–∏:</span>
        <div class="threat-counts">
          <div class="threat-count">
            <img src="/static/shahed.png" class="threat-icon" alt="–®–∞—Ö–µ–¥–∏">
            <span class="threat-num air" id="countAir">0</span>
          </div>
          <div class="threat-count">
            <img src="/static/raketa.png" class="threat-icon" alt="–†–∞–∫–µ—Ç–∏">
            <span class="threat-num artillery" id="countArtillery">0</span>
          </div>
        </div>
      </div>
      
      <button class="sidebar-toggle-btn" onclick="toggleSidebar()" title="–ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ –ø–æ–¥—ñ—ó">
        <i class="material-icons">chevron_left</i>
      </button>
    </div>
  </nav>
  
  <!-- Main container -->
  <div class="main-container">
    <!-- Map container - Leaflet with SVG overlay -->
    <div class="map-container">
      <!-- Leaflet map div -->
      <div id="map"></div>
      
      <!-- Legend -->
      <div class="legend">
        <div class="legend-item">
          <div class="legend-color air"></div>
          <span>–ü–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞</span>
        </div>
        <div class="legend-item">
          <div class="legend-color artillery"></div>
          <span>–ó–∞–≥—Ä–æ–∑–∞ –∞—Ä—Ç–æ–±—Å—Ç—Ä—ñ–ª—É</span>
        </div>
        <div class="legend-item">
          <div class="legend-color street"></div>
          <span>–ó–∞–≥—Ä–æ–∑–∞ –≤—É–ª–∏—á–Ω–∏—Ö –±–æ—ó–≤</span>
        </div>
        <div class="legend-item">
          <div class="legend-color none"></div>
          <span>–ù–µ–º–∞—î —Ç—Ä–∏–≤–æ–≥–∏</span>
        </div>
      </div>
      
      <!-- Map info -->
      <div class="map-info">
        neptun.in.ua<br>
        –°—Ç–∞–Ω–æ–º –Ω–∞ <span id="updateTime">--</span>
      </div>
      
      <!-- Bottom controls -->
      <div class="bottom-controls">
        <button class="control-btn" onclick="toggleDemoMode()" id="demoBtn">
          <span class="material-icons" style="font-size: 18px;">bug_report</span>
          –î–µ–º–æ
        </button>
        <button class="control-btn" onclick="showStats()">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        <div style="display: flex; align-items: center; gap: 8px;">
          <span style="font-size: 14px;">–¢–µ–º–∞</span>
          <div class="theme-toggle" onclick="toggleTheme()"></div>
        </div>
      </div>
    </div>
    
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">
          <span class="pulse-dot"></span>
          –ó–∞–≥—Ä–æ–∑–∏:
        </div>
        <div class="sidebar-counts">
          <div class="sidebar-count">
            <span class="sidebar-count-icon">‚úàÔ∏è</span>
            <span class="sidebar-count-num" id="sidebarAir">0</span>
          </div>
          <div class="sidebar-count">
            <span class="sidebar-count-icon">üí•</span>
            <span class="sidebar-count-num" id="sidebarArtillery">0</span>
          </div>
          <div class="sidebar-count">
            <span class="sidebar-count-icon">üõ∏</span>
            <span class="sidebar-count-num" id="sidebarShahed">0</span>
          </div>
        </div>
      </div>
      
      <!-- Air Raid Alerts Section -->
      <div class="alarms-section" id="alarmsSection" style="display: none;">
        <div class="alarms-header" style="padding: 12px 16px; background: rgba(155, 44, 44, 0.2); border-bottom: 1px solid rgba(197, 48, 48, 0.3);">
          <span style="color: #f87171; font-weight: 600; font-size: 14px;">üö® –ü–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞</span>
          <span id="alarmCount" style="background: #dc2626; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 600; margin-left: 8px;">0</span>
        </div>
        <div class="alarms-list" id="alarmsList" style="max-height: 200px; overflow-y: auto; padding: 8px 0;">
          <!-- Alarm regions will be listed here -->
        </div>
      </div>
      
      <div class="events-list" id="eventsList">
        <!-- Events will be loaded here -->
        <div style="padding: 20px; text-align: center; color: var(--text2);">
          –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ–¥—ñ–π...
        </div>
      </div>
      
      <a href="https://t.me/+aBR79kExNQM1ZjZi" target="_blank" class="tg-banner">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="white">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .37z"/>
        </svg>
        Telegram –∫–∞–Ω–∞–ª
      </a>
    </aside>
  </div>

  <script>
    // ===== CONFIG =====
    const API_URL = '/data';
    const UPDATE_INTERVAL = 10000;
    
    // Ukraine bounds for Leaflet
    // From SVG geoViewBox: "22.138577 52.380834 40.220623 44.387017"
    // Format is: west north east south (minLng maxLat maxLng minLat)
    const UA_BOUNDS = {
      south: 44.387017,   // minLat (4th value in geoViewBox)
      north: 52.380834,   // maxLat (2nd value in geoViewBox)
      west: 22.138577,    // minLng (1st value in geoViewBox)
      east: 40.220623,    // maxLng (3rd value in geoViewBox)
      center: [48.5, 31.5]
    };
    
    // SVG overlay bounds for Leaflet: [[south, west], [north, east]]
    const SVG_BOUNDS = [[UA_BOUNDS.south, UA_BOUNDS.west], [UA_BOUNDS.north, UA_BOUNDS.east]];
    
    // Threat type icons (emoji for sidebar)
    const ICONS = {
      shahed: 'üõ∏',
      rocket: 'üöÄ',
      avia: '‚úàÔ∏è',
      artillery: 'üí•',
      fpv: 'üéØ',
      default: '‚ö†Ô∏è'
    };
    
    // PNG icons for map markers
    const PNG_ICONS = {
      shahed: '/static/shahed.png',
      rocket: '/static/raketa.png',
      avia: '/static/avia.png',
      artillery: '/static/artillery.png',
      fpv: '/static/fpv.png',
      pusk: '/static/pusk.png',
      vibuh: '/static/vibuh.png',
      kab: '/static/kab.png',
      default: '/static/default.png'
    };
    
    // ===== ALARM API CONFIG =====
    const ALARM_API_KEY = '57fe8a39:7698ad50f0f15d502b280a83019bab25';
    const ALARM_API_URL = 'https://api.ukrainealarm.com/api/v3/alerts';
    const ALARM_UPDATE_INTERVAL = 30000; // 30 seconds
    
    // Mapping from API regionName to GeoJSON NL_NAME_1 (Ukrainian name)
    // Note: GeoJSON has some names with accents (–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æÃÅ–≤—Å—å–∫–∞, –î–æ–Ω–µÃÅ—Ü—å–∫–∞)
    const REGION_MAPPING = {
      "–í—ñ–Ω–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–í—ñ–Ω–Ω–∏—Ü—å–∫–∞",
      "–í–æ–ª–∏–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–í–æ–ª–∏–Ω—Å—å–∫–∞",
      "–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æÃÅ–≤—Å—å–∫–∞",
      "–î–æ–Ω–µ—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–î–æ–Ω–µÃÅ—Ü—å–∫–∞",
      "–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞",
      "–ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞",
      "–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞",
      "–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞",
      "–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–ö–∏—ó–≤—Å—å–∫–∞",
      "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞",
      "–õ—É–≥–∞–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–õ—É–≥–∞–Ω—Å—å–∫–∞",
      "–õ—å–≤—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–õ—å–≤—ñ–≤—Å—å–∫–∞",  // GeoJSON has NA for Lviv, use NAME_1
      "–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞",
      "–û–¥–µ—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–û–¥–µ—Å—å–∫–∞",
      "–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞",
      "–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞",
      "–°—É–º—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–°—É–º—Å—å–∫–∞",
      "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞",
      "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞",
      "–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞",
      "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞",
      "–ß–µ—Ä–∫–∞—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–ß–µ—Ä–∫–∞—Å—å–∫–∞",
      "–ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫–∞",
      "–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞",
      "–º. –ö–∏—ó–≤": "–ö–∏—ó–≤",
      "–ê–≤—Ç–æ–Ω–æ–º–Ω–∞ –†–µ—Å–ø—É–±–ª—ñ–∫–∞ –ö—Ä–∏–º": "–ö—Ä–∏–º",
      "–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å": "–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å"
    };

    // ===== STATE =====
    let sidebarOpen = true;
    let currentData = [];
    let map = null;
    let markerLayer = null;
    let svgOverlay = null;
    let cityLabelsLayer = null;
    let alarmLayer = null;
    let districtAlarmLayer = null; // New layer for districts
    let alarmRegions = {}; // Store active alarm regions
    let alarmDistricts = {}; // Store active alarm districts
    let geojsonData = null; // Store GeoJSON data for oblasts
    let districtsGeojsonData = null; // Store GeoJSON data for districts

    // City coordinates for labels
    const CITIES = [
      { name: "–ö–∏—ó–≤", lat: 50.4501, lng: 30.5234, size: "capital" },
      { name: "–•–∞—Ä–∫—ñ–≤", lat: 49.9935, lng: 36.2304, size: "major" },
      { name: "–û–¥–µ—Å–∞", lat: 46.4825, lng: 30.7233, size: "major" },
      { name: "–î–Ω—ñ–ø—Ä–æ", lat: 48.4647, lng: 35.0462, size: "major" },
      { name: "–õ—å–≤—ñ–≤", lat: 49.8397, lng: 24.0297, size: "major" },
      { name: "–ó–∞–ø–æ—Ä—ñ–∂–∂—è", lat: 47.8388, lng: 35.1396, size: "major" },
      { name: "–ú–∏–∫–æ–ª–∞—ó–≤", lat: 46.9750, lng: 31.9946, size: "city" },
      { name: "–•–µ—Ä—Å–æ–Ω", lat: 46.6354, lng: 32.6169, size: "city" },
      { name: "–í—ñ–Ω–Ω–∏—Ü—è", lat: 49.2331, lng: 28.4682, size: "city" },
      { name: "–ü–æ–ª—Ç–∞–≤–∞", lat: 49.5883, lng: 34.5514, size: "city" },
      { name: "–ß–µ—Ä–Ω—ñ–≥—ñ–≤", lat: 51.4982, lng: 31.2893, size: "city" },
      { name: "–°—É–º–∏", lat: 50.9077, lng: 34.7981, size: "city" },
      { name: "–ñ–∏—Ç–æ–º–∏—Ä", lat: 50.2547, lng: 28.6587, size: "city" },
      { name: "–ß–µ—Ä–∫–∞—Å–∏", lat: 49.4444, lng: 32.0598, size: "city" },
      { name: "–†—ñ–≤–Ω–µ", lat: 50.6199, lng: 26.2516, size: "city" },
      { name: "–õ—É—Ü—å–∫", lat: 50.7472, lng: 25.3254, size: "city" },
      { name: "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å", lat: 49.5535, lng: 25.5948, size: "city" },
      { name: "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π", lat: 49.4230, lng: 26.9871, size: "city" },
      { name: "–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫", lat: 48.9226, lng: 24.7111, size: "city" },
      { name: "–£–∂–≥–æ—Ä–æ–¥", lat: 48.6208, lng: 22.2879, size: "city" },
      { name: "–ß–µ—Ä–Ω—ñ–≤—Ü—ñ", lat: 48.2920, lng: 25.9358, size: "city" },
      { name: "–ö—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π", lat: 48.5079, lng: 32.2623, size: "city" },
    ];
    
    // Get PNG icon URL for threat type
    function getPngIcon(threatType) {
      const tt = (threatType || '').toLowerCase();
      
      if (tt.includes('shahed') || tt.includes('—à–∞—Ö–µ–¥') || tt.includes('–±–ø–ª–∞') || tt.includes('–¥—Ä–æ–Ω')) {
        return { url: PNG_ICONS.shahed, type: 'shahed' };
      } else if (tt.includes('rocket') || tt.includes('—Ä–∞–∫–µ—Ç') || tt.includes('–±–∞–ª—ñ') || tt.includes('–∫—Ä–∏–ª–∞')) {
        return { url: PNG_ICONS.rocket, type: 'rocket' };
      } else if (tt.includes('avia') || tt.includes('–∞–≤—ñ–∞') || tt.includes('–º—ñ')) {
        return { url: PNG_ICONS.avia, type: 'avia' };
      } else if (tt.includes('artillery') || tt.includes('–∞—Ä—Ç') || tt.includes('–æ–±—Å—Ç—Ä—ñ–ª')) {
        return { url: PNG_ICONS.artillery, type: 'artillery' };
      } else if (tt.includes('fpv') || tt.includes('—Ñ–ø–≤')) {
        return { url: PNG_ICONS.fpv, type: 'fpv' };
      } else if (tt.includes('pusk') || tt.includes('–ø—É—Å–∫')) {
        return { url: PNG_ICONS.pusk, type: 'pusk' };
      } else if (tt.includes('kab') || tt.includes('–∫–∞–±')) {
        return { url: PNG_ICONS.kab, type: 'kab' };
      } else if (tt.includes('vibuh') || tt.includes('–≤–∏–±—É—Ö') || tt.includes('–≤–∏–±—É—Ö–∏')) {
        return { url: PNG_ICONS.vibuh, type: 'vibuh' };
      }
      return { url: PNG_ICONS.default, type: 'default' };
    }
    
    // Initialize Leaflet map with SVG overlay
    function initMap() {
      // Create map without tile layer - we use SVG as background
      map = L.map('map', {
        center: UA_BOUNDS.center,
        zoom: 6,
        minZoom: 5,
        maxZoom: 10,
        zoomControl: true,
        attributionControl: false,
        crs: L.CRS.EPSG3857, // Standard Web Mercator
        preferCanvas: true // Use Canvas renderer for better polygon fill
      });
      
      // Add SVG overlay as the base map (covers Ukraine bounds)
      svgOverlay = L.imageOverlay('/static/ukraine_mapsvg.svg', SVG_BOUNDS, {
        opacity: 1,
        interactive: false,
        className: 'svg-map-layer'
      }).addTo(map);
      
      // Fit map to SVG bounds
      map.fitBounds(SVG_BOUNDS);
      
      // Create marker layer
      markerLayer = L.layerGroup().addTo(map);
      
      // Create city labels layer
      cityLabelsLayer = L.layerGroup().addTo(map);
      
      // Add city labels
      addCityLabels();
      
      // Add zoom control with custom position
      L.control.zoom({
        position: 'topright',
        zoomInTitle: '–ó–±—ñ–ª—å—à–∏—Ç–∏',
        zoomOutTitle: '–ó–º–µ–Ω—à–∏—Ç–∏'
      }).addTo(map);
      
      // Update city labels on zoom
      map.on('zoomend', function() {
        updateCityLabelsSize();
      });
      
      console.log('Leaflet map initialized with SVG overlay');
      console.log('Bounds:', SVG_BOUNDS);
      
      // Load GeoJSON and start alarm updates
      loadGeoJSONAndAlarms();
    }
    
    // Load GeoJSON data and initialize alarm layer
    async function loadGeoJSONAndAlarms() {
      try {
        // Load GeoJSON for Ukraine oblasts
        const oblastResponse = await fetch('/static/ukraine_oblasts.geojson');
        if (!oblastResponse.ok) throw new Error('Failed to load oblasts GeoJSON');
        geojsonData = await oblastResponse.json();
        console.log('Oblasts GeoJSON loaded:', geojsonData.features?.length, 'features');
        
        // Load GeoJSON for Ukraine districts (raions 2020)
        const districtResponse = await fetch('/static/ukraine_raions_2020.geojson');
        if (!districtResponse.ok) throw new Error('Failed to load districts GeoJSON');
        districtsGeojsonData = await districtResponse.json();
        console.log('Districts GeoJSON loaded:', districtsGeojsonData.features?.length, 'features');
        
        // Create oblast alarm layer (for State-level alarms)
        alarmLayer = L.geoJSON(geojsonData, {
          style: function(feature) {
            const regionName = feature.properties.NL_NAME_1 || feature.properties.NAME_1;
            const isAlarm = alarmRegions[regionName];
            return {
              fillColor: isAlarm ? '#991b1b' : 'transparent',
              fillOpacity: isAlarm ? 1 : 0,
              color: isAlarm ? '#7f1d1d' : 'transparent',
              weight: isAlarm ? 1 : 0
            };
          },
          onEachFeature: function(feature, layer) {
            const regionName = feature.properties.NL_NAME_1 || feature.properties.NAME_1;
            layer.bindPopup(`<b>${regionName} –æ–±–ª–∞—Å—Ç—å</b>`);
          }
        }).addTo(map);
        
        // Create district alarm layer (for District-level alarms)
        // DEBUG: Force all districts to show as red to test fill
        districtAlarmLayer = L.geoJSON(districtsGeojsonData, {
          style: function(feature) {
            const districtName = feature.properties.name;
            const isAlarm = alarmDistricts[districtName];
            // DEBUG: Force red fill for ALL districts to test
            const forceShow = true; // Set to false in production
            const showAlarm = isAlarm || forceShow;
            return {
              fillColor: showAlarm ? '#b91c1c' : 'transparent',
              fillOpacity: showAlarm ? 0.7 : 0,
              color: showAlarm ? '#7f1d1d' : 'transparent',
              weight: showAlarm ? 1 : 0
            };
          },
          onEachFeature: function(feature, layer) {
            const districtName = feature.properties.name;
            layer.bindPopup(`<b>${districtName}</b>`);
          }
        }).addTo(map);
        
        // Move alarm layers to back (but above SVG)
        alarmLayer.bringToBack();
        districtAlarmLayer.bringToBack();
        
        // Fetch initial alarms
        await fetchAlarms();
        
        // Start regular alarm updates
        setInterval(fetchAlarms, ALARM_UPDATE_INTERVAL);
        
      } catch (error) {
        console.error('Error loading GeoJSON or alarms:', error);
      }
    }
    
    // Fetch alarms from ukrainealarm API
    async function fetchAlarms() {
      try {
        // Use CORS proxy or direct call (depends on your backend setup)
        // For direct call, you need a proxy or backend endpoint
        const response = await fetch('/api/alarms/proxy');
        
        if (!response.ok) {
          throw new Error('Proxy failed');
        }
        
        const data = await response.json();
        updateAlarmLayer(data);
        updateAlarmsList(data);
        
      } catch (error) {
        console.error('Error fetching alarms:', error);
      }
    }
    
    // Update alarms list in sidebar
    function updateAlarmsList(alertsData) {
      const alarmsSection = document.getElementById('alarmsSection');
      const alarmsList = document.getElementById('alarmsList');
      const alarmCount = document.getElementById('alarmCount');
      
      if (!alertsData || (!alertsData.states?.length && !alertsData.districts?.length)) {
        alarmsSection.style.display = 'none';
        return;
      }
      
      alarmsSection.style.display = 'block';
      const totalAlerts = (alertsData.states?.length || 0) + (alertsData.districts?.length || 0);
      alarmCount.textContent = totalAlerts;
      
      let html = '';
      
      // Show State (oblast) alerts first
      if (alertsData.states?.length > 0) {
        alertsData.states.forEach(state => {
          html += `<div style="padding: 8px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 8px;">
            <span style="color: #ef4444; font-size: 14px;">üî¥</span>
            <span style="color: #fca5a5; font-size: 13px; font-weight: 500;">${state.regionName}</span>
            <span style="color: #6b7280; font-size: 11px; margin-left: auto;">–≤—Å—è –æ–±–ª–∞—Å—Ç—å</span>
          </div>`;
        });
      }
      
      // Group districts by oblast
      if (alertsData.districts?.length > 0) {
        const byOblast = {};
        alertsData.districts.forEach(d => {
          const oblast = d.oblast || '–Ü–Ω—à–µ';
          if (!byOblast[oblast]) byOblast[oblast] = [];
          byOblast[oblast].push(d.regionName);
        });
        
        Object.entries(byOblast).forEach(([oblast, districts]) => {
          html += `<div style="padding: 8px 16px; border-bottom: 1px solid rgba(255,255,255,0.05);">
            <div style="color: #fbbf24; font-size: 12px; font-weight: 600; margin-bottom: 4px;">${oblast || '–†–∞–π–æ–Ω'}</div>
            <div style="color: #94a3b8; font-size: 12px; line-height: 1.4;">${districts.join(', ')}</div>
          </div>`;
        });
      }
      
      alarmsList.innerHTML = html;
    }
    
    // Update alarm layer based on API response
    function updateAlarmLayer(alertsData) {
      // Reset alarm regions and districts
      alarmRegions = {};
      alarmDistricts = {};
      
      // Only process State-level alerts for oblast map coloring
      const states = alertsData?.states || [];
      // Process District-level alerts for district map coloring
      const districts = alertsData?.districts || [];
      
      // Fallback mapping for English names (NAME_1 in GeoJSON)
      const ENGLISH_MAPPING = {
        "–ê–≤—Ç–æ–Ω–æ–º–Ω–∞ –†–µ—Å–ø—É–±–ª—ñ–∫–∞ –ö—Ä–∏–º": "Crimea",
        "–õ—å–≤—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "L'viv",
        "–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Dnipropetrovs'k",
        "–î–æ–Ω–µ—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Donets'k",
        "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Kharkiv",
        "–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Kiev",
        "–º. –ö–∏—ó–≤": "KievCity",
        "–û–¥–µ—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Odessa",
        "–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Zaporizhia",
        "–õ—É–≥–∞–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Luhans'k",
        "–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Mykolayiv",
        "–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Kherson",
        "–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Poltava",
        "–ß–µ—Ä–∫–∞—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Cherkasy",
        "–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Chernihiv",
        "–°—É–º—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Sumy",
        "–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Zhytomyr",
        "–í—ñ–Ω–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Vinnytsya",
        "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Khmel'nyts'kyy",
        "–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Rivne",
        "–í–æ–ª–∏–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Volyn",
        "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Ternopil'",
        "–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Ivano-Frankivs'k",
        "–ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Zakarpattia",
        "–ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Chernivtsi",
        "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å": "Kirovohrad",
        "–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å": "Sevastopol'"
      };
      
      // Process State alerts for oblast map coloring
      states.forEach(region => {
        if (region.activeAlerts && region.activeAlerts.length > 0) {
          const geoJsonNameUkr = REGION_MAPPING[region.regionName];
          const geoJsonNameEng = ENGLISH_MAPPING[region.regionName];
          
          if (geoJsonNameUkr) {
            alarmRegions[geoJsonNameUkr] = true;
          }
          if (geoJsonNameEng) {
            alarmRegions[geoJsonNameEng] = true;
          }
        }
      });
      
      // Process District alerts for district map coloring
      districts.forEach(district => {
        if (district.regionName) {
          // Store by exact name from API
          alarmDistricts[district.regionName] = true;
        }
      });
      
      console.log('Active State alarms:', states.length, '| District alarms:', districts.length);
      console.log('Alarm oblasts:', Object.keys(alarmRegions));
      console.log('Alarm districts:', Object.keys(alarmDistricts));
      
      // Update oblast GeoJSON layer style
      if (alarmLayer) {
        alarmLayer.setStyle(function(feature) {
          const regionNameUkr = feature.properties.NL_NAME_1;
          const regionNameEng = feature.properties.NAME_1;
          const isAlarm = alarmRegions[regionNameUkr] || alarmRegions[regionNameEng];
          return {
            fillColor: isAlarm ? '#991b1b' : 'transparent',
            fillOpacity: isAlarm ? 1 : 0,
            color: isAlarm ? '#7f1d1d' : 'transparent',
            weight: isAlarm ? 1 : 0
          };
        });
      }
      
      // Update district GeoJSON layer style
      if (districtAlarmLayer) {
        districtAlarmLayer.setStyle(function(feature) {
          const districtName = feature.properties.name;
          const isAlarm = alarmDistricts[districtName];
          return {
            fillColor: isAlarm ? '#b91c1c' : 'transparent',
            fillOpacity: isAlarm ? 1 : 0,
            color: isAlarm ? '#7f1d1d' : 'transparent',
            weight: isAlarm ? 1 : 0
          };
        });
      }
    }
    
    // Add city labels to map
    function addCityLabels() {
      if (!cityLabelsLayer) return;
      
      const zoom = map.getZoom();
      const scale = Math.pow(2, zoom - 6) * 0.8; // Base scale at zoom 6
      
      CITIES.forEach(city => {
        let baseFontSize = 12, fontWeight = '500', color = '#a0aec0';
        let baseDotSize = 5, dotColor = '#a0aec0';
        
        if (city.size === 'capital') {
          baseFontSize = 14; fontWeight = '600'; color = '#ffffff';
          baseDotSize = 6; dotColor = '#ffffff';
        } else if (city.size === 'major') {
          baseFontSize = 13; fontWeight = '500'; color = '#ffffff';
          baseDotSize = 5; dotColor = '#ffffff';
        } else if (city.size === 'city') {
          baseFontSize = 11; fontWeight = '400'; color = '#a0aec0';
          baseDotSize = 4; dotColor = '#a0aec0';
        }
        
        const fontSize = Math.max(10, Math.min(18, baseFontSize * scale));
        const dotSize = Math.max(3, Math.min(10, baseDotSize * scale));
        
        // Add city dot marker
        const dotIcon = L.divIcon({
          className: 'city-dot',
          html: '<div style="width:' + dotSize + 'px;height:' + dotSize + 'px;background:' + dotColor + ';border-radius:50%;"></div>',
          iconSize: [dotSize, dotSize],
          iconAnchor: [dotSize/2, dotSize/2]
        });
        
        L.marker([city.lat, city.lng], { icon: dotIcon, interactive: false }).addTo(cityLabelsLayer);
        
        // Add city label (offset from dot) - fixed anchor for proper alignment
        const labelOffset = dotSize + 4; // offset below dot
        const labelIcon = L.divIcon({
          className: 'city-label',
          html: '<div style="font-size:' + fontSize + 'px;font-weight:' + fontWeight + ';color:' + color + ';text-shadow:2px 2px 4px rgba(0,0,0,0.9),-2px -2px 4px rgba(0,0,0,0.9);white-space:nowrap;text-align:center;">' + city.name + '</div>',
          iconSize: [0, 0],
          iconAnchor: [0, -labelOffset]
        });
        
        L.marker([city.lat, city.lng], { icon: labelIcon, interactive: false }).addTo(cityLabelsLayer);
      });
      console.log('Added', CITIES.length, 'city labels with dots');
    }
    
    function updateCityLabelsSize() {
      if (!cityLabelsLayer) return;
      cityLabelsLayer.clearLayers();
      addCityLabels();
    }
    
    // Create Leaflet icon for marker
    function createLeafletIcon(iconUrl, iconType) {
      const size = iconType === 'rocket' ? 42 : iconType === 'shahed' ? 40 : 36;
      return L.divIcon({
        className: `threat-marker-icon ${iconType}`,
        html: `<img src="${iconUrl}" alt="threat" style="width:${size}px;height:${size}px;">`,
        iconSize: [size, size],
        iconAnchor: [size/2, size/2],
        popupAnchor: [0, -size/2]
      });
    }
    
    // Update markers on Leaflet map
    function updateMarkers(points) {
      if (!map || !markerLayer) return;
      
      // Clear existing markers
      markerLayer.clearLayers();
      
      points.forEach((point) => {
        if (!point.lat || !point.lng) return;
        
        // Check bounds
        if (point.lat < UA_BOUNDS.south || point.lat > UA_BOUNDS.north ||
            point.lng < UA_BOUNDS.west || point.lng > UA_BOUNDS.east) {
          return;
        }
        
        // Get icon
        const icon = getPngIcon(point.threat_type || point.type);
        const leafletIcon = createLeafletIcon(icon.url, icon.type);
        
        // Create marker at exact lat/lng
        const marker = L.marker([point.lat, point.lng], { icon: leafletIcon });
        
        // Add popup
        const popupContent = `
          <div class="popup-title">${point.place || '–ó–∞–≥—Ä–æ–∑–∞'}</div>
          <div class="popup-text">${point.text || ''}</div>
          <div class="popup-time">${point.date || ''}</div>
        `;
        marker.bindPopup(popupContent);
        
        // Add to layer
        marker.addTo(markerLayer);
      });
      
      console.log('Updated', points.length, 'markers on Leaflet map');
    }
    
    // Demo threats data
    const DEMO_THREATS = [
      { lat: 49.0164, lng: 36.3097, place: '–õ–æ–∑–æ–≤–∞', text: '–ó–∞–≥—Ä–æ–∑–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –ë–ü–õ–ê', threat_type: 'shahed', oblast: '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞' },
      { lat: 48.5161, lng: 34.5333, place: '–¢–µ—Ä–Ω—ñ–≤–∫–∞', text: '–ó–∞–≥—Ä–æ–∑–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –ë–ü–õ–ê', threat_type: 'shahed', oblast: '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞' },
      { lat: 48.4564, lng: 35.8478, place: '–ü–µ—Ç—Ä–æ–ø–∞–≤–ª—ñ–≤–∫–∞', text: '–ó–∞–≥—Ä–æ–∑–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –ë–ü–õ–ê', threat_type: 'shahed', oblast: '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞' },
      { lat: 50.0750, lng: 31.4667, place: '–ü–µ—Ä–µ—è—Å–ª–∞–≤', text: '–ó–∞–≥—Ä–æ–∑–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –ë–ü–õ–ê', threat_type: 'shahed', oblast: '–ö–∏—ó–≤—Å—å–∫–∞' },
      { lat: 49.0378, lng: 36.9956, place: '–ë–∞—Ä–≤—ñ–Ω–∫–æ–≤–µ', text: '2—Ö –ë–ü–õ–ê - –ó–∞–≥—Ä–æ–∑–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è', threat_type: 'shahed', oblast: '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞' },
      { lat: 47.0764, lng: 32.7978, place: '–°–Ω—ñ–≥—É—Ä—ñ–≤–∫–∞', text: '–ó–∞–≥—Ä–æ–∑–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –ë–ü–õ–ê', threat_type: 'shahed', oblast: '–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞' },
      { lat: 49.1981, lng: 37.2553, place: '–Ü–∑—é–º', text: '–ó–∞–≥—Ä–æ–∑–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –ë–ü–õ–ê', threat_type: 'shahed', oblast: '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞' },
      { lat: 46.6, lng: 30.05, place: '–î–æ–±—Ä–æ—Å–ª–∞–≤', text: '2—Ö –ë–ü–õ–ê - –ó–∞–≥—Ä–æ–∑–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è', threat_type: 'shahed', oblast: '–û–¥–µ—Å—å–∫–∞' },
      { lat: 46.6354, lng: 32.6169, place: '–•–µ—Ä—Å–æ–Ω', text: '–ó–∞–≥—Ä–æ–∑–∞ –æ–±—Å—Ç—Ä—ñ–ª—É! –ü–µ—Ä–µ–π–¥—ñ—Ç—å –≤ —É–∫—Ä–∏—Ç—Ç—è!', threat_type: 'artillery', oblast: '–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞' },
      { lat: 46.4825, lng: 30.7233, place: '–û–¥–µ—Å–∞', text: '–ó–ú–Ü –ø–æ–≤—ñ–¥–æ–º–ª—è—é—Ç—å –ø—Ä–æ –≤–∏–±—É—Ö–∏', threat_type: 'vibuh', oblast: '–û–¥–µ—Å—å–∫–∞' },
    ];
    
    // Toggle demo mode
    let demoMode = false;
    
    function toggleDemoMode() {
      demoMode = !demoMode;
      const btn = document.getElementById('demoBtn');
      if (demoMode) {
        updateMarkers(DEMO_THREATS);
        updateEventsList(DEMO_THREATS);
        if (btn) btn.style.background = 'var(--danger)';
      } else {
        if (markerLayer) markerLayer.clearLayers();
        fetchData();
        if (btn) btn.style.background = '';
      }
    }
    
    // ===== SIDEBAR FUNCTIONS =====
    function toggleSidebar() {
      sidebarOpen = !sidebarOpen;
      const sidebar = document.getElementById('sidebar');
      const btn = document.querySelector('.sidebar-toggle-btn i');
      
      if (sidebarOpen) {
        sidebar.classList.remove('collapsed');
        btn.textContent = 'chevron_left';
      } else {
        sidebar.classList.add('collapsed');
        btn.textContent = 'chevron_right';
      }
    }
    
    function toggleTheme() {
      document.querySelector('.theme-toggle').classList.toggle('light');
    }
    
    function showStats() {
      window.open('/analytics', '_blank');
    }
    
    function updateTime() {
      const now = new Date();
      const options = { day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' };
      document.getElementById('updateTime').textContent = now.toLocaleDateString('uk-UA', options);
    }
    
    // Update events list
    function updateEventsList(points) {
      const list = document.getElementById('eventsList');
      if (!list) return;
      
      if (!points || !points.length) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text2);">–ü–æ–¥—ñ–π –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
        return;
      }
      
      // Count threats
      let airCount = 0, artilleryCount = 0, shahedCount = 0;
      
      points.forEach(p => {
        const tt = (p.threat_type || '').toLowerCase();
        if (tt.includes('shahed') || tt.includes('—à–∞—Ö–µ–¥')) shahedCount++;
        else if (tt.includes('artillery') || tt.includes('–∞—Ä—Ç')) artilleryCount++;
        else if (tt.includes('avia') || tt.includes('–∞–≤—ñ–∞') || tt.includes('air')) airCount++;
      });
      
      // Update counters
      document.getElementById('countAir').textContent = airCount;
      document.getElementById('countArtillery').textContent = artilleryCount;
      document.getElementById('sidebarAir').textContent = airCount;
      document.getElementById('sidebarArtillery').textContent = artilleryCount;
      document.getElementById('sidebarShahed').textContent = shahedCount;
      
      // Generate events HTML
      list.innerHTML = points.slice(0, 50).map(ev => {
        const threatType = ev.threat_type || 'default';
        const icon = ICONS[threatType] || ICONS.default;
        const place = ev.place || '–£–∫—Ä–∞—ó–Ω–∞';
        const text = ev.text || '';
        const time = ev.date || '';
        
        // Type label
        const typeLabels = {
          'shahed': '–ë–ü–õ–ê Shahed',
          'rocket': '–ë–∞–ª—ñ—Å—Ç–∏—á–Ω–∞/–∫—Ä–∏–ª–∞—Ç–∞ —Ä–∞–∫–µ—Ç–∞',
          'avia': '–ü–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞',
          'artillery': '–ó–∞–≥—Ä–æ–∑–∞ –∞—Ä—Ç–æ–±—Å—Ç—Ä—ñ–ª—É',
          'fpv': 'FPV-–¥—Ä–æ–Ω',
          'default': '–ó–∞–≥—Ä–æ–∑–∞'
        };
        const typeLabel = typeLabels[threatType] || typeLabels.default;
        
        return `
          <div class="event-item">
            <span class="event-icon">${icon}</span>
            <div class="event-content">
              <div class="event-place">${place}</div>
              <div class="event-type">${typeLabel}</div>
              <div class="event-time">${time}</div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Fetch data from API
    async function fetchData() {
      try {
        const response = await fetch(API_URL);
        if (!response.ok) throw new Error('API error');
        const data = await response.json();
        // API returns { tracks: [...], events: [...] }
        currentData = data.tracks || data.points || data || [];
        console.log('Fetched data:', currentData.length, 'tracks');
        
        updateMarkers(currentData);
        updateEventsList(currentData);
        updateTime();
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }
    
    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize Leaflet map
      initMap();
      
      updateTime();
      
      // Load demo data initially
      if (demoMode) {
        updateMarkers(DEMO_THREATS);
        updateEventsList(DEMO_THREATS);
      } else {
        fetchData();
      }
      
      // Regular data updates (only if not in demo mode)
      setInterval(() => {
        if (!demoMode) {
          fetchData();
        }
      }, UPDATE_INTERVAL);
    });
  </script>
</body>
</html>