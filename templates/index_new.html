<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Карта тривог України | NEPTUN</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- TopoJSON client for shared boundaries -->
  <script src="https://unpkg.com/topojson-client@3"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --main-bg: #1e2433;
      --text: #ffffff;
      --text-muted: #718096;
      --accent: #4299e1;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    
    body {
      background: var(--main-bg);
    }
    
    #map {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--main-bg);
    }
    
    /* Leaflet customization */
    .leaflet-container {
      background: var(--main-bg) !important;
    }
    
    .leaflet-control-zoom {
      border: none !important;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4) !important;
      border-radius: 12px !important;
      overflow: hidden;
    }
    
    .leaflet-control-zoom a {
      background: rgba(36, 43, 69, 0.95) !important;
      color: var(--text) !important;
      border: 1px solid rgba(74, 158, 255, 0.2) !important;
      width: 40px !important;
      height: 40px !important;
      line-height: 40px !important;
      font-size: 20px !important;
    }
    
    .leaflet-control-zoom a:hover {
      background: rgba(74, 158, 255, 0.3) !important;
    }
    
    /* Marker styles */
    .threat-marker-icon {
      background: transparent !important;
      border: none !important;
    }
    
    .threat-marker-icon img {
      width: 36px;
      height: 36px;
      filter: drop-shadow(0 3px 8px rgba(220, 38, 38, 0.6));
      animation: marker-pulse 2s ease-in-out infinite;
    }
    
    .threat-marker-icon.shahed img {
      width: 40px;
      height: 40px;
    }
    
    .threat-marker-icon.rocket img {
      width: 42px;
      height: 42px;
      filter: drop-shadow(0 3px 8px rgba(249, 115, 22, 0.7));
    }
    
    @keyframes marker-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    /* Popup styling */
    .leaflet-popup-content-wrapper {
      background: rgba(36, 43, 69, 0.98) !important;
      color: var(--text) !important;
      border: 1px solid rgba(74, 158, 255, 0.25) !important;
      border-radius: 12px !important;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5) !important;
    }
    
    .leaflet-popup-tip {
      background: rgba(36, 43, 69, 0.98) !important;
    }
    
    .leaflet-popup-content {
      margin: 12px 16px !important;
      font-size: 13px;
    }
    
    .popup-title {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 6px;
    }
    
    .popup-text {
      color: var(--text-muted);
      font-size: 12px;
    }
    
    .popup-time {
      color: var(--accent);
      font-size: 11px;
      margin-top: 6px;
    }
    
    /* City labels */
    .city-label {
      background: transparent !important;
      border: none !important;
      transform: translateX(-50%);
    }
    
    .city-dot {
      background: transparent !important;
      border: none !important;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // ===== CONFIG =====
    const API_URL = '/data';
    const UPDATE_INTERVAL = 10000;
    
    const UA_BOUNDS = {
      south: 44.387017,
      north: 52.380834,
      west: 22.138577,
      east: 40.220623,
      center: [48.5, 31.5]
    };
    
    const SVG_BOUNDS = [[UA_BOUNDS.south, UA_BOUNDS.west], [UA_BOUNDS.north, UA_BOUNDS.east]];
    
    const PNG_ICONS = {
      shahed: '/static/shahed.png',
      rocket: '/static/raketa.png',
      avia: '/static/avia.png',
      artillery: '/static/artillery.png',
      fpv: '/static/fpv.png',
      pusk: '/static/pusk.png',
      vibuh: '/static/vibuh.png',
      kab: '/static/kab.png',
      default: '/static/default.png'
    };
    
    // ===== ALARM API CONFIG =====
    const ALARM_UPDATE_INTERVAL = 30000;
    
    const REGION_MAPPING = {
      "Вінницька область": "Вінницька",
      "Волинська область": "Волинська",
      "Дніпропетровська область": "Дніпропетро́вська",
      "Донецька область": "Доне́цька",
      "Житомирська область": "Житомирська",
      "Закарпатська область": "Закарпатська",
      "Запорізька область": "Запорізька",
      "Івано-Франківська область": "Івано-Франківська",
      "Київська область": "Київська",
      "Кіровоградська область": "Кіровоградська",
      "Луганська область": "Луганська",
      "Львівська область": "Львівська",
      "Миколаївська область": "Миколаївська",
      "Одеська область": "Одеська",
      "Полтавська область": "Полтавська",
      "Рівненська область": "Рівненська",
      "Сумська область": "Сумська",
      "Тернопільська область": "Тернопільська",
      "Харківська область": "Харківська",
      "Херсонська область": "Херсонська",
      "Хмельницька область": "Хмельницька",
      "Черкаська область": "Черкаська",
      "Чернівецька область": "Чернівецька",
      "Чернігівська область": "Чернігівська",
      "м. Київ": "Київ",
      "Автономна Республіка Крим": "Крим",
      "Севастополь": "Севастополь"
    };

    const OBLAST_NORMALIZE = {
      "Вінницька область": "Вінницька",
      "Волинська область": "Волинська",
      "Дніпропетровська область": "Дніпропетровська",
      "Донецька область": "Донецька",
      "Житомирська область": "Житомирська",
      "Закарпатська область": "Закарпатська",
      "Запорізька область": "Запорізька",
      "Івано-Франківська область": "Івано-Франківська",
      "Київська область": "Київська",
      "Кіровоградська область": "Кіровоградська",
      "Луганська область": "Луганська",
      "Львівська область": "Львівська",
      "Миколаївська область": "Миколаївська",
      "Одеська область": "Одеська",
      "Полтавська область": "Полтавська",
      "Рівненська область": "Рівненська",
      "Сумська область": "Сумська",
      "Тернопільська область": "Тернопільська",
      "Харківська область": "Харківська",
      "Херсонська область": "Херсонська",
      "Хмельницька область": "Хмельницька",
      "Черкаська область": "Черкаська",
      "Чернівецька область": "Чернівецька",
      "Чернігівська область": "Чернігівська",
      "м. Київ": "Київ"
    };

    const DISTRICT_TO_OBLAST = {
      "Вінницький район": "Вінницька",
      "Гайсинський район": "Вінницька",
      "Жмеринський район": "Вінницька",
      "Могилів-Подільський район": "Вінницька",
      "Тульчинський район": "Вінницька",
      "Хмільницький район": "Вінницька",
      "Володимирський район": "Волинська",
      "Камінь-Каширський район": "Волинська",
      "Ковельський район": "Волинська",
      "Луцький район": "Волинська",
      "Дніпровський район": "Дніпропетровська",
      "Кам'янський район": "Дніпропетровська",
      "Криворізький район": "Дніпропетровська",
      "Нікопольський район": "Дніпропетровська",
      "Новомосковський район": "Дніпропетровська",
      "Павлоградський район": "Дніпропетровська",
      "Синельниківський район": "Дніпропетровська",
      "Бахмутський район": "Донецька",
      "Волноваський район": "Донецька",
      "Горлівський район": "Донецька",
      "Донецький район": "Донецька",
      "Кальміуський район": "Донецька",
      "Краматорський район": "Донецька",
      "Маріупольський район": "Донецька",
      "Покровський район": "Донецька",
      "Бердичівський район": "Житомирська",
      "Житомирський район": "Житомирська",
      "Коростенський район": "Житомирська",
      "Новоград-Волинський район": "Житомирська",
      "Берегівський район": "Закарпатська",
      "Мукачівський район": "Закарпатська",
      "Рахівський район": "Закарпатська",
      "Тячівський район": "Закарпатська",
      "Ужгородський район": "Закарпатська",
      "Хустський район": "Закарпатська",
      "Бердянський район": "Запорізька",
      "Василівський район": "Запорізька",
      "Запорізький район": "Запорізька",
      "Мелітопольський район": "Запорізька",
      "Пологівський район": "Запорізька",
      "Верховинський район": "Івано-Франківська",
      "Івано-Франківський район": "Івано-Франківська",
      "Калуський район": "Івано-Франківська",
      "Коломийський район": "Івано-Франківська",
      "Косівський район": "Івано-Франківська",
      "Надвірнянський район": "Івано-Франківська",
      "Білоцерківський район": "Київська",
      "Бориспільський район": "Київська",
      "Броварський район": "Київська",
      "Бучанський район": "Київська",
      "Вишгородський район": "Київська",
      "Обухівський район": "Київська",
      "Фастівський район": "Київська",
      "Голованівський район": "Кіровоградська",
      "Кропивницький район": "Кіровоградська",
      "Новоукраїнський район": "Кіровоградська",
      "Олександрійський район": "Кіровоградська",
      "Алчевський район": "Луганська",
      "Довжанський район": "Луганська",
      "Луганський район": "Луганська",
      "Ровеньківський район": "Луганська",
      "Свердловський район": "Луганська",
      "Сєвєродонецький район": "Луганська",
      "Старобільський район": "Луганська",
      "Щастинський район": "Луганська",
      "Дрогобицький район": "Львівська",
      "Золочівський район": "Львівська",
      "Львівський район": "Львівська",
      "Самбірський район": "Львівська",
      "Стрийський район": "Львівська",
      "Червоноградський район": "Львівська",
      "Яворівський район": "Львівська",
      "Баштанський район": "Миколаївська",
      "Вознесенський район": "Миколаївська",
      "Миколаївський район": "Миколаївська",
      "Первомайський район": "Миколаївська",
      "Білгород-Дністровський район": "Одеська",
      "Березівський район": "Одеська",
      "Болградський район": "Одеська",
      "Ізмаїльський район": "Одеська",
      "Одеський район": "Одеська",
      "Подільський район": "Одеська",
      "Роздільнянський район": "Одеська",
      "Кременчуцький район": "Полтавська",
      "Лубенський район": "Полтавська",
      "Миргородський район": "Полтавська",
      "Полтавський район": "Полтавська",
      "Вараський район": "Рівненська",
      "Дубенський район": "Рівненська",
      "Рівненський район": "Рівненська",
      "Сарненський район": "Рівненська",
      "Конотопський район": "Сумська",
      "Охтирський район": "Сумська",
      "Роменський район": "Сумська",
      "Сумський район": "Сумська",
      "Шосткинський район": "Сумська",
      "Кременецький район": "Тернопільська",
      "Тернопільський район": "Тернопільська",
      "Чортківський район": "Тернопільська",
      "Богодухівський район": "Харківська",
      "Ізюмський район": "Харківська",
      "Красноградський район": "Харківська",
      "Куп'янський район": "Харківська",
      "Лозівський район": "Харківська",
      "Харківський район": "Харківська",
      "Чугуївський район": "Харківська",
      "Бериславський район": "Херсонська",
      "Генічеський район": "Херсонська",
      "Каховський район": "Херсонська",
      "Скадовський район": "Херсонська",
      "Херсонський район": "Херсонська",
      "Кам'янець-Подільський район": "Хмельницька",
      "Хмельницький район": "Хмельницька",
      "Шепетівський район": "Хмельницька",
      "Звенигородський район": "Черкаська",
      "Золотоніський район": "Черкаська",
      "Уманський район": "Черкаська",
      "Черкаський район": "Черкаська",
      "Вижницький район": "Чернівецька",
      "Дністровський район": "Чернівецька",
      "Чернівецький район": "Чернівецька",
      "Корюківський район": "Чернігівська",
      "Ніжинський район": "Чернігівська",
      "Новгород-Сіверський район": "Чернігівська",
      "Прилуцький район": "Чернігівська",
      "Чернігівський район": "Чернігівська",
      "Бахчисарайський район": "Крим",
      "Білогірський район": "Крим",
      "Джанкойський район": "Крим",
      "Кіровський район": "Крим",
      "Красногвардійський район": "Крим",
      "Красноперекопський район": "Крим",
      "Ленінський район": "Крим",
      "Нижньогірський район": "Крим",
      "Первомайський район": "Крим",
      "Роздольненський район": "Крим",
      "Сакський район": "Крим",
      "Сімферопольський район": "Крим",
      "Совєтський район": "Крим",
      "Чорноморський район": "Крим"
    };

    // ===== STATE =====
    let currentData = [];
    let map = null;
    let markerLayer = null;
    let svgOverlay = null;
    let cityLabelsLayer = null;
    let alarmLayer = null;
    let districtAlarmLayer = null;
    let alarmRegions = {};
    let alarmDistricts = {};
    let geojsonData = null;
    let districtsGeojsonData = null;

    const CITIES = [
      { name: "Київ", lat: 50.4501, lng: 30.5234, size: "capital" },
      { name: "Харків", lat: 49.9935, lng: 36.2304, size: "major" },
      { name: "Одеса", lat: 46.4825, lng: 30.7233, size: "major" },
      { name: "Дніпро", lat: 48.4647, lng: 35.0462, size: "major" },
      { name: "Львів", lat: 49.8397, lng: 24.0297, size: "major" },
      { name: "Запоріжжя", lat: 47.8388, lng: 35.1396, size: "major" },
      { name: "Миколаїв", lat: 46.9750, lng: 31.9946, size: "city" },
      { name: "Херсон", lat: 46.6354, lng: 32.6169, size: "city" },
      { name: "Вінниця", lat: 49.2331, lng: 28.4682, size: "city" },
      { name: "Полтава", lat: 49.5883, lng: 34.5514, size: "city" },
      { name: "Чернігів", lat: 51.4982, lng: 31.2893, size: "city" },
      { name: "Суми", lat: 50.9077, lng: 34.7981, size: "city" },
      { name: "Житомир", lat: 50.2547, lng: 28.6587, size: "city" },
      { name: "Черкаси", lat: 49.4444, lng: 32.0598, size: "city" },
      { name: "Рівне", lat: 50.6199, lng: 26.2516, size: "city" },
      { name: "Луцьк", lat: 50.7472, lng: 25.3254, size: "city" },
      { name: "Тернопіль", lat: 49.5535, lng: 25.5948, size: "city" },
      { name: "Хмельницький", lat: 49.4230, lng: 26.9871, size: "city" },
      { name: "Івано-Франківськ", lat: 48.9226, lng: 24.7111, size: "city" },
      { name: "Ужгород", lat: 48.6208, lng: 22.2879, size: "city" },
      { name: "Чернівці", lat: 48.2920, lng: 25.9358, size: "city" },
      { name: "Кропивницький", lat: 48.5079, lng: 32.2623, size: "city" },
    ];
    
    function getPngIcon(threatType) {
      const tt = (threatType || '').toLowerCase();
      
      if (tt.includes('shahed') || tt.includes('шахед') || tt.includes('бпла') || tt.includes('дрон')) {
        return { url: PNG_ICONS.shahed, type: 'shahed' };
      } else if (tt.includes('rocket') || tt.includes('ракет') || tt.includes('балі') || tt.includes('крила') || tt.includes('високошвидкісн')) {
        return { url: PNG_ICONS.rocket, type: 'rocket' };
      } else if (tt.includes('avia') || tt.includes('авіа') || tt.includes('мі')) {
        return { url: PNG_ICONS.avia, type: 'avia' };
      } else if (tt.includes('artillery') || tt.includes('арт') || tt.includes('обстріл')) {
        return { url: PNG_ICONS.artillery, type: 'artillery' };
      } else if (tt.includes('fpv') || tt.includes('фпв')) {
        return { url: PNG_ICONS.fpv, type: 'fpv' };
      } else if (tt.includes('pusk') || tt.includes('пуск')) {
        return { url: PNG_ICONS.pusk, type: 'pusk' };
      } else if (tt.includes('kab') || tt.includes('каб')) {
        return { url: PNG_ICONS.kab, type: 'kab' };
      } else if (tt.includes('vibuh') || tt.includes('вибух') || tt.includes('вибухи')) {
        return { url: PNG_ICONS.vibuh, type: 'vibuh' };
      }
      return { url: PNG_ICONS.default, type: 'default' };
    }
    
    function initMap() {
      map = L.map('map', {
        center: UA_BOUNDS.center,
        zoom: 6,
        minZoom: 5,
        maxZoom: 10,
        zoomControl: false,
        attributionControl: false,
        crs: L.CRS.EPSG3857
      });
      
      svgOverlay = L.imageOverlay('/static/ukraine_mapsvg.svg', SVG_BOUNDS, {
        opacity: 1,
        interactive: false,
        className: 'svg-map-layer'
      }).addTo(map);
      
      map.fitBounds(SVG_BOUNDS);
      
      markerLayer = L.layerGroup().addTo(map);
      cityLabelsLayer = L.layerGroup().addTo(map);
      
      addCityLabels();
      
      L.control.zoom({
        position: 'topright',
        zoomInTitle: 'Збільшити',
        zoomOutTitle: 'Зменшити'
      }).addTo(map);
      
      map.on('zoomend', function() {
        updateCityLabelsSize();
      });
      
      loadGeoJSONAndAlarms();
    }
    
    async function loadGeoJSONAndAlarms() {
      try {
        const oblastResponse = await fetch('/static/ukraine_oblasts.geojson');
        if (!oblastResponse.ok) throw new Error('Failed to load oblasts GeoJSON');
        geojsonData = await oblastResponse.json();
        
        // Load TopoJSON for districts (shared boundaries = no gaps)
        const districtResponse = await fetch('/static/ukraine_raions_2020.topojson?v=3');
        if (!districtResponse.ok) throw new Error('Failed to load districts TopoJSON');
        const topoData = await districtResponse.json();
        // Convert TopoJSON to GeoJSON
        districtsGeojsonData = topojson.feature(topoData, topoData.objects.districts);
        console.log('Districts loaded from TopoJSON:', districtsGeojsonData.features?.length);
        
        alarmLayer = L.geoJSON(geojsonData, {
          style: function(feature) {
            const regionName = feature.properties.NL_NAME_1 || feature.properties.NAME_1;
            const isAlarm = alarmRegions[regionName];
            return {
              fillColor: isAlarm ? '#991b1b' : 'transparent',
              fillOpacity: isAlarm ? 1 : 0,
              color: isAlarm ? '#7f1d1d' : 'transparent',
              weight: isAlarm ? 1 : 0
            };
          },
          onEachFeature: function(feature, layer) {
            const regionName = feature.properties.NL_NAME_1 || feature.properties.NAME_1;
            layer.bindPopup(`<b>${regionName} область</b>`);
          }
        }).addTo(map);
        
        const svgRenderer = L.svg();
        
        districtAlarmLayer = L.geoJSON(districtsGeojsonData, {
          renderer: svgRenderer,
          style: function(feature) {
            const districtName = feature.properties.name;
            const isAlarm = alarmDistricts[districtName];
            return {
              fillColor: isAlarm ? '#b91c1c' : 'transparent',
              fillOpacity: isAlarm ? 1 : 0,
              // No stroke - TopoJSON handles shared boundaries
              color: 'transparent',
              weight: 0
            };
          },
          onEachFeature: function(feature, layer) {
            const districtName = feature.properties.name;
            layer.bindPopup(`<b>${districtName}</b>`);
          }
        }).addTo(map);
        
        alarmLayer.bringToBack();
        districtAlarmLayer.bringToBack();
        
        await fetchAlarms();
        setInterval(fetchAlarms, ALARM_UPDATE_INTERVAL);
        
      } catch (error) {
        console.error('Error loading GeoJSON or alarms:', error);
      }
    }
    
    let lastAlarmsData = null;
    
    async function fetchAlarms() {
      try {
        const response = await fetch('/api/alarms/proxy');
        if (!response.ok) throw new Error('Alarm API error');
        const data = await response.json();
        
        if (JSON.stringify(data) === JSON.stringify(lastAlarmsData)) {
          return;
        }
        lastAlarmsData = data;
        
        alarmRegions = {};
        alarmDistricts = {};
        
        if (data.states) {
          data.states.forEach(s => {
            if (s.regionName) {
              const mappedName = REGION_MAPPING[s.regionName];
              if (mappedName) {
                alarmRegions[mappedName] = true;
              }
              alarmRegions[s.regionName] = true;
            }
          });
        }
        
        if (data.districts) {
          data.districts.forEach(d => {
            if (d.regionName) {
              alarmDistricts[d.regionName] = true;
            }
          });
        }
        
        updateAlarmStyles();
        
      } catch (error) {
        console.error('Error fetching alarms:', error);
      }
    }
    
    function updateAlarmStyles() {
      if (alarmLayer) {
        alarmLayer.setStyle(function(feature) {
          const regionName = feature.properties.NL_NAME_1 || feature.properties.NAME_1;
          const isAlarm = alarmRegions[regionName] || alarmRegions[regionName + ' область'];
          return {
            fillColor: isAlarm ? '#991b1b' : 'transparent',
            fillOpacity: isAlarm ? 1 : 0,
            color: isAlarm ? '#7f1d1d' : 'transparent',
            weight: isAlarm ? 1 : 0
          };
        });
      }
      
      if (districtAlarmLayer) {
        const alarmedOblasts = new Set();
        
        Object.keys(alarmRegions).forEach(regionName => {
          if (alarmRegions[regionName]) {
            alarmedOblasts.add(regionName);
            const normalized = OBLAST_NORMALIZE[regionName];
            if (normalized) alarmedOblasts.add(normalized);
          }
        });
        
        districtAlarmLayer.setStyle(function(feature) {
          const districtName = feature.properties.name;
          const districtOblast = DISTRICT_TO_OBLAST[districtName];
          const isAlarm = alarmDistricts[districtName] || (districtOblast && alarmedOblasts.has(districtOblast));
          
          return {
            fillColor: isAlarm ? '#b91c1c' : 'transparent',
            fillOpacity: isAlarm ? 1 : 0,
            // No stroke - TopoJSON shared boundaries prevent gaps
            color: 'transparent',
            weight: 0
          };
        });
      }
    }
    
    function addCityLabels() {
      if (!cityLabelsLayer) return;
      
      const zoom = map.getZoom();
      
      CITIES.forEach(city => {
        const sizeConfig = {
          capital: { fontSize: 16, fontWeight: 700, dotSize: 8 },
          major: { fontSize: 14, fontWeight: 600, dotSize: 6 },
          city: { fontSize: 12, fontWeight: 500, dotSize: 4 }
        };
        const config = sizeConfig[city.size] || sizeConfig.city;
        
        if (city.size === 'city' && zoom < 6) return;
        
        const labelIcon = L.divIcon({
          className: 'city-label',
          html: `<div style="
            color: rgba(255,255,255,0.9);
            font-size: ${config.fontSize}px;
            font-weight: ${config.fontWeight};
            text-shadow: 0 1px 3px rgba(0,0,0,0.8), 0 0 10px rgba(0,0,0,0.5);
            white-space: nowrap;
            pointer-events: none;
          ">${city.name}</div>`,
          iconSize: [0, 0],
          iconAnchor: [0, -10]
        });
        
        L.marker([city.lat, city.lng], { icon: labelIcon, interactive: false })
          .addTo(cityLabelsLayer);
        
        const dotIcon = L.divIcon({
          className: 'city-dot',
          html: `<div style="
            width: ${config.dotSize}px;
            height: ${config.dotSize}px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            box-shadow: 0 0 6px rgba(255,255,255,0.5);
          "></div>`,
          iconSize: [config.dotSize, config.dotSize],
          iconAnchor: [config.dotSize/2, config.dotSize/2]
        });
        
        L.marker([city.lat, city.lng], { icon: dotIcon, interactive: false })
          .addTo(cityLabelsLayer);
      });
    }
    
    function updateCityLabelsSize() {
      cityLabelsLayer.clearLayers();
      addCityLabels();
    }
    
    function createLeafletIcon(iconUrl, iconType) {
      const sizeMap = {
        shahed: [40, 40],
        rocket: [42, 42],
        default: [36, 36]
      };
      const size = sizeMap[iconType] || sizeMap.default;
      
      return L.divIcon({
        className: `threat-marker-icon ${iconType}`,
        html: `<img src="${iconUrl}" style="width: ${size[0]}px; height: ${size[1]}px;">`,
        iconSize: size,
        iconAnchor: [size[0]/2, size[1]/2],
        popupAnchor: [0, -size[1]/2]
      });
    }
    
    function updateMarkers(points) {
      if (!markerLayer) return;
      markerLayer.clearLayers();
      
      points.forEach((point) => {
        if (!point.lat || !point.lng) return;
        
        if (point.lat < UA_BOUNDS.south || point.lat > UA_BOUNDS.north ||
            point.lng < UA_BOUNDS.west || point.lng > UA_BOUNDS.east) {
          return;
        }
        
        const icon = getPngIcon(point.threat_type || point.type);
        const leafletIcon = createLeafletIcon(icon.url, icon.type);
        
        const marker = L.marker([point.lat, point.lng], { icon: leafletIcon });
        
        const popupContent = `
          <div class="popup-title">${point.place || 'Загроза'}</div>
          <div class="popup-text">${point.text || ''}</div>
          <div class="popup-time">${point.date || ''}</div>
        `;
        marker.bindPopup(popupContent);
        marker.addTo(markerLayer);
      });
    }
    
    async function fetchData() {
      try {
        const response = await fetch(API_URL);
        if (!response.ok) throw new Error('API error');
        const data = await response.json();
        currentData = data.tracks || data.points || data || [];
        updateMarkers(currentData);
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      fetchData();
      setInterval(fetchData, UPDATE_INTERVAL);
    });
  </script>
</body>
</html>
