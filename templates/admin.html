<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸŒŠ Neptun Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0e1a;--card:#141b2d;--border:#1e2942;--blue:#3b82f6;--purple:#8b5cf6;--green:#10b981;--red:#ef4444;--yellow:#f59e0b;--text:#f1f5f9;--muted:#64748b}
body{font-family:'Inter',system-ui,sans-serif;background:linear-gradient(135deg,#0a0e1a,#1a1f35);color:var(--text);min-height:100vh;line-height:1.6}
.container{max-width:1600px;margin:0 auto;padding:1.5rem}
.header{background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(139,92,246,0.1));backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:1rem;padding:1.5rem 2rem;margin-bottom:2rem;box-shadow:0 8px 32px rgba(0,0,0,0.4)}
.header-content{display:flex;align-items:center;justify-content:space-between;gap:1.5rem;flex-wrap:wrap}
.header-title h1{font-size:2rem;font-weight:800;background:linear-gradient(135deg,var(--blue),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-0.5px}
.status-badges{display:flex;gap:0.75rem;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;gap:0.5rem;padding:0.5rem 1rem;border-radius:0.5rem;font-size:0.875rem;font-weight:600;border:1px solid}
.badge.success{background:rgba(16,185,129,0.2);border-color:rgba(16,185,129,0.5);color:#10b981}
.badge.danger{background:rgba(239,68,68,0.2);border-color:rgba(239,68,68,0.5);color:#ef4444}
.badge.info{background:rgba(59,130,246,0.2);border-color:rgba(59,130,246,0.5);color:#3b82f6}
.badge.warning{background:rgba(245,158,11,0.2);border-color:rgba(245,158,11,0.5);color:#f59e0b}
.status-dot{width:8px;height:8px;border-radius:50%;animation:pulse 2s infinite}
.status-dot.online{background:#10b981;box-shadow:0 0 12px rgba(16,185,129,0.8)}
.status-dot.offline{background:var(--muted)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.btn{display:inline-flex;align-items:center;gap:0.5rem;padding:0.75rem 1.25rem;border:none;border-radius:0.5rem;font-size:0.875rem;font-weight:600;cursor:pointer;transition:all 0.2s;text-decoration:none;white-space:nowrap}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.btn-primary{background:linear-gradient(135deg,var(--blue),#6366f1);color:#fff}
.btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 24px rgba(59,130,246,0.5)}
.btn-success{background:linear-gradient(135deg,var(--green),#059669);color:#fff}
.btn-success:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 24px rgba(16,185,129,0.5)}
.btn-danger{background:linear-gradient(135deg,var(--red),#dc2626);color:#fff}
.btn-danger:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 24px rgba(239,68,68,0.5)}
.btn-warning{background:linear-gradient(135deg,var(--yellow),#d97706);color:#fff}
.btn-secondary{background:var(--card);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover:not(:disabled){border-color:var(--blue);transform:translateY(-2px)}
.btn-sm{padding:0.5rem 0.875rem;font-size:0.8rem}
.input{background:rgba(10,14,26,0.8);border:1px solid var(--border);border-radius:0.5rem;padding:0.75rem 1rem;color:var(--text);font-size:0.875rem;transition:all 0.2s;width:100%}
.input:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,130,246,0.2)}
textarea.input{resize:vertical;min-height:80px;font-family:inherit}
.card{background:linear-gradient(135deg,rgba(20,27,45,0.8),rgba(30,41,66,0.6));backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:1rem;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,0.3);transition:all 0.3s;margin-bottom:2rem}
.card:hover{transform:translateY(-4px);box-shadow:0 8px 32px rgba(0,0,0,0.5);border-color:rgba(59,130,246,0.3)}
.card-header{background:rgba(30,41,66,0.5);padding:1.25rem 1.75rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem}
.card-title{font-size:1.125rem;font-weight:700;display:flex;align-items:center;gap:0.5rem}
.card-body{padding:1.75rem}
.card-body.compact{padding:1rem}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.25rem;margin-bottom:2rem}
.stat-card{background:linear-gradient(135deg,rgba(20,27,45,0.9),rgba(30,41,66,0.7));border:1px solid var(--border);border-radius:1rem;padding:1.5rem;text-align:center;transition:all 0.3s;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--blue),var(--purple));opacity:0;transition:opacity 0.3s}
.stat-card:hover{transform:translateY(-4px);border-color:var(--blue);box-shadow:0 8px 24px rgba(0,0,0,0.4)}
.stat-card:hover::before{opacity:1}
.stat-value{font-size:2.5rem;font-weight:800;background:linear-gradient(135deg,var(--blue),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:0.5rem;line-height:1}
.stat-label{font-size:0.875rem;color:var(--muted);font-weight:500}
.table-container{overflow-x:auto;border-radius:0.75rem;border:1px solid var(--border)}
.table{width:100%;border-collapse:collapse;font-size:0.875rem}
.table th{background:rgba(30,41,66,0.6);padding:1rem;text-align:left;font-weight:700;border-bottom:1px solid var(--border);white-space:nowrap}
.table td{padding:1rem;border-bottom:1px solid rgba(30,41,66,0.3);color:#cbd5e1}
.table tbody tr{transition:all 0.2s}
.table tbody tr:hover{background:rgba(30,41,66,0.4)}
.table tbody tr:last-child td{border-bottom:none}
.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.form-group{display:flex;flex-direction:column;gap:0.5rem}
.form-label{font-size:0.875rem;font-weight:600;color:#cbd5e1}
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.25rem;align-items:end}
.debug-console{background:rgba(10,14,26,0.95);border:1px solid var(--border);border-radius:0.75rem;max-height:500px;overflow-y:auto;font-family:Monaco,monospace;font-size:0.8rem}
.debug-entry{padding:0.75rem 1.25rem;border-bottom:1px solid rgba(30,41,66,0.2);display:flex;gap:1rem;align-items:flex-start}
.debug-entry:last-child{border-bottom:none}
.debug-timestamp{color:var(--muted);font-size:0.75rem;flex-shrink:0}
.debug-category{background:rgba(59,130,246,0.2);color:var(--blue);padding:0.25rem 0.625rem;border-radius:0.375rem;font-size:0.7rem;font-weight:700;flex-shrink:0;text-transform:uppercase;letter-spacing:0.5px}
.debug-message{color:var(--text);flex:1;word-break:break-word}
#adminMap{height:600px;width:100%;border-radius:0.75rem;border:1px solid var(--border);transition:all 0.3s}
.map-toolbar{display:flex;gap:0.75rem;margin-top:1rem;flex-wrap:wrap;align-items:center}
.map-stats{background:rgba(10,14,26,0.9);padding:0.5rem 1rem;border-radius:0.5rem;font-size:0.8rem;color:#cbd5e1;border:1px solid var(--border);font-weight:600}
.empty-state{text-align:center;padding:3rem 2rem;color:var(--muted)}
.empty-state-icon{font-size:3rem;margin-bottom:1rem;opacity:0.5}
.notification{position:fixed;top:20px;right:20px;padding:1rem 1.5rem;border-radius:0.75rem;color:#fff;font-size:0.9rem;font-weight:600;z-index:10000;max-width:400px;box-shadow:0 8px 32px rgba(0,0,0,0.5);animation:slideIn 0.3s}
.notification-success{background:linear-gradient(135deg,var(--green),#059669)}
.notification-error{background:linear-gradient(135deg,var(--red),#dc2626)}
.notification-warning{background:linear-gradient(135deg,var(--yellow),#d97706)}
.notification-info{background:linear-gradient(135deg,var(--blue),#6366f1)}
@keyframes slideIn{from{opacity:0;transform:translateX(100px)}to{opacity:1;transform:translateX(0)}}
@media(max-width:768px){.container{padding:1rem}.header-content{flex-direction:column;align-items:stretch}.stats-grid{grid-template-columns:repeat(2,1fr)}.form-grid{grid-template-columns:1fr}}
::-webkit-scrollbar{width:10px;height:10px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--card);border-radius:5px}
::-webkit-scrollbar-thumb:hover{background:var(--border)}
</style>
</head>
<body>
<div class="container">
<header class="header">
<div class="header-content">
<div class="header-title"><h1>ğŸŒŠ Neptun Admin Dashboard</h1></div>
<div class="status-badges">
{% if secret %}
<span class="badge success"><span class="status-dot online"></span>Authenticated</span>
{% else %}
<span class="badge danger"><span class="status-dot offline"></span>Not Authorized</span>
{% endif %}
<span class="badge info">ğŸ“… Today: {{ daily_unique }}</span>
<span class="badge info">ğŸ“Š Week: {{ week_unique }}</span>
</div>
<form method="get" action="/admin" style="display:flex;gap:0.75rem;align-items:center">
<input type="text" name="secret" placeholder="Secret key..." value="{{ secret }}" class="input" style="min-width:200px;width:auto">
<button type="submit" class="btn btn-primary btn-sm">ğŸ” Login</button>
</form>
</div>
</header>

<div class="stats-grid">
<div class="stat-card">
<div class="stat-value" id="statActive">{{ visitors|length }}</div>
<div class="stat-label">ğŸ‘¥ Active Users</div>
</div>
<div class="stat-card">
<div class="stat-value" id="statBlocked">{{ blocked|length }}</div>
<div class="stat-label">ğŸš« Blocked</div>
</div>
<div class="stat-card">
<div class="stat-value" id="statPending">{{ raw_count }}</div>
<div class="stat-label">â³ Pending Geo</div>
</div>
<div class="stat-card">
<div class="stat-value" id="statMarkers">{{ markers|length }}</div>
<div class="stat-label">ğŸ“ Markers</div>
</div>
<div class="stat-card">
<div class="stat-value" id="statDebug">{{ debug_logs|length }}</div>
<div class="stat-label">ğŸ› Debug Logs</div>
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">âš™ï¸ System Configuration</h2>
</div>
<div class="card-body">
<div class="form-grid">
<div class="form-group">
<label class="form-label">Monitor Period (minutes)</label>
<input type="number" id="monPeriod" value="{{ monitor_period }}" min="1" max="360" class="input">
</div>
<div style="display:flex;align-items:flex-end;gap:0.75rem">
<button class="btn btn-success" onclick="saveMonPeriod()">ğŸ’¾ Save Changes</button>
<span id="monStatus" class="badge info" style="display:none"></span>
</div>
</div>
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">ğŸ—ºï¸ Live Operations Map</h2>
<div style="display:flex;gap:0.5rem;flex-wrap:wrap">
<button class="btn btn-secondary btn-sm" onclick="reloadMarkers()">ğŸ”„ Refresh</button>
<button class="btn btn-success btn-sm" onclick="toggleAuto()" id="autoBtn">ğŸ” Auto: ON</button>
<button class="btn btn-danger btn-sm" onclick="forceReload()">ğŸ’¥ Force Reload Users</button>
</div>
</div>
<div class="card-body compact">
<div id="adminMap"></div>
<div class="map-toolbar">
<span class="map-stats" id="mapStats">Loading map...</span>
</div>
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">ğŸ‘¥ Active Visitors <span class="badge info">{{ visitors|length }}</span></h2>
</div>
<div class="card-body compact">
{% if visitors %}
<div class="table-container">
<table class="table">
<thead>
<tr>
<th>Session ID</th>
<th>IP Address</th>
<th>Device</th>
<th>Duration</th>
<th>Last Seen</th>
<th>Action</th>
</tr>
</thead>
<tbody>
{% for v in visitors %}
<tr>
<td class="truncate" style="max-width:150px" title="{{ v.id }}">{{ v.id[:16] }}...</td>
<td>{{ v.ip or 'N/A' }}</td>
<td class="truncate" style="max-width:200px" title="{{ v.ua }}">{{ v.ua_short }}</td>
<td><span class="badge info">{{ v.age_fmt }}</span></td>
<td><span class="badge warning">{{ v.last_seen }}</span></td>
<td><button class="btn btn-danger btn-sm" onclick="blockUser('{{ v.id }}')">ğŸš« Block</button></td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="empty-state">
<div class="empty-state-icon">ğŸ‘¤</div>
<p>No active visitors</p>
</div>
{% endif %}
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">ğŸš« Blocked Users <span class="badge danger">{{ blocked|length }}</span></h2>
</div>
<div class="card-body compact">
{% if blocked %}
<div class="table-container">
<table class="table">
<thead>
<tr>
<th>Blocked ID</th>
<th>Action</th>
</tr>
</thead>
<tbody>
{% for b in blocked %}
<tr>
<td class="truncate" style="max-width:400px" title="{{ b }}">{{ b[:30] }}...</td>
<td><button class="btn btn-success btn-sm" onclick="unblockUser('{{ b }}')">âœ… Unblock</button></td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="empty-state">
<div class="empty-state-icon">ğŸ”“</div>
<p>No blocked users</p>
</div>
{% endif %}
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">ğŸ“¨ Raw Messages (Pending Geo) <span class="badge warning" id="rawCount">{{ raw_count }}</span></h2>
</div>
<div class="card-body compact">
{% if raw_msgs %}
<div class="table-container">
<table class="table">
<thead>
<tr>
<th>Time</th>
<th>Channel</th>
<th>Message</th>
</tr>
</thead>
<tbody id="rawTable">
{% for r in raw_msgs %}
<tr>
<td style="white-space:nowrap;font-size:0.8rem">{{ r.date }}</td>
<td><span class="badge info">{{ r.channel }}</span></td>
<td class="truncate" style="max-width:500px" title="{{ r.text }}">{{ r.text }}</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="empty-state">
<div class="empty-state-icon">ğŸ“¬</div>
<p>No pending messages</p>
</div>
{% endif %}
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">ğŸ“ Recent Markers <span class="badge success">{{ markers|length }}</span></h2>
</div>
<div class="card-body compact">
{% if markers %}
<div class="table-container">
<table class="table">
<thead>
<tr>
<th>Time</th>
<th>Type</th>
<th>Location</th>
<th>Message</th>
<th>Action</th>
</tr>
</thead>
<tbody>
{% for m in markers %}
<tr>
<td style="white-space:nowrap;font-size:0.8rem">{{ m.date }}</td>
<td><span class="badge {% if m.threat_type=='shahed' %}info{% elif m.threat_type=='raketa' %}danger{% else %}warning{% endif %}">{{ m.threat_type }}</span></td>
<td style="font-weight:600">{{ m.place }}</td>
<td class="truncate" style="max-width:400px" title="{{ m.text }}">{{ (m.text or '')[:100] }}{% if (m.text|length or 0)>100 %}...{% endif %}</td>
<td><button class="btn btn-danger btn-sm" onclick="hideMarker({{ m.lat }},{{ m.lng }},'{{ (m.text or '')|e }}','{{ (m.channel or m.source)|e }}')">ğŸ‘ï¸ Hide</button></td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="empty-state">
<div class="empty-state-icon">ğŸ“Œ</div>
<p>No recent markers</p>
</div>
{% endif %}
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">ğŸ“Œ Add Manual Marker</h2>
</div>
<div class="card-body">
<form id="markerForm" class="form-grid">
<div class="form-group">
<label class="form-label">Latitude</label>
<input type="number" step="0.000001" required id="mmLat" placeholder="48.4500" class="input">
</div>
<div class="form-group">
<label class="form-label">Longitude</label>
<input type="number" step="0.000001" required id="mmLng" placeholder="31.1200" class="input">
</div>
<div class="form-group">
<label class="form-label">Location Name</label>
<input type="text" id="mmPlace" placeholder="ĞšĞ¸Ñ—Ğ²" class="input">
</div>
<div class="form-group">
<label class="form-label">Threat Type</label>
<select id="mmType" class="input">
<option value="shahed">Shahed</option>
<option value="raketa">Rocket</option>
<option value="artillery">Artillery</option>
<option value="manual">Manual</option>
</select>
</div>
<div class="form-group" style="grid-column:1/-1">
<label class="form-label">Description</label>
<textarea id="mmText" required placeholder="Event description..." class="input"></textarea>
</div>
<div style="grid-column:1/-1;display:flex;gap:1rem">
<button type="submit" class="btn btn-primary">â• Add Marker</button>
<span id="mmStatus" class="badge info" style="display:none"></span>
</div>
</form>
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">ğŸ—ƒï¸ Cache Management <span class="badge warning">{{ neg_geocode|length }}</span></h2>
<button class="btn btn-danger btn-sm" onclick="clearCache()">ğŸ—‘ï¸ Clear All</button>
</div>
<div class="card-body compact">
{% if neg_geocode %}
<div class="table-container" style="max-height:400px;overflow-y:auto">
<table class="table">
<thead>
<tr>
<th>City Name</th>
<th>Region</th>
<th>Action</th>
</tr>
</thead>
<tbody>
{% for name,region in neg_geocode %}
<tr>
<td>{{ name }}</td>
<td>{{ region or "â€”" }}</td>
<td><button class="btn btn-danger btn-sm" onclick="delCache('{{ name }}')">ğŸ—‘ï¸ Delete</button></td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="empty-state">
<div class="empty-state-icon">ğŸ—‚ï¸</div>
<p>Cache is empty</p>
</div>
{% endif %}
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">ğŸ› Debug Console <span class="badge info">{{ debug_logs|length }}</span></h2>
<button class="btn btn-danger btn-sm" onclick="clearLogs()">ğŸ—‘ï¸ Clear Logs</button>
</div>
<div class="card-body compact">
{% if debug_logs %}
<div class="debug-console">
{% for log in debug_logs[-100:] %}
<div class="debug-entry">
<span class="debug-timestamp">{{ log.timestamp[-8:] }}</span>
<span class="debug-category">{{ log.category }}</span>
<span class="debug-message">{{ log.message }}</span>
</div>
{% endfor %}
</div>
{% else %}
<div class="empty-state">
<div class="empty-state-icon">ğŸ“</div>
<p>No debug logs available</p>
</div>
{% endif %}
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">ğŸ› ï¸ Advanced Tools</h2>
</div>
<div class="card-body">
<div class="form-grid">
<div class="form-group">
<label class="form-label">System Statistics</label>
<button class="btn btn-info" onclick="loadStats()">ğŸ“Š Load Stats</button>
</div>
<div class="form-group">
<label class="form-label">Data Cleanup (Keep Days)</label>
<div style="display:flex;gap:0.5rem">
<input type="number" id="cleanDays" value="7" min="1" max="30" class="input" style="width:100px">
<button class="btn btn-warning" onclick="cleanup()">ğŸ§¹ Clean</button>
</div>
</div>
<div class="form-group">
<label class="form-label">Export Data</label>
<div style="display:flex;gap:0.5rem;flex-wrap:wrap">
<button class="btn btn-secondary btn-sm" onclick="exportData('messages')">ğŸ“ Messages</button>
<button class="btn btn-secondary btn-sm" onclick="exportData('stats')">ğŸ“ˆ Stats</button>
</div>
</div>
</div>
<div id="advStatus" class="debug-console" style="margin-top:1rem;display:none"></div>
</div>
</div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const S=new URLSearchParams(location.search).get('secret')||'';
let map=null,layer=null,auto=true;
function notif(m,t='info'){const n=document.createElement('div');n.className='notification notification-'+t;n.textContent=m;document.body.appendChild(n);setTimeout(()=>{n.style.opacity='0';n.style.transform='translateX(100px)';setTimeout(()=>n.remove(),300)},4000)}
async function api(e,o={}){try{const u=e.includes('?')?`${e}&secret=${encodeURIComponent(S)}`:`${e}?secret=${encodeURIComponent(S)}`;const r=await fetch(u,o);if(!r.ok)throw new Error(`HTTP ${r.status}`);return await r.json()}catch(err){notif(`Error: ${err.message}`,'error');throw err}}
function initMap(){if(map)return;try{map=L.map('adminMap',{attributionControl:false,zoomControl:true}).setView([49,31.3],6);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:11}).addTo(map);layer=L.layerGroup().addTo(map);console.log('âœ… Map initialized');reloadMarkers()}catch(e){console.error('âŒ Map failed:',e);notif('Map initialization failed','error')}}
async function reloadMarkers(){if(!map||!layer)return;try{const d=await fetch(`/data?timeRange=40&confRange=0&maxTracks=100&ts=${Date.now()}`).then(r=>r.json());const t=d.tracks||[];layer.clearLayers();t.forEach(m=>{if(!m.lat||!m.lng)return;const i=L.icon({iconUrl:`/static/${m.threat_type||'shahed'}.png`,iconSize:[34,34],iconAnchor:[17,17]});const k=L.marker([m.lat,m.lng],{icon:i}).addTo(layer);const p=`<div style="font-size:0.85rem;max-width:250px"><strong style="color:#3b82f6">${m.place||'Unknown'}</strong><br><div style="margin:6px 0">${(m.text||'').slice(0,200)}</div><div style="opacity:0.7;font-size:0.75rem">${m.date||''}</div></div>`;k.bindPopup(p)});document.getElementById('mapStats').textContent=`ğŸ“ Markers: ${t.length}`;console.log(`âœ… Loaded ${t.length} markers`)}catch(e){console.error('âŒ Load failed:',e);notif('Failed to load markers','error')}}
function toggleAuto(){auto=!auto;const b=document.getElementById('autoBtn');b.textContent=`ğŸ” Auto: ${auto?'ON':'OFF'}`;b.className=auto?'btn btn-success btn-sm':'btn btn-secondary btn-sm'}
async function blockUser(id){try{await api('/block',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});notif('User blocked successfully','success');setTimeout(()=>location.reload(),1000)}catch(e){}}
async function unblockUser(id){try{await api('/unblock',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});notif('User unblocked successfully','success');setTimeout(()=>location.reload(),1000)}catch(e){}}
async function saveMonPeriod(){const v=document.getElementById('monPeriod').value;const s=document.getElementById('monStatus');s.style.display='inline-flex';s.textContent='Saving...';try{await api('/admin/set_monitor_period',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({value:parseInt(v)})});s.textContent='âœ… Saved';notif('Monitor period updated','success')}catch(e){s.textContent='âŒ Error'}}
document.getElementById('markerForm').addEventListener('submit',async(e)=>{e.preventDefault();const lat=document.getElementById('mmLat').value;const lng=document.getElementById('mmLng').value;const place=document.getElementById('mmPlace').value;const threat_type=document.getElementById('mmType').value;const text=document.getElementById('mmText').value;const s=document.getElementById('mmStatus');s.style.display='inline-flex';s.textContent='Creating...';try{await api('/admin/add_manual_marker',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lat,lng,place,threat_type,text})});s.textContent='âœ… Created';notif('Marker created successfully','success');setTimeout(()=>location.reload(),1000)}catch(e){s.textContent='âŒ Error'}});
async function hideMarker(lat,lng,text,source){try{await fetch('/hide_marker',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lat,lng,text,source})});notif('Marker hidden','success');setTimeout(()=>location.reload(),1000)}catch(e){}}
async function clearCache(){if(!confirm('Clear all negative geocode cache? This cannot be undone.'))return;try{await api('/admin/neg_geocode_clear',{method:'POST'});notif('Cache cleared successfully','success');setTimeout(()=>location.reload(),1000)}catch(e){}}
async function delCache(name){try{await api('/admin/neg_geocode_delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})});notif('Cache entry deleted','success');setTimeout(()=>location.reload(),1000)}catch(e){}}
async function clearLogs(){if(!confirm('Clear all debug logs? This cannot be undone.'))return;try{await api('/admin/clear_debug_logs',{method:'POST'});notif('Debug logs cleared','success');setTimeout(()=>location.reload(),1000)}catch(e){}}
async function loadStats(){const s=document.getElementById('advStatus');s.style.display='block';try{const d=await api('/admin/stats');const t=d.stats;let h='';h+=`<div class="debug-entry"><span class="debug-category">MESSAGES</span><span class="debug-message">Total: ${t.messages.total}, Geo: ${t.messages.with_coordinates}, Pending: ${t.messages.pending_geo}, Recent 24h: ${t.messages.recent_24h}</span></div>`;h+=`<div class="debug-entry"><span class="debug-category">SYSTEM</span><span class="debug-message">Active Users: ${t.system.active_users}, Blocked: ${t.system.blocked_users}, Hidden Markers: ${t.system.hidden_markers}, Cache Size: ${t.system.neg_cache_size}</span></div>`;s.innerHTML=h}catch(e){s.innerHTML=`<div class="debug-entry"><span class="debug-message">Error: ${e.message}</span></div>`}}
async function cleanup(){const d=document.getElementById('cleanDays').value;if(!confirm(`Clean up data older than ${d} days? This cannot be undone.`))return;const s=document.getElementById('advStatus');s.style.display='block';s.innerHTML='<div class="debug-entry"><span class="debug-message">Cleaning up old data...</span></div>';try{const r=await api('/admin/cleanup',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({days:parseInt(d)})});s.innerHTML=`<div class="debug-entry"><span class="debug-category">CLEANED</span><span class="debug-message">Messages: ${r.cleaned.messages}, Debug Logs: ${r.cleaned.debug_logs}, Visitor Records: ${r.cleaned.visitor_records}</span></div>`;s.innerHTML+=`<div class="debug-entry"><span class="debug-category">REMAINING</span><span class="debug-message">Messages: ${r.remaining.messages}, Debug Logs: ${r.remaining.debug_logs}</span></div>`;notif('Cleanup completed successfully','success');setTimeout(()=>location.reload(),2000)}catch(e){s.innerHTML=`<div class="debug-entry"><span class="debug-message">Error: ${e.message}</span></div>`}}
async function exportData(type){try{const d=await api(`/admin/export?type=${type}`);const b=new Blob([JSON.stringify(d.data,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`neptun_${type}_${new Date().toISOString().split('T')[0]}.json`;a.click();URL.revokeObjectURL(u);notif(`Exported ${type} data successfully`,'success')}catch(e){}}
async function forceReload(){if(!confirm('âš ï¸ WARNING: This will force reload the page for ALL active users!\n\nContinue?'))return;try{await api('/admin/trigger-force-reload',{method:'POST'});notif('Force reload activated for all users','success')}catch(e){}}
async function updateRaw(){try{const d=await api('/admin/raw_msgs');document.getElementById('rawCount').textContent=d.raw_count;const t=document.getElementById('rawTable');if(t&&d.raw_msgs.length>0){t.innerHTML=d.raw_msgs.map(r=>`<tr><td style="white-space:nowrap;font-size:0.8rem">${r.date}</td><td><span class="badge info">${r.channel}</span></td><td class="truncate" style="max-width:500px" title="${r.text}">${r.text}</td></tr>`).join('')}}catch(e){console.warn('Raw messages update failed:',e)}}
async function updateStats(){try{const d=await api('/admin/stats');const s=d.stats;document.getElementById('statActive').textContent=s.system.active_users;document.getElementById('statBlocked').textContent=s.system.blocked_users;document.getElementById('statPending').textContent=s.messages.pending_geo;document.getElementById('statMarkers').textContent=s.messages.with_coordinates;document.getElementById('statDebug').textContent=s.system.debug_logs}catch(e){console.warn('Stats update failed:',e)}}
setInterval(()=>{if(auto&&map)reloadMarkers()},30000);
setInterval(updateRaw,15000);
setInterval(updateStats,20000);
document.addEventListener('DOMContentLoaded',()=>{console.log('ğŸŒŠ Neptun Admin Dashboard initialized');if(typeof L==='undefined'){notif('Leaflet library failed to load','error');return}setTimeout(()=>{initMap();updateStats();updateRaw()},100)});
</script>
</body>
</html>
