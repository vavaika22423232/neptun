<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>üåä Neptun Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0e1a;--card:#141b2d;--border:#1e2942;--blue:#3b82f6;--purple:#8b5cf6;--green:#10b981;--red:#ef4444;--yellow:#f59e0b;--text:#f1f5f9;--muted:#64748b}
body{font-family:'Inter',system-ui,sans-serif;background:linear-gradient(135deg,#0a0e1a,#1a1f35);color:var(--text);min-height:100vh;line-height:1.6}
.container{max-width:1600px;margin:0 auto;padding:1.5rem}
.header{background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(139,92,246,0.1));backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:1rem;padding:1.5rem 2rem;margin-bottom:2rem;box-shadow:0 8px 32px rgba(0,0,0,0.4)}
.header-content{display:flex;align-items:center;justify-content:space-between;gap:1.5rem;flex-wrap:wrap}
.header-title h1{font-size:2rem;font-weight:800;background:linear-gradient(135deg,var(--blue),var(--purple));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-0.5px}
.status-badges{display:flex;gap:0.75rem;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;gap:0.5rem;padding:0.5rem 1rem;border-radius:0.5rem;font-size:0.875rem;font-weight:600;border:1px solid}
.badge.success{background:rgba(16,185,129,0.2);border-color:rgba(16,185,129,0.5);color:#10b981}
.badge.danger{background:rgba(239,68,68,0.2);border-color:rgba(239,68,68,0.5);color:#ef4444}
.badge.info{background:rgba(59,130,246,0.2);border-color:rgba(59,130,246,0.5);color:#3b82f6}
.badge.warning{background:rgba(245,158,11,0.2);border-color:rgba(245,158,11,0.5);color:#f59e0b}
.status-dot{width:8px;height:8px;border-radius:50%;animation:pulse 2s infinite}
.status-dot.online{background:#10b981;box-shadow:0 0 12px rgba(16,185,129,0.8)}
.status-dot.offline{background:var(--muted)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.btn{display:inline-flex;align-items:center;gap:0.5rem;padding:0.75rem 1.25rem;border:none;border-radius:0.5rem;font-size:0.875rem;font-weight:600;cursor:pointer;transition:all 0.2s;text-decoration:none;white-space:nowrap}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.btn-primary{background:linear-gradient(135deg,var(--blue),#6366f1);color:#fff}
.btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 24px rgba(59,130,246,0.5)}
.btn-success{background:linear-gradient(135deg,var(--green),#059669);color:#fff}
.btn-success:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 24px rgba(16,185,129,0.5)}
.btn-danger{background:linear-gradient(135deg,var(--red),#dc2626);color:#fff}
.btn-danger:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 24px rgba(239,68,68,0.5)}
.btn-warning{background:linear-gradient(135deg,var(--yellow),#d97706);color:#fff}
.btn-secondary{background:var(--card);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover:not(:disabled){border-color:var(--blue);transform:translateY(-2px)}
.btn-sm{padding:0.5rem 0.875rem;font-size:0.8rem}
.input{background:rgba(10,14,26,0.8);border:1px solid var(--border);border-radius:0.5rem;padding:0.75rem 1rem;color:var(--text);font-size:0.875rem;transition:all 0.2s;width:100%}
.input:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,130,246,0.2)}
textarea.input{resize:vertical;min-height:80px;font-family:inherit}
.card{background:linear-gradient(135deg,rgba(20,27,45,0.8),rgba(30,41,66,0.6));backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:1rem;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,0.3);transition:all 0.3s;margin-bottom:2rem}
.card.card-map{overflow:visible}
.card.card-map .card-body{overflow:visible}
.card:hover{transform:translateY(-4px);box-shadow:0 8px 32px rgba(0,0,0,0.5);border-color:rgba(59,130,246,0.3)}
.card-header{background:rgba(30,41,66,0.5);padding:1.25rem 1.75rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem}
.card-title{font-size:1.125rem;font-weight:700;display:flex;align-items:center;gap:0.5rem}
.card-body{padding:1.75rem}
.card-body.compact{padding:1rem}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.25rem;margin-bottom:2rem}
.stat-card{background:linear-gradient(135deg,rgba(20,27,45,0.9),rgba(30,41,66,0.7));border:1px solid var(--border);border-radius:1rem;padding:1.5rem;text-align:center;transition:all 0.3s;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--blue),var(--purple));opacity:0;transition:opacity 0.3s}
.stat-card:hover{transform:translateY(-4px);border-color:var(--blue);box-shadow:0 8px 24px rgba(0,0,0,0.4)}
.stat-card:hover::before{opacity:1}
.stat-value{font-size:2.5rem;font-weight:800;background:linear-gradient(135deg,var(--blue),var(--purple));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:0.5rem;line-height:1}
.stat-label{font-size:0.875rem;color:var(--muted);font-weight:500}
.table-container{overflow-x:auto;border-radius:0.75rem;border:1px solid var(--border)}
.table{width:100%;border-collapse:collapse;font-size:0.875rem}
.table th{background:rgba(30,41,66,0.6);padding:1rem;text-align:left;font-weight:700;border-bottom:1px solid var(--border);white-space:nowrap}
.table td{padding:1rem;border-bottom:1px solid rgba(30,41,66,0.3);color:#cbd5e1}
.table tbody tr{transition:all 0.2s}
.table tbody tr:hover{background:rgba(30,41,66,0.4)}
.table tbody tr:last-child td{border-bottom:none}
.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.form-group{display:flex;flex-direction:column;gap:0.5rem}
.form-label{font-size:0.875rem;font-weight:600;color:#cbd5e1}
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.25rem;align-items:end}
.debug-console{background:rgba(10,14,26,0.95);border:1px solid var(--border);border-radius:0.75rem;max-height:500px;overflow-y:auto;font-family:Monaco,monospace;font-size:0.8rem}
.debug-entry{padding:0.75rem 1.25rem;border-bottom:1px solid rgba(30,41,66,0.2);display:flex;gap:1rem;align-items:flex-start}
.debug-entry:last-child{border-bottom:none}
.debug-timestamp{color:var(--muted);font-size:0.75rem;flex-shrink:0}
.debug-category{background:rgba(59,130,246,0.2);color:var(--blue);padding:0.25rem 0.625rem;border-radius:0.375rem;font-size:0.7rem;font-weight:700;flex-shrink:0;text-transform:uppercase;letter-spacing:0.5px}
.debug-message{color:var(--text);flex:1;word-break:break-word}
#adminMap{height:600px;width:100%;border-radius:0.75rem;border:1px solid var(--border);transition:all 0.3s;cursor:crosshair}
.map-toolbar{display:flex;gap:0.75rem;margin-top:1rem;flex-wrap:wrap;align-items:center}
.map-stats{background:rgba(10,14,26,0.9);padding:0.5rem 1rem;border-radius:0.5rem;font-size:0.8rem;color:#cbd5e1;border:1px solid var(--border);font-weight:600}
.marker-editor{position:absolute;top:10px;right:10px;background:rgba(10,14,26,0.95);border:1px solid var(--border);border-radius:0.75rem;padding:1rem 1rem 1.25rem;z-index:1000;min-width:280px;max-height:calc(100vh - 40px);height:calc(100% - 20px);overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,0.6);display:flex;flex-direction:column;gap:0.75rem}
.marker-editor h3{margin:0;font-size:0.9rem;color:var(--blue);font-weight:700}
.marker-editor-field{margin-bottom:0.75rem}
.marker-editor-field label{display:block;font-size:0.75rem;color:#cbd5e1;margin-bottom:0.25rem;font-weight:600}
.marker-editor-field input,.marker-editor-field select{width:100%;padding:0.5rem;background:rgba(20,27,45,0.8);border:1px solid var(--border);border-radius:0.375rem;color:var(--text);font-size:0.8rem}
.marker-editor-buttons{display:flex;gap:0.5rem;margin-top:auto;position:sticky;bottom:0;background:rgba(10,14,26,0.95);padding-top:0.75rem}
.marker-editor-buttons button{flex:1;padding:0.5rem;border:none;border-radius:0.375rem;font-size:0.75rem;font-weight:600;cursor:pointer;transition:all 0.2s}
.rotatable-marker{transition:transform 0.2s ease;cursor:move}
.rotation-handle{width:20px;height:20px;background:var(--blue);border:2px solid white;border-radius:50%;position:absolute;top:-30px;left:50%;transform:translateX(-50%);cursor:grab;box-shadow:0 2px 8px rgba(0,0,0,0.4);z-index:1001}
.rotation-handle:active{cursor:grabbing;background:var(--purple)}
.vector-summary{min-height:42px;border:1px solid var(--border);border-radius:0.375rem;padding:0.45rem 0.6rem;background:rgba(20,27,45,0.8);color:#e2e8f0;font-size:0.8rem;line-height:1.4}
.empty-state{text-align:center;padding:3rem 2rem;color:var(--muted)}
.empty-state-icon{font-size:3rem;margin-bottom:1rem;opacity:0.5}
.notification{position:fixed;top:20px;right:20px;padding:1rem 1.5rem;border-radius:0.75rem;color:#fff;font-size:0.9rem;font-weight:600;z-index:10000;max-width:400px;box-shadow:0 8px 32px rgba(0,0,0,0.5);animation:slideIn 0.3s}
.notification-success{background:linear-gradient(135deg,var(--green),#059669)}
.notification-error{background:linear-gradient(135deg,var(--red),#dc2626)}
.notification-warning{background:linear-gradient(135deg,var(--yellow),#d97706)}
.notification-info{background:linear-gradient(135deg,var(--blue),#6366f1)}
@keyframes slideIn{from{opacity:0;transform:translateX(100px)}to{opacity:1;transform:translateX(0)}}
@media(max-width:768px){.container{padding:1rem}.header-content{flex-direction:column;align-items:stretch}.stats-grid{grid-template-columns:repeat(2,1fr)}.form-grid{grid-template-columns:1fr}}
::-webkit-scrollbar{width:10px;height:10px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--card);border-radius:5px}
::-webkit-scrollbar-thumb:hover{background:var(--border)}
</style>
</head>
<body>
<div class="container">
<header class="header">
<div class="header-content">
<div class="header-title"><h1>üåä Neptun Admin Dashboard</h1></div>
<div class="status-badges">
{% if secret %}
<span class="badge success"><span class="status-dot online"></span>Authenticated</span>
{% else %}
<span class="badge danger"><span class="status-dot offline"></span>Not Authorized</span>
{% endif %}
<span class="badge info">üìÖ Today: {{ daily_unique }}</span>
<span class="badge info">üìä Week: {{ week_unique }}</span>
</div>
<form method="get" action="/admin" style="display:flex;gap:0.75rem;align-items:center">
<input type="text" name="secret" placeholder="Secret key..." value="{{ secret }}" class="input" style="min-width:200px;width:auto">
<button type="submit" class="btn btn-primary btn-sm">üîê Login</button>
</form>
</div>
</header>

<div class="stats-grid">
<div class="stat-card">
<div class="stat-value" id="statActive">{{ visitors|length }}</div>
<div class="stat-label">üë• Active Users</div>
</div>
<div class="stat-card">
<div class="stat-value" id="statBlocked">{{ blocked|length }}</div>
<div class="stat-label">üö´ Blocked</div>
</div>
<div class="stat-card">
<div class="stat-value" id="statPending">{{ raw_count }}</div>
<div class="stat-label">‚è≥ Pending Geo</div>
</div>
<div class="stat-card">
<div class="stat-value" id="statMarkers">{{ markers|length }}</div>
<div class="stat-label">üìç Markers</div>
</div>
<div class="stat-card">
<div class="stat-value" id="statDebug">{{ debug_logs|length }}</div>
<div class="stat-label">üêõ Debug Logs</div>
</div>
</div>

<div class="card card-map">
<div class="card-header">
<h2 class="card-title">‚öôÔ∏è System Configuration</h2>
</div>
<div class="card-body">
<div class="form-grid">
<div class="form-group">
<label class="form-label">Monitor Period (minutes)</label>
<input type="number" id="monPeriod" value="{{ monitor_period }}" min="1" max="360" class="input">
</div>
<div style="display:flex;align-items:flex-end;gap:0.75rem">
<button class="btn btn-success" onclick="saveMonPeriod()">üíæ Save Changes</button>
<span id="monStatus" class="badge info" style="display:none"></span>
</div>
</div>
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">üó∫Ô∏è Live Operations Map</h2>
<div style="display:flex;gap:0.5rem;flex-wrap:wrap">
<button class="btn btn-primary btn-sm" id="addModeBtn" onclick="toggleAddMode()">‚ûï Add Mode: OFF</button>
<button class="btn btn-secondary btn-sm" onclick="copySelectedMarker()" id="copyBtn" disabled>üìã Copy</button>
<button class="btn btn-secondary btn-sm" onclick="pasteMarker()" id="pasteBtn" disabled>üìå Paste</button>
<button class="btn btn-warning btn-sm" onclick="rotateSelected(-15)">‚Ü∂ -15¬∞</button>
<button class="btn btn-warning btn-sm" onclick="rotateSelected(15)">‚Ü∑ +15¬∞</button>
<button class="btn btn-secondary btn-sm" onclick="toggleVectorMode()" id="vectorBtn">üéØ Vector: OFF</button>
<button class="btn btn-secondary btn-sm" onclick="clearMarkerVector()" id="clearVectorBtn" disabled>üßπ Clear Vector</button>
<button class="btn btn-danger btn-sm" onclick="deleteSelected()">üóëÔ∏è Delete</button>
<button class="btn btn-secondary btn-sm" onclick="reloadMarkers()">üîÑ Refresh</button>
<button class="btn btn-success btn-sm" onclick="toggleAuto()" id="autoBtn">üîÅ Auto: ON</button>
<button class="btn btn-danger btn-sm" onclick="forceReload()">üí• Force Reload Users</button>
</div>
</div>
<div class="card-body" style="padding:0;position:relative">
<div id="adminMap"></div>
<div id="markerEditor" class="marker-editor" style="display:none">
<h3>‚úèÔ∏è Edit Marker</h3>
<div class="marker-editor-field">
<label>Latitude</label>
<input type="number" step="0.000001" id="editLat" class="input">
</div>
<div class="marker-editor-field">
<label>Longitude</label>
<input type="number" step="0.000001" id="editLng" class="input">
</div>
<div class="marker-editor-field">
<label>Location</label>
<input type="text" id="editPlace" class="input">
</div>
<div class="marker-editor-field">
<label>Rotation (degrees)</label>
<input type="number" id="editRotation" value="0" min="-180" max="180" step="15" class="input" oninput="updateSelectedRotation(this.value)">
</div>
<div class="marker-editor-field">
<label>Vector Target Label</label>
<input type="text" id="editVectorLabel" class="input" placeholder="–¶—ñ–ª—å / –Ω–∞–ø—Ä—è–º–æ–∫" oninput="updateMarkerVectorLabel(this.value)">
</div>
<div class="marker-editor-field">
<label>Vector Summary</label>
<div id="vectorSummary" class="vector-summary">‚Äî</div>
</div>
<div class="marker-editor-field">
<label>Animation Target (Lat, Lng)</label>
<div style="display:flex;gap:0.5rem">
<input type="number" step="0.000001" id="animTargetLat" class="input" placeholder="50.000000" oninput="storeAnimationTarget()">
<input type="number" step="0.000001" id="animTargetLng" class="input" placeholder="30.000000" oninput="storeAnimationTarget()">
</div>
</div>
<div class="marker-editor-field">
<label>Animation Duration (sec)</label>
<input type="number" id="animDuration" class="input" min="0.5" step="0.5" value="4" oninput="storeAnimationTarget()">
</div>
<div class="marker-editor-field">
<label>Animation Actions</label>
<div style="display:flex;flex-wrap:wrap;gap:0.5rem">
<button type="button" class="btn btn-secondary btn-sm" onclick="setAnimationTargetFromMarker()">üìç Use Current Point</button>
<button type="button" class="btn btn-secondary btn-sm" onclick="useVectorForAnimation()">üéØ Use Vector Target</button>
<button type="button" class="btn btn-success btn-sm" onclick="animateSelectedMarker()">‚ñ∂Ô∏è Animate</button>
<button type="button" id="cancelAnimBtn" class="btn btn-danger btn-sm" onclick="cancelMarkerAnimation()" disabled>‚èπ Stop</button>
</div>
</div>
<div class="marker-editor-field">
<label>Type</label>
<select id="editType" class="input">
<option value="shahed">Shahed</option>
<option value="raketa">Rocket</option>
<option value="avia">Aviation</option>
<option value="artillery">Artillery</option>
<option value="obstril">Shelling</option>
<option value="fpv">FPV Drone</option>
<option value="pusk">Launch</option>
<option value="vibuh">Explosion</option>
<option value="vidboi">Repel</option>
<option value="rozved">Reconnaissance</option>
<option value="rszv">MLRS</option>
<option value="kab">KAB</option>
<option value="trivoga">Alarm</option>
<option value="manual">Manual</option>
</select>
</div>
<div class="marker-editor-field">
<label>Description</label>
<textarea id="editText" class="input" rows="3"></textarea>
</div>
<div class="marker-editor-buttons">
<button id="editSaveBtn" class="btn btn-success" style="background:#10b981" onclick="saveMarkerEdit()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
<button class="btn btn-secondary" style="background:#64748b" onclick="closeMarkerEditor()">‚úñ Cancel</button>
</div>
</div>
<div class="map-toolbar">
<span class="map-stats" id="mapStats">Loading map...</span>
</div>
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">üìå Add Manual Marker</h2>
</div>
<div class="card-body">
<form id="markerForm" class="form-grid">
<div class="form-group">
<label class="form-label">Latitude</label>
<input type="number" step="0.000001" required id="mmLat" placeholder="48.4500" class="input">
</div>
<div class="form-group">
<label class="form-label">Longitude</label>
<input type="number" step="0.000001" required id="mmLng" placeholder="31.1200" class="input">
</div>
<div class="form-group">
<label class="form-label">Location Name</label>
<input type="text" id="mmPlace" placeholder="–ö–∏—ó–≤" class="input">
</div>
<div class="form-group">
<label class="form-label">Threat Type</label>
<select id="mmType" class="input">
<option value="shahed">Shahed</option>
<option value="raketa">Rocket</option>
<option value="avia">Aviation</option>
<option value="artillery">Artillery</option>
<option value="obstril">Shelling</option>
<option value="fpv">FPV Drone</option>
<option value="pusk">Launch</option>
<option value="vibuh">Explosion</option>
<option value="vidboi">Repel</option>
<option value="rozved">Reconnaissance</option>
<option value="rszv">MLRS</option>
<option value="kab">KAB</option>
<option value="trivoga">Alarm</option>
<option value="manual">Manual</option>
</select>
</div>
<div class="form-group" style="grid-column:1/-1">
<label class="form-label">Description</label>
<textarea id="mmText" required placeholder="Event description..." class="input"></textarea>
</div>
<div style="grid-column:1/-1;display:flex;gap:1rem">
<button type="submit" class="btn btn-primary">‚ûï Add Marker</button>
<span id="mmStatus" class="badge info" style="display:none"></span>
</div>
</form>
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">üë• Active Visitors <span class="badge info">{{ visitors|length }}</span></h2>
</div>
<div class="card-body compact">
{% if visitors %}
<div class="table-container">
<table class="table">
<thead>
<tr>
<th>Session ID</th>
<th>IP Address</th>
<th>Device</th>
<th>Duration</th>
<th>Last Seen</th>
<th>Action</th>
</tr>
</thead>
<tbody>
{% for v in visitors %}
<tr>
<td class="truncate" style="max-width:150px" title="{{ v.id }}">{{ v.id[:16] }}...</td>
<td>{{ v.ip or 'N/A' }}</td>
<td class="truncate" style="max-width:200px" title="{{ v.ua }}">{{ v.ua_short }}</td>
<td><span class="badge info">{{ v.age_fmt }}</span></td>
<td><span class="badge warning">{{ v.last_seen }}</span></td>
<td><button class="btn btn-danger btn-sm" onclick="blockUser('{{ v.id }}')">üö´ Block</button></td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="empty-state">
<div class="empty-state-icon">üë§</div>
<p>No active visitors</p>
</div>
{% endif %}
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">üö´ Blocked Users <span class="badge danger">{{ blocked|length }}</span></h2>
</div>
<div class="card-body compact">
{% if blocked %}
<div class="table-container">
<table class="table">
<thead>
<tr>
<th>Blocked ID</th>
<th>Action</th>
</tr>
</thead>
<tbody>
{% for b in blocked %}
<tr>
<td class="truncate" style="max-width:400px" title="{{ b }}">{{ b[:30] }}...</td>
<td><button class="btn btn-success btn-sm" onclick="unblockUser('{{ b }}')">‚úÖ Unblock</button></td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="empty-state">
<div class="empty-state-icon">üîì</div>
<p>No blocked users</p>
</div>
{% endif %}
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">üì® Raw Messages (Pending Geo) <span class="badge warning" id="rawCount">{{ raw_count }}</span></h2>
</div>
<div class="card-body compact">
{% if raw_msgs %}
<div class="table-container">
<table class="table">
<thead>
<tr>
<th>Time</th>
<th>Channel</th>
<th>Message</th>
</tr>
</thead>
<tbody id="rawTable">
{% for r in raw_msgs %}
<tr>
<td style="white-space:nowrap;font-size:0.8rem">{{ r.date }}</td>
<td><span class="badge info">{{ r.channel }}</span></td>
<td class="truncate" style="max-width:500px" title="{{ r.text }}">{{ r.text }}</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="empty-state">
<div class="empty-state-icon">üì¨</div>
<p>No pending messages</p>
</div>
{% endif %}
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">üìç Recent Markers <span class="badge success">{{ markers|length }}</span></h2>
</div>
<div class="card-body compact">
{% if markers %}
<div class="table-container">
<table class="table">
<thead>
<tr>
<th>Time</th>
<th>Type</th>
<th>Location</th>
<th>Message</th>
<th>Action</th>
</tr>
</thead>
<tbody>
{% for m in markers %}
<tr>
<td style="white-space:nowrap;font-size:0.8rem">{{ m.date }}</td>
<td><span class="badge {% if m.threat_type=='shahed' %}info{% elif m.threat_type=='raketa' %}danger{% else %}warning{% endif %}">{{ m.threat_type }}</span></td>
<td style="font-weight:600">{{ m.place }}</td>
<td class="truncate" style="max-width:400px" title="{{ m.text }}">{{ (m.text or '')[:100] }}{% if (m.text|length or 0)>100 %}...{% endif %}</td>
<td><button class="btn btn-danger btn-sm" data-lat="{{ m.lat }}" data-lng="{{ m.lng }}" data-text="{{ (m.text or '')|e }}" data-source="{{ (m.channel or m.source)|e }}" onclick="hideMarker(this.dataset.lat,this.dataset.lng,this.dataset.text,this.dataset.source)">üëÅÔ∏è Hide</button></td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="empty-state">
<div class="empty-state-icon">üìå</div>
<p>No recent markers</p>
</div>
{% endif %}
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">üëÅÔ∏è Hidden Markers <span id="hiddenCount" class="badge danger">0</span></h2>
<button class="btn btn-sm btn-secondary" onclick="loadHiddenMarkers()">üîÑ Refresh</button>
</div>
<div class="card-body">
<div id="hiddenMarkersContainer">
<div class="empty-state">
<div class="empty-state-icon">üëÅÔ∏è</div>
<p>No hidden markers</p>
</div>
</div>
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">üóÉÔ∏è Cache Management <span class="badge warning">{{ neg_geocode|length }}</span></h2>
<button class="btn btn-danger btn-sm" onclick="clearCache()">üóëÔ∏è Clear All</button>
</div>
<div class="card-body compact">
{% if neg_geocode %}
<div class="table-container" style="max-height:400px;overflow-y:auto">
<table class="table">
<thead>
<tr>
<th>City Name</th>
<th>Region</th>
<th>Action</th>
</tr>
</thead>
<tbody>
{% for name,region in neg_geocode %}
<tr>
<td>{{ name }}</td>
<td>{{ region or "‚Äî" }}</td>
<td><button class="btn btn-danger btn-sm" onclick="delCache('{{ name }}')">üóëÔ∏è Delete</button></td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="empty-state">
<div class="empty-state-icon">üóÇÔ∏è</div>
<p>Cache is empty</p>
</div>
{% endif %}
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">üêõ Debug Console <span class="badge info">{{ debug_logs|length }}</span></h2>
<button class="btn btn-danger btn-sm" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
</div>
<div class="card-body compact">
{% if debug_logs %}
<div class="debug-console">
{% for log in debug_logs[-100:] %}
<div class="debug-entry">
<span class="debug-timestamp">{{ log.timestamp[-8:] }}</span>
<span class="debug-category">{{ log.category }}</span>
<span class="debug-message">{{ log.message }}</span>
</div>
{% endfor %}
</div>
{% else %}
<div class="empty-state">
<div class="empty-state-icon">üìù</div>
<p>No debug logs available</p>
</div>
{% endif %}
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">üõ†Ô∏è Advanced Tools</h2>
</div>
<div class="card-body">
<div class="form-grid">
<div class="form-group">
<label class="form-label">System Statistics</label>
<button class="btn btn-info" onclick="loadStats()">üìä Load Stats</button>
</div>
<div class="form-group">
<label class="form-label">Data Cleanup (Keep Days)</label>
<div style="display:flex;gap:0.5rem">
<input type="number" id="cleanDays" value="7" min="1" max="30" class="input" style="width:100px">
<button class="btn btn-warning" onclick="cleanup()">üßπ Clean</button>
</div>
</div>
<div class="form-group">
<label class="form-label">Export Data</label>
<div style="display:flex;gap:0.5rem;flex-wrap:wrap">
<button class="btn btn-secondary btn-sm" onclick="exportData('messages')">üìù Messages</button>
<button class="btn btn-secondary btn-sm" onclick="exportData('stats')">üìà Stats</button>
</div>
</div>
</div>
<div id="advStatus" class="debug-console" style="margin-top:1rem;display:none"></div>
</div>
</div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const S=new URLSearchParams(location.search).get('secret')||'';
let map=null,layer=null,vectorLayer=null,auto=true;
let addMode=false,selectedMarker=null,clipboard=null,editingMarker=null;
let markerRotations=new Map(); // Store rotation for each marker
let autoMarkerWarningAt=0;
let tempNewMarker=null;
let vectorMode=false;
const markerVectors=new Map();
let markerAnimation=null;
function notif(m,t='info'){const n=document.createElement('div');n.className='notification notification-'+t;n.textContent=m;document.body.appendChild(n);setTimeout(()=>{n.style.opacity='0';n.style.transform='translateX(100px)';setTimeout(()=>n.remove(),300)},4000)}
async function api(e,o={}){try{const u=e.includes('?')?`${e}&secret=${encodeURIComponent(S)}`:`${e}?secret=${encodeURIComponent(S)}`;const r=await fetch(u,o);if(!r.ok)throw new Error(`HTTP ${r.status}`);return await r.json()}catch(err){notif(`Error: ${err.message}`,'error');throw err}}
function initMap(){if(map)return;try{map=L.map('adminMap',{attributionControl:false,zoomControl:true}).setView([49,31.3],6);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map);vectorLayer=L.layerGroup().addTo(map);layer=L.layerGroup().addTo(map);map.on('click',onMapClick);console.log('‚úÖ Map initialized');reloadMarkers()}catch(e){console.error('‚ùå Map failed:',e);notif('Map initialization failed','error')}}

function createRotatableMarker(lat,lng,iconUrl,rotation=0){const iconSize=34;const angle=rotation||0;const icon=L.divIcon({html:`<div class="rotatable-marker" style="transform:rotate(${angle}deg);width:${iconSize}px;height:${iconSize}px"><img src="${iconUrl}" style="width:100%;height:100%;display:block"/></div>`,className:'',iconSize:[iconSize,iconSize],iconAnchor:[iconSize/2,iconSize/2]});return L.marker([lat,lng],{icon:icon,draggable:true});}

function updateVectorSummary(data){const summary=document.getElementById('vectorSummary');const clearBtn=document.getElementById('clearVectorBtn');if(!summary)return;const hasVector=data&&data.trajectory&&data.trajectory.end;const label=(data&&data.course_target)||'';const coords=hasVector?`${data.trajectory.end[0].toFixed(2)}, ${data.trajectory.end[1].toFixed(2)}`:'';const dir=data&&data.course_direction?` (${data.course_direction})`:'';summary.textContent=hasVector?(label?`${label}${dir}`:`${coords}${dir}`):'‚Äî';if(clearBtn){clearBtn.disabled=!hasVector}}

function setVectorMode(state){const btn=document.getElementById('vectorBtn');let desired=!!state;if(desired&&!selectedMarker){notif('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç–∫—É –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è','warning');desired=false;}vectorMode=desired;if(btn){btn.textContent=`üéØ Vector: ${vectorMode?'ON':'OFF'}`;btn.className=vectorMode?'btn btn-success btn-sm':'btn btn-secondary btn-sm';}if(vectorMode){setAddMode(false,{keepTemp:true});if(map)map.getContainer().style.cursor='crosshair';notif('–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –∑–∞–¥–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–µ—Ç–∫–∏','info');}else{if(map&&!addMode)map.getContainer().style.cursor='';}}
function toggleVectorMode(){setVectorMode(!vectorMode)}

function clearMarkerVector(){if(!selectedMarker){notif('Select a marker first','warning');return;}const data=selectedMarker._markerData||{};data.trajectory=null;data.course_direction=null;data.course_target=null;data.course_source=null;data.course_type=null;removeVectorForMarker(selectedMarker);const labelInput=document.getElementById('editVectorLabel');if(labelInput)labelInput.value='';updateVectorSummary(data);notif('Vector cleared','info');}

function removeVectorForMarker(marker){if(!marker)return;const entry=markerVectors.get(marker._leaflet_id);if(entry){if(vectorLayer){if(entry.line)vectorLayer.removeLayer(entry.line);if(entry.arrow)vectorLayer.removeLayer(entry.arrow);}markerVectors.delete(marker._leaflet_id);}}

function renderVectorForMarker(marker){if(!marker||!vectorLayer)return;removeVectorForMarker(marker);const data=marker._markerData||{};const traj=data.trajectory;if(!traj||!traj.end)return;const start=traj.start||[marker.getLatLng().lat,marker.getLatLng().lng];const end=traj.end;if(typeof start[0]!=='number'||typeof end[0]!=='number')return;const line=L.polyline([start,end],{color:'#f97316',weight:4,opacity:0.85,dashArray:'8 4'}).addTo(vectorLayer);const angle=Math.atan2(end[0]-start[0],end[1]-start[1])*180/Math.PI+90;const arrowIcon=L.divIcon({html:`<div style="transform:rotate(${angle}deg);color:#f97316;font-weight:700;font-size:18px;">‚ñ≤</div>`,className:'',iconSize:[18,18],iconAnchor:[9,9]});const arrow=L.marker([end[0],end[1]],{icon:arrowIcon,interactive:false}).addTo(vectorLayer);markerVectors.set(marker._leaflet_id,{line,arrow});}

function computeDirectionMeta(start,end){const dy=end[0]-start[0];const dx=end[1]-start[1];const absDy=Math.abs(dy);const absDx=Math.abs(dx);let token=null;if(absDy<1e-6&&absDx<1e-6)return {token:null,label:null,arrow:null};if(absDy>absDx*1.4){token=dy>0?'n':'s';}else if(absDx>absDy*1.4){token=dx>0?'e':'w';}else if(dy>=0&&dx>=0){token='ne';}else if(dy>=0&&dx<0){token='nw';}else if(dy<0&&dx>=0){token='se';}else{token='sw';}const courseLabels={n:'–ø—ñ–≤–Ω—ñ—á',s:'–ø—ñ–≤–¥–µ–Ω—å',e:'—Å—Ö—ñ–¥',w:'–∑–∞—Ö—ñ–¥',ne:'–ø—ñ–≤–Ω—ñ—á–Ω–∏–π —Å—Ö—ñ–¥',nw:'–ø—ñ–≤–Ω—ñ—á–Ω–∏–π –∑–∞—Ö—ñ–¥',se:'–ø—ñ–≤–¥–µ–Ω–Ω–∏–π —Å—Ö—ñ–¥',sw:'–ø—ñ–≤–¥–µ–Ω–Ω–∏–π –∑–∞—Ö—ñ–¥'};const arrowLabels={n:'–ø—ñ–≤–Ω–æ—á—ñ',s:'–ø—ñ–≤–¥–Ω—è',e:'—Å—Ö–æ–¥—É',w:'–∑–∞—Ö–æ–¥—É',ne:'–ø—ñ–≤–Ω—ñ—á–Ω–æ–≥–æ —Å—Ö–æ–¥—É',nw:'–ø—ñ–≤–Ω—ñ—á–Ω–æ–≥–æ –∑–∞—Ö–æ–¥—É',se:'–ø—ñ–≤–¥–µ–Ω–Ω–æ–≥–æ —Å—Ö–æ–¥—É',sw:'–ø—ñ–≤–¥–µ–Ω–Ω–æ–≥–æ –∑–∞—Ö–æ–¥—É'};return {token,label:courseLabels[token]||null,arrow:arrowLabels[token]||null};}

function applyVectorToMarker(marker,latlng){
	const data=marker._markerData||{};
	const startLat=parseFloat(document.getElementById('editLat').value)||marker.getLatLng().lat;
	const startLng=parseFloat(document.getElementById('editLng').value)||marker.getLatLng().lng;
	const start=[startLat,startLng];
	const end=[latlng.lat,latlng.lng];
	const dirMeta=computeDirectionMeta(start,end);
	const trajectory={start,end,source:data.place||'manual',target:data.course_target||null,kind:'manual_vector'};
	data.trajectory=trajectory;
	data.course_direction=dirMeta.label?`–∫—É—Ä—Å –Ω–∞ ${dirMeta.label}`:null;
	data.course_source=data.place||'manual';
	data.course_type='manual_vector';
	if(dirMeta.arrow&&data.place){
		const base=data.place.split('‚Üê')[0].trim();
		data.place=`${base} ‚Üê${dirMeta.arrow}`.trim();
		document.getElementById('editPlace').value=data.place;
	}
	const labelInput=document.getElementById('editVectorLabel');
	if(labelInput){
		if(!labelInput.value){
			labelInput.value=dirMeta.label||'';
		}
		data.course_target=(labelInput.value||'').trim()||null;
	}
	if(data.trajectory){
		data.trajectory.target=data.course_target||null;
	}
	renderVectorForMarker(marker);
	updateVectorSummary(data);
	if(selectedMarker===marker){setAnimationInputsFromTarget({lat:end[0],lng:end[1]});}
	notif('Vector updated. –ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Ç–∫—É.','success');
	setVectorMode(false);
}

function updateMarkerVectorLabel(value){if(!selectedMarker)return;const data=selectedMarker._markerData||{};const v=(value||'').trim();data.course_target=v||null;if(data.trajectory){data.trajectory.target=v||null;}updateVectorSummary(data);}

function getAnimationControls(){return{latInput:document.getElementById('animTargetLat'),lngInput:document.getElementById('animTargetLng'),durationInput:document.getElementById('animDuration'),cancelBtn:document.getElementById('cancelAnimBtn')}}

function getPreferredAnimationTarget(data){if(!data)return null;if(data.animation_target&&typeof data.animation_target.lat==='number'&&typeof data.animation_target.lng==='number')return data.animation_target;if(data.trajectory&&data.trajectory.end&&typeof data.trajectory.end[0]==='number'&&typeof data.trajectory.end[1]==='number'){return{lat:data.trajectory.end[0],lng:data.trajectory.end[1]}}return null}

function populateAnimationInputs(data){const{latInput,lngInput,durationInput}=getAnimationControls();if(!latInput||!lngInput||!durationInput)return;const target=getPreferredAnimationTarget(data);if(target){latInput.value=target.lat.toFixed(6);lngInput.value=target.lng.toFixed(6)}else{latInput.value='';lngInput.value='';}const duration=(data&&data.animation_duration)||4;durationInput.value=duration}

function setAnimationInputsFromTarget(target){const{latInput,lngInput}=getAnimationControls();if(!latInput||!lngInput)return;if(target){latInput.value=target.lat.toFixed(6);lngInput.value=target.lng.toFixed(6)}else{latInput.value='';lngInput.value='';}storeAnimationTarget()}

function storeAnimationTarget(){if(!selectedMarker)return;const{latInput,lngInput,durationInput}=getAnimationControls();if(!latInput||!lngInput||!durationInput)return;const data=selectedMarker._markerData=selectedMarker._markerData||{};const lat=parseFloat(latInput.value);const lng=parseFloat(lngInput.value);const duration=parseFloat(durationInput.value)||4;if(!Number.isNaN(lat)&&!Number.isNaN(lng)){data.animation_target={lat,lng}}else{delete data.animation_target}data.animation_duration=Math.max(0.5,duration)}

function setAnimationTargetFromMarker(){if(!selectedMarker){notif('Select a marker first','warning');return;}const pos=selectedMarker.getLatLng();setAnimationInputsFromTarget({lat:pos.lat,lng:pos.lng});notif('–¶–µ–ª—å –∞–Ω–∏–º–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Ç–µ–∫—É—â–∏–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏','info')}

function useVectorForAnimation(){if(!selectedMarker){notif('Select a marker first','warning');return;}const data=selectedMarker._markerData||{};const traj=data.trajectory; if(!traj||!traj.end){notif('–°–Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–π—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ','warning');return;}setAnimationInputsFromTarget({lat:traj.end[0],lng:traj.end[1]});notif('–¶–µ–ª—å –∞–Ω–∏–º–∞—Ü–∏–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –∏–∑ –≤–µ–∫—Ç–æ—Ä–∞','success')}

function updateAnimationButtonState(running){const{cancelBtn}=getAnimationControls();if(cancelBtn){cancelBtn.disabled=!running}}

function finalizeMarkerAnimation(){if(markerAnimation&&markerAnimation.marker&&markerAnimation.marker.dragging){markerAnimation.marker.dragging.enable();}markerAnimation=null;updateAnimationButtonState(false)}

function cancelMarkerAnimation(silent=false){if(!markerAnimation)return;if(markerAnimation.frame)cancelAnimationFrame(markerAnimation.frame);finalizeMarkerAnimation();if(!silent)notif('–ê–Ω–∏–º–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞','info')}

function animateSelectedMarker(){if(!selectedMarker){notif('Select a marker first','warning');return;}const{latInput,lngInput,durationInput}=getAnimationControls();if(!latInput||!lngInput||!durationInput){notif('–ö–æ–Ω—Ç—Ä–æ–ª—ã –∞–Ω–∏–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã','error');return;}const targetLat=parseFloat(latInput.value);const targetLng=parseFloat(lngInput.value);if(Number.isNaN(targetLat)||Number.isNaN(targetLng)){notif('–£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω–µ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∞–Ω–∏–º–∞—Ü–∏–∏','warning');return;}const durationSec=Math.max(0.5,parseFloat(durationInput.value)||4);const current=selectedMarker.getLatLng();if(Math.abs(current.lat-targetLat)<1e-6&&Math.abs(current.lng-targetLng)<1e-6){notif('–ú–µ—Ç–∫–∞ —É–∂–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —ç—Ç–æ–π —Ç–æ—á–∫–µ','info');return;}cancelMarkerAnimation(true);const data=selectedMarker._markerData=selectedMarker._markerData||{};const start={lat:current.lat,lng:current.lng};const end={lat:targetLat,lng:targetLng};markerAnimation={marker:selectedMarker,start,end,duration:durationSec*1000,startTime:null,frame:null,data};if(selectedMarker.dragging)selectedMarker.dragging.disable();updateAnimationButtonState(true);const easeOut=t=>1-Math.pow(1-t,3);const step=timestamp=>{if(!markerAnimation||markerAnimation.marker!==selectedMarker)return;if(!markerAnimation.startTime)markerAnimation.startTime=timestamp;const progress=Math.min((timestamp-markerAnimation.startTime)/markerAnimation.duration,1);const eased=easeOut(progress);const lat=start.lat+(end.lat-start.lat)*eased;const lng=start.lng+(end.lng-start.lng)*eased;selectedMarker.setLatLng([lat,lng]);data.lat=lat;data.lng=lng;if(data.trajectory&&data.trajectory.start){data.trajectory.start=[lat,lng];}document.getElementById('editLat').value=lat.toFixed(6);document.getElementById('editLng').value=lng.toFixed(6);if(progress<1){markerAnimation.frame=requestAnimationFrame(step);}else{finalizeMarkerAnimation();if(data.trajectory)renderVectorForMarker(selectedMarker);notif('–ú–µ—Ç–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ —Ç–æ—á–∫—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è','success');}};markerAnimation.frame=requestAnimationFrame(step)}

async function reloadMarkers(){if(!map||!layer)return;if(markerAnimation){console.log('‚è∏Ô∏è Reload paused: animation in progress');return}if(tempNewMarker&&tempNewMarker._isNew){console.log('‚è∏Ô∏è Reload paused: new marker in progress');return}try{const d=await fetch(`/data?timeRange=40&confRange=0&maxTracks=100&ts=${Date.now()}`).then(r=>r.json());const t=d.tracks||[];layer.clearLayers();markerRotations.clear();if(vectorLayer){vectorLayer.clearLayers();markerVectors.clear();}t.forEach(m=>{if(!m.lat||!m.lng)return;const rotation=m.rotation||0;const k=createRotatableMarker(m.lat,m.lng,`/static/${m.threat_type||'shahed'}.png`,rotation);k.addTo(layer);k._markerData={id:m.id||null,lat:m.lat,lng:m.lng,place:m.place||'',type:m.threat_type||'shahed',text:m.text||'',rotation:rotation,channel:m.channel||'admin',manual:!!m.manual,trajectory:m.trajectory||null,course_direction:m.course_direction||null,course_target:m.course_target||null,course_source:m.course_source||null,course_type:m.course_type||null};markerRotations.set(k._leaflet_id,rotation);if(k._markerData.trajectory)renderVectorForMarker(k);k.on('click',function(e){L.DomEvent.stopPropagation(e);selectMarker(k)});k.on('drag',function(){const pos=k.getLatLng();if(selectedMarker===k){document.getElementById('editLat').value=pos.lat.toFixed(6);document.getElementById('editLng').value=pos.lng.toFixed(6)}});k.on('dragend',function(){const pos=k.getLatLng();k._markerData.lat=pos.lat;k._markerData.lng=pos.lng;if(k._markerData.trajectory&&k._markerData.trajectory.start){k._markerData.trajectory.start=[pos.lat,pos.lng];renderVectorForMarker(k);}if(selectedMarker===k){document.getElementById('editLat').value=pos.lat.toFixed(6);document.getElementById('editLng').value=pos.lng.toFixed(6);}persistMarkerPosition(k);});const p=`<div style="font-size:0.85rem;max-width:250px"><strong style="color:#3b82f6">${m.place||'Unknown'}</strong><br><div style="margin:6px 0">${(m.text||'').slice(0,200)}</div><div style="opacity:0.7;font-size:0.75rem">${m.date||''}</div></div>`;k.bindPopup(p)});document.getElementById('mapStats').textContent=`üìç Markers: ${t.length}`;console.log(`‚úÖ Loaded ${t.length} markers`)}catch(e){console.error('‚ùå Load failed:',e);notif('Failed to load markers','error')}}

async function persistMarkerPosition(marker){const data=marker?._markerData||{};if(!data.manual){const now=Date.now();if(now-autoMarkerWarningAt>5000){notif('This marker comes from live feed; drag changes reset on refresh. Save manual markers instead.','warning');autoMarkerWarningAt=now;}setTimeout(()=>reloadMarkers(),500);return;}if(!data.id){console.warn('Cannot persist marker without id');return;}const payload={id:data.id,lat:data.lat,lng:data.lng,place:data.place||'',threat_type:data.type||'manual',text:data.text||'',rotation:data.rotation||0,trajectory:data.trajectory||null,course_direction:data.course_direction||null,course_target:data.course_target||null,course_source:data.course_source||null,course_type:data.course_type||null};try{const response=await fetch('/admin/update_manual_marker?secret='+encodeURIComponent(S),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(!response.ok){const txt=await response.text();throw new Error(txt||'Failed to save position');}console.log(`üíæ Position saved for manual marker ${data.id}`);}catch(err){console.error('Position save failed:',err);notif('Failed to save marker position: '+err.message,'error');setTimeout(()=>reloadMarkers(),800);}}

function setAddMode(state,{keepTemp=false}={}){addMode=state;const btn=document.getElementById('addModeBtn');if(!btn||!map)return;if(addMode){btn.textContent='‚ûï Add Mode: ON';btn.className='btn btn-success btn-sm';map.getContainer().style.cursor='crosshair';setVectorMode(false);notif('–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –º–µ—Ç–∫—É','info')}else{btn.textContent='‚ûï Add Mode: OFF';btn.className='btn btn-primary btn-sm';if(!vectorMode)map.getContainer().style.cursor='';if(!keepTemp&&tempNewMarker){layer.removeLayer(tempNewMarker);tempNewMarker=null}}}
function toggleAddMode(){setAddMode(!addMode)}

function onMapClick(e){if(vectorMode){if(!selectedMarker){notif('Select a marker first','warning');setVectorMode(false);return;}applyVectorToMarker(selectedMarker,e.latlng);return;}if(!addMode)return;const lat=e.latlng.lat;const lng=e.latlng.lng;if(tempNewMarker){layer.removeLayer(tempNewMarker);}const iconUrl='/static/shahed.png';tempNewMarker=createRotatableMarker(lat,lng,iconUrl,0);tempNewMarker._markerData={id:null,lat:lat,lng:lng,place:'',type:'manual',text:'',rotation:0,channel:'admin',manual:true,trajectory:null,course_direction:null,course_target:null,course_source:null,course_type:null};tempNewMarker._isNew=true;tempNewMarker.addTo(layer);tempNewMarker.on('drag',function(){const pos=tempNewMarker.getLatLng();document.getElementById('editLat').value=pos.lat.toFixed(6);document.getElementById('editLng').value=pos.lng.toFixed(6)});tempNewMarker.on('dragend',function(){const pos=tempNewMarker.getLatLng();tempNewMarker._markerData.lat=pos.lat;tempNewMarker._markerData.lng=pos.lng;if(tempNewMarker._markerData.trajectory){tempNewMarker._markerData.trajectory.start=[pos.lat,pos.lng];renderVectorForMarker(tempNewMarker);}document.getElementById('editLat').value=pos.lat.toFixed(6);document.getElementById('editLng').value=pos.lng.toFixed(6)});setAddMode(false,{keepTemp:true});const latFixed=lat.toFixed(6);const lngFixed=lng.toFixed(6);document.getElementById('mmLat').value=latFixed;document.getElementById('mmLng').value=lngFixed;if(document.getElementById('mmPlace'))document.getElementById('mmPlace').value='';document.getElementById('mmText').value=`Marker at ${latFixed}, ${lngFixed}`;selectMarker(tempNewMarker);document.getElementById('editPlace').value='';document.getElementById('editType').value='manual';document.getElementById('editText').value='';document.getElementById('editRotation').value=0;notif('–ù–æ–≤–∞—è –º–µ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∞. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –∏ –Ω–∞–∂–º–∏—Ç–µ –°–æ–∑–¥–∞—Ç—å.','success')}

function selectMarker(marker){cancelMarkerAnimation(true);if(selectedMarker&&selectedMarker!==marker){selectedMarker.setOpacity(1)}selectedMarker=marker;marker.setOpacity(0.7);const data=marker._markerData||{};const isNew=!data.id;document.getElementById('editLat').value=data.lat||marker.getLatLng().lat.toFixed(6);document.getElementById('editLng').value=data.lng||marker.getLatLng().lng.toFixed(6);document.getElementById('editPlace').value=data.place||'';document.getElementById('editType').value=data.type||'shahed';document.getElementById('editText').value=data.text||'';document.getElementById('editRotation').value=data.rotation||0;const labelInput=document.getElementById('editVectorLabel');if(labelInput){labelInput.value=data.course_target||'';}updateVectorSummary(data);populateAnimationInputs(data);document.getElementById('clearVectorBtn').disabled=!(data&&data.trajectory);document.getElementById('markerEditor').style.display='block';const saveBtn=document.getElementById('editSaveBtn');if(saveBtn){saveBtn.textContent=isNew?'‚ûï –°–æ–∑–¥–∞—Ç—å':'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}document.getElementById('copyBtn').disabled=isNew;notif(isNew?'–ù–æ–≤–∞—è –º–µ—Ç–∫–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é.':'Marker selected. Edit or copy it.','info')}

function closeMarkerEditor(){document.getElementById('markerEditor').style.display='none';cancelMarkerAnimation(true);if(selectedMarker){if(selectedMarker._isNew&&layer){layer.removeLayer(selectedMarker);tempNewMarker=null;}selectedMarker.setOpacity(1);selectedMarker=null}document.getElementById('copyBtn').disabled=true;const labelInput=document.getElementById('editVectorLabel');if(labelInput)labelInput.value='';updateVectorSummary(null);setVectorMode(false);populateAnimationInputs(null)}

function updateSelectedRotation(angle){if(!selectedMarker)return;const currentLatLng=selectedMarker.getLatLng();const iconUrl=`/static/${selectedMarker._markerData?.type||'shahed'}.png`;const iconSize=34;const icon=L.divIcon({html:`<div class="rotatable-marker" style="transform:rotate(${angle}deg);width:${iconSize}px;height:${iconSize}px"><img src="${iconUrl}" style="width:100%;height:100%;display:block"/></div>`,className:'',iconSize:[iconSize,iconSize],iconAnchor:[iconSize/2,iconSize/2]});selectedMarker.setIcon(icon);selectedMarker.setLatLng(currentLatLng);if(selectedMarker._markerData){selectedMarker._markerData.rotation=parseFloat(angle)}markerRotations.set(selectedMarker._leaflet_id,parseFloat(angle))}

function rotateSelected(delta){if(!selectedMarker){notif('Select a marker first','warning');return}const current=parseFloat(document.getElementById('editRotation').value)||0;const newAngle=current+delta;document.getElementById('editRotation').value=newAngle;updateSelectedRotation(newAngle);notif(`Rotated to ${newAngle}¬∞`,'success')}

function copySelectedMarker(){if(!selectedMarker){notif('Select a marker first','warning');return}if(selectedMarker._isNew){notif('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–æ–≤—É—é –º–µ—Ç–∫—É','warning');return}const data=selectedMarker._markerData||{};clipboard={lat:data.lat||selectedMarker.getLatLng().lat,lng:data.lng||selectedMarker.getLatLng().lng,place:data.place||document.getElementById('editPlace').value,type:data.type||document.getElementById('editType').value,text:data.text||document.getElementById('editText').value,rotation:data.rotation||parseFloat(document.getElementById('editRotation').value)||0,trajectory:data.trajectory||null,course_direction:data.course_direction||null,course_target:data.course_target||null,course_source:data.course_source||null,course_type:data.course_type||null};document.getElementById('pasteBtn').disabled=false;notif('Marker copied to clipboard','success')}

async function pasteMarker(){if(!clipboard){notif('Clipboard is empty. Copy a marker first.','warning');return}try{const response=await fetch('/admin/add_manual_marker?secret='+encodeURIComponent(S),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lat:clipboard.lat,lng:clipboard.lng,place:clipboard.place+' (copy)',threat_type:clipboard.type,text:clipboard.text,rotation:clipboard.rotation,trajectory:clipboard.trajectory,course_direction:clipboard.course_direction,course_target:clipboard.course_target,course_source:clipboard.course_source,course_type:clipboard.course_type})});if(!response.ok)throw new Error('Failed to paste');notif('Marker pasted successfully','success');setTimeout(()=>reloadMarkers(),500)}catch(e){console.error('Paste error:',e);notif('Failed to paste marker: '+e.message,'error')}}

document.addEventListener('keydown',function(e){const active=document.activeElement;const tag=(active&&active.tagName)?active.tagName.toLowerCase():'';const editable=active&&(active.isContentEditable||tag==='input'||tag==='textarea'||tag==='select');const selection=window.getSelection();if(editable||(selection&&selection.toString().length>0))return;const key=e.key?.toLowerCase();if((e.ctrlKey||e.metaKey)&&key==='c'){e.preventDefault();copySelectedMarker();return}if((e.ctrlKey||e.metaKey)&&key==='v'){e.preventDefault();pasteMarker();}});

async function deleteSelected(){if(!selectedMarker){notif('Select a marker first','warning');return}if(selectedMarker._isNew){closeMarkerEditor();notif('–ù–æ–≤–∞—è –º–µ—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞','info');return}if(!confirm('Delete this marker?'))return;const data=selectedMarker._markerData||{};try{await fetch('/hide_marker',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lat:data.lat,lng:data.lng,text:data.text,source:data.channel||'admin'})});notif('Marker deleted','success');closeMarkerEditor();reloadMarkers()}catch(e){notif('Failed to delete marker','error')}}

async function saveMarkerEdit(){
	if(!selectedMarker){notif('No marker selected','warning');return}
	const newLat=parseFloat(document.getElementById('editLat').value);
	const newLng=parseFloat(document.getElementById('editLng').value);
	const newPlace=(document.getElementById('editPlace').value||'').trim();
	const newType=document.getElementById('editType').value;
	const newText=(document.getElementById('editText').value||'').trim();
	const newRotation=parseFloat(document.getElementById('editRotation').value)||0;
	if(Number.isNaN(newLat)||Number.isNaN(newLng)){notif('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã','warning');return}
	if(!newText){notif('–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è','warning');return}
	const markerData=selectedMarker._markerData=selectedMarker._markerData||{};
	const markerId=markerData.id;
	const isNew=!markerId;
	const endpoint=isNew?'/admin/add_manual_marker':'/admin/update_manual_marker';
	markerData.lat=newLat;
	markerData.lng=newLng;
	markerData.place=newPlace;
	markerData.type=newType;
	markerData.text=newText;
	markerData.rotation=newRotation;
	if(newPlace){markerData.course_source=newPlace;}
	const basePayload={lat:newLat,lng:newLng,place:newPlace,threat_type:newType,text:newText,rotation:newRotation,trajectory:markerData.trajectory||null,course_direction:markerData.course_direction||null,course_target:markerData.course_target||null,course_source:markerData.course_source||null,course_type:markerData.course_type||null};
	const payload=isNew?basePayload:{id:markerId,...basePayload};
	const requestInit={method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)};
	const sendRequest=url=>fetch(`${url}?secret=${encodeURIComponent(S)}`,requestInit);
	const parseError=async response=>{const errTxt=await response.text();try{const parsed=JSON.parse(errTxt);return parsed.error||parsed.message||'Failed to save'}catch(_){return errTxt||'Failed to save'}};
	const handleSuccess=message=>{notif(message,'success');closeMarkerEditor();tempNewMarker=null;setTimeout(()=>reloadMarkers(),400)};
	try{
		let response=await sendRequest(endpoint);
		if(!response.ok){
			const errorMessage=await parseError(response);
			const isMissingInsert=!isNew&&response.status===404&&(errorMessage||'').toLowerCase().includes('not found');
			if(isMissingInsert){
				notif('–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–∑–¥–∞—é –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å','warning');
				const recreateInit={...requestInit,body:JSON.stringify(basePayload)};
				const recreateResponse=await fetch(`/admin/add_manual_marker?secret=${encodeURIComponent(S)}`,recreateInit);
				if(!recreateResponse.ok){
					const recreateError=await parseError(recreateResponse);
					throw new Error(recreateError);
				}
				handleSuccess('–ú–µ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –∑–∞–Ω–æ–≤–æ');
				return;
			}
			throw new Error(errorMessage);
		}
		handleSuccess(isNew?'–ú–µ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∞':'Marker updated successfully');
	}catch(e){
		console.error('Save error:',e);
		notif('Failed to save marker: '+e.message,'error');
	}
}
async function deleteMarkerFromMap(lat,lng,text,source){try{await fetch('/hide_marker',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lat,lng,text,source})});notif('Marker deleted','success');reloadMarkers()}catch(e){notif('Failed to delete marker','error')}}
function toggleAuto(){auto=!auto;const b=document.getElementById('autoBtn');b.textContent=`üîÅ Auto: ${auto?'ON':'OFF'}`;b.className=auto?'btn btn-success btn-sm':'btn btn-secondary btn-sm'}
async function blockUser(id){try{await api('/block',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});notif('User blocked successfully','success');setTimeout(()=>location.reload(),1000)}catch(e){}}
async function unblockUser(id){try{await api('/unblock',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});notif('User unblocked successfully','success');setTimeout(()=>location.reload(),1000)}catch(e){}}
async function saveMonPeriod(){const v=document.getElementById('monPeriod').value;const s=document.getElementById('monStatus');s.style.display='inline-flex';s.textContent='Saving...';try{await api('/admin/set_monitor_period',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({value:parseInt(v)})});s.textContent='‚úÖ Saved';notif('Monitor period updated','success')}catch(e){s.textContent='‚ùå Error'}}
document.getElementById('markerForm').addEventListener('submit',async(e)=>{e.preventDefault();const lat=document.getElementById('mmLat').value;const lng=document.getElementById('mmLng').value;const place=document.getElementById('mmPlace').value;const threat_type=document.getElementById('mmType').value;const text=document.getElementById('mmText').value;const s=document.getElementById('mmStatus');s.style.display='inline-flex';s.textContent='Creating...';try{await api('/admin/add_manual_marker',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lat,lng,place,threat_type,text})});s.textContent='‚úÖ Created';notif('Marker created successfully','success');setTimeout(()=>location.reload(),1000)}catch(err){s.textContent=`‚ùå ${err.message||'Error'}`}});
async function hideMarker(lat,lng,text,source){try{await fetch('/hide_marker',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lat,lng,text,source})});notif('Marker hidden','success');setTimeout(()=>location.reload(),1000)}catch(e){}}
async function loadHiddenMarkers(){try{const d=await api('/admin/hidden_markers');const h=d.hidden||[];document.getElementById('hiddenCount').textContent=h.length;const c=document.getElementById('hiddenMarkersContainer');if(h.length===0){c.innerHTML='<div class="empty-state"><div class="empty-state-icon">üëÅÔ∏è</div><p>No hidden markers</p></div>';return}let html='<div style="max-height:400px;overflow-y:auto"><table class="table"><thead><tr><th>Location</th><th>Text</th><th>Hidden Date</th><th>Action</th></tr></thead><tbody>';h.forEach(m=>{html+=`<tr><td>${m.lat.toFixed(4)}, ${m.lng.toFixed(4)}</td><td style="max-width:300px;overflow:hidden;text-overflow:ellipsis">${(m.text||'').substring(0,100)}</td><td>${m.hidden_date||''}</td><td><button class="btn btn-success btn-sm" onclick="unhideMarker(${m.lat},${m.lng},'${(m.text||'').replace(/'/g,"\\'")}','${m.source||''}')">‚Ü©Ô∏è Restore</button></td></tr>`});html+='</tbody></table></div>';c.innerHTML=html}catch(e){console.error('Failed to load hidden markers:',e);notif('Failed to load hidden markers','error')}}
async function unhideMarker(lat,lng,text,source){try{await api('/admin/unhide_marker',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lat,lng,text,source})});notif('Marker restored','success');loadHiddenMarkers();reloadMarkers()}catch(e){notif('Failed to restore marker','error')}}
async function clearCache(){if(!confirm('Clear all negative geocode cache? This cannot be undone.'))return;try{await api('/admin/neg_geocode_clear',{method:'POST'});notif('Cache cleared successfully','success');setTimeout(()=>location.reload(),1000)}catch(e){}}
async function delCache(name){try{await api('/admin/neg_geocode_delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})});notif('Cache entry deleted','success');setTimeout(()=>location.reload(),1000)}catch(e){}}
async function clearLogs(){if(!confirm('Clear all debug logs? This cannot be undone.'))return;try{await api('/admin/clear_debug_logs',{method:'POST'});notif('Debug logs cleared','success');setTimeout(()=>location.reload(),1000)}catch(e){}}
async function loadStats(){const s=document.getElementById('advStatus');s.style.display='block';try{const d=await api('/admin/stats');const t=d.stats;let h='';h+=`<div class="debug-entry"><span class="debug-category">MESSAGES</span><span class="debug-message">Total: ${t.messages.total}, Geo: ${t.messages.with_coordinates}, Pending: ${t.messages.pending_geo}, Recent 24h: ${t.messages.recent_24h}</span></div>`;h+=`<div class="debug-entry"><span class="debug-category">SYSTEM</span><span class="debug-message">Active Users: ${t.system.active_users}, Blocked: ${t.system.blocked_users}, Hidden Markers: ${t.system.hidden_markers}, Cache Size: ${t.system.neg_cache_size}</span></div>`;s.innerHTML=h}catch(e){s.innerHTML=`<div class="debug-entry"><span class="debug-message">Error: ${e.message}</span></div>`}}
async function cleanup(){const d=document.getElementById('cleanDays').value;if(!confirm(`Clean up data older than ${d} days? This cannot be undone.`))return;const s=document.getElementById('advStatus');s.style.display='block';s.innerHTML='<div class="debug-entry"><span class="debug-message">Cleaning up old data...</span></div>';try{const r=await api('/admin/cleanup',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({days:parseInt(d)})});s.innerHTML=`<div class="debug-entry"><span class="debug-category">CLEANED</span><span class="debug-message">Messages: ${r.cleaned.messages}, Debug Logs: ${r.cleaned.debug_logs}, Visitor Records: ${r.cleaned.visitor_records}</span></div>`;s.innerHTML+=`<div class="debug-entry"><span class="debug-category">REMAINING</span><span class="debug-message">Messages: ${r.remaining.messages}, Debug Logs: ${r.remaining.debug_logs}</span></div>`;notif('Cleanup completed successfully','success');setTimeout(()=>location.reload(),2000)}catch(e){s.innerHTML=`<div class="debug-entry"><span class="debug-message">Error: ${e.message}</span></div>`}}
async function exportData(type){try{const d=await api(`/admin/export?type=${type}`);const b=new Blob([JSON.stringify(d.data,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`neptun_${type}_${new Date().toISOString().split('T')[0]}.json`;a.click();URL.revokeObjectURL(u);notif(`Exported ${type} data successfully`,'success')}catch(e){}}
async function forceReload(){if(!confirm('‚ö†Ô∏è WARNING: This will force reload the page for ALL active users!\n\nContinue?'))return;try{await api('/admin/trigger-force-reload',{method:'POST'});notif('Force reload activated for all users','success')}catch(e){}}
async function updateRaw(){try{const d=await api('/admin/raw_msgs');document.getElementById('rawCount').textContent=d.raw_count;const t=document.getElementById('rawTable');if(t&&d.raw_msgs.length>0){t.innerHTML=d.raw_msgs.map(r=>`<tr><td style="white-space:nowrap;font-size:0.8rem">${r.date}</td><td><span class="badge info">${r.channel}</span></td><td class="truncate" style="max-width:500px" title="${r.text}">${r.text}</td></tr>`).join('')}}catch(e){console.warn('Raw messages update failed:',e)}}
async function updateStats(){try{const d=await api('/admin/stats');const s=d.stats;document.getElementById('statActive').textContent=s.system.active_users;document.getElementById('statBlocked').textContent=s.system.blocked_users;document.getElementById('statPending').textContent=s.messages.pending_geo;document.getElementById('statMarkers').textContent=s.messages.with_coordinates;document.getElementById('statDebug').textContent=s.system.debug_logs}catch(e){console.warn('Stats update failed:',e)}}
setInterval(()=>{if(auto&&map)reloadMarkers()},30000);
setInterval(updateRaw,15000);
setInterval(updateStats,20000);
document.addEventListener('DOMContentLoaded',()=>{console.log('üåä Neptun Admin Dashboard initialized');if(typeof L==='undefined'){notif('Leaflet library failed to load','error');return}setTimeout(()=>{initMap();updateStats();updateRaw();loadHiddenMarkers()},100)});
</script>
</body>
</html>
