<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Neptun Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NEPTUN ADMIN â€” Apple/Linear Style Redesign
   Design System: Minimal, Calm, Premium
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

*, *::before, *::after {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  /* Core Palette â€” Neutral Dark */
  --bg-primary: #0c0c0e;
  --bg-secondary: #141416;
  --bg-tertiary: #1c1c1f;
  --bg-elevated: #232326;
  
  /* Borders â€” Subtle */
  --border-subtle: rgba(255,255,255,0.06);
  --border-default: rgba(255,255,255,0.08);
  --border-hover: rgba(255,255,255,0.12);
  
  /* Accent â€” Single Cold Blue */
  --accent: #3b82f6;
  --accent-muted: rgba(59,130,246,0.15);
  --accent-subtle: rgba(59,130,246,0.08);
  
  /* Semantic */
  --success: #22c55e;
  --success-muted: rgba(34,197,94,0.12);
  --danger: #ef4444;
  --danger-muted: rgba(239,68,68,0.12);
  --warning: #f59e0b;
  --warning-muted: rgba(245,158,11,0.12);
  
  /* Text */
  --text-primary: #fafafa;
  --text-secondary: rgba(250,250,250,0.64);
  --text-tertiary: rgba(250,250,250,0.4);
  
  /* Timing */
  --ease-out: cubic-bezier(0.22, 1, 0.36, 1);
  --duration-fast: 150ms;
  --duration-normal: 200ms;
  --duration-slow: 300ms;
  
  /* Spacing */
  --space-xs: 0.25rem;
  --space-sm: 0.5rem;
  --space-md: 1rem;
  --space-lg: 1.5rem;
  --space-xl: 2rem;
  --space-2xl: 3rem;
  
  /* Radius */
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 14px;
  --radius-xl: 20px;
}

@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    transition-duration: 0.01ms !important;
  }
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  line-height: 1.5;
  font-size: 14px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Layout
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.container {
  max-width: 1440px;
  margin: 0 auto;
  padding: var(--space-xl);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Header â€” Clean, Minimal
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
  background: var(--bg-secondary);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-lg);
  padding: var(--space-lg) var(--space-xl);
  margin-bottom: var(--space-xl);
}

.header-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--space-lg);
  flex-wrap: wrap;
}

.header-title h1 {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--text-primary);
  letter-spacing: -0.02em;
  display: flex;
  align-items: center;
  gap: var(--space-sm);
}

.header-title h1::before {
  content: '';
  width: 8px;
  height: 8px;
  background: var(--accent);
  border-radius: 50%;
  box-shadow: 0 0 12px var(--accent);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Badges â€” Subtle, Calm
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.status-badges {
  display: flex;
  gap: var(--space-sm);
  flex-wrap: wrap;
}

.badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: var(--radius-sm);
  font-size: 12px;
  font-weight: 500;
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 1px solid var(--border-subtle);
  transition: all var(--duration-fast) var(--ease-out);
}

.badge.success {
  background: var(--success-muted);
  color: var(--success);
  border-color: transparent;
}

.badge.danger {
  background: var(--danger-muted);
  color: var(--danger);
  border-color: transparent;
}

.badge.info {
  background: var(--accent-subtle);
  color: var(--accent);
  border-color: transparent;
}

.badge.warning {
  background: var(--warning-muted);
  color: var(--warning);
  border-color: transparent;
}

.status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
}

.status-dot.online {
  background: var(--success);
  animation: softPulse 2.5s ease-in-out infinite;
}

.status-dot.offline {
  background: var(--text-tertiary);
}

@keyframes softPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Buttons â€” Apple-style
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 8px 14px;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all var(--duration-normal) var(--ease-out);
  text-decoration: none;
  white-space: nowrap;
  position: relative;
  overflow: hidden;
}

.btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none !important;
}

.btn:active:not(:disabled) {
  transform: scale(0.97);
}

.btn-primary {
  background: var(--accent);
  color: #fff;
}

.btn-primary:hover:not(:disabled) {
  background: #4b8ef7;
  box-shadow: 0 4px 16px rgba(59,130,246,0.3);
}

.btn-success {
  background: var(--success);
  color: #fff;
}

.btn-success:hover:not(:disabled) {
  background: #2dd468;
  box-shadow: 0 4px 16px rgba(34,197,94,0.25);
}

.btn-danger {
  background: var(--danger);
  color: #fff;
}

.btn-danger:hover:not(:disabled) {
  background: #f55a5a;
  box-shadow: 0 4px 16px rgba(239,68,68,0.25);
}

.btn-warning {
  background: var(--warning);
  color: #fff;
}

.btn-secondary {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 1px solid var(--border-default);
}

.btn-secondary:hover:not(:disabled) {
  background: var(--bg-elevated);
  border-color: var(--border-hover);
  color: var(--text-primary);
}

.btn-sm {
  padding: 6px 10px;
  font-size: 12px;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Inputs â€” Clean
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.input {
  background: var(--bg-primary);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-sm);
  padding: 10px 12px;
  color: var(--text-primary);
  font-size: 13px;
  transition: all var(--duration-fast) var(--ease-out);
  width: 100%;
}

.input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-muted);
}

.input::placeholder {
  color: var(--text-tertiary);
}

textarea.input {
  resize: vertical;
  min-height: 72px;
  font-family: inherit;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Cards â€” No gradient, subtle elevation
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: var(--bg-secondary);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-lg);
  overflow: hidden;
  margin-bottom: var(--space-xl);
  transition: border-color var(--duration-normal) var(--ease-out);
}

.card.card-map {
  overflow: visible;
}

.card.card-map .card-body {
  overflow: visible;
}

.card:hover {
  border-color: var(--border-hover);
}

.card-header {
  padding: var(--space-md) var(--space-lg);
  border-bottom: 1px solid var(--border-subtle);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: var(--space-md);
}

.card-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: var(--space-sm);
}

.card-body {
  padding: var(--space-lg);
}

.card-body.compact {
  padding: var(--space-md);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Stats Grid â€” Clean metrics
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: var(--space-md);
  margin-bottom: var(--space-xl);
}

.stat-card {
  background: var(--bg-tertiary);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-md);
  padding: var(--space-lg);
  text-align: center;
  transition: all var(--duration-normal) var(--ease-out);
}

.stat-card:hover {
  transform: translateY(-2px);
  border-color: var(--border-hover);
}

.stat-value {
  font-size: 2rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
  line-height: 1;
  letter-spacing: -0.02em;
}

.stat-label {
  font-size: 12px;
  color: var(--text-tertiary);
  font-weight: 500;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Tables â€” Minimal
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-container {
  overflow-x: auto;
  border-radius: var(--radius-md);
  border: 1px solid var(--border-subtle);
}

.table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.table th {
  background: var(--bg-tertiary);
  padding: 12px 16px;
  text-align: left;
  font-weight: 500;
  color: var(--text-secondary);
  border-bottom: 1px solid var(--border-subtle);
  white-space: nowrap;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

.table td {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border-subtle);
  color: var(--text-secondary);
}

.table tbody tr {
  transition: background var(--duration-fast) var(--ease-out);
}

.table tbody tr:hover {
  background: var(--bg-tertiary);
}

.table tbody tr:last-child td {
  border-bottom: none;
}

.truncate {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Forms
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.form-label {
  font-size: 12px;
  font-weight: 500;
  color: var(--text-secondary);
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: var(--space-md);
  align-items: end;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Debug Console
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.debug-console {
  background: var(--bg-primary);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-md);
  max-height: 400px;
  overflow-y: auto;
  font-family: 'SF Mono', Monaco, 'Courier New', monospace;
  font-size: 12px;
}

.debug-entry {
  padding: 10px 16px;
  border-bottom: 1px solid var(--border-subtle);
  display: flex;
  gap: 12px;
  align-items: flex-start;
}

.debug-entry:last-child {
  border-bottom: none;
}

.debug-timestamp {
  color: var(--text-tertiary);
  font-size: 11px;
  flex-shrink: 0;
}

.debug-category {
  background: var(--accent-subtle);
  color: var(--accent);
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 600;
  flex-shrink: 0;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.debug-message {
  color: var(--text-secondary);
  flex: 1;
  word-break: break-word;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Map â€” Hero Element
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#adminMap {
  height: 640px;
  width: 100%;
  border-radius: var(--radius-md);
  border: 1px solid var(--border-subtle);
  cursor: crosshair;
}

.map-toolbar {
  display: flex;
  gap: var(--space-sm);
  margin-top: var(--space-md);
  flex-wrap: wrap;
  align-items: center;
}

.map-stats {
  background: var(--bg-tertiary);
  padding: 6px 12px;
  border-radius: var(--radius-sm);
  font-size: 12px;
  color: var(--text-secondary);
  border: 1px solid var(--border-subtle);
  font-weight: 500;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Marker Editor Panel
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.marker-editor {
  position: absolute;
  top: 12px;
  right: 12px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-lg);
  padding: var(--space-md);
  z-index: 1000;
  min-width: 260px;
  max-height: calc(100vh - 48px);
  height: calc(100% - 24px);
  overflow-y: auto;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.marker-editor h3 {
  margin: 0;
  font-size: 13px;
  color: var(--text-primary);
  font-weight: 600;
}

.marker-editor-field {
  margin-bottom: 8px;
}

.marker-editor-field label {
  display: block;
  font-size: 11px;
  color: var(--text-tertiary);
  margin-bottom: 4px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

.marker-editor-field input,
.marker-editor-field select {
  width: 100%;
  padding: 8px 10px;
  background: var(--bg-primary);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 12px;
}

.marker-editor-field input:focus,
.marker-editor-field select:focus {
  outline: none;
  border-color: var(--accent);
}

.marker-editor-buttons {
  display: flex;
  gap: var(--space-sm);
  margin-top: auto;
  position: sticky;
  bottom: 0;
  background: var(--bg-secondary);
  padding-top: var(--space-sm);
}

.marker-editor-buttons button {
  flex: 1;
  padding: 8px;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out);
}

.rotatable-marker {
  transition: transform var(--duration-fast) var(--ease-out);
  cursor: move;
}

.rotation-handle {
  width: 18px;
  height: 18px;
  background: var(--accent);
  border: 2px solid white;
  border-radius: 50%;
  position: absolute;
  top: -28px;
  left: 50%;
  transform: translateX(-50%);
  cursor: grab;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  z-index: 1001;
}

.rotation-handle:active {
  cursor: grabbing;
}

.vector-summary {
  min-height: 36px;
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-sm);
  padding: 8px 10px;
  background: var(--bg-primary);
  color: var(--text-secondary);
  font-size: 12px;
  line-height: 1.4;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Empty States
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state {
  text-align: center;
  padding: var(--space-2xl) var(--space-xl);
  color: var(--text-tertiary);
}

.empty-state-icon {
  font-size: 2rem;
  margin-bottom: var(--space-md);
  opacity: 0.4;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Notifications â€” Subtle
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.notification {
  position: fixed;
  top: 24px;
  right: 24px;
  padding: 12px 20px;
  border-radius: var(--radius-md);
  color: #fff;
  font-size: 13px;
  font-weight: 500;
  z-index: 10000;
  max-width: 360px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  animation: slideIn var(--duration-slow) var(--ease-out);
}

.notification-success { background: var(--success); }
.notification-error { background: var(--danger); }
.notification-warning { background: var(--warning); }
.notification-info { background: var(--accent); }

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(24px) translateY(-8px);
  }
  to {
    opacity: 1;
    transform: translateX(0) translateY(0);
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Menu Sections â€” Apple Grid Style
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.menu-section {
  background: var(--bg-secondary);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-lg);
  padding: var(--space-xl);
  cursor: pointer;
  transition: all var(--duration-normal) var(--ease-out);
  text-align: center;
}

.menu-section:hover {
  transform: translateY(-4px);
  border-color: var(--border-hover);
  box-shadow: 0 12px 40px rgba(0,0,0,0.2);
}

.menu-icon {
  font-size: 2.5rem;
  margin-bottom: var(--space-md);
  transition: transform var(--duration-normal) var(--ease-out);
  filter: grayscale(0.2);
}

.menu-section:hover .menu-icon {
  transform: scale(1.08);
  filter: grayscale(0);
}

.menu-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.menu-desc {
  font-size: 12px;
  color: var(--text-tertiary);
  line-height: 1.5;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Section Animations â€” Smooth Enter
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.admin-section {
  animation: sectionEnter var(--duration-slow) var(--ease-out);
}

@keyframes sectionEnter {
  from {
    opacity: 0;
    transform: translateY(12px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Toggle Switch â€” Minimal
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 44px;
  height: 24px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--bg-tertiary);
  transition: var(--duration-normal) var(--ease-out);
  border-radius: 24px;
  border: 1px solid var(--border-default);
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 2px;
  bottom: 2px;
  background: white;
  transition: var(--duration-normal) var(--ease-out);
  border-radius: 50%;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}

.toggle-switch input:checked + .toggle-slider {
  background: var(--success);
  border-color: var(--success);
}

.toggle-switch input:checked + .toggle-slider:before {
  transform: translateX(20px);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Scrollbar â€” Minimal
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: var(--bg-elevated);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--border-hover);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Responsive
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 768px) {
  .container {
    padding: var(--space-md);
  }
  
  .header-content {
    flex-direction: column;
    align-items: stretch;
  }
  
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  #adminMap {
    height: 400px;
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Utility â€” Page Load Animation
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.container {
  animation: pageEnter var(--duration-slow) var(--ease-out);
}

@keyframes pageEnter {
  from {
    opacity: 0;
    transform: translateY(8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
</head>
<body>
<div class="container">
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Header â€” Clean & Minimal
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="header">
<div class="header-content">
<div class="header-title"><h1>Neptun Admin</h1></div>
<div class="status-badges">
{% if secret %}
<span class="badge success"><span class="status-dot online"></span>Online</span>
{% else %}
<span class="badge danger"><span class="status-dot offline"></span>Not Authorized</span>
{% endif %}
<span class="badge">Today {{ daily_unique }}</span>
<span class="badge">Week {{ week_unique }}</span>
</div>
<form method="get" action="/admin" style="display:flex;gap:8px;align-items:center">
<input type="text" name="secret" placeholder="Secret key" value="{{ secret }}" class="input" style="width:160px">
<button type="submit" class="btn btn-primary btn-sm">Login</button>
</form>
</div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Main Menu â€” Apple Grid Style
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="mainMenu" style="display:block">
<div class="card">
<div class="card-header">
<h2 class="card-title">Navigation</h2>
</div>
<div class="card-body">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:var(--space-md)">
<div class="menu-section" onclick="showSection('overview')">
<div class="menu-icon">ğŸ“Š</div>
<div class="menu-title">Overview</div>
<div class="menu-desc">System statistics & metrics</div>
</div>
<div class="menu-section" onclick="showSection('map')">
<div class="menu-icon">ğŸ—ºï¸</div>
<div class="menu-title">Live Map</div>
<div class="menu-desc">Markers & trajectories</div>
</div>
<div class="menu-section" onclick="showSection('subscriptions')">
<div class="menu-icon">ğŸ’³</div>
<div class="menu-title">Subscriptions</div>
<div class="menu-desc">Payments & approvals</div>
</div>
<div class="menu-section" onclick="showSection('nicknames')">
<div class="menu-icon">ğŸ†”</div>
<div class="menu-title">User IDs</div>
<div class="menu-desc">Registered identifiers</div>
</div>
<div class="menu-section" onclick="showSection('users')">
<div class="menu-icon">ğŸ‘¥</div>
<div class="menu-title">Users</div>
<div class="menu-desc">Visitors & blocking</div>
</div>
<div class="menu-section" onclick="showSection('messages')">
<div class="menu-icon">ğŸ“¨</div>
<div class="menu-title">Messages</div>
<div class="menu-desc">Pending geocoding</div>
</div>
<div class="menu-section" onclick="showSection('debug')">
<div class="menu-icon">ğŸ”§</div>
<div class="menu-title">Debug</div>
<div class="menu-desc">Logs & diagnostics</div>
</div>
</div>
</div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Section: Overview
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="section-overview" class="admin-section" style="display:none">
<button class="btn btn-secondary btn-sm" onclick="showMainMenu()" style="margin-bottom:var(--space-lg)">â† Back</button>

<div class="stats-grid">
<div class="stat-card">
<div class="stat-value" id="statActive">{{ visitors|length }}</div>
<div class="stat-label">Active Users</div>
</div>
<div class="stat-card">
<div class="stat-value" id="statBlocked">{{ blocked|length }}</div>
<div class="stat-label">Blocked</div>
</div>
<div class="stat-card">
<div class="stat-value" id="statPending">{{ raw_count }}</div>
<div class="stat-label">Pending</div>
</div>
<div class="stat-card">
<div class="stat-value" id="statMarkers">{{ markers|length }}</div>
<div class="stat-label">Markers</div>
</div>
<div class="stat-card">
<div class="stat-value" id="statDebug">{{ debug_logs|length }}</div>
<div class="stat-label">Logs</div>
</div>
</div>

<div class="card card-map">
<div class="card-header">
<h2 class="card-title">Configuration</h2>
</div>
<div class="card-body">
<div class="form-grid">
<div class="form-group">
<label class="form-label">Monitor Period (min)</label>
<input type="number" id="monPeriod" value="{{ monitor_period }}" min="1" max="360" class="input">
</div>
<div style="display:flex;align-items:flex-end;gap:var(--space-sm)">
<button class="btn btn-success btn-sm" onclick="saveMonPeriod()">Save</button>
<span id="monStatus" class="badge" style="display:none"></span>
</div>
</div>


</div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Section: Map â€” Hero Element
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="section-map" class="admin-section" style="display:none">
<button class="btn btn-secondary btn-sm" onclick="showMainMenu()" style="margin-bottom:var(--space-lg)">â† Back</button>

<div class="card">
<div class="card-header">
<h2 class="card-title">Live Map</h2>
<div style="display:flex;gap:6px;flex-wrap:wrap">
<button class="btn btn-primary btn-sm" id="addModeBtn" onclick="toggleAddMode()">Add Mode</button>
<button class="btn btn-secondary btn-sm" onclick="copySelectedMarker()" id="copyBtn" disabled>Copy</button>
<button class="btn btn-secondary btn-sm" onclick="pasteMarker()" id="pasteBtn" disabled>Paste</button>
<button class="btn btn-secondary btn-sm" onclick="rotateSelected(-15)">âˆ’15Â°</button>
<button class="btn btn-secondary btn-sm" onclick="rotateSelected(15)">+15Â°</button>
<button class="btn btn-secondary btn-sm" onclick="toggleVectorMode()" id="vectorBtn">Vector</button>
<button class="btn btn-secondary btn-sm" onclick="clearMarkerVector()" id="clearVectorBtn" disabled>Clear</button>
<button class="btn btn-danger btn-sm" onclick="deleteSelected()">Delete</button>
<button class="btn btn-secondary btn-sm" onclick="reloadMarkers()">Refresh</button>
<button class="btn btn-success btn-sm" onclick="toggleAuto()" id="autoBtn">Auto: ON</button>
<button class="btn btn-secondary btn-sm" onclick="forceReload()">Force Reload</button>
</div>
</div>
<div class="card-body" style="padding:0;position:relative">
<div id="adminMap"></div>
<div id="markerEditor" class="marker-editor" style="display:none">
<h3>Edit Marker</h3>
<div class="marker-editor-field">
<label>Latitude</label>
<input type="number" step="0.000001" id="editLat" class="input">
</div>
<div class="marker-editor-field">
<label>Longitude</label>
<input type="number" step="0.000001" id="editLng" class="input">
</div>
<div class="marker-editor-field">
<label>Location</label>
<input type="text" id="editPlace" class="input">
</div>
<div class="marker-editor-field">
<label>Rotation (deg)</label>
<input type="number" id="editRotation" value="0" min="-180" max="180" step="15" class="input" oninput="updateSelectedRotation(this.value)">
</div>
<div class="marker-editor-field">
<label>Vector Target</label>
<input type="text" id="editVectorLabel" class="input" placeholder="Target / direction" oninput="updateMarkerVectorLabel(this.value)">
</div>
<div class="marker-editor-field">
<label>Vector Summary</label>
<div id="vectorSummary" class="vector-summary">â€”</div>
</div>
<div class="marker-editor-field">
<label>Animation Target</label>
<div style="display:flex;gap:6px">
<input type="number" step="0.000001" id="animTargetLat" class="input" placeholder="Lat" oninput="storeAnimationTarget()">
<input type="number" step="0.000001" id="animTargetLng" class="input" placeholder="Lng" oninput="storeAnimationTarget()">
</div>
</div>
<div class="marker-editor-field">
<label>Duration (sec)</label>
<input type="number" id="animDuration" class="input" min="0.5" step="0.5" value="4" oninput="storeAnimationTarget()">
</div>
<div class="marker-editor-field">
<label>Animation</label>
<div style="display:flex;flex-wrap:wrap;gap:4px">
<button type="button" class="btn btn-secondary btn-sm" onclick="setAnimationTargetFromMarker()">Current</button>
<button type="button" class="btn btn-secondary btn-sm" onclick="useVectorForAnimation()">Vector</button>
<button type="button" class="btn btn-success btn-sm" onclick="animateSelectedMarker()">Play</button>
<button type="button" id="cancelAnimBtn" class="btn btn-danger btn-sm" onclick="cancelMarkerAnimation()" disabled>Stop</button>
</div>
</div>
<div class="marker-editor-field">
<label>Type</label>
<select id="editType" class="input" onchange="updateMarkerIcon(this.value)">
<option value="shahed">Shahed</option>
<option value="raketa">Rocket</option>
<option value="avia">Aviation</option>
<option value="artillery">Artillery</option>
<option value="obstril">Shelling</option>
<option value="fpv">FPV Drone</option>
<option value="pusk">Launch</option>
<option value="vibuh">Explosion</option>
<option value="vidboi">Repel</option>
<option value="rozved">Reconnaissance</option>
<option value="rszv">MLRS</option>
<option value="kab">KAB</option>
<option value="trivoga">Alarm</option>
<option value="manual">Manual</option>
</select>
</div>
<div class="marker-editor-field">
<label>Icon</label>
<div style="display:flex;align-items:center;gap:8px">
<img id="markerIconPreview" src="/static/shahed3.webp" alt="Icon" style="width:28px;height:28px;border-radius:4px;border:1px solid var(--border-subtle);background:#fff;padding:2px">
<span id="markerIconLabel" class="badge">shahed3.webp</span>
</div>
</div>
<div class="marker-editor-field">
<label>Description</label>
<textarea id="editText" class="input" rows="2"></textarea>
</div>
<div class="marker-editor-buttons">
<button id="editSaveBtn" class="btn btn-success" onclick="saveMarkerEdit()">Save</button>
<button class="btn btn-secondary" onclick="closeMarkerEditor()">Cancel</button>
</div>
</div>
<div class="map-toolbar">
<span class="map-stats" id="mapStats">Loading...</span>
</div>
</div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Section: Subscriptions
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="section-subscriptions" class="admin-section" style="display:none">
<button class="btn btn-secondary btn-sm" onclick="showMainMenu()" style="margin-bottom:var(--space-lg)">â† Back</button>

<div class="card">
<div class="card-header">
<h2 class="card-title">Subscriptions <span class="badge success">{{ subscriptions|length if subscriptions else 0 }}</span></h2>
</div>
<div class="card-body">
{% if subscriptions %}
<div class="stats-grid" style="margin-bottom:var(--space-lg)">
<div class="stat-card">
<div class="stat-value">{{ subscriptions|length }}</div>
<div class="stat-label">Total</div>
</div>
<div class="stat-card">
<div class="stat-value">{{ subscriptions|selectattr('status', 'equalto', 'paid')|list|length }}</div>
<div class="stat-label">Paid</div>
</div>
<div class="stat-card">
<div class="stat-value">{{ subscriptions|selectattr('status', 'equalto', 'pending')|list|length }}</div>
<div class="stat-label">Pending</div>
</div>
<div class="stat-card">
<div class="stat-value">{{ (subscriptions|selectattr('status', 'equalto', 'paid')|map(attribute='amount')|sum)|int }}</div>
<div class="stat-label">Revenue (UAH)</div>
</div>
</div>
<div class="table-container">
<table class="table">
<thead>
<tr>
<th>Name</th>
<th>Telegram</th>
<th>Type</th>
<th>Amount</th>
<th>Status</th>
<th>Date</th>
<th>Action</th>
</tr>
</thead>
<tbody>
{% for sub in subscriptions %}
<tr>
<td><strong>{{ sub.name }}</strong></td>
<td>
{% if sub.telegram %}
<a href="https://t.me/{{ sub.telegram|replace('@', '')|replace('https://t.me/', '') }}" target="_blank" style="color:var(--accent)">{{ sub.telegram }}</a>
{% else %}â€”{% endif %}
</td>
<td style="font-size:12px">{{ sub.type }}</td>
<td><strong>{{ sub.amount }} {{ sub.currency }}</strong></td>
<td>
{% if sub.status == 'paid' %}
<span class="badge success">Paid</span>
{% else %}
<span class="badge warning">Pending</span>
{% endif %}
</td>
<td style="font-size:11px;color:var(--text-tertiary)">{{ sub.timestamp[:16].replace('T', ' ') }}</td>
<td>
{% if sub.status == 'pending' %}
<button class="btn btn-success btn-sm" onclick="approveSubscription('{{ sub.id }}')">Approve</button>
{% else %}â€”{% endif %}
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="empty-state">
<div class="empty-state-icon">ğŸ’³</div>
<p>No subscriptions</p>
</div>
{% endif %}
</div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Section: User Nicknames
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="section-nicknames" class="admin-section" style="display:none">
<button class="btn btn-secondary btn-sm" onclick="showMainMenu()" style="margin-bottom:var(--space-lg)">â† Back</button>

<div class="card">
<div class="card-header">
<h2 class="card-title">User IDs</h2>
<span class="badge" id="nicknamesCount">0</span>
</div>
<div class="card-body">
<p style="color:var(--text-tertiary);font-size:12px;margin-bottom:var(--space-md)">
User IDs stored in localStorage. Collected from active sessions via JavaScript.
</p>

<div style="margin-bottom:var(--space-md);display:flex;gap:var(--space-sm);align-items:center">
<input type="text" id="nicknameSearch" placeholder="Search..." class="input" style="max-width:240px" oninput="filterNicknames()">
<button class="btn btn-primary btn-sm" onclick="loadNicknamesFromSessions()">Refresh</button>
</div>

<div id="nicknamesTable" class="table-container">
<table class="table">
<thead>
<tr>
<th>#</th>
<th>User ID</th>
<th>First Seen</th>
<th>Source</th>
</tr>
</thead>
<tbody id="nicknamesBody">
<tr>
<td colspan="4" style="padding:var(--space-xl);text-align:center;color:var(--text-tertiary)">
Loading...
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Section: Users
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="section-users" class="admin-section" style="display:none">
<button class="btn btn-secondary btn-sm" onclick="showMainMenu()" style="margin-bottom:var(--space-lg)">â† Back</button>

<div class="card">
<div class="card-header">
<h2 class="card-title">Add Marker</h2>
</div>
<div class="card-body">
<form id="markerForm" class="form-grid">
<div class="form-group">
<label class="form-label">Latitude</label>
<input type="number" step="0.000001" required id="mmLat" placeholder="48.4500" class="input">
</div>
<div class="form-group">
<label class="form-label">Longitude</label>
<input type="number" step="0.000001" required id="mmLng" placeholder="31.1200" class="input">
</div>
<div class="form-group">
<label class="form-label">Location</label>
<input type="text" id="mmPlace" placeholder="Kyiv" class="input">
</div>
<div class="form-group">
<label class="form-label">Type</label>
<select id="mmType" class="input">
<option value="shahed">Shahed</option>
<option value="raketa">Rocket</option>
<option value="avia">Aviation</option>
<option value="artillery">Artillery</option>
<option value="obstril">Shelling</option>
<option value="fpv">FPV Drone</option>
<option value="pusk">Launch</option>
<option value="vibuh">Explosion</option>
<option value="vidboi">Repel</option>
<option value="rozved">Reconnaissance</option>
<option value="rszv">MLRS</option>
<option value="kab">KAB</option>
<option value="trivoga">Alarm</option>
<option value="manual">Manual</option>
</select>
</div>
<div class="form-group" style="grid-column:1/-1">
<label class="form-label">Description</label>
<textarea id="mmText" required placeholder="Event description..." class="input"></textarea>
</div>
<div style="grid-column:1/-1;display:flex;gap:var(--space-sm)">
<button type="submit" class="btn btn-primary btn-sm">Add</button>
<span id="mmStatus" class="badge" style="display:none"></span>
</div>
</form>
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">Active Visitors <span class="badge info">{{ visitors|length }}</span></h2>
</div>
<div class="card-body compact">
{% if visitors %}
<div class="table-container">
<table class="table">
<thead>
<tr>
<th>Session</th>
<th>User ID</th>
<th>IP</th>
<th>Device</th>
<th>Duration</th>
<th>Last</th>
<th>Action</th>
</tr>
</thead>
<tbody>
{% for v in visitors %}
<tr>
<td class="truncate" style="max-width:120px" title="{{ v.id }}">{{ v.id[:12] }}...</td>
<td>
{% if v.nickname %}
<span class="badge success">{{ v.nickname }}</span>
{% else %}â€”{% endif %}
</td>
<td>{{ v.ip or 'â€”' }}</td>
<td class="truncate" style="max-width:160px" title="{{ v.ua }}">{{ v.ua_short }}</td>
<td><span class="badge">{{ v.age_fmt }}</span></td>
<td><span class="badge warning">{{ v.last_seen }}</span></td>
<td><button class="btn btn-danger btn-sm" onclick="blockUser('{{ v.id }}')">Block</button></td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="empty-state">
<div class="empty-state-icon">ğŸ‘¤</div>
<p>No active visitors</p>
</div>
{% endif %}
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">Blocked <span class="badge danger">{{ blocked|length }}</span></h2>
</div>
<div class="card-body compact">
{% if blocked %}
<div class="table-container">
<table class="table">
<thead>
<tr>
<th>ID</th>
<th>Action</th>
</tr>
</thead>
<tbody>
{% for b in blocked %}
<tr>
<td class="truncate" style="max-width:300px" title="{{ b }}">{{ b[:24] }}...</td>
<td><button class="btn btn-success btn-sm" onclick="unblockUser('{{ b }}')">Unblock</button></td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="empty-state">
<div class="empty-state-icon">ğŸ”“</div>
<p>No blocked users</p>
</div>
{% endif %}
</div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Section: Messages
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="section-messages" class="admin-section" style="display:none">
<button class="btn btn-secondary btn-sm" onclick="showMainMenu()" style="margin-bottom:var(--space-lg)">â† Back</button>

<div class="card">
<div class="card-header">
<h2 class="card-title">Raw Messages <span class="badge warning" id="rawCount">{{ raw_count }}</span></h2>
</div>
<div class="card-body compact">
{% if raw_msgs %}
<div class="table-container">
<table class="table">
<thead>
<tr>
<th>Time</th>
<th>Channel</th>
<th>Message</th>
</tr>
</thead>
<tbody id="rawTable">
{% for r in raw_msgs %}
<tr>
<td style="white-space:nowrap;font-size:12px">{{ r.date }}</td>
<td><span class="badge info">{{ r.channel }}</span></td>
<td class="truncate" style="max-width:400px" title="{{ r.text }}">{{ r.text }}</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="empty-state">
<div class="empty-state-icon">ğŸ“¬</div>
<p>No pending messages</p>
</div>
{% endif %}
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">Recent Markers <span class="badge success">{{ markers|length }}</span></h2>
</div>
<div class="card-body compact">
{% if markers %}
<div class="table-container">
<table class="table">
<thead>
<tr>
<th>Time</th>
<th>Type</th>
<th>Location</th>
<th>Message</th>
<th>Action</th>
</tr>
</thead>
<tbody>
{% for m in markers %}
<tr>
<td style="white-space:nowrap;font-size:12px">{{ m.date }}</td>
<td><span class="badge {% if m.threat_type=='shahed' %}info{% elif m.threat_type=='raketa' %}danger{% else %}warning{% endif %}">{{ m.threat_type }}</span></td>
<td style="font-weight:500">{{ m.place }}</td>
<td class="truncate" style="max-width:300px" title="{{ m.text }}">{{ (m.text or '')[:80] }}{% if (m.text|length or 0)>80 %}...{% endif %}</td>
<td><button class="btn btn-secondary btn-sm" data-lat="{{ m.lat }}" data-lng="{{ m.lng }}" data-text="{{ (m.text or '')|e }}" data-source="{{ (m.channel or m.source)|e }}" onclick="hideMarker(this.dataset.lat,this.dataset.lng,this.dataset.text,this.dataset.source)">Hide</button></td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="empty-state">
<div class="empty-state-icon">ğŸ“Œ</div>
<p>No recent markers</p>
</div>
{% endif %}
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">Hidden <span id="hiddenCount" class="badge danger">0</span></h2>
<button class="btn btn-sm btn-secondary" onclick="loadHiddenMarkers()">Refresh</button>
</div>
<div class="card-body">
<div id="hiddenMarkersContainer">
<div class="empty-state">
<div class="empty-state-icon">ğŸ‘ï¸</div>
<p>No hidden markers</p>
</div>
</div>
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">Cache <span class="badge warning">{{ neg_geocode|length }}</span></h2>
<button class="btn btn-danger btn-sm" onclick="clearCache()">Clear All</button>
</div>
<div class="card-body compact">
{% if neg_geocode %}
<div class="table-container" style="max-height:320px;overflow-y:auto">
<table class="table">
<thead>
<tr>
<th>City</th>
<th>Region</th>
<th>Action</th>
</tr>
</thead>
<tbody>
{% for name,region in neg_geocode %}
<tr>
<td>{{ name }}</td>
<td>{{ region or "â€”" }}</td>
<td><button class="btn btn-danger btn-sm" onclick="delCache('{{ name }}')">Delete</button></td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="empty-state">
<div class="empty-state-icon">ğŸ—‚ï¸</div>
<p>Cache empty</p>
</div>
{% endif %}
</div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Section: Debug
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="section-debug" class="admin-section" style="display:none">
<button class="btn btn-secondary btn-sm" onclick="showMainMenu()" style="margin-bottom:var(--space-lg)">â† Back</button>

<div class="card">
<div class="card-header">
<h2 class="card-title">Debug Console <span class="badge info">{{ debug_logs|length }}</span></h2>
<button class="btn btn-danger btn-sm" onclick="clearLogs()">Clear</button>
</div>
<div class="card-body compact">
{% if debug_logs %}
<div class="debug-console">
{% for log in debug_logs[-100:] %}
<div class="debug-entry">
<span class="debug-timestamp">{{ log.timestamp[-8:] }}</span>
<span class="debug-category">{{ log.category }}</span>
<span class="debug-message">{{ log.message }}</span>
</div>
{% endfor %}
</div>
{% else %}
<div class="empty-state">
<div class="empty-state-icon">ğŸ“</div>
<p>No logs</p>
</div>
{% endif %}
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">Tools</h2>
</div>
<div class="card-body">
<div class="form-grid">
<div class="form-group">
<label class="form-label">Statistics</label>
<button class="btn btn-secondary btn-sm" onclick="loadStats()">Load Stats</button>
</div>
<div class="form-group">
<label class="form-label">Cleanup (days)</label>
<div style="display:flex;gap:6px">
<input type="number" id="cleanDays" value="7" min="1" max="30" class="input" style="width:80px">
<button class="btn btn-warning btn-sm" onclick="cleanup()">Clean</button>
</div>
</div>
<div class="form-group">
<label class="form-label">Export</label>
<div style="display:flex;gap:6px">
<button class="btn btn-secondary btn-sm" onclick="exportData('messages')">Messages</button>
<button class="btn btn-secondary btn-sm" onclick="exportData('stats')">Stats</button>
</div>
</div>
</div>
<div id="advStatus" class="debug-console" style="margin-top:var(--space-md);display:none"></div>
</div>
</div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const S=new URLSearchParams(location.search).get('secret')||'';
let map=null,layer=null,vectorLayer=null,auto=true;
let addMode=false,selectedMarker=null,clipboard=null,editingMarker=null;
let markerRotations=new Map(); // Store rotation for each marker
let autoMarkerWarningAt=0;
let tempNewMarker=null;
let vectorMode=false;
const markerVectors=new Map();
let markerAnimation=null;
function notif(m,t='info'){const n=document.createElement('div');n.className='notification notification-'+t;n.textContent=m;document.body.appendChild(n);setTimeout(()=>{n.style.opacity='0';n.style.transform='translateX(100px)';setTimeout(()=>n.remove(),300)},4000)}
async function api(e,o={}){try{const u=e.includes('?')?`${e}&secret=${encodeURIComponent(S)}`:`${e}?secret=${encodeURIComponent(S)}`;const r=await fetch(u,o);if(!r.ok)throw new Error(`HTTP ${r.status}`);return await r.json()}catch(err){notif(`Error: ${err.message}`,'error');throw err}}
function initMap(){if(map)return;try{map=L.map('adminMap',{attributionControl:false,zoomControl:true}).setView([49,31.3],6);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map);vectorLayer=L.layerGroup().addTo(map);layer=L.layerGroup().addTo(map);map.on('click',onMapClick);console.log('âœ… Map initialized');reloadMarkers()}catch(e){console.error('âŒ Map failed:',e);notif('Map initialization failed','error')}}

function buildMarkerIcon(iconUrl,rotation=0){const iconSize=34;const angle=rotation||0;return L.divIcon({html:`<div class="rotatable-marker" style="transform:rotate(${angle}deg);width:${iconSize}px;height:${iconSize}px"><img src="${iconUrl}" style="width:100%;height:100%;display:block"/></div>`,className:'',iconSize:[iconSize,iconSize],iconAnchor:[iconSize/2,iconSize/2]});}
function createRotatableMarker(lat,lng,iconUrl,rotation=0){return L.marker([lat,lng],{icon:buildMarkerIcon(iconUrl,rotation),draggable:true});}
function updateMarkerIcon(type,markerOverride=null){const iconUrl=`/static/${type}.png`;const preview=document.getElementById('markerIconPreview');if(preview){preview.src=iconUrl;preview.alt=`${type} icon`;}const label=document.getElementById('markerIconLabel');if(label){label.textContent=`${type}.png`;}const markerTarget=markerOverride||selectedMarker;if(markerTarget&&markerTarget._markerData){markerTarget._markerData.type=type;const rotation=markerTarget._markerData.rotation||0;markerTarget.setIcon(buildMarkerIcon(iconUrl,rotation));}}

function updateVectorSummary(data){const summary=document.getElementById('vectorSummary');const clearBtn=document.getElementById('clearVectorBtn');if(!summary)return;const hasVector=data&&data.trajectory&&data.trajectory.end;const label=(data&&data.course_target)||'';const coords=hasVector?`${data.trajectory.end[0].toFixed(2)}, ${data.trajectory.end[1].toFixed(2)}`:'';const dir=data&&data.course_direction?` (${data.course_direction})`:'';summary.textContent=hasVector?(label?`${label}${dir}`:`${coords}${dir}`):'â€”';if(clearBtn){clearBtn.disabled=!hasVector}}

function setVectorMode(state){const btn=document.getElementById('vectorBtn');let desired=!!state;if(desired&&!selectedMarker){notif('Select a marker first','warning');desired=false;}vectorMode=desired;if(btn){btn.textContent=vectorMode?'Vector: ON':'Vector';btn.className=vectorMode?'btn btn-success btn-sm':'btn btn-secondary btn-sm';}if(vectorMode){setAddMode(false,{keepTemp:true});if(map)map.getContainer().style.cursor='crosshair';notif('Click map to set direction','info');}else{if(map&&!addMode)map.getContainer().style.cursor='';}}
function toggleVectorMode(){setVectorMode(!vectorMode)}

function clearMarkerVector(){if(!selectedMarker){notif('Select a marker first','warning');return;}const data=selectedMarker._markerData||{};data.trajectory=null;data.course_direction=null;data.course_target=null;data.course_source=null;data.course_type=null;removeVectorForMarker(selectedMarker);const labelInput=document.getElementById('editVectorLabel');if(labelInput)labelInput.value='';updateVectorSummary(data);notif('Vector cleared','info');}

function removeVectorForMarker(marker){if(!marker)return;const entry=markerVectors.get(marker._leaflet_id);if(entry){if(vectorLayer){if(entry.line)vectorLayer.removeLayer(entry.line);if(entry.arrow)vectorLayer.removeLayer(entry.arrow);}markerVectors.delete(marker._leaflet_id);}}

function renderVectorForMarker(marker){if(!marker||!vectorLayer)return;removeVectorForMarker(marker);const data=marker._markerData||{};const traj=data.trajectory;if(!traj||!traj.end)return;const start=traj.start||[marker.getLatLng().lat,marker.getLatLng().lng];const end=traj.end;if(typeof start[0]!=='number'||typeof end[0]!=='number')return;const line=L.polyline([start,end],{color:'#f97316',weight:4,opacity:0.85,dashArray:'8 4'}).addTo(vectorLayer);const angle=Math.atan2(end[0]-start[0],end[1]-start[1])*180/Math.PI+90;const arrowIcon=L.divIcon({html:`<div style="transform:rotate(${angle}deg);color:#f97316;font-weight:700;font-size:18px;">â–²</div>`,className:'',iconSize:[18,18],iconAnchor:[9,9]});const arrow=L.marker([end[0],end[1]],{icon:arrowIcon,interactive:false}).addTo(vectorLayer);markerVectors.set(marker._leaflet_id,{line,arrow});}

function computeDirectionMeta(start,end){const dy=end[0]-start[0];const dx=end[1]-start[1];const absDy=Math.abs(dy);const absDx=Math.abs(dx);let token=null;if(absDy<1e-6&&absDx<1e-6)return {token:null,label:null,arrow:null};if(absDy>absDx*1.4){token=dy>0?'n':'s';}else if(absDx>absDy*1.4){token=dx>0?'e':'w';}else if(dy>=0&&dx>=0){token='ne';}else if(dy>=0&&dx<0){token='nw';}else if(dy<0&&dx>=0){token='se';}else{token='sw';}const courseLabels={n:'Ğ¿Ñ–Ğ²Ğ½Ñ–Ñ‡',s:'Ğ¿Ñ–Ğ²Ğ´ĞµĞ½ÑŒ',e:'ÑÑ…Ñ–Ğ´',w:'Ğ·Ğ°Ñ…Ñ–Ğ´',ne:'Ğ¿Ñ–Ğ²Ğ½Ñ–Ñ‡Ğ½Ğ¸Ğ¹ ÑÑ…Ñ–Ğ´',nw:'Ğ¿Ñ–Ğ²Ğ½Ñ–Ñ‡Ğ½Ğ¸Ğ¹ Ğ·Ğ°Ñ…Ñ–Ğ´',se:'Ğ¿Ñ–Ğ²Ğ´ĞµĞ½Ğ½Ğ¸Ğ¹ ÑÑ…Ñ–Ğ´',sw:'Ğ¿Ñ–Ğ²Ğ´ĞµĞ½Ğ½Ğ¸Ğ¹ Ğ·Ğ°Ñ…Ñ–Ğ´'};const arrowLabels={n:'Ğ¿Ñ–Ğ²Ğ½Ğ¾Ñ‡Ñ–',s:'Ğ¿Ñ–Ğ²Ğ´Ğ½Ñ',e:'ÑÑ…Ğ¾Ğ´Ñƒ',w:'Ğ·Ğ°Ñ…Ğ¾Ğ´Ñƒ',ne:'Ğ¿Ñ–Ğ²Ğ½Ñ–Ñ‡Ğ½Ğ¾Ğ³Ğ¾ ÑÑ…Ğ¾Ğ´Ñƒ',nw:'Ğ¿Ñ–Ğ²Ğ½Ñ–Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ñ…Ğ¾Ğ´Ñƒ',se:'Ğ¿Ñ–Ğ²Ğ´ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ ÑÑ…Ğ¾Ğ´Ñƒ',sw:'Ğ¿Ñ–Ğ²Ğ´ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ñ…Ğ¾Ğ´Ñƒ'};return {token,label:courseLabels[token]||null,arrow:arrowLabels[token]||null};}

function applyVectorToMarker(marker,latlng){
	const data=marker._markerData||{};
	const startLat=parseFloat(document.getElementById('editLat').value)||marker.getLatLng().lat;
	const startLng=parseFloat(document.getElementById('editLng').value)||marker.getLatLng().lng;
	const start=[startLat,startLng];
	const end=[latlng.lat,latlng.lng];
	const dirMeta=computeDirectionMeta(start,end);
	const trajectory={start,end,source:data.place||'manual',target:data.course_target||null,kind:'manual_vector'};
	data.trajectory=trajectory;
	data.course_direction=dirMeta.label?`ĞºÑƒÑ€Ñ Ğ½Ğ° ${dirMeta.label}`:null;
	data.course_source=data.place||'manual';
	data.course_type='manual_vector';
	if(dirMeta.arrow&&data.place){
		const base=data.place.split('â†')[0].trim();
		data.place=`${base} â†${dirMeta.arrow}`.trim();
		document.getElementById('editPlace').value=data.place;
	}
	const labelInput=document.getElementById('editVectorLabel');
	if(labelInput){
		if(!labelInput.value){
			labelInput.value=dirMeta.label||'';
		}
		data.course_target=(labelInput.value||'').trim()||null;
	}
	if(data.trajectory){
		data.trajectory.target=data.course_target||null;
	}
	renderVectorForMarker(marker);
	updateVectorSummary(data);
	if(selectedMarker===marker){setAnimationInputsFromTarget({lat:end[0],lng:end[1]});}
	notif('Vector updated. ĞĞµ Ğ·Ğ°Ğ±ÑƒĞ´ÑŒÑ‚Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¼ĞµÑ‚ĞºÑƒ.','success');
	setVectorMode(false);
}

function updateMarkerVectorLabel(value){if(!selectedMarker)return;const data=selectedMarker._markerData||{};const v=(value||'').trim();data.course_target=v||null;if(data.trajectory){data.trajectory.target=v||null;}updateVectorSummary(data);}

function getAnimationControls(){return{latInput:document.getElementById('animTargetLat'),lngInput:document.getElementById('animTargetLng'),durationInput:document.getElementById('animDuration'),cancelBtn:document.getElementById('cancelAnimBtn')}}

function getPreferredAnimationTarget(data){if(!data)return null;if(data.animation_target&&typeof data.animation_target.lat==='number'&&typeof data.animation_target.lng==='number')return data.animation_target;if(data.trajectory&&data.trajectory.end&&typeof data.trajectory.end[0]==='number'&&typeof data.trajectory.end[1]==='number'){return{lat:data.trajectory.end[0],lng:data.trajectory.end[1]}}return null}

function populateAnimationInputs(data){const{latInput,lngInput,durationInput}=getAnimationControls();if(!latInput||!lngInput||!durationInput)return;const target=getPreferredAnimationTarget(data);if(target){latInput.value=target.lat.toFixed(6);lngInput.value=target.lng.toFixed(6)}else{latInput.value='';lngInput.value='';}const duration=(data&&data.animation_duration)||4;durationInput.value=duration}

function setAnimationInputsFromTarget(target){const{latInput,lngInput}=getAnimationControls();if(!latInput||!lngInput)return;if(target){latInput.value=target.lat.toFixed(6);lngInput.value=target.lng.toFixed(6)}else{latInput.value='';lngInput.value='';}storeAnimationTarget()}

function storeAnimationTarget(){if(!selectedMarker)return;const{latInput,lngInput,durationInput}=getAnimationControls();if(!latInput||!lngInput||!durationInput)return;const data=selectedMarker._markerData=selectedMarker._markerData||{};const lat=parseFloat(latInput.value);const lng=parseFloat(lngInput.value);const duration=parseFloat(durationInput.value)||4;if(!Number.isNaN(lat)&&!Number.isNaN(lng)){data.animation_target={lat,lng}}else{delete data.animation_target}data.animation_duration=Math.max(0.5,duration)}

function setAnimationTargetFromMarker(){if(!selectedMarker){notif('Select a marker first','warning');return;}const pos=selectedMarker.getLatLng();setAnimationInputsFromTarget({lat:pos.lat,lng:pos.lng});notif('Ğ¦ĞµĞ»ÑŒ Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¼Ğ¸ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ°Ğ¼Ğ¸','info')}

function useVectorForAnimation(){if(!selectedMarker){notif('Select a marker first','warning');return;}const data=selectedMarker._markerData||{};const traj=data.trajectory; if(!traj||!traj.end){notif('Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ·Ğ°Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ','warning');return;}setAnimationInputsFromTarget({lat:traj.end[0],lng:traj.end[1]});notif('Ğ¦ĞµĞ»ÑŒ Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ğ¸ ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ¸Ğ· Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ°','success')}

function updateAnimationButtonState(running){const{cancelBtn}=getAnimationControls();if(cancelBtn){cancelBtn.disabled=!running}}

function finalizeMarkerAnimation(){if(markerAnimation&&markerAnimation.marker&&markerAnimation.marker.dragging){markerAnimation.marker.dragging.enable();}markerAnimation=null;updateAnimationButtonState(false)}

function cancelMarkerAnimation(silent=false){if(!markerAnimation)return;if(markerAnimation.frame)cancelAnimationFrame(markerAnimation.frame);finalizeMarkerAnimation();if(!silent)notif('ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°','info')}

function animateSelectedMarker(){if(!selectedMarker){notif('Select a marker first','warning');return;}const{latInput,lngInput,durationInput}=getAnimationControls();if(!latInput||!lngInput||!durationInput){notif('ĞšĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ñ‹ Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹','error');return;}const targetLat=parseFloat(latInput.value);const targetLng=parseFloat(lngInput.value);if(Number.isNaN(targetLat)||Number.isNaN(targetLng)){notif('Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹ Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ğ¸','warning');return;}const durationSec=Math.max(0.5,parseFloat(durationInput.value)||4);const current=selectedMarker.getLatLng();if(Math.abs(current.lat-targetLat)<1e-6&&Math.abs(current.lng-targetLng)<1e-6){notif('ĞœĞµÑ‚ĞºĞ° ÑƒĞ¶Ğµ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑÑ Ğ² ÑÑ‚Ğ¾Ğ¹ Ñ‚Ğ¾Ñ‡ĞºĞµ','info');return;}cancelMarkerAnimation(true);const data=selectedMarker._markerData=selectedMarker._markerData||{};const start={lat:current.lat,lng:current.lng};const end={lat:targetLat,lng:targetLng};markerAnimation={marker:selectedMarker,start,end,duration:durationSec*1000,startTime:null,frame:null,data};if(selectedMarker.dragging)selectedMarker.dragging.disable();updateAnimationButtonState(true);const easeOut=t=>1-Math.pow(1-t,3);const step=timestamp=>{if(!markerAnimation||markerAnimation.marker!==selectedMarker)return;if(!markerAnimation.startTime)markerAnimation.startTime=timestamp;const progress=Math.min((timestamp-markerAnimation.startTime)/markerAnimation.duration,1);const eased=easeOut(progress);const lat=start.lat+(end.lat-start.lat)*eased;const lng=start.lng+(end.lng-start.lng)*eased;selectedMarker.setLatLng([lat,lng]);data.lat=lat;data.lng=lng;if(data.trajectory&&data.trajectory.start){data.trajectory.start=[lat,lng];}document.getElementById('editLat').value=lat.toFixed(6);document.getElementById('editLng').value=lng.toFixed(6);if(progress<1){markerAnimation.frame=requestAnimationFrame(step);}else{finalizeMarkerAnimation();if(data.trajectory)renderVectorForMarker(selectedMarker);notif('ĞœĞµÑ‚ĞºĞ° Ğ¿ĞµÑ€ĞµĞ¼ĞµÑ‰ĞµĞ½Ğ° Ğ² Ñ‚Ğ¾Ñ‡ĞºÑƒ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ','success');}};markerAnimation.frame=requestAnimationFrame(step)}

async function reloadMarkers(){if(!map||!layer)return;if(markerAnimation){console.log('â¸ï¸ Reload paused: animation in progress');return}if(tempNewMarker&&tempNewMarker._isNew){console.log('â¸ï¸ Reload paused: new marker in progress');return}try{const d=await fetch(`/data?timeRange=40&confRange=0&maxTracks=100&ts=${Date.now()}`).then(r=>r.json());const t=d.tracks||[];layer.clearLayers();markerRotations.clear();if(vectorLayer){vectorLayer.clearLayers();markerVectors.clear();}t.forEach(m=>{if(!m.lat||!m.lng)return;const rotation=m.rotation||0;const k=createRotatableMarker(m.lat,m.lng,`/static/${m.threat_type||'shahed'}.png`,rotation);k.addTo(layer);k._markerData={id:m.id||null,lat:m.lat,lng:m.lng,place:m.place||'',type:m.threat_type||'shahed',text:m.text||'',rotation:rotation,channel:m.channel||'admin',manual:!!m.manual,trajectory:m.trajectory||null,course_direction:m.course_direction||null,course_target:m.course_target||null,course_source:m.course_source||null,course_type:m.course_type||null};markerRotations.set(k._leaflet_id,rotation);if(k._markerData.trajectory)renderVectorForMarker(k);k.on('click',function(e){L.DomEvent.stopPropagation(e);selectMarker(k)});k.on('drag',function(){const pos=k.getLatLng();if(selectedMarker===k){document.getElementById('editLat').value=pos.lat.toFixed(6);document.getElementById('editLng').value=pos.lng.toFixed(6)}});k.on('dragend',function(){const pos=k.getLatLng();k._markerData.lat=pos.lat;k._markerData.lng=pos.lng;if(k._markerData.trajectory&&k._markerData.trajectory.start){k._markerData.trajectory.start=[pos.lat,pos.lng];renderVectorForMarker(k);}if(selectedMarker===k){document.getElementById('editLat').value=pos.lat.toFixed(6);document.getElementById('editLng').value=pos.lng.toFixed(6);}persistMarkerPosition(k);});const p=`<div style="font-size:0.85rem;max-width:250px"><strong style="color:#3b82f6">${m.place||'Unknown'}</strong><br><div style="margin:6px 0">${(m.text||'').slice(0,200)}</div><div style="opacity:0.7;font-size:0.75rem">${m.date||''}</div></div>`;k.bindPopup(p)});document.getElementById('mapStats').textContent=`ğŸ“ Markers: ${t.length}`;console.log(`âœ… Loaded ${t.length} markers`)}catch(e){console.error('âŒ Load failed:',e);notif('Failed to load markers','error')}}

async function persistMarkerPosition(marker){const data=marker?._markerData||{};if(!data.manual){const now=Date.now();if(now-autoMarkerWarningAt>5000){notif('This marker comes from live feed; drag changes reset on refresh. Save manual markers instead.','warning');autoMarkerWarningAt=now;}setTimeout(()=>reloadMarkers(),500);return;}if(!data.id){console.warn('Cannot persist marker without id');return;}const payload={id:data.id,lat:data.lat,lng:data.lng,place:data.place||'',threat_type:data.type||'manual',text:data.text||'',rotation:data.rotation||0,trajectory:data.trajectory||null,course_direction:data.course_direction||null,course_target:data.course_target||null,course_source:data.course_source||null,course_type:data.course_type||null};try{const response=await fetch('/admin/update_manual_marker?secret='+encodeURIComponent(S),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(!response.ok){const txt=await response.text();throw new Error(txt||'Failed to save position');}console.log(`ğŸ’¾ Position saved for manual marker ${data.id}`);}catch(err){console.error('Position save failed:',err);notif('Failed to save marker position: '+err.message,'error');setTimeout(()=>reloadMarkers(),800);}}

function setAddMode(state,{keepTemp=false}={}){addMode=state;const btn=document.getElementById('addModeBtn');if(!btn||!map)return;if(addMode){btn.textContent='Add Mode: ON';btn.className='btn btn-success btn-sm';map.getContainer().style.cursor='crosshair';setVectorMode(false);notif('Click map to place marker','info')}else{btn.textContent='Add Mode';btn.className='btn btn-primary btn-sm';if(!vectorMode)map.getContainer().style.cursor='';if(!keepTemp&&tempNewMarker){layer.removeLayer(tempNewMarker);tempNewMarker=null}}}
function toggleAddMode(){setAddMode(!addMode)}

function onMapClick(e){if(vectorMode){if(!selectedMarker){notif('Select a marker first','warning');setVectorMode(false);return;}applyVectorToMarker(selectedMarker,e.latlng);return;}if(!addMode)return;const lat=e.latlng.lat;const lng=e.latlng.lng;if(tempNewMarker){layer.removeLayer(tempNewMarker);}const iconUrl='/static/shahed3.webp';tempNewMarker=createRotatableMarker(lat,lng,iconUrl,0);tempNewMarker._markerData={id:null,lat:lat,lng:lng,place:'',type:'manual',text:'',rotation:0,channel:'admin',manual:true,trajectory:null,course_direction:null,course_target:null,course_source:null,course_type:null};tempNewMarker._isNew=true;tempNewMarker.addTo(layer);tempNewMarker.on('drag',function(){const pos=tempNewMarker.getLatLng();document.getElementById('editLat').value=pos.lat.toFixed(6);document.getElementById('editLng').value=pos.lng.toFixed(6)});tempNewMarker.on('dragend',function(){const pos=tempNewMarker.getLatLng();tempNewMarker._markerData.lat=pos.lat;tempNewMarker._markerData.lng=pos.lng;if(tempNewMarker._markerData.trajectory){tempNewMarker._markerData.trajectory.start=[pos.lat,pos.lng];renderVectorForMarker(tempNewMarker);}document.getElementById('editLat').value=pos.lat.toFixed(6);document.getElementById('editLng').value=pos.lng.toFixed(6)});setAddMode(false,{keepTemp:true});const latFixed=lat.toFixed(6);const lngFixed=lng.toFixed(6);document.getElementById('mmLat').value=latFixed;document.getElementById('mmLng').value=lngFixed;if(document.getElementById('mmPlace'))document.getElementById('mmPlace').value='';document.getElementById('mmText').value=`Marker at ${latFixed}, ${lngFixed}`;selectMarker(tempNewMarker);document.getElementById('editPlace').value='';document.getElementById('editType').value='manual';document.getElementById('editText').value='';document.getElementById('editRotation').value=0;notif('ĞĞ¾Ğ²Ğ°Ñ Ğ¼ĞµÑ‚ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°. Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ.','success')}

function selectMarker(marker){cancelMarkerAnimation(true);if(selectedMarker&&selectedMarker!==marker){selectedMarker.setOpacity(1)}selectedMarker=marker;marker.setOpacity(0.7);const data=marker._markerData||{};const isNew=!data.id;document.getElementById('editLat').value=data.lat||marker.getLatLng().lat.toFixed(6);document.getElementById('editLng').value=data.lng||marker.getLatLng().lng.toFixed(6);document.getElementById('editPlace').value=data.place||'';document.getElementById('editType').value=data.type||'shahed';updateMarkerIcon(data.type||'shahed',marker);document.getElementById('editText').value=data.text||'';document.getElementById('editRotation').value=data.rotation||0;const labelInput=document.getElementById('editVectorLabel');if(labelInput){labelInput.value=data.course_target||'';}updateVectorSummary(data);populateAnimationInputs(data);document.getElementById('clearVectorBtn').disabled=!(data&&data.trajectory);document.getElementById('markerEditor').style.display='block';const saveBtn=document.getElementById('editSaveBtn');if(saveBtn){saveBtn.textContent=isNew?'â• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ':'ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ'}document.getElementById('copyBtn').disabled=isNew;notif(isNew?'ĞĞ¾Ğ²Ğ°Ñ Ğ¼ĞµÑ‚ĞºĞ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ° Ğº Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ.':'Marker selected. Edit or copy it.','info')}

function closeMarkerEditor(){document.getElementById('markerEditor').style.display='none';cancelMarkerAnimation(true);if(selectedMarker){if(selectedMarker._isNew&&layer){layer.removeLayer(selectedMarker);tempNewMarker=null;}selectedMarker.setOpacity(1);selectedMarker=null}document.getElementById('copyBtn').disabled=true;const labelInput=document.getElementById('editVectorLabel');if(labelInput)labelInput.value='';updateVectorSummary(null);setVectorMode(false);populateAnimationInputs(null)}

function updateSelectedRotation(angle){if(!selectedMarker)return;const rotation=parseFloat(angle);const currentLatLng=selectedMarker.getLatLng();const iconUrl=`/static/${selectedMarker._markerData?.type||'shahed'}.png`;selectedMarker.setIcon(buildMarkerIcon(iconUrl,rotation));selectedMarker.setLatLng(currentLatLng);if(selectedMarker._markerData){selectedMarker._markerData.rotation=rotation}markerRotations.set(selectedMarker._leaflet_id,rotation)}

function rotateSelected(delta){if(!selectedMarker){notif('Select a marker first','warning');return}const current=parseFloat(document.getElementById('editRotation').value)||0;const newAngle=current+delta;document.getElementById('editRotation').value=newAngle;updateSelectedRotation(newAngle);notif(`Rotated to ${newAngle}Â°`,'success')}

function copySelectedMarker(){if(!selectedMarker){notif('Select a marker first','warning');return}if(selectedMarker._isNew){notif('Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²ÑƒÑ Ğ¼ĞµÑ‚ĞºÑƒ','warning');return}const data=selectedMarker._markerData||{};clipboard={lat:data.lat||selectedMarker.getLatLng().lat,lng:data.lng||selectedMarker.getLatLng().lng,place:data.place||document.getElementById('editPlace').value,type:data.type||document.getElementById('editType').value,text:data.text||document.getElementById('editText').value,rotation:data.rotation||parseFloat(document.getElementById('editRotation').value)||0,trajectory:data.trajectory||null,course_direction:data.course_direction||null,course_target:data.course_target||null,course_source:data.course_source||null,course_type:data.course_type||null};document.getElementById('pasteBtn').disabled=false;notif('Marker copied to clipboard','success')}

async function pasteMarker(){if(!clipboard){notif('Clipboard is empty. Copy a marker first.','warning');return}try{const response=await fetch('/admin/add_manual_marker?secret='+encodeURIComponent(S),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lat:clipboard.lat,lng:clipboard.lng,place:clipboard.place+' (copy)',threat_type:clipboard.type,text:clipboard.text,rotation:clipboard.rotation,trajectory:clipboard.trajectory,course_direction:clipboard.course_direction,course_target:clipboard.course_target,course_source:clipboard.course_source,course_type:clipboard.course_type})});if(!response.ok)throw new Error('Failed to paste');notif('Marker pasted successfully','success');setTimeout(()=>reloadMarkers(),500)}catch(e){console.error('Paste error:',e);notif('Failed to paste marker: '+e.message,'error')}}

document.addEventListener('keydown',function(e){const active=document.activeElement;const tag=(active&&active.tagName)?active.tagName.toLowerCase():'';const editable=active&&(active.isContentEditable||tag==='input'||tag==='textarea'||tag==='select');const selection=window.getSelection();if(editable||(selection&&selection.toString().length>0))return;const key=e.key?.toLowerCase();if((e.ctrlKey||e.metaKey)&&key==='c'){e.preventDefault();copySelectedMarker();return}if((e.ctrlKey||e.metaKey)&&key==='v'){e.preventDefault();pasteMarker();}});

async function deleteSelected(){if(!selectedMarker){notif('Select a marker first','warning');return}if(selectedMarker._isNew){closeMarkerEditor();notif('ĞĞ¾Ğ²Ğ°Ñ Ğ¼ĞµÑ‚ĞºĞ° Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°','info');return}if(!confirm('Delete this marker?'))return;const data=selectedMarker._markerData||{};try{await fetch('/hide_marker',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lat:data.lat,lng:data.lng,text:data.text,source:data.channel||'admin'})});notif('Marker deleted','success');closeMarkerEditor();reloadMarkers()}catch(e){notif('Failed to delete marker','error')}}

async function approveSubscription(subscriptionId){if(!confirm('Approve this subscription payment?'))return;try{const response=await fetch(`/admin/subscription/${subscriptionId}/approve`,{method:'POST'});if(!response.ok)throw new Error('Server error');notif('âœ… Subscription approved! Email sent.','success');setTimeout(()=>location.reload(),1500)}catch(e){console.error('Approve error:',e);notif('âŒ Failed to approve subscription','error')}}

async function saveMarkerEdit(){
	if(!selectedMarker){notif('No marker selected','warning');return}
	const newLat=parseFloat(document.getElementById('editLat').value);
	const newLng=parseFloat(document.getElementById('editLng').value);
	const newPlace=(document.getElementById('editPlace').value||'').trim();
	const newType=document.getElementById('editType').value;
	const newText=(document.getElementById('editText').value||'').trim();
	const newRotation=parseFloat(document.getElementById('editRotation').value)||0;
	if(Number.isNaN(newLat)||Number.isNaN(newLng)){notif('Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹','warning');return}
	if(!newText){notif('Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ','warning');return}
	const markerData=selectedMarker._markerData=selectedMarker._markerData||{};
	const markerId=markerData.id;
	const isNew=!markerId;
	const endpoint=isNew?'/admin/add_manual_marker':'/admin/update_manual_marker';
	markerData.lat=newLat;
	markerData.lng=newLng;
	markerData.place=newPlace;
	markerData.type=newType;
	markerData.text=newText;
	markerData.rotation=newRotation;
	if(newPlace){markerData.course_source=newPlace;}
	const basePayload={lat:newLat,lng:newLng,place:newPlace,threat_type:newType,text:newText,rotation:newRotation,trajectory:markerData.trajectory||null,course_direction:markerData.course_direction||null,course_target:markerData.course_target||null,course_source:markerData.course_source||null,course_type:markerData.course_type||null};
	const payload=isNew?basePayload:{id:markerId,...basePayload};
	const requestInit={method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)};
	const sendRequest=url=>fetch(`${url}?secret=${encodeURIComponent(S)}`,requestInit);
	const parseError=async response=>{const errTxt=await response.text();try{const parsed=JSON.parse(errTxt);return parsed.error||parsed.message||'Failed to save'}catch(_){return errTxt||'Failed to save'}};
	const handleSuccess=message=>{notif(message,'success');closeMarkerEditor();tempNewMarker=null;setTimeout(()=>reloadMarkers(),400)};
	try{
		let response=await sendRequest(endpoint);
		if(!response.ok){
			const errorMessage=await parseError(response);
			const isMissingInsert=!isNew&&response.status===404&&(errorMessage||'').toLowerCase().includes('not found');
			if(isMissingInsert){
				notif('ĞÑ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¼ĞµÑ‚ĞºĞ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°, ÑĞ¾Ğ·Ğ´Ğ°Ñ Ğ½Ğ¾Ğ²ÑƒÑ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ','warning');
				const recreateInit={...requestInit,body:JSON.stringify(basePayload)};
				const recreateResponse=await fetch(`/admin/add_manual_marker?secret=${encodeURIComponent(S)}`,recreateInit);
				if(!recreateResponse.ok){
					const recreateError=await parseError(recreateResponse);
					throw new Error(recreateError);
				}
				handleSuccess('ĞœĞµÑ‚ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾');
				return;
			}
			throw new Error(errorMessage);
		}
		handleSuccess(isNew?'ĞœĞµÑ‚ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°':'Marker updated successfully');
	}catch(e){
		console.error('Save error:',e);
		notif('Failed to save marker: '+e.message,'error');
	}
}
async function deleteMarkerFromMap(lat,lng,text,source){try{await fetch('/hide_marker',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lat,lng,text,source})});notif('Marker deleted','success');reloadMarkers()}catch(e){notif('Failed to delete marker','error')}}
function toggleAuto(){auto=!auto;const b=document.getElementById('autoBtn');b.textContent=`Auto: ${auto?'ON':'OFF'}`;b.className=auto?'btn btn-success btn-sm':'btn btn-secondary btn-sm'}
async function blockUser(id){try{await api('/block',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});notif('User blocked successfully','success');setTimeout(()=>location.reload(),1000)}catch(e){}}
async function unblockUser(id){try{await api('/unblock',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});notif('User unblocked successfully','success');setTimeout(()=>location.reload(),1000)}catch(e){}}
async function saveMonPeriod(){const v=document.getElementById('monPeriod').value;const s=document.getElementById('monStatus');s.style.display='inline-flex';s.textContent='Saving...';try{await api('/admin/set_monitor_period',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({value:parseInt(v)})});s.textContent='âœ… Saved';notif('Monitor period updated','success')}catch(e){s.textContent='âŒ Error'}}

document.getElementById('markerForm').addEventListener('submit',async(e)=>{e.preventDefault();const lat=document.getElementById('mmLat').value;const lng=document.getElementById('mmLng').value;const place=document.getElementById('mmPlace').value;const threat_type=document.getElementById('mmType').value;const text=document.getElementById('mmText').value;const s=document.getElementById('mmStatus');s.style.display='inline-flex';s.textContent='Creating...';try{await api('/admin/add_manual_marker',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lat,lng,place,threat_type,text})});s.textContent='âœ… Created';notif('Marker created successfully','success');setTimeout(()=>location.reload(),1000)}catch(err){s.textContent=`âŒ ${err.message||'Error'}`}});
async function hideMarker(lat,lng,text,source){try{await fetch('/hide_marker',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lat,lng,text,source})});notif('Marker hidden','success');setTimeout(()=>location.reload(),1000)}catch(e){}}
async function loadHiddenMarkers(){try{const d=await api('/admin/hidden_markers');const h=d.hidden||[];document.getElementById('hiddenCount').textContent=h.length;const c=document.getElementById('hiddenMarkersContainer');if(h.length===0){c.innerHTML='<div class="empty-state"><div class="empty-state-icon">ğŸ‘ï¸</div><p>No hidden markers</p></div>';return}let html='<div style="max-height:400px;overflow-y:auto"><table class="table"><thead><tr><th>Location</th><th>Text</th><th>Hidden Date</th><th>Action</th></tr></thead><tbody>';h.forEach(m=>{html+=`<tr><td>${m.lat.toFixed(4)}, ${m.lng.toFixed(4)}</td><td style="max-width:300px;overflow:hidden;text-overflow:ellipsis">${(m.text||'').substring(0,100)}</td><td>${m.hidden_date||''}</td><td><button class="btn btn-success btn-sm" onclick="unhideMarker(${m.lat},${m.lng},'${(m.text||'').replace(/'/g,"\\'")}','${m.source||''}')">â†©ï¸ Restore</button></td></tr>`});html+='</tbody></table></div>';c.innerHTML=html}catch(e){console.error('Failed to load hidden markers:',e);notif('Failed to load hidden markers','error')}}
async function unhideMarker(lat,lng,text,source){try{await api('/admin/unhide_marker',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lat,lng,text,source})});notif('Marker restored','success');loadHiddenMarkers();reloadMarkers()}catch(e){notif('Failed to restore marker','error')}}
async function clearCache(){if(!confirm('Clear all negative geocode cache? This cannot be undone.'))return;try{await api('/admin/neg_geocode_clear',{method:'POST'});notif('Cache cleared successfully','success');setTimeout(()=>location.reload(),1000)}catch(e){}}
async function delCache(name){try{await api('/admin/neg_geocode_delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})});notif('Cache entry deleted','success');setTimeout(()=>location.reload(),1000)}catch(e){}}
async function clearLogs(){if(!confirm('Clear all debug logs? This cannot be undone.'))return;try{await api('/admin/clear_debug_logs',{method:'POST'});notif('Debug logs cleared','success');setTimeout(()=>location.reload(),1000)}catch(e){}}
async function loadStats(){const s=document.getElementById('advStatus');s.style.display='block';try{const d=await api('/admin/stats');const t=d.stats;let h='';h+=`<div class="debug-entry"><span class="debug-category">MESSAGES</span><span class="debug-message">Total: ${t.messages.total}, Geo: ${t.messages.with_coordinates}, Pending: ${t.messages.pending_geo}, Recent 24h: ${t.messages.recent_24h}</span></div>`;h+=`<div class="debug-entry"><span class="debug-category">SYSTEM</span><span class="debug-message">Active Users: ${t.system.active_users}, Blocked: ${t.system.blocked_users}, Hidden Markers: ${t.system.hidden_markers}, Cache Size: ${t.system.neg_cache_size}</span></div>`;s.innerHTML=h}catch(e){s.innerHTML=`<div class="debug-entry"><span class="debug-message">Error: ${e.message}</span></div>`}}
async function cleanup(){const d=document.getElementById('cleanDays').value;if(!confirm(`Clean up data older than ${d} days? This cannot be undone.`))return;const s=document.getElementById('advStatus');s.style.display='block';s.innerHTML='<div class="debug-entry"><span class="debug-message">Cleaning up old data...</span></div>';try{const r=await api('/admin/cleanup',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({days:parseInt(d)})});s.innerHTML=`<div class="debug-entry"><span class="debug-category">CLEANED</span><span class="debug-message">Messages: ${r.cleaned.messages}, Debug Logs: ${r.cleaned.debug_logs}, Visitor Records: ${r.cleaned.visitor_records}</span></div>`;s.innerHTML+=`<div class="debug-entry"><span class="debug-category">REMAINING</span><span class="debug-message">Messages: ${r.remaining.messages}, Debug Logs: ${r.remaining.debug_logs}</span></div>`;notif('Cleanup completed successfully','success');setTimeout(()=>location.reload(),2000)}catch(e){s.innerHTML=`<div class="debug-entry"><span class="debug-message">Error: ${e.message}</span></div>`}}
async function exportData(type){try{const d=await api(`/admin/export?type=${type}`);const b=new Blob([JSON.stringify(d.data,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`neptun_${type}_${new Date().toISOString().split('T')[0]}.json`;a.click();URL.revokeObjectURL(u);notif(`Exported ${type} data successfully`,'success')}catch(e){}}
async function forceReload(){if(!confirm('âš ï¸ WARNING: This will force reload the page for ALL active users!\n\nContinue?'))return;try{await api('/admin/trigger-force-reload',{method:'POST'});notif('Force reload activated for all users','success')}catch(e){}}
async function updateRaw(){try{const d=await api('/admin/raw_msgs');document.getElementById('rawCount').textContent=d.raw_count;const t=document.getElementById('rawTable');if(t&&d.raw_msgs.length>0){t.innerHTML=d.raw_msgs.map(r=>`<tr><td style="white-space:nowrap;font-size:0.8rem">${r.date}</td><td><span class="badge info">${r.channel}</span></td><td class="truncate" style="max-width:500px" title="${r.text}">${r.text}</td></tr>`).join('')}}catch(e){console.warn('Raw messages update failed:',e)}}
async function updateStats(){try{const d=await api('/admin/stats');const s=d.stats;document.getElementById('statActive').textContent=s.system.active_users;document.getElementById('statBlocked').textContent=s.system.blocked_users;document.getElementById('statPending').textContent=s.messages.pending_geo;document.getElementById('statMarkers').textContent=s.messages.with_coordinates;document.getElementById('statDebug').textContent=s.system.debug_logs}catch(e){console.warn('Stats update failed:',e)}}
setInterval(()=>{if(auto&&map)reloadMarkers()},30000);
setInterval(updateRaw,15000);
setInterval(updateStats,20000);

function showMainMenu(){document.querySelectorAll('.admin-section').forEach(s=>s.style.display='none');document.getElementById('mainMenu').style.display='block'}
function showSection(name){document.querySelectorAll('.admin-section').forEach(s=>s.style.display='none');document.getElementById('mainMenu').style.display='none';const section=document.getElementById('section-'+name);if(section){section.style.display='block';if(name==='map'&&!map){setTimeout(()=>initMap(),100)}else if(name==='nicknames'){loadNicknamesFromSessions()}}else{notif('Section not found: '+name,'error')}}

// Nicknames management
let allNicknames = [];
async function loadNicknamesFromSessions() {
  try {
    // In real scenario, you'd fetch from backend API that collects nicknames from active sessions
    // For now, we'll show a placeholder since localStorage is client-side only
    const tbody = document.getElementById('nicknamesBody');
    const countBadge = document.getElementById('nicknamesCount');
    
    tbody.innerHTML = `
      <tr>
        <td colspan="4" style="padding:2rem;text-align:center;color:var(--muted)">
          <div style="margin-bottom:1rem;font-size:1.5rem">âš ï¸</div>
          <div style="font-size:1rem;font-weight:600;margin-bottom:0.5rem">Client-Side Data Only</div>
          <div style="font-size:0.875rem">
            User nicknames are stored in each user's browser localStorage.<br>
            To collect them, you need to implement a backend endpoint that:<br>
            1. Collects nicknames from active visitor sessions<br>
            2. Stores them in a database (e.g., visitor_nicknames table)<br>
            3. Returns the list via API endpoint: /admin/nicknames<br><br>
            For now, check your own localStorage: <strong>${localStorage.getItem('user_nickname') || 'Not set'}</strong>
          </div>
        </td>
      </tr>
    `;
    
    countBadge.textContent = '0 nicknames (client-side only)';
    
    // Example implementation if you had an API:
    /*
    const response = await api('/admin/nicknames');
    allNicknames = response.nicknames || [];
    
    tbody.innerHTML = allNicknames.length === 0 
      ? `<tr><td colspan="4" style="padding:2rem;text-align:center;color:var(--muted)">No nicknames found</td></tr>`
      : allNicknames.map((n, i) => `
          <tr style="border-top:1px solid var(--border)">
            <td style="padding:1rem">${i + 1}</td>
            <td style="padding:1rem;font-weight:600;color:var(--blue)">${n.nickname}</td>
            <td style="padding:1rem;color:var(--muted);font-size:0.875rem">${n.timestamp}</td>
            <td style="padding:1rem"><span class="badge info">${n.source}</span></td>
          </tr>
        `).join('');
    
    countBadge.textContent = `${allNicknames.length} nicknames`;
    */
  } catch (e) {
    document.getElementById('nicknamesBody').innerHTML = `
      <tr><td colspan="4" style="padding:2rem;text-align:center;color:var(--red)">Error: ${e.message}</td></tr>
    `;
  }
}

function filterNicknames() {
  const search = document.getElementById('nicknameSearch').value.toLowerCase();
  const filtered = allNicknames.filter(n => n.nickname.toLowerCase().includes(search));
  const tbody = document.getElementById('nicknamesBody');
  
  tbody.innerHTML = filtered.length === 0
    ? `<tr><td colspan="4" style="padding:2rem;text-align:center;color:var(--muted)">No matching nicknames</td></tr>`
    : filtered.map((n, i) => `
        <tr style="border-top:1px solid var(--border)">
          <td style="padding:1rem">${i + 1}</td>
          <td style="padding:1rem;font-weight:600;color:var(--blue)">${n.nickname}</td>
          <td style="padding:1rem;color:var(--muted);font-size:0.875rem">${n.timestamp}</td>
          <td style="padding:1rem"><span class="badge info">${n.source}</span></td>
        </tr>
      `).join('');
}

document.addEventListener('DOMContentLoaded',()=>{console.log('ğŸŒŠ Neptun Admin Dashboard initialized');if(typeof L==='undefined'){notif('Leaflet library failed to load','error');return}const hash=window.location.hash.substring(1);if(hash&&document.getElementById('section-'+hash)){showSection(hash)}updateStats();updateRaw();loadHiddenMarkers();const typeSelect=document.getElementById('editType');if(typeSelect){updateMarkerIcon(typeSelect.value||'shahed');}});
</script>
</body>
</html>
