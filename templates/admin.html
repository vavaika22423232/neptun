<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<title>Admin Panel</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
 body{font-family:Arial,system-ui,sans-serif;background:#0f172a;color:#f1f5f9;margin:0;padding:1.5rem;}
 h1{margin:0 0 1rem;font-size:1.4rem;}
 table{width:100%;border-collapse:collapse;margin-top:1rem;font-size:0.85rem;}
 th,td{padding:8px 10px;border:1px solid #1e293b;text-align:left;}
 th{background:#1e293b;} tr:nth-child(even){background:#162132;}
 .blocked-list{margin-top:2rem;}
 button{background:#2563eb;color:#fff;border:0;padding:6px 10px;border-radius:5px;cursor:pointer;font-weight:600;font-size:.75rem;}
 button:hover{background:#1d4ed8;}
 .danger{background:#dc2626;} .danger:hover{background:#b91c1c;}
 .ok{background:#16a34a;} .ok:hover{background:#15803d;}
 .topbar{display:flex;gap:1rem;align-items:center;flex-wrap:wrap;}
 input[type=text]{background:#0f1d33;border:1px solid #1e2f43;color:#fff;padding:6px 8px;border-radius:5px;}
 .badge{display:inline-block;background:#334155;padding:2px 6px;border-radius:4px;font-size:.65rem;margin-left:6px;}
.hidden-box{margin-top:2rem;}
.hidden-box table td{font-size:.7rem;}
.neg-cache{margin-top:2rem;}
.neg-cache table td{font-size:.7rem;}
</style>
</head>
<body>
  <div class="topbar">
    <h1>Admin</h1>
    {% if secret %}<span class="badge">auth ok</span>{% else %}<span class="badge" style="background:#991b1b">no secret</span>{% endif %}
  <span class="badge" title="Унікальні відвідувачі за сьогодні">Day: {{ daily_unique }}</span>
  <span class="badge" title="Унікальні відвідувачі за 7 днів">Week: {{ week_unique }}</span>
    <form method="get" action="/admin" style="display:flex;gap:.5rem;align-items:center;">
      <input type="text" name="secret" placeholder="secret" value="{{ secret }}" />
      <button type="submit">Reload</button>
    </form>
    <div style="margin-left:auto;display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;">
      <label style="font-size:.7rem;display:flex;flex-direction:column;gap:4px;">
        <span style="opacity:.7;">Період моніторингу (хв)</span>
        <input type="number" id="monPeriod" value="{{ monitor_period }}" min="1" max="360" style="width:90px;">
      </label>
      <button type="button" class="ok" onclick="saveMonPeriod()">Зберегти</button>
      <span id="monStatus" style="font-size:.65rem;color:#94a3b8;"></span>
    </div>
  </div>
  <h2 style="margin-top:1.2rem;font-size:1rem">Active Visitors ({{ visitors|length }})</h2>
  <table>
  <thead><tr><th>ID</th><th>IP</th><th>Device</th><th>Time</th><th>Action</th></tr></thead>
    <tbody>
      {% for v in visitors %}
      <tr>
        <td style="max-width:220px;overflow-wrap:anywhere;">{{ v.id }}</td>
        <td>{{ v.ip }}</td>
  <td title="{{ v.ua }}" style="max-width:140px;overflow-wrap:anywhere;">{{ v.ua_short }}</td>
  <td title="{{ v.age }}s">{{ v.age_fmt }}</td>
        <td><button class="danger" onclick="blockId('{{ v.id }}')">Block</button></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="blocked-list">
    <h2 style="font-size:1rem">Blocked ({{ blocked|length }})</h2>
    <table>
      <thead><tr><th>ID</th><th>Action</th></tr></thead>
      <tbody>
        {% for b in blocked %}
        <tr>
          <td style="max-width:240px;overflow-wrap:anywhere;">{{ b }}</td>
          <td><button class="ok" onclick="unblockId('{{ b }}')">Unblock</button></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="blocked-list" style="margin-top:2rem;">
    <h2 style="font-size:1rem">Raw (pending geo) {{ raw_count }}</h2>
    <table>
      <thead><tr><th>Time</th><th>Channel</th><th>Text</th></tr></thead>
      <tbody>
        {% for r in raw_msgs %}
        <tr>
          <td style="white-space:nowrap;">{{ r.date }}</td>
          <td style="white-space:nowrap;">{{ r.channel }}</td>
          <td style="max-width:420px;overflow-wrap:anywhere;">{{ r.text }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="blocked-list" style="margin-top:2rem;">
    <h2 style="font-size:1rem">Markers (last {{ markers|length }})</h2>
    <table>
      <thead><tr><th>Time</th><th>Type</th><th>Place</th><th>Excerpt</th><th>Action</th></tr></thead>
      <tbody>
        {% for m in markers %}
        <tr>
          <td style="white-space:nowrap;">{{ m.date }}</td>
          <td style="white-space:nowrap;">{{ m.threat_type }}</td>
          <td style="white-space:nowrap;">{{ m.place }}</td>
          <td style="max-width:340px;overflow-wrap:anywhere;">{{ m.text }}</td>
          <td>
            <button class="danger" 
              data-lat="{{ m.lat }}" 
              data-lng="{{ m.lng }}" 
              data-text="{{ (m.text or '')|e }}" 
              data-source="{{ (m.channel or m.source)|e }}"
              onclick="hideMarker(this.dataset.lat,this.dataset.lng,this.dataset.text,this.dataset.source)">Hide</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="blocked-list" style="margin-top:2rem;">
    <h2 style="font-size:1rem;display:flex;align-items:center;gap:.75rem;flex-wrap:wrap;">Додати ручну мітку <span style="font-size:.65rem;opacity:.6;">(manual marker)</span></h2>
    <form onsubmit="return addManualMarker(event)" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.6rem;align-items:end;max-width:880px;">
      <label style="display:flex;flex-direction:column;font-size:.65rem;gap:4px;">
        <span>Lat</span>
        <input type="text" required id="mmLat" placeholder="48.45" />
      </label>
      <label style="display:flex;flex-direction:column;font-size:.65rem;gap:4px;">
        <span>Lng</span>
        <input type="text" required id="mmLng" placeholder="31.12" />
      </label>
      <label style="display:flex;flex-direction:column;font-size:.65rem;gap:4px;">
        <span>Place</span>
        <input type="text" id="mmPlace" placeholder="Київ" />
      </label>
      <label style="display:flex;flex-direction:column;font-size:.65rem;gap:4px;">
        <span>Type</span>
        <select id="mmType">
          <option value="shahed">shahed</option>
          <option value="raketa">raketa</option>
          <option value="avia">avia</option>
          <option value="pvo">pvo</option>
          <option value="vibuh">vibuh</option>
          <option value="mlrs">mlrs</option>
          <option value="artillery">artillery</option>
          <option value="obstril">obstril</option>
          <option value="fpv">fpv</option>
          <option value="pusk">pusk</option>
          <option value="manual" selected>manual</option>
        </select>
      </label>
      <label style="display:flex;flex-direction:column;font-size:.65rem;gap:4px;">
        <span>Icon (optional)</span>
        <input type="text" id="mmIcon" placeholder="custom.png" />
      </label>
      <label style="display:flex;flex-direction:column;font-size:.65rem;gap:4px;grid-column:1 / -1;">
        <span>Text</span>
        <textarea id="mmText" required placeholder="Опис події" style="min-height:60px;background:#0f1d33;border:1px solid #1e2f43;color:#fff;padding:6px 8px;border-radius:5px;font-family:inherit;font-size:.7rem;"></textarea>
      </label>
      <div style="display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;grid-column:1 / -1;">
        <button type="submit" class="ok">Створити</button>
        <span id="mmStatus" style="font-size:.65rem;opacity:.8;"></span>
      </div>
    </form>
    <details style="margin-top:1rem;">
      <summary style="cursor:pointer;font-size:.75rem;opacity:.9;">Як користуватись (інтерактивне вибирання координат)</summary>
      <p style="font-size:.65rem;line-height:1.4;opacity:.8;">Відкрийте основну карту у вкладці, натисніть правою кнопкою (або довгий тап) у місці події, оберіть «Копіювати координати», вставте у поля Lat/Lng. (Можна додати окремий режим кліку прямо тут у майбутньому).</p>
    </details>
  </div>
  <div class="hidden-box">
    <h2 style="font-size:1rem">Hidden Markers ({{ hidden_markers|length }})</h2>
    <table>
      <thead><tr><th>Lat</th><th>Lng</th><th>Source</th><th>Excerpt</th><th>Action</th></tr></thead>
      <tbody>
      {% for h in hidden_markers %}
        <tr>
          <td>{{ h.lat }}</td>
          <td>{{ h.lng }}</td>
          <td style="white-space:nowrap;">{{ h.source }}</td>
          <td style="max-width:260px;overflow-wrap:anywhere;">{{ h.text[:140] }}</td>
          <td><button class="ok" onclick="unhideKey('{{ h.key }}')">Unhide</button></td>
        </tr>
      {% endfor %}
      {% if not hidden_markers %}
        <tr><td colspan="5" style="opacity:.6;">No hidden markers</td></tr>
      {% endif %}
      </tbody>
    </table>
    {% if hidden_markers %}
      <button style="margin-top:.75rem;" class="danger" onclick="bulkUnhide()">Unhide ALL</button>
    {% endif %}
  </div>
  <div class="neg-cache">
    <h2 style="font-size:1rem;display:flex;align-items:center;gap:.75rem;flex-wrap:wrap;">Negative Geocode Cache ({{ neg_geocode|length }})
      <button class="danger" style="margin-left:auto;" onclick="clearNegCache()">Clear All</button>
    </h2>
    <table>
      <thead><tr><th>Query</th><th>When</th><th>Reason</th><th>Action</th></tr></thead>
      <tbody>
      {% for key, meta in neg_geocode %}
        <tr>
          <td style="max-width:220px;overflow-wrap:anywhere;">{{ key }}</td>
          <td style="white-space:nowrap;">{{ meta.ts | datetime if meta.ts else meta.ts }}</td>
          <td style="white-space:nowrap;">{{ meta.reason }}</td>
          <td><button class="ok" onclick="delNeg('{{ key }}')">Remove</button></td>
        </tr>
      {% endfor %}
      {% if not neg_geocode %}
        <tr><td colspan="4" style="opacity:.6;">Empty</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
<script>
async function blockId(id){
  const secret = new URLSearchParams(location.search).get('secret')||'';
  const r = await fetch('/block?secret='+encodeURIComponent(secret), {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});
  if(r.ok) location.reload();
}
async function unblockId(id){
  const secret = new URLSearchParams(location.search).get('secret')||'';
  const r = await fetch('/unblock?secret='+encodeURIComponent(secret), {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});
  if(r.ok) location.reload();
}
async function saveMonPeriod(){
  const secret = new URLSearchParams(location.search).get('secret')||'';
  const val = document.getElementById('monPeriod').value;
  const statusEl = document.getElementById('monStatus');
  statusEl.textContent='Saving...';
  try{
    const r = await fetch('/admin/set_monitor_period?secret='+encodeURIComponent(secret), {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({value:val})});
    const js = await r.json();
    if(js.status==='ok'){
      statusEl.textContent='OK ('+js.monitor_period+')';
      statusEl.style.color='#10b981';
    }else{
      statusEl.textContent='Error';
      statusEl.style.color='#dc2626';
    }
  }catch(e){
    statusEl.textContent='Error';
    statusEl.style.color='#dc2626';
  }
}
async function hideMarker(lat,lng,text,source){
  const secret = new URLSearchParams(location.search).get('secret')||'';
  // Server hide endpoint does not need secret, but we keep secret param for possible future auth
  try{
    const r = await fetch('/hide_marker?secret='+encodeURIComponent(secret), {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lat,lng,text,source})});
    if(r.ok){ location.reload(); }
  }catch(e){}
}
async function unhideKey(key){
  try{
    const r = await fetch('/unhide_marker',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key})});
    if(r.ok) location.reload();
  }catch(e){}
}
async function bulkUnhide(){
  // naive: iterate all keys in the table
  const rows = document.querySelectorAll('.hidden-box tbody tr button.ok');
  for(const btn of rows){
    const key = btn.getAttribute('onclick').match(/unhideKey\('(.*)'\)/)[1];
    try{ await fetch('/unhide_marker',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key})}); }catch(e){}
  }
  location.reload();
}
async function clearNegCache(){
  const secret = new URLSearchParams(location.search).get('secret')||'';
  if(!confirm('Clear all negative geocode entries?')) return;
  try{ const r=await fetch('/admin/neg_geocode_clear?secret='+encodeURIComponent(secret),{method:'POST'}); if(r.ok) location.reload(); }catch(e){}
}
async function delNeg(name){
  const secret = new URLSearchParams(location.search).get('secret')||'';
  try{ const r=await fetch('/admin/neg_geocode_delete?secret='+encodeURIComponent(secret),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})}); if(r.ok) location.reload(); }catch(e){}
}
async function addManualMarker(ev){
  ev.preventDefault();
  const secret = new URLSearchParams(location.search).get('secret')||'';
  const lat = document.getElementById('mmLat').value.trim();
  const lng = document.getElementById('mmLng').value.trim();
  const place = document.getElementById('mmPlace').value.trim();
  const type = document.getElementById('mmType').value;
  const icon = document.getElementById('mmIcon').value.trim();
  const text = document.getElementById('mmText').value.trim();
  const status = document.getElementById('mmStatus');
  status.textContent='Saving...'; status.style.color='#94a3b8';
  try{
    const r = await fetch('/admin/add_manual_marker?secret='+encodeURIComponent(secret),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lat,lng,place,threat_type:type,text,icon})});
    const js = await r.json();
    if(js.status==='ok'){
      status.textContent='OK'; status.style.color='#10b981';
      setTimeout(()=>location.reload(),600);
    } else {
      status.textContent='ERR: '+js.error; status.style.color='#dc2626';
    }
  }catch(e){
    status.textContent='ERR'; status.style.color='#dc2626';
  }
  return false;
}
</script>
</body>
</html>
