<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>NEPTUN — Карта загроз</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --main-bg: #0a0f1c;
      --panel-bg: #111827;
      --accent: #3b82f6;
      --accent2: #10b981;
      --text: #f3f4f6;
      --text2: #d1d5db;
      --text-muted: #9ca3af;
      --border: #1f2937;
      --shadow: rgba(0, 0, 0, 0.25);
      --card-bg: rgba(17, 24, 39, 0.95);
      --card-blur: blur(12px);
      --danger: #ef4444;
      --warning: #f59e0b;
      --success: #10b981;
    }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--main-bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.5;
    }
    
  .navbar {width:100%;background:var(--panel-bg);color:var(--text);font-weight:600;font-size:1.15rem;padding:.7rem 1.1rem;box-shadow:0 4px 20px var(--shadow);display:flex;align-items:center;gap:1.5rem;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50;backdrop-filter:blur(12px);}    
    .navbar .logo {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .navbar .logo img {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 0.75rem;
      background: var(--accent);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
      transition: transform 0.2s;
    }
    
    .navbar .logo img:hover {
      transform: scale(1.05);
    }

  .live-users {display:inline-flex;align-items:center;gap:.3rem;padding:.32rem .65rem;background:linear-gradient(135deg,#1e293b,#0f172a 60%);border:1px solid #1f2b3a;border-radius:999px;font-size:.68rem;font-weight:600;letter-spacing:.4px;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);box-shadow:0 0 0 1px rgba(59,130,246,.15),0 4px 10px -2px rgba(0,0,0,.45);white-space:nowrap;}
        .live-users:before {content:"";width:10px;height:10px;background:radial-gradient(circle at 30% 30%,#34d399,#059669);border-radius:50%;box-shadow:0 0 8px 2px rgba(16,185,129,.6);animation:pulse 2.2s ease-in-out infinite;}
        @keyframes pulse {0%{box-shadow:0 0 0 0 rgba(16,185,129,.6);transform:scale(1);}50%{box-shadow:0 0 0 6px rgba(16,185,129,0);transform:scale(1.08);}100%{box-shadow:0 0 0 0 rgba(16,185,129,0);transform:scale(1);}}
        .live-users span{color:#e2e8f0}
        .live-users strong{color:#34d399;font-weight:700}
    
  .navbar .nav-links {display:flex;gap:.75rem;font-size:.85rem;flex-wrap:wrap;align-items:center;}
    
  .navbar .nav-links a {color:var(--text2);text-decoration:none;font-weight:500;transition:all .2s;padding:.45rem .75rem;border-radius:.5rem;line-height:1;display:flex;align-items:center;gap:.25rem;}
    
    .navbar .nav-links a:hover {
      color: var(--text);
      background: var(--border);
    }
    
    .navbar .nav-links a.active {
      color: var(--accent);
      background: rgba(59, 130, 246, 0.1);
    }
    .main-content {
      display: grid;
      grid-template-columns: minmax(320px, 400px) 1fr;
      gap: 2rem;
      padding: 2rem;
      max-width: 1920px;
      margin: 0 auto;
    }
    
    .card {
      background: var(--card-bg);
      border-radius: 1rem;
      box-shadow: 0 8px 32px var(--shadow);
      padding: 1.5rem;
      backdrop-filter: var(--card-blur);
      border: 1px solid var(--border);
      height: fit-content;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px var(--shadow);
    }
    .card h2 {
      margin: 0 0 1.5rem 0;
      font-size: 1.5rem;
      color: var(--text);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .card h2::before {
      content: '';
      display: block;
      width: 4px;
      height: 1.5rem;
      background: var(--accent);
      border-radius: 2px;
    }
    
    .card .event-list {
      max-height: calc(100vh - 15rem);
      overflow-y: auto;
      padding-right: 0.5rem;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }
    
    .card .event-list::-webkit-scrollbar {
      width: 6px;
    }
    
    .card .event-list::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .card .event-list::-webkit-scrollbar-thumb {
      background-color: var(--border);
      border-radius: 3px;
    }
    
    .event {
      background: var(--panel-bg);
      border-radius: 0.75rem;
      margin-bottom: 1rem;
      padding: 1rem;
      box-shadow: 0 2px 8px var(--shadow);
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }
    
    .event:hover {
      transform: translateX(4px);
      border-color: var(--accent);
    }
    .event:last-child { 
      margin-bottom: 0; 
    }
    
    .event .event-icon {
      width: 2.5rem;
      height: 2.5rem;
      padding: 0.5rem;
      border-radius: 0.75rem;
      background: rgba(59, 130, 246, 0.1);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }
    
    .event .event-info {
      flex: 1;
      color: var(--text);
      font-size: 0.9375rem;
      line-height: 1.5;
    }
    
    .event .event-time {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .event .event-time::before {
      content: '';
      display: inline-block;
      width: 0.5rem;
      height: 0.5rem;
      background: var(--accent);
      border-radius: 50%;
      opacity: 0.7;
    }
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--panel-bg);
      border-radius: 0.75rem;
      border: 1px solid var(--border);
    }
    
    .filters label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .filters input, .filters select {
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 0.625rem 1rem;
      font-size: 0.9375rem;
      background: var(--main-bg);
      color: var(--text);
      transition: all 0.2s;
      width: 100%;
    }
    
    .filters input:hover, .filters select:hover {
      border-color: var(--accent);
    }
    .filters input:focus, .filters select:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    
    .filters button {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 0.5rem;
      padding: 0.625rem 1.25rem;
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .filters button:hover {
      background: var(--accent);
      opacity: 0.9;
      transform: translateY(-1px);
    }
    
    .filters button:active {
      transform: translateY(0);
    }
    
    .filters button i {
      font-size: 1.25rem;
    }
    .map-card {
      grid-column: 2;
      grid-row: 1 / 4;
      padding: 0;
      overflow: hidden;
      background: var(--panel-bg);
      border-radius: 1rem;
      border: 1px solid var(--border);
  position: relative; /* ensure absolutely positioned controls anchor here */
    }
    
    #map {
      height: calc(100vh - 4rem);
      width: 100%;
      border-radius: 1rem;
      box-shadow: inset 0 0 20px var(--shadow);
    }
    
    .map-controls {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      gap: 0.5rem;
  z-index: 120; /* above map and tiles, below modal */
    }
    
    .map-control-btn {
      background: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 0.5rem;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .map-control-btn:hover {
      background: var(--border);
      transform: translateY(-1px);
    }
    @media (max-width: 1100px) {
      .main-content {
        grid-template-columns: 1fr;
        padding: 1rem;
      }
      
      .map-card {
        grid-column: 1;
        grid-row: 1;
        height: 50vh;
      }
      
      #map {
        height: 100%;
      }
      
      .card {
        grid-column: 1;
      }
    }
    
    @media (max-width: 700px) {
      .navbar {
        padding: 0.75rem 1rem;
      }
      
      .navbar .logo span {
        font-size: 1rem;
      }
      
      .navbar .nav-links {
        display: none;
      }
      
      .main-content {
        padding: 0.5rem;
        gap: 0.5rem;
      }
      
      .card {
        padding: 1rem;
        border-radius: 0.75rem;
      }
      
      .filters {
        grid-template-columns: 1fr;
      }
    }
    
    /* Темна тема для карти */
    [class*="copyrights-pane"] {
      background-color: var(--panel-bg) !important;
      color: var(--text) !important;
    }
    
    /* Анимації */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .event {
      animation: fadeIn 0.3s ease-out;
    }
  /* Warning modal */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:200;animation:fadeIn .25s ease;}
  .modal{background:#111c2b;border:1px solid #1f2b3a;border-radius:1rem;padding:1.75rem;max-width:520px;width:92%;box-shadow:0 10px 40px -5px rgba(0,0,0,.6),0 0 0 1px rgba(59,130,246,.15);font-size:.95rem;line-height:1.55;position:relative;font-weight:500;}
  .modal h3{margin:0 0 1rem;font-size:1.35rem;letter-spacing:.5px;background:linear-gradient(90deg,#3b82f6,#06b6d4);-webkit-background-clip:text;background-clip:text;color:transparent;}
  .modal p{margin:.35rem 0;color:#e5e7eb;}
  .modal button{margin-top:1.2rem;background:#2563eb;color:#fff;font-weight:600;border:0;padding:.65rem 1.25rem;border-radius:.65rem;cursor:pointer;box-shadow:0 4px 18px -4px rgba(37,99,235,.55);transition:.18s;}
  .modal button:hover{background:#1d4ed8;transform:translateY(-2px);} .modal button:active{transform:translateY(0);} 
  .modal-close{position:absolute;top:.6rem;right:.6rem;background:#1e293b;border:1px solid #2c3a4d;color:#9ca3af;width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:600;font-size:14px;transition:.18s;} .modal-close:hover{color:#fff;background:#253549;}
  @media (max-width:600px){.modal{padding:1.25rem;font-size:.9rem;} .modal h3{font-size:1.15rem;}}
    /* Дополнительные стили */
    .input-group {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .input-suffix {
      position: absolute;
      right: 1rem;
      color: var(--text-muted);
      pointer-events: none;
    }
    
    .info-content {
      display: grid;
      gap: 1.5rem;
    }
    
    .info-section {
      background: var(--panel-bg);
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
    }
    
    .info-section h3 {
      margin: 0 0 0.75rem 0;
      font-size: 1rem;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .info-section p {
      margin: 0;
      color: var(--text2);
      font-size: 0.9375rem;
      line-height: 1.5;
    }
    
    .accent-link {
      color: var(--accent);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      transition: opacity 0.2s;
    }
    
    .accent-link:hover {
      opacity: 0.8;
    }
    
    .accent-link i {
      font-size: 1rem;
    }
    /* --- Mobile full-width centering fix (eliminate right gap) --- */
    * { box-sizing: border-box; }
    @media (max-width: 840px){
      html, body { width:100%; max-width:100%; overflow-x:hidden; }
      .main-content { display:block; padding:0 !important; margin:0 !important; width:100vw; max-width:100vw; }
      .map-card, .card { width:100vw; max-width:100vw; margin:0 !important; border-radius:0; }
      #map { width:100%; max-width:100%; border-radius:0; }
    }
    /* --- Fullscreen map (custom) --- */
    body.map-expanded { overflow:hidden; }
    body.map-expanded .navbar { display:none; }
    body.map-expanded .main-content { padding:0 !important; margin:0 !important; }
    body.map-expanded .map-card { position:fixed; inset:0; z-index:500; width:100vw !important; height:100vh !important; border-radius:0 !important; }
    body.map-expanded #map { height:100vh !important; width:100vw !important; border-radius:0 !important; }
    body.map-expanded .card:not(.map-card) { display:none !important; }
    /* Dynamic viewport height for mobile browsers supporting dvh */
    @supports (height: 100dvh) {
      body.map-expanded .map-card { height:100dvh !important; }
      body.map-expanded #map { height:100dvh !important; }
    }
    /* Ensure controls stay above map in fullscreen */
    body.map-expanded .map-controls { z-index:600; top:0.75rem; right:0.75rem; }
  /* Force-hide any default Google fullscreen control if Google re-injects it */
  .gm-fullscreen-control { display:none !important; }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="logo">
  <img src="/static/neptun.jpg" alt="NEPTUN">
  <span>NEPTUN</span>
    </div>
    <div class="nav-links">
      <a href="#map" class="active"><i class="material-icons">map</i> Карта</a>
      <a href="#events"><i class="material-icons">notifications</i> Події</a>
      <a href="#about"><i class="material-icons">info</i> Інфо</a>
    </div>
  <div class="live-users" id="liveUsers" title="Активні відвідувачі"><span>онлайн</span><strong>0</strong></div>
  </div>

  <!-- Warning Modal -->
  <div class="modal-overlay" id="warnModal" style="display:none;">
    <div class="modal" role="alertdialog" aria-modal="true" aria-labelledby="warnTitle">
      <button class="modal-close" onclick="closeWarn()" aria-label="Закрити">×</button>
      <h3 id="warnTitle">Попередження!</h3>
      <p>Мапу <strong>не можна використовувати</strong> в прямих трансляціях TikTok та інших соцмережах.</p>
      <p>Використання <strong>тільки в інформативних цілях.</strong></p>
  <p style="margin-top:.6rem;color:#fca5a5;"><strong>Увага:</strong> В разі виявлення порушення ваш тікток акаунт буде заблокований модераторами.</p>
      <button onclick="ackWarn()">Зрозуміло</button>
    </div>
  </div>

  <div class="main-content">
    <!-- Map moved to top -->
    <div class="map-card">
      <div class="map-controls">
        <button class="map-control-btn" onclick="map.setZoom(map.getZoom() + 1)">
          <i class="material-icons">add</i>
        </button>
        <button class="map-control-btn" onclick="map.setZoom(map.getZoom() - 1)">
          <i class="material-icons">remove</i>
        </button>
        <button class="map-control-btn" onclick="map.setCenter({lat: 48.3794, lng: 31.1656})">
          <i class="material-icons">center_focus_strong</i>
        </button>
        <button class="map-control-btn" id="expandBtn" onclick="toggleMapExpand()" title="Розгорнути карту" aria-label="Розгорнути карту">
          <i class="material-icons" id="expandIcon">fullscreen</i>
        </button>
      </div>
      <div id="map"></div>
    </div>
    <div class="card" id="events">
      <h2>Останні події</h2>
      <div class="filters">
        <label>
          Тип загрози
          <select id="threatTypeSelect">
            <option value="">Всі типи</option>
            <option value="shahed">Шахед/БПЛА</option>
            <option value="raketa">Ракета</option>
            <option value="avia">Авіація</option>
            <option value="pvo">ППО</option>
          </select>
        </label>
        <button onclick="updateMarkers()">
          <i class="material-icons">refresh</i>
          Оновити дані
        </button>
      </div>
      <div class="event-list" id="eventList"></div>
    </div>

    <div class="card" id="about">
      <h2>Про систему</h2>
      <div class="info-content">
        <div class="info-section">
          <h3><i class="material-icons">security</i> Призначення</h3>
          <p>Система показує географію повідомлень про повітряні та інші загрози (ракети, БпЛА, артилерія) у режимі близькому до реального часу.</p>
        </div>
        <div class="info-section">
          <h3><i class="material-icons">update</i> Оновлення</h3>
          <p>Дані оновлюються автоматично кожну хвилину з перевірених джерел.</p>
        </div>
        <div class="info-section">
          <h3><i class="material-icons">warning</i> Важливо</h3>
          <p>Координати та типи загроз визначаються автоматично. Можливі похибки у визначенні місць.</p>
        </div>
        <div class="info-section">
          <h3><i class="material-icons">code</i> Розробка</h3>
          <p>Проєкт <a href="https://t.me/+zFxu_4W_ishiNjli" target="_blank" class="accent-link">НЕПТУН <i class="material-icons">open_in_new</i></a></p>
        </div>
      </div>
    </div>

  </div>
  <script>
    // Константи та налаштування
    const UKRAINE_CENTER = { lat: 48.3794, lng: 31.1656 };
    const ICONS = { shahed:'/static/shahed.png', raketa:'/static/raketa.png', avia:'/static/avia.png', pvo:'/static/rozved.png', explosion:'/static/explosion.png', mlrs:'/static/mlrs.png', artillery:'/static/artillery.png', default:'/static/default.png' };
    function preloadIcons(){ Object.keys(ICONS).forEach(k=>{const url=ICONS[k]; const img=new Image(); img.onerror=()=>{ICONS[k]='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAALElEQVQokWP8////fwY0wAgjGJgGLABWMMRAFEg0gGE0GoBmGuwmCkYBAGmxD/dzJvLRwAAAABJRU5ErkJggg==';}; img.src=url;}); }
    let map, markers=[], circles=[]; let markerData=[];
    function clearMap(){ markers.forEach(m=>m.setMap && m.setMap(null)); markers=[]; circles.forEach(c=>c.setMap(null)); circles=[]; }
    async function updateMarkers(){
      let threatType = document.getElementById('threatTypeSelect').value;
      const res = await fetch('/data?confRange=0');
      const data = await res.json();
      let points = (data.tracks||[]).filter(p=>{
        if(typeof p.lat!== 'number'|| typeof p.lng!== 'number') return false;
        if(isNaN(p.lat)||isNaN(p.lng)) return false;
        if(Math.abs(p.lat)<1 && Math.abs(p.lng)<1) return false;
        if(p.lat<43||p.lat>53.5||p.lng<21||p.lng>41) return false;
        const vague=['схід','захід','північ','південь','восток','запад','север','юг'];
        if(!p.place || vague.includes((p.place||'').toLowerCase())) return false;
        return true; });
      if(threatType) points = points.filter(p=> (p.threat_type||'').toLowerCase()===threatType);
      renderMarkers(points, data);
    }
    function renderMarkers(points,data){
      clearMap(); markerData=points;
      points.forEach((p,idx)=>{
        if(/відбій|отбой/i.test(p.text||'')) return;
        let iconUrl = ICONS[p.threat_type]||ICONS.default;
        if(p.marker_icon){ iconUrl = p.marker_icon.startsWith('http')||p.marker_icon.startsWith('/')? p.marker_icon: '/static/'+p.marker_icon; }
        let radius=0,color='#e53935'; if(p.threat_type==='shahed'){radius=10000;} else if(p.threat_type==='raketa'){radius=20000;color='#1976d2';} else if(p.threat_type==='avia'){radius=30000;color='#fbc02d';}
        const pulseCircle = new google.maps.Circle({strokeColor:'#00ffe7',strokeOpacity:0.7,strokeWeight:2,fillColor:color,fillOpacity:0.38,map,center:{lat:p.lat,lng:p.lng},radius: radius*0.7,zIndex:0});
        circles.push(pulseCircle); let start=Date.now()+idx*200; function anim(){const t=((Date.now()-start)%1600)/1600; pulseCircle.setRadius(radius*(0.7+0.7*t)); pulseCircle.setOptions({fillOpacity:0.38*(1-t)}); if(pulseCircle.getMap()) requestAnimationFrame(anim);} if(radius>0) anim();
        let marker = new google.maps.Marker({position:{lat:p.lat,lng:p.lng}, map, title:p.text, icon:{url:iconUrl, scaledSize:new google.maps.Size(32,28)}, opacity:0}); markers.push(marker); setTimeout(()=>marker.setOpacity(1),80+idx*40);
        const info = new google.maps.InfoWindow({content:`<div style="background:#23272f;color:#f4f6fa;border-radius:10px;padding:10px 8px;min-width:220px;max-width:340px;font-size:1.04rem;box-shadow:0 2px 12px #0008;border:1.5px solid #31343b;">`+`<b>Повідомлення:</b><br>${p.text||''}<br><b>Час:</b> ${p.date||''}</div>`});
        marker.addListener('click',()=>info.open(map,marker));
      });
      updateEventList((data&&data.events)||points);
    }
    function updateEventList(points){ const el=document.getElementById('eventList'); if(!el) return; if(!points||!points.length){ el.innerHTML='<div style="color:#888;padding:12px;">Загроз на данний час немає</div>'; return;} el.innerHTML=points.slice(0,20).map(ev=>{let iconUrl=ICONS[ev.threat_type]||ICONS.default; if(ev.marker_icon){ iconUrl= ev.marker_icon.startsWith('http')||ev.marker_icon.startsWith('/')? ev.marker_icon: '/static/'+ev.marker_icon;} return `<div class='event'><img class='event-icon' src='${iconUrl}'><div class='event-info'><b>${ev.place||''}</b><br>${ev.text||''}<div class='event-time'>${ev.date||''}</div></div></div>`;}).join(''); }
    async function initMap(){
      map = new google.maps.Map(document.getElementById('map'), {zoom:6, center:UKRAINE_CENTER, mapTypeControl:false, streetViewControl:false, fullscreenControl:false, gestureHandling:'greedy', zoomControl:false});
      // Presence
      const uid = localStorage.getItem('presence_id') || (self.crypto?.randomUUID? crypto.randomUUID(): (Date.now()+''+Math.random()).replace(/\D/g,''));
      localStorage.setItem('presence_id', uid);
      async function pingPresence(){ try{ const r= await fetch('/presence',{method:'POST',headers:{'Content-Type':'application/json'}, body: JSON.stringify({id:uid})}); const j= await r.json(); if(j.status==='blocked'){ blockOverlay(); return;} if(j.visitors!==undefined){ const el=document.getElementById('liveUsers'); if(el) el.querySelector('strong').textContent=j.visitors; } }catch(e){} }
      function blockOverlay(){ const ov=document.createElement('div'); ov.style.cssText='position:fixed;inset:0;background:#0a0f1f;display:flex;align-items:center;justify-content:center;z-index:9999;font-family:Inter,sans-serif;color:#fff;padding:2rem;text-align:center;'; ov.innerHTML='<div style="max-width:480px;">Ваш доступ тимчасово обмежено.</div>'; document.body.appendChild(ov); }
      pingPresence(); setInterval(pingPresence,5000);
      await updateMarkers();
      try{ const es=new EventSource('/stream'); es.onmessage = ev=>{ try{ const p=JSON.parse(ev.data); if(p.tracks && p.tracks.length) updateMarkers(); if(p.control){ if(p.control.type==='block'){ const my=localStorage.getItem('presence_id'); if(p.control.id && my && p.control.id===my){ blockOverlay(); try{es.close();}catch(e){} } } if(p.control.type==='time_range'){ updateMarkers(); } } }catch(e){} } }catch(e){}
      setInterval(updateMarkers,10000);
    }
    function openWarn(){ const o=document.getElementById('warnModal'); if(o) o.style.display='flex'; }
    function closeWarn(){ const o=document.getElementById('warnModal'); if(o) o.style.display='none'; }
    function ackWarn(){ closeWarn(); }
    function toggleMapExpand(){ const body=document.body; const btn=document.getElementById('expandBtn'); const icon=document.getElementById('expandIcon'); const mapCard=document.querySelector('.map-card'); const was=body.classList.contains('map-expanded'); if(was){ body.classList.remove('map-expanded'); if(btn){ btn.title='Розгорнути карту'; btn.setAttribute('aria-label','Розгорнути карту'); } if(icon){ icon.textContent='fullscreen'; } if(mapCard){ mapCard.style.height=''; } setTimeout(()=>{ if(map){ google.maps.event.trigger(map,'resize'); } },150); } else { body.classList.add('map-expanded'); if(btn){ btn.title='Згорнути карту'; btn.setAttribute('aria-label','Згорнути карту'); } if(icon){ icon.textContent='fullscreen_exit'; } if(mapCard){ mapCard.style.height=window.innerHeight+'px'; } setTimeout(()=>{ if(map){ google.maps.event.trigger(map,'resize'); map.setCenter(UKRAINE_CENTER);} },200);} }
    window.addEventListener('orientationchange',()=>{ if(document.body.classList.contains('map-expanded')){ const mc=document.querySelector('.map-card'); if(mc){ mc.style.height=window.innerHeight+'px'; if(map){ google.maps.event.trigger(map,'resize'); } } } });
    window.addEventListener('resize',()=>{ if(document.body.classList.contains('map-expanded')){ const mc=document.querySelector('.map-card'); if(mc){ mc.style.height=window.innerHeight+'px'; if(map){ google.maps.event.trigger(map,'resize'); } } } });
    window.onload=()=>{ preloadIcons(); initMap(); openWarn(); };
  </script>
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCNvHPPImGhTBA7NyOL7kNvfFe4bTIRpGs&callback=initMap&language=uk"></script>
</body>
</html>
