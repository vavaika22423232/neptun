<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>NEPTUN — Карта загроз</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Leaflet (OpenStreetMap) CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <style>
    :root {
      --main-bg: #0a0f1c;
      --panel-bg: #111827;
      --accent: #3b82f6;
      --accent2: #10b981;
      --text: #f3f4f6;
      --text2: #d1d5db;
      --text-muted: #9ca3af;
      --border: #1f2937;
      --shadow: rgba(0, 0, 0, 0.25);
      --card-bg: rgba(17, 24, 39, 0.95);
      --card-blur: blur(12px);
      --danger: #ef4444;
      --warning: #f59e0b;
      --success: #10b981;
    }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--main-bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.5;
    }
    
  .navbar {width:100%;background:var(--panel-bg);color:var(--text);font-weight:600;font-size:1.15rem;padding:.7rem 1.1rem;box-shadow:0 4px 20px var(--shadow);display:flex;align-items:center;gap:1.5rem;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50;backdrop-filter:blur(12px);}    
    .navbar .logo {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .navbar .logo img {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 0.75rem;
      background: var(--accent);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
      transition: transform 0.2s;
    }
    
    .navbar .logo img:hover {
      transform: scale(1.05);
    }

  .live-users {display:inline-flex;align-items:center;gap:.3rem;padding:.32rem .65rem;background:linear-gradient(135deg,#1e293b,#0f172a 60%);border:1px solid #1f2b3a;border-radius:999px;font-size:.68rem;font-weight:600;letter-spacing:.4px;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);box-shadow:0 0 0 1px rgba(59,130,246,.15),0 4px 10px -2px rgba(0,0,0,.45);white-space:nowrap;}
        .live-users:before {content:"";width:10px;height:10px;background:radial-gradient(circle at 30% 30%,#34d399,#059669);border-radius:50%;box-shadow:0 0 8px 2px rgba(16,185,129,.6);animation:pulse 2.2s ease-in-out infinite;}
        @keyframes pulse {0%{box-shadow:0 0 0 0 rgba(16,185,129,.6);transform:scale(1);}50%{box-shadow:0 0 0 6px rgba(16,185,129,0);transform:scale(1.08);}100%{box-shadow:0 0 0 0 rgba(16,185,129,0);transform:scale(1);}}
        .live-users span{color:#e2e8f0}
        .live-users strong{color:#34d399;font-weight:700}
    
  .navbar .nav-links {display:flex;gap:.75rem;font-size:.85rem;flex-wrap:wrap;align-items:center;}
    
  .navbar .nav-links a {color:var(--text2);text-decoration:none;font-weight:500;transition:all .2s;padding:.45rem .75rem;border-radius:.5rem;line-height:1;display:flex;align-items:center;gap:.25rem;}
    
    .navbar .nav-links a:hover {
      color: var(--text);
      background: var(--border);
    }
    
    .navbar .nav-links a.active {
      color: var(--accent);
      background: rgba(59, 130, 246, 0.1);
    }
    .main-content {
      display: grid;
      grid-template-columns: minmax(320px, 400px) 1fr;
      gap: 2rem;
      padding: 2rem;
      max-width: 1920px;
      margin: 0 auto;
    }
    
    .card {
      background: var(--card-bg);
      border-radius: 1rem;
      box-shadow: 0 8px 32px var(--shadow);
      padding: 1.5rem;
      backdrop-filter: var(--card-blur);
      border: 1px solid var(--border);
      height: fit-content;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px var(--shadow);
    }
    .card h2 {
      margin: 0 0 1.5rem 0;
      font-size: 1.5rem;
      color: var(--text);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .card h2::before {
      content: '';
      display: block;
      width: 4px;
      height: 1.5rem;
      background: var(--accent);
      border-radius: 2px;
    }
    
    .card .event-list {
      max-height: calc(100vh - 15rem);
      overflow-y: auto;
      padding-right: 0.5rem;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }
    
    .card .event-list::-webkit-scrollbar {
      width: 6px;
    }
    
    .card .event-list::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .card .event-list::-webkit-scrollbar-thumb {
      background-color: var(--border);
      border-radius: 3px;
    }
    
    .event {
      background: var(--panel-bg);
      border-radius: 0.75rem;
      margin-bottom: 1rem;
      padding: 1rem;
      box-shadow: 0 2px 8px var(--shadow);
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }
    
    .event:hover {
      transform: translateX(4px);
      border-color: var(--accent);
    }
    .event:last-child { 
      margin-bottom: 0; 
    }
    
    .event .event-icon {
      width: 2.5rem;
      height: 2.5rem;
      padding: 0.5rem;
      border-radius: 0.75rem;
      background: rgba(59, 130, 246, 0.1);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }
    
    .event .event-info {
      flex: 1;
      color: var(--text);
      font-size: 0.9375rem;
      line-height: 1.5;
    }
    
    .event .event-time {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .event .event-time::before {
      content: '';
      display: inline-block;
      width: 0.5rem;
      height: 0.5rem;
      background: var(--accent);
      border-radius: 50%;
      opacity: 0.7;
    }
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--panel-bg);
      border-radius: 0.75rem;
      border: 1px solid var(--border);
    }
    
    .filters label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .filters input, .filters select {
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 0.625rem 1rem;
      font-size: 0.9375rem;
      background: var(--main-bg);
      color: var(--text);
      transition: all 0.2s;
      width: 100%;
    }
    
    .filters input:hover, .filters select:hover {
      border-color: var(--accent);
    }
    .filters input:focus, .filters select:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    
    .filters button {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 0.5rem;
      padding: 0.625rem 1.25rem;
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .filters button:hover {
      background: var(--accent);
      opacity: 0.9;
      transform: translateY(-1px);
    }
    
    .filters button:active {
      transform: translateY(0);
    }
    
    .filters button i {
      font-size: 1.25rem;
    }
    .map-card {
      grid-column: 2;
      grid-row: 1 / 4;
      padding: 0;
      overflow: hidden;
      background: var(--panel-bg);
      border-radius: 1rem;
      border: 1px solid var(--border);
  position: relative; /* ensure absolutely positioned controls anchor here */
    }
    
    #map {
      height: calc(100vh - 4rem);
      width: 100%;
      border-radius: 1rem;
      box-shadow: inset 0 0 20px var(--shadow);
      position: relative;
      background: radial-gradient(circle at 55% 45%, #162132 0%, #0a0f1c 70%);
    }
    /* Subtle grid + glow overlay */
    #map:before { content:""; position:absolute; inset:0; pointer-events:none; background-image:
      repeating-linear-gradient(0deg, rgba(255,255,255,0.025) 0, rgba(255,255,255,0.025) 1px, transparent 1px, transparent 24px),
      repeating-linear-gradient(90deg, rgba(255,255,255,0.02) 0, rgba(255,255,255,0.02) 1px, transparent 1px, transparent 24px); mix-blend-mode:overlay; }
    #map:after { content:""; position:absolute; inset:0; pointer-events:none; background:
      radial-gradient(circle at 60% 40%, rgba(59,130,246,0.20), rgba(59,130,246,0) 60%),
      radial-gradient(circle at 30% 70%, rgba(16,185,129,0.18), rgba(16,185,129,0) 55%);
      mix-blend-mode:screen; }
    
    .map-controls {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      gap: 0.5rem;
  z-index: 120; /* above map and tiles, below modal */
    }
    
    .map-control-btn {
      background: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 0.5rem;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .map-control-btn:hover {
      background: var(--border);
      transform: translateY(-1px);
    }
    @media (max-width: 1100px) {
      .main-content {
        grid-template-columns: 1fr;
        padding: 1rem;
      }
      
      .map-card {
        grid-column: 1;
        grid-row: 1;
        height: 50vh;
      }
      
      #map {
        height: 100%;
      }
      
      .card {
        grid-column: 1;
      }
    }
    
    @media (max-width: 700px) {
      .navbar {
        padding: 0.75rem 1rem;
      }
      
      .navbar .logo span {
        font-size: 1rem;
      }
      
      .navbar .nav-links {
        display: none;
      }
      
      .main-content {
        padding: 0.5rem;
        gap: 0.5rem;
      }
      
      .card {
        padding: 1rem;
        border-radius: 0.75rem;
      }
      
      .filters {
        grid-template-columns: 1fr;
      }
    }
    
    /* Темна тема для карти */
    [class*="copyrights-pane"] {
      background-color: var(--panel-bg) !important;
      color: var(--text) !important;
    }
    
    /* Анимації */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .event {
      animation: fadeIn 0.3s ease-out;
    }
  /* Warning modal */
  /* Increased z-index to sit above Leaflet panes (popup pane ~700) */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:10000;animation:fadeIn .25s ease;}
  .modal{background:#111c2b;border:1px solid #1f2b3a;border-radius:1rem;padding:1.75rem;max-width:520px;width:92%;box-shadow:0 10px 40px -5px rgba(0,0,0,.6),0 0 0 1px rgba(59,130,246,.15);font-size:.95rem;line-height:1.55;position:relative;font-weight:500;}
  .modal h3{margin:0 0 1rem;font-size:1.35rem;letter-spacing:.5px;background:linear-gradient(90deg,#3b82f6,#06b6d4);-webkit-background-clip:text;background-clip:text;color:transparent;}
  .modal p{margin:.35rem 0;color:#e5e7eb;}
  .modal button{margin-top:1.2rem;background:#2563eb;color:#fff;font-weight:600;border:0;padding:.65rem 1.25rem;border-radius:.65rem;cursor:pointer;box-shadow:0 4px 18px -4px rgba(37,99,235,.55);transition:.18s;}
  .modal button:hover{background:#1d4ed8;transform:translateY(-2px);} .modal button:active{transform:translateY(0);} 
  .modal-close{position:absolute;top:.6rem;right:.6rem;background:#1e293b;border:1px solid #2c3a4d;color:#9ca3af;width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:600;font-size:14px;transition:.18s;} .modal-close:hover{color:#fff;background:#253549;}
  @media (max-width:600px){.modal{padding:1.25rem;font-size:.9rem;} .modal h3{font-size:1.15rem;}}
    /* Дополнительные стили */
    .input-group {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .input-suffix {
      position: absolute;
      right: 1rem;
      color: var(--text-muted);
      pointer-events: none;
    }
    
    .info-content {
      display: grid;
      gap: 1.5rem;
    }
    
    .info-section {
      background: var(--panel-bg);
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
    }
    
    .info-section h3 {
      margin: 0 0 0.75rem 0;
      font-size: 1rem;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .info-section p {
      margin: 0;
      color: var(--text2);
      font-size: 0.9375rem;
      line-height: 1.5;
    }
    
    .accent-link {
      color: var(--accent);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      transition: opacity 0.2s;
    }
    
    .accent-link:hover {
      opacity: 0.8;
    }
    
    .accent-link i {
      font-size: 1rem;
    }
    /* --- Mobile full-width centering fix (eliminate right gap) --- */
    * { box-sizing: border-box; }
    @media (max-width: 840px){
      html, body { width:100%; max-width:100%; overflow-x:hidden; }
      .main-content { display:block; padding:0 !important; margin:0 !important; width:100vw; max-width:100vw; }
      .map-card, .card { width:100vw; max-width:100vw; margin:0 !important; border-radius:0; }
      #map { width:100%; max-width:100%; border-radius:0; }
    }
    /* --- Fullscreen map (custom) --- */
    body.map-expanded { overflow:hidden; }
    body.map-expanded .navbar { display:none; }
    body.map-expanded .main-content { padding:0 !important; margin:0 !important; }
    body.map-expanded .map-card { position:fixed; inset:0; z-index:500; width:100vw !important; height:100vh !important; border-radius:0 !important; }
    body.map-expanded #map { height:100vh !important; width:100vw !important; border-radius:0 !important; }
    body.map-expanded .card:not(.map-card) { display:none !important; }
    /* Dynamic viewport height for mobile browsers supporting dvh */
    @supports (height: 100dvh) {
      body.map-expanded .map-card { height:100dvh !important; }
      body.map-expanded #map { height:100dvh !important; }
    }
    /* Ensure controls stay above map in fullscreen */
    body.map-expanded .map-controls { z-index:600; top:0.75rem; right:0.75rem; }
  /* Force-hide any default Google fullscreen control if Google re-injects it */
  .gm-fullscreen-control { display:none !important; }
  /* --- Modern Threat Marker Styles (DivIcons) --- */
  .threat-marker { width:40px; height:40px; position:relative; display:flex; align-items:center; justify-content:center; border-radius:14px; background:linear-gradient(145deg,#1e293b,#0f172a); box-shadow:0 4px 14px -2px rgba(0,0,0,.6),0 0 0 1px rgba(255,255,255,0.04),0 0 0 2px rgba(59,130,246,0.15); overflow:visible; }
  .threat-marker img { width:60%; height:60%; object-fit:contain; filter:drop-shadow(0 2px 4px rgba(0,0,0,.6)); }
  .threat-marker:before { content:""; position:absolute; inset:-2px; border-radius:16px; padding:2px; background:linear-gradient(120deg,var(--c,#3b82f6),#0ea5e9,#3b82f6); /* Standard + webkit masks for hollow glowing border */ mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); mask-composite:exclude; -webkit-mask-composite:xor; animation:borderShift 6s linear infinite; opacity:.85; }
  .threat-marker:after { content:""; position:absolute; width:54px; height:54px; border-radius:50%; background:radial-gradient(circle at 50% 55%, var(--c,#3b82f6), rgba(0,0,0,0) 70%); filter:blur(12px); opacity:.55; z-index:-1; animation:pulseGlow 3.2s ease-in-out infinite; }
  @keyframes pulseGlow { 0%,100%{ transform:scale(.85); opacity:.55;} 50%{ transform:scale(1); opacity:.85;} }
  @keyframes borderShift { 0%{ filter:hue-rotate(0deg);} 100%{ filter:hue-rotate(360deg);} }
  .tm-badge { position:absolute; top:-7px; right:-6px; background:var(--c,#3b82f6); color:#fff; font-size:.68rem; font-weight:700; padding:2px 6px 3px; border-radius:10px; box-shadow:0 2px 6px -1px rgba(0,0,0,.6),0 0 0 1px rgba(255,255,255,.15); letter-spacing:.3px; }
  /* Per-type accent overrides */
  .tm-raketa{ --c:#fb923c; }
  .tm-shahed{ --c:#f87171; }
  .tm-avia{ --c:#38bdf8; }
  .tm-pvo{ --c:#a78bfa; }
  .tm-artillery{ --c:#facc15; }
  .tm-mlrs{ --c:#fbbf24; }
  .tm-vibuh{ --c:#eab308; }
  .tm-alarm{ --c:#ef4444; }
  .tm-alarm_cancel{ --c:#10b981; }
  /* Cluster styling */
  .cluster-icon { background:transparent; }
  .cluster-outer { position:relative; width:52px; height:52px; border-radius:50%; display:flex; align-items:center; justify-content:center; animation:clusterPulse 4.5s ease-in-out infinite; }
  .cluster-inner { width:44px; height:44px; border-radius:50%; background:linear-gradient(135deg,#1e293b,#0f172a); display:flex; align-items:center; justify-content:center; font-size:.85rem; font-weight:600; color:#fff; letter-spacing:.5px; box-shadow:0 4px 14px -2px rgba(0,0,0,.65),0 0 0 1px rgba(255,255,255,0.06),0 0 0 4px rgba(59,130,246,0.25); }
  .cluster-outer:before { content:""; position:absolute; inset:0; border-radius:50%; background:conic-gradient(from 0deg, #3b82f6, #0ea5e9, #10b981, #3b82f6); filter:blur(6px); opacity:.55; animation:spin 14s linear infinite; }
  .cluster-outer.sm .cluster-inner{ box-shadow:0 0 0 4px rgba(59,130,246,.25);} /* base */
  .cluster-outer.md .cluster-inner{ box-shadow:0 0 0 5px rgba(16,185,129,.35);} 
  .cluster-outer.lg .cluster-inner{ box-shadow:0 0 0 6px rgba(234,179,8,.35);} 
  .cluster-outer.xlg .cluster-inner{ box-shadow:0 0 0 7px rgba(239,68,68,.4);} 
  @keyframes spin { to { transform:rotate(360deg);} }
  @keyframes clusterPulse { 0%,100%{ transform:scale(.9);} 50%{ transform:scale(1);} }
  /* Reposition & style Leaflet controls */
  .leaflet-control-layers { background:rgba(17,24,39,.92); backdrop-filter:blur(10px); border:1px solid #1f2937; border-radius:.85rem; box-shadow:0 4px 18px -4px rgba(0,0,0,.55); color:#e5e7eb; overflow:hidden; }
  .leaflet-control-layers-expanded { padding:.6rem .75rem .55rem; }
  .leaflet-control-layers-toggle { background:#1e293b !important; width:34px; height:34px; }
  .leaflet-control-attribution { background:rgba(17,24,39,.8); color:#94a3b8; font-size:.6rem; padding:.3rem .55rem; border-radius:.5rem; backdrop-filter:blur(6px); }
  .leaflet-container a { color:#38bdf8; }
  /* Center control fix styling */
  .map-control-btn.center-btn { position:relative; }
  .map-control-btn.center-btn:after { content:""; position:absolute; inset:0; border-radius:.5rem; box-shadow:0 0 0 2px rgba(59,130,246,.35),0 0 12px -2px rgba(59,130,246,.55); opacity:0; transition:.25s; }
  .map-control-btn.center-btn:hover:after { opacity:1; }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="logo">
  <img src="/static/neptun.jpg" alt="NEPTUN">
  <span>NEPTUN</span>
    </div>
    <div class="nav-links">
      <a href="#map" class="active"><i class="material-icons">map</i> Карта</a>
      <a href="#events"><i class="material-icons">notifications</i> Події</a>
      <a href="#about"><i class="material-icons">info</i> Інфо</a>
    </div>
  <div class="live-users" id="liveUsers" title="Активні відвідувачі / Beta"><span>онлайн</span><strong>0</strong><span style="margin-left:.5rem;color:#fbbf24;font-weight:700;letter-spacing:.5px;">BETA</span></div>
  </div>

  <!-- Warning Modal -->
  <div class="modal-overlay" id="warnModal" style="display:none;">
    <div class="modal" role="alertdialog" aria-modal="true" aria-labelledby="warnTitle">
      <button class="modal-close" onclick="closeWarn()" aria-label="Закрити">×</button>
      <h3 id="warnTitle">Попередження!</h3>
      <p>Мапу <strong>не можна використовувати</strong> в прямих трансляціях TikTok та інших соцмережах.</p>
      <p>Використання <strong>тільки в інформативних цілях.</strong></p>
  <p style="margin-top:.6rem;color:#fca5a5;"><strong>Увага:</strong> В разі виявлення порушення ваш тікток акаунт буде заблокований модераторами.</p>
      <button onclick="ackWarn()">Зрозуміло</button>
    </div>
  </div>

  <div class="main-content">
    <!-- Map moved to top -->
    <div class="map-card">
      <div class="map-controls">
        <button class="map-control-btn" onclick="map.setZoom(map.getZoom() + 1)">
          <i class="material-icons">add</i>
        </button>
        <button class="map-control-btn" onclick="map.setZoom(map.getZoom() - 1)">
          <i class="material-icons">remove</i>
        </button>
  <button class="map-control-btn center-btn" onclick="centerMap()" title="Центр України">
          <i class="material-icons">center_focus_strong</i>
        </button>
        <button class="map-control-btn" id="expandBtn" onclick="toggleMapExpand()" title="Розгорнути карту" aria-label="Розгорнути карту">
          <i class="material-icons" id="expandIcon">fullscreen</i>
        </button>
      </div>
      <div id="map"></div>
    </div>
    <div class="card" id="events">
      <h2>Останні події</h2>
      <div class="filters">
        <label>
          Період моніторингу
          <div class="input-group">
            <input type="number" id="timeRange" value="0" readonly disabled style="opacity:.6;cursor:not-allowed;" title="Фіксовано адміністратором">
            <span class="input-suffix">хв</span>
          </div>
        </label>
        <label>
          Тип загрози
          <select id="threatTypeSelect">
            <option value="">Всі типи</option>
            <option value="shahed">Шахед/БПЛА</option>
            <option value="raketa">Ракета</option>
            <option value="avia">Авіація</option>
            <option value="pvo">ППО</option>
          </select>
        </label>
        <button onclick="updateMarkers()">
          <i class="material-icons">refresh</i>
          Оновити дані
        </button>
      </div>
      <div class="event-list" id="eventList"></div>
    </div>

    <div class="card" id="about">
      <h2>Про систему</h2>
      <div class="info-content">
        <div class="info-section">
          <h3><i class="material-icons">security</i> Призначення</h3>
          <p>Система показує географію повідомлень про повітряні та інші загрози (ракети, БпЛА, артилерія) у режимі близькому до реального часу.</p>
        </div>
        <div class="info-section">
          <h3><i class="material-icons">update</i> Оновлення</h3>
          <p>Дані оновлюються автоматично кожну хвилину з перевірених джерел.</p>
        </div>
        <div class="info-section">
          <h3><i class="material-icons">warning</i> Важливо</h3>
          <p>Координати та типи загроз визначаються автоматично. Можливі похибки у визначенні місць.</p>
        </div>
        <div class="info-section">
          <h3><i class="material-icons">code</i> Розробка</h3>
          <p>Проєкт <a href="https://t.me/+zFxu_4W_ishiNjli" target="_blank" class="accent-link">НЕПТУН <i class="material-icons">open_in_new</i></a></p>
        </div>
      </div>
    </div>

  </div>
  <!-- Leaflet (OpenStreetMap) JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    // Константы и настройки
    const UKRAINE_CENTER = { lat: 48.3794, lng: 31.1656 };
    const ICONS = {
      shahed: '/static/shahed.png',
      raketa: '/static/raketa.png',
      avia: '/static/avia.png',
      pvo: '/static/rozved.png',
  vibuh: '/static/vibuh.png',
  alarm: '/static/trivoga.png',
  alarm_cancel: '/static/vidboi.png',
  mlrs: '/static/mlrs.png',
  artillery: '/static/artillery.png',
      default: '/static/default.png'
    };
    // Fallback tiny red dot if icon 404
    function preloadIcons(){
      Object.keys(ICONS).forEach(k=>{const url=ICONS[k]; const img=new Image(); img.onload=()=>{}; img.onerror=()=>{ICONS[k]='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAALElEQVQokWP8////fwY0wAgjGJgGLABWMMRAFEg0gGE0GoBmGuwmCkYBAGmxD/dzJvLRwAAAABJRU5ErkJggg==';}; img.src=url;});
    }
    // Состояние приложения
    let map;
    let clusterLayer = null;
    let markers = [];
    const TYPE_COLORS = { shahed:'#f87171', raketa:'#fb923c', avia:'#38bdf8', pvo:'#a78bfa', vibuh:'#eab308', alarm:'#ef4444', alarm_cancel:'#10b981', mlrs:'#fbbf24', artillery:'#facc15', default:'#3b82f6' };
    function createDivIcon(p, iconUrl){
      const type = (p.threat_type||'default').toLowerCase();
      const color = TYPE_COLORS[type] || TYPE_COLORS.default;
      const badge = (p.count && p.count>1) ? `<div class='tm-badge'>${p.count}</div>` : '';
      const html = `<div class="threat-marker tm-${type}" style="--c:${color}">${badge}${iconUrl?`<img src='${iconUrl}' alt=''>`:''}</div>`;
      return L.divIcon({ html, className:'', iconSize:[40,40], iconAnchor:[20,20], popupAnchor:[0,-18] });
    }
    async function updateMarkers() {
      const timeRange = 50; // fixed
      const threatType = document.getElementById('threatTypeSelect').value;
      const params = new URLSearchParams({ timeRange, confRange: 0 });
      const res = await fetch(`/data?${params.toString()}`);
      const data = await res.json();
      let points = (data.tracks || []).filter(p => {
        if (typeof p.lat !== 'number' || typeof p.lng !== 'number') return false;
        if (isNaN(p.lat) || isNaN(p.lng)) return false;
        if (Math.abs(p.lat) < 1 && Math.abs(p.lng) < 1) return false;
        if (p.lat < 43 || p.lat > 53.5 || p.lng < 21 || p.lng > 41) return false;
        const vague = ['схід','захід','північ','південь','восток','запад','север','юг'];
        if (!p.place || vague.includes(p.place.toLowerCase())) return false;
        return true;
      });
      if (threatType) points = points.filter(p => (p.threat_type || '').toLowerCase() === threatType);
      if (clusterLayer) { clusterLayer.clearLayers(); }
      else {
        clusterLayer = L.markerClusterGroup({
          maxClusterRadius:52,
          spiderfyOnMaxZoom:true,
          showCoverageOnHover:false,
          iconCreateFunction: cluster => {
            const count = cluster.getChildCount();
            const scale = count>50?'xlg':count>25?'lg':count>10?'md':'sm';
            return L.divIcon({ html:`<div class="cluster-outer ${scale}"><div class="cluster-inner">${count}</div></div>`, className:'cluster-icon', iconSize:[52,52] });
          }
        }).addTo(map);
      }
      markers = [];
      points.forEach(p => {
        let iconUrl = ICONS[p.threat_type] || ICONS.default;
        if (p.marker_icon) {
          iconUrl = (p.marker_icon.startsWith('http') || p.marker_icon.startsWith('/')) ? p.marker_icon : '/static/' + p.marker_icon;
        }
  const icon = createDivIcon(p, iconUrl);
  const m = L.marker([p.lat, p.lng], { icon });
        const popupHtml = `<div style="background:#23272f;color:#f4f6fa;border-radius:10px;padding:10px 8px;min-width:180px;font-size:.78rem;line-height:1.3;">`
          + (p.place ? `<div style='font-size:.9rem;font-weight:600;margin-bottom:4px;'>${p.place}</div>` : '')
          + (p.count ? `<div style='margin-bottom:4px;font-weight:600;color:#f87171;'>Кількість: ${p.count}×</div>` : '')
          + `<div style='white-space:pre-wrap;'>${p.text || ''}</div>`
          + `<div style='margin-top:6px;font-size:.6rem;opacity:.6;'>${p.date || ''}</div>`
          + `</div>`;
        m.bindPopup(popupHtml, { closeButton:false, autoPan:true });
        if (p.count && p.count > 1) { m.openPopup(); }
  clusterLayer.addLayer(m);
        markers.push(m);
      });
      updateEventList(data.events || []);
    }
    function updateEventList(points) {
      const el = document.getElementById('eventList');
      if (!el) return;
      if (!points || !points.length) {
        el.innerHTML = '<div style="color:#888;padding:12px;">Загроз на данний час немає</div>';
        return;
      }
      el.innerHTML = points.slice(0, 20).map(ev => {
        let iconUrl = ICONS[ev.threat_type] || ICONS.default;
        if (ev.marker_icon) {
          if (ev.marker_icon.startsWith('http') || ev.marker_icon.startsWith('/')) {
            iconUrl = ev.marker_icon;
          } else {
            iconUrl = '/static/' + ev.marker_icon;
          }
        }
        const isCancel = ev.threat_type === 'alarm_cancel';
  const isAlarm = ev.threat_type === 'alarm';
        const placeLine = (ev.place && !isCancel) ? `<b>${ev.place}</b><br>` : '';
  return `<div class='event'><img class='event-icon' src='${iconUrl}' alt='${ev.threat_type || ''}'><div class='event-info'>${placeLine}${ev.text || ''}<div class='event-time'>${ev.date || ''}</div></div></div>`;
      }).join('');
    }
    async function initMap() {
  map = L.map('map', { zoomControl:false, attributionControl:true }).setView([48.3794,31.1656], 6);
  const light = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap contributors'});
  const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap &copy; CARTO'});
  const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom:19, attribution:'Tiles &copy; Esri' });
  dark.addTo(map);
  const baseLayers = { 'Dark': dark, 'Light': light, 'Satellite': sat };
  const layerControl = L.control.layers(baseLayers, {}, { position:'bottomleft' }).addTo(map);
      // ---- Presence (active users) ----
      const uid = localStorage.getItem('presence_id') || (self.crypto?.randomUUID ? crypto.randomUUID() : (Date.now()+""+Math.random()).replace(/\D/g,''));
      localStorage.setItem('presence_id', uid);
      async function pingPresence(){
        try {
          const r = await fetch('/presence', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id:uid})});
          const j = await r.json();
          if(j.status === 'blocked'){
            // Show overlay and stop further updates
            const ov = document.createElement('div');
            ov.style.cssText='position:fixed;inset:0;background:#0a0f1f;display:flex;align-items:center;justify-content:center;z-index:9999;font-family:Inter,sans-serif;color:#fff;padding:2rem;text-align:center;';
            ov.innerHTML='<div style="max-width:480px;">Ваш доступ тимчасово обмежено.</div>';
            document.body.appendChild(ov);
            return;
          }
          if(j.visitors !== undefined){
            const el = document.getElementById('liveUsers');
            if(el){ el.querySelector('strong').textContent = j.visitors; }
          }
        } catch(e){}
      }
      pingPresence();
  setInterval(pingPresence, 5000);

      // --- Интеграция с alerts.in.ua ---
      let airAlarmLayer = null;
      async function fetchAirAlarms(){
        try { const r = await fetch('https://alerts.com.ua/api/states'); const j = await r.json(); return j.regions || {}; } catch(e){ return {}; }
      }
      async function showAirAlarmsOnMap(){
        const regions = await fetchAirAlarms();
        const geoRes = await fetch('https://alerts.com.ua/static/geo/ukraine_regions.json');
        const geo = await geoRes.json();
        if (airAlarmLayer) { airAlarmLayer.remove(); }
        airAlarmLayer = L.geoJSON(geo, {
          style: feature => {
            let code = feature.properties.id || feature.properties.ISO_3166_2;
            if (code) code = code.toUpperCase();
            let alarm = false;
            if (code && regions[code]) alarm = regions[code].alert;
            if (!alarm && code && regions[code.toLowerCase()]) alarm = regions[code.toLowerCase()].alert;
            return {
              color: alarm ? '#e53935' : '#bdbdbd',
              weight: alarm ? 2 : 1,
              fillColor: alarm ? '#ffe082' : '#e0e4ea',
              fillOpacity: alarm ? 0.55 : 0.12
            };
          }
        }).addTo(map);
      }
      showAirAlarmsOnMap();
      setInterval(showAirAlarmsOnMap, 20000);

      await updateMarkers();
      try {
    const es = new EventSource('/stream');
    const uid2 = localStorage.getItem('presence_id');
    es.onmessage = ev => {
          try {
            const p = JSON.parse(ev.data);
      if (p.tracks && p.tracks.length) { updateMarkers(); }
      if (p.control && p.control.type === 'block' && p.control.id && uid2 && p.control.id === uid2) {
               // show block overlay instantly
               const ov = document.createElement('div');
               ov.style.cssText='position:fixed;inset:0;background:#0a0f1f;display:flex;align-items:center;justify-content:center;z-index:9999;font-family:Inter,sans-serif;color:#fff;padding:2rem;text-align:center;';
               ov.innerHTML='<div style="max-width:480px;">Ваш доступ тимчасово обмежено.</div>';
               document.body.appendChild(ov);
               try { es.close(); } catch(e){}
            }
          } catch(e){}
        };
      } catch(e) {}
      setInterval(updateMarkers, 10000);
    }
  function openWarn(){const o=document.getElementById('warnModal'); if(o) o.style.display='flex';}
  function closeWarn(){const o=document.getElementById('warnModal'); if(o) o.style.display='none';}
  function ackWarn(){ closeWarn(); }
  function toggleMapExpand(){
    const body = document.body;
    const btn = document.getElementById('expandBtn');
    const icon = document.getElementById('expandIcon');
    const mapCard = document.querySelector('.map-card');
    const wasExpanded = body.classList.contains('map-expanded');
    if(wasExpanded){
      body.classList.remove('map-expanded');
      if(btn){ btn.title='Розгорнути карту'; btn.setAttribute('aria-label','Розгорнути карту'); }
      if(icon){ icon.textContent='fullscreen'; }
  if(mapCard){ mapCard.style.height=''; }
      // restore map size
  setTimeout(()=>{ if(map){ map.invalidateSize(); } },150);
    } else {
      body.classList.add('map-expanded');
      if(btn){ btn.title='Згорнути карту'; btn.setAttribute('aria-label','Згорнути карту'); }
      if(icon){ icon.textContent='fullscreen_exit'; }
      // Set explicit height for iOS Safari dynamic bars
      if(mapCard){ mapCard.style.height= window.innerHeight + 'px'; }
  setTimeout(()=>{ if(map){ map.invalidateSize(); map.setView([UKRAINE_CENTER.lat, UKRAINE_CENTER.lng]); } },200);
    }
  }
  function centerMap(){ if(map){ map.setView([UKRAINE_CENTER.lat, UKRAINE_CENTER.lng], 6, { animate:true }); } }
  // Adjust fullscreen height on orientation / resize for mobile
  window.addEventListener('orientationchange', ()=>{ if(document.body.classList.contains('map-expanded')){ const mapCard=document.querySelector('.map-card'); if(mapCard){ mapCard.style.height=window.innerHeight+'px'; if(map){ map.invalidateSize(); } } } });
  window.addEventListener('resize', ()=>{ if(document.body.classList.contains('map-expanded')){ const mapCard=document.querySelector('.map-card'); if(mapCard){ mapCard.style.height=window.innerHeight+'px'; if(map){ map.invalidateSize(); } } } });
  window.onload = () => { preloadIcons(); initMap(); openWarn(); };
  </script>
  <!-- Google Maps script removed after migration to Leaflet / OpenStreetMap -->
</body>
</html>
