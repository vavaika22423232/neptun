<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>NEPTUN — Карта загроз</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Leaflet (OpenStreetMap) CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    :root {
      --main-bg: #0a0f1c;
      --panel-bg: #111827;
      --accent: #3b82f6;
      --accent2: #10b981;
      --text: #f3f4f6;
      --text2: #d1d5db;
      --text-muted: #9ca3af;
      --border: #1f2937;
      --shadow: rgba(0, 0, 0, 0.25);
      --card-bg: rgba(17, 24, 39, 0.95);
      --card-blur: blur(12px);
      --danger: #ef4444;
      --warning: #f59e0b;
      --success: #10b981;
    }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--main-bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.5;
    }
    
  .navbar {width:100%;background:var(--panel-bg);color:var(--text);font-weight:600;font-size:1.15rem;padding:.7rem 1.1rem;box-shadow:0 4px 20px var(--shadow);display:flex;align-items:center;gap:1.5rem;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50;backdrop-filter:blur(12px);}    
    .navbar .logo {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .navbar .logo img {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 0.75rem;
      background: var(--accent);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
      transition: transform 0.2s;
    }
    
    .navbar .logo img:hover {
      transform: scale(1.05);
    }

  .live-users {display:inline-flex;align-items:center;gap:.3rem;padding:.32rem .65rem;background:linear-gradient(135deg,#1e293b,#0f172a 60%);border:1px solid #1f2b3a;border-radius:999px;font-size:.68rem;font-weight:600;letter-spacing:.4px;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);box-shadow:0 0 0 1px rgba(59,130,246,.15),0 4px 10px -2px rgba(0,0,0,.45);white-space:nowrap;}
        .live-users:before {content:"";width:10px;height:10px;background:radial-gradient(circle at 30% 30%,#34d399,#059669);border-radius:50%;box-shadow:0 0 8px 2px rgba(16,185,129,.6);animation:pulse 2.2s ease-in-out infinite;}
        @keyframes pulse {0%{box-shadow:0 0 0 0 rgba(16,185,129,.6);transform:scale(1);}50%{box-shadow:0 0 0 6px rgba(16,185,129,0);transform:scale(1.08);}100%{box-shadow:0 0 0 0 rgba(16,185,129,0);transform:scale(1);}}
        .live-users span{color:#e2e8f0}
        .live-users strong{color:#34d399;font-weight:700}
    
  .navbar .nav-links {display:flex;gap:.75rem;font-size:.85rem;flex-wrap:wrap;align-items:center;}
    
  .navbar .nav-links a {color:var(--text2);text-decoration:none;font-weight:500;transition:all .2s;padding:.45rem .75rem;border-radius:.5rem;line-height:1;display:flex;align-items:center;gap:.25rem;}
    
    .navbar .nav-links a:hover {
      color: var(--text);
      background: var(--border);
    }
    
    .navbar .nav-links a.active {
      color: var(--accent);
      background: rgba(59, 130, 246, 0.1);
    }
    .main-content {
      display: grid;
      grid-template-columns: minmax(320px, 400px) 1fr;
      gap: 2rem;
      padding: 2rem;
      max-width: 1920px;
      margin: 0 auto;
    }
    
    .card {
      background: var(--card-bg);
      border-radius: 1rem;
      box-shadow: 0 8px 32px var(--shadow);
      padding: 1.5rem;
      backdrop-filter: var(--card-blur);
      border: 1px solid var(--border);
      height: fit-content;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px var(--shadow);
    }
    .card h2 {
      margin: 0 0 1.5rem 0;
      font-size: 1.5rem;
      color: var(--text);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .card h2::before {
      content: '';
      display: block;
      width: 4px;
      height: 1.5rem;
      background: var(--accent);
      border-radius: 2px;
    }
    
    .card .event-list {
      max-height: calc(100vh - 15rem);
      overflow-y: auto;
      padding-right: 0.5rem;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }
    
    .card .event-list::-webkit-scrollbar {
      width: 6px;
    }
    
    .card .event-list::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .card .event-list::-webkit-scrollbar-thumb {
      background-color: var(--border);
      border-radius: 3px;
    }
    
    .event {
      background: var(--panel-bg);
      border-radius: 0.75rem;
      margin-bottom: 1rem;
      padding: 1rem;
      box-shadow: 0 2px 8px var(--shadow);
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }
    
    .event:hover {
      transform: translateX(4px);
      border-color: var(--accent);
    }
    .event:last-child { 
      margin-bottom: 0; 
    }
    
    .event .event-icon {
      width: 2.5rem;
      height: 2.5rem;
      padding: 0.5rem;
      border-radius: 0.75rem;
      background: rgba(59, 130, 246, 0.1);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }
    
    .event .event-info {
      flex: 1;
      color: var(--text);
      font-size: 0.9375rem;
      line-height: 1.5;
    }
    
    .event .event-time {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .event .event-time::before {
      content: '';
      display: inline-block;
      width: 0.5rem;
      height: 0.5rem;
      background: var(--accent);
      border-radius: 50%;
      opacity: 0.7;
    }
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--panel-bg);
      border-radius: 0.75rem;
      border: 1px solid var(--border);
    }
    
    .filters label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .filters input, .filters select {
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 0.625rem 1rem;
      font-size: 0.9375rem;
      background: var(--main-bg);
      color: var(--text);
      transition: all 0.2s;
      width: 100%;
    }
    
    .filters input:hover, .filters select:hover {
      border-color: var(--accent);
    }
    .filters input:focus, .filters select:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    
    .filters button {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 0.5rem;
      padding: 0.625rem 1.25rem;
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .filters button:hover {
      background: var(--accent);
      opacity: 0.9;
      transform: translateY(-1px);
    }
    
    .filters button:active {
      transform: translateY(0);
    }
    
    .filters button i {
      font-size: 1.25rem;
    }
    .map-card {
      grid-column: 2;
      grid-row: 1 / 4;
      padding: 0;
      overflow: hidden;
      background: radial-gradient(circle at 35% 30%, #ffffff, #e9eef3 55%, #dde4ea);
      border-radius: 1.15rem;
      border: 1px solid #d0d9e2;
      position: relative;
      box-shadow: 0 8px 26px -10px rgba(0,0,0,.25), 0 2px 4px rgba(0,0,0,.08), 0 0 0 1px rgba(255,255,255,.6) inset;
      backdrop-filter: blur(6px) saturate(1.2);
    }
    
    #map {
      height: calc(100vh - 4rem);
      width: 100%;
      border-radius: 1.15rem;
      background:#f1f4f8;
      box-shadow: 0 0 0 1px rgba(0,0,0,.04), 0 4px 18px -8px rgba(0,0,0,.18), inset 0 0 0 1px rgba(255,255,255,.55);
      position:relative;
    }
    #map:after { /* subtle vignette */
      content:"";position:absolute;inset:0;pointer-events:none;background:radial-gradient(circle at 60% 40%,rgba(255,255,255,0) 40%,rgba(0,0,0,.15) 95%);
      mix-blend-mode:multiply;opacity:.35;
    }
    
    .map-controls {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      gap: 0.5rem;
  /* Leaflet panes use z-index up to ~700 (popupPane). Use higher to always stay on top */
  z-index: 1200; /* above all Leaflet layers, below modal */
    }
    
    .map-control-btn {
      background: linear-gradient(145deg,rgba(255,255,255,0.82),rgba(248,250,252,0.95));
      border: 1px solid #c3cdd6;
      border-radius: 0.65rem;
      padding: 0.55rem;
      color: #1e293b;
      cursor: pointer;
      transition: all 0.25s;
      backdrop-filter: blur(10px) saturate(1.3);
      box-shadow: 0 2px 5px rgba(0,0,0,.12),0 0 0 1px rgba(255,255,255,.7) inset,0 6px 18px -8px rgba(0,0,0,.22);
    }
    .map-control-btn:hover { background:linear-gradient(145deg,#ffffff,#f1f5f9); transform: translateY(-3px) scale(1.04); box-shadow:0 6px 18px -6px rgba(0,0,0,.25),0 0 0 1px rgba(255,255,255,.85) inset; }
    .map-control-btn:active { transform:translateY(0); }
    .map-control-btn i { font-size:20px; }
    .map-controls { pointer-events:none; }
    .map-controls .map-control-btn { pointer-events:auto; }
    .leaflet-popup-content-wrapper{background:#ffffff;border:1px solid #d7dde3;border-radius:.9rem;box-shadow:0 6px 22px -6px rgba(0,0,0,.25);} 
    .leaflet-popup-tip{background:#ffffff;border:1px solid #d7dde3;}
    .leaflet-container a{color:#2563eb;}
  /* --- Custom sharper markers --- */
  .threat-marker{position:relative;}
  .threat-marker .tm-core{--c:var(--c,#334155);width:38px;height:38px;border-radius:50%;background:radial-gradient(circle at 35% 30%,rgba(255,255,255,.92),rgba(255,255,255,.15)),linear-gradient(145deg,var(--c),color-mix(in srgb,var(--c) 78%,#000));border:2px solid #fff;box-shadow:0 6px 14px -3px rgba(0,0,0,.45),0 0 0 1px rgba(0,0,0,.12);display:flex;align-items:center;justify-content:center;position:relative;backdrop-filter:blur(3px) saturate(1.2);}
  .threat-marker .tm-core:after{content:"";position:absolute;bottom:-8px;left:50%;width:14px;height:14px;background:linear-gradient(145deg,var(--c),color-mix(in srgb,var(--c) 70%,#000));transform:translateX(-50%) rotate(45deg);border:2px solid #fff;border-top:none;border-left:none;border-bottom-right-radius:3px;box-shadow:0 4px 6px -2px rgba(0,0,0,.35);}
  .threat-marker img{width:60%;height:60%;object-fit:contain;filter:drop-shadow(0 1px 2px rgba(0,0,0,.45));transition:transform .25s ease;}
  .threat-marker:hover .tm-core{box-shadow:0 10px 24px -6px rgba(0,0,0,.5),0 0 0 1px rgba(0,0,0,.15);}
  .threat-marker:hover img{transform:scale(1.08);}
  /* Pulse for active air alarm markers */
  .threat-marker .tm-core.alarm{animation:alarmPulse 1.8s ease-in-out infinite;}
  @keyframes alarmPulse {0%{box-shadow:0 0 0 0 rgba(251,191,36,.55),0 0 0 1px rgba(0,0,0,.1);}60%{box-shadow:0 0 0 12px rgba(251,191,36,0),0 0 0 1px rgba(0,0,0,.12);}100%{box-shadow:0 0 0 0 rgba(251,191,36,0),0 0 0 1px rgba(0,0,0,.12);}}
  .threat-marker .tm-badge{position:absolute;top:-4px;right:-4px;background:#fff;color:#111827;font-size:.6rem;font-weight:700;padding:2px 4px;border-radius:10px;border:1px solid rgba(0,0,0,.1);box-shadow:0 2px 4px -1px rgba(0,0,0,.35);}
  .threat-marker .tm-core.alarm{--c:#fbbf24;}
  .threat-marker .tm-core.alarm_cancel{--c:#64748b;}
  .threat-marker .tm-core.shahed{--c:#2563eb;}
  .threat-marker .tm-core.fpv{--c:#4338ca;}
  .threat-marker .tm-core.raketa{--c:#dc2626;}
  .threat-marker .tm-core.avia{--c:#f59e0b;}
  .threat-marker .tm-core.pvo{--c:#059669;}
  .threat-marker .tm-core.vibuh{--c:#6d28d9;}
  .threat-marker .tm-core.artillery{--c:#b45309;}
  .threat-marker .tm-core.obstril{--c:#b91c1c;}
  .threat-marker .tm-core.mlrs{--c:#9d174d;}
  @media (prefers-reduced-motion:no-preference){.threat-marker .tm-core{animation:popIn .25s ease;}}
  @keyframes popIn{from{transform:scale(.5);opacity:0;}to{transform:scale(1);opacity:1;}}
    @media (max-width: 1100px) {
      .main-content {
        grid-template-columns: 1fr;
        padding: 1rem;
      }
      
      .map-card {
        grid-column: 1;
        grid-row: 1;
        height: 50vh;
      }
      
      #map {
        height: 100%;
      }
      
      .card {
        grid-column: 1;
      }
    }
    
    @media (max-width: 700px) {
      .navbar {
        padding: 0.75rem 1rem;
      }
      
      .navbar .logo span {
        font-size: 1rem;
      }
      
      .navbar .nav-links {
        display: none;
      }
      
      .main-content {
        padding: 0.5rem;
        gap: 0.5rem;
      }
      
      .card {
        padding: 1rem;
        border-radius: 0.75rem;
      }
      
      .filters {
        grid-template-columns: 1fr;
      }
    }
    
    /* Темна тема для карти */
    [class*="copyrights-pane"] {
      background-color: var(--panel-bg) !important;
      color: var(--text) !important;
    }
    
    /* Анимації */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .event {
      animation: fadeIn 0.3s ease-out;
    }
  /* Warning modal */
  /* Increased z-index to sit above Leaflet panes (popup pane ~700) */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:10000;animation:fadeIn .25s ease;}
  .modal{background:#111c2b;border:1px solid #1f2b3a;border-radius:1rem;padding:1.75rem;max-width:520px;width:92%;box-shadow:0 10px 40px -5px rgba(0,0,0,.6),0 0 0 1px rgba(59,130,246,.15);font-size:.95rem;line-height:1.55;position:relative;font-weight:500;}
  .modal h3{margin:0 0 1rem;font-size:1.35rem;letter-spacing:.5px;background:linear-gradient(90deg,#3b82f6,#06b6d4);-webkit-background-clip:text;background-clip:text;color:transparent;}
  .modal p{margin:.35rem 0;color:#e5e7eb;}
  .modal button{margin-top:1.2rem;background:#2563eb;color:#fff;font-weight:600;border:0;padding:.65rem 1.25rem;border-radius:.65rem;cursor:pointer;box-shadow:0 4px 18px -4px rgba(37,99,235,.55);transition:.18s;}
  .modal button:hover{background:#1d4ed8;transform:translateY(-2px);} .modal button:active{transform:translateY(0);} 
  .modal-close{position:absolute;top:.6rem;right:.6rem;background:#1e293b;border:1px solid #2c3a4d;color:#9ca3af;width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:600;font-size:14px;transition:.18s;} .modal-close:hover{color:#fff;background:#253549;}
  @media (max-width:600px){.modal{padding:1.25rem;font-size:.9rem;} .modal h3{font-size:1.15rem;}}
    /* Дополнительные стили */
    .input-group {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .input-suffix {
      position: absolute;
      right: 1rem;
      color: var(--text-muted);
      pointer-events: none;
    }
    
    .info-content {
      display: grid;
      gap: 1.5rem;
    }
    
    .info-section {
      background: var(--panel-bg);
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
    }
    
    .info-section h3 {
      margin: 0 0 0.75rem 0;
      font-size: 1rem;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .info-section p {
      margin: 0;
      color: var(--text2);
      font-size: 0.9375rem;
      line-height: 1.5;
    }
    
    .accent-link {
      color: var(--accent);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      transition: opacity 0.2s;
    }
    
    .accent-link:hover {
      opacity: 0.8;
    }
    
    .accent-link i {
      font-size: 1rem;
    }
    /* --- Mobile full-width centering fix (eliminate right gap) --- */
    * { box-sizing: border-box; }
    @media (max-width: 840px){
      html, body { width:100%; max-width:100%; overflow-x:hidden; }
      .main-content { display:block; padding:0 !important; margin:0 !important; width:100vw; max-width:100vw; }
      .map-card, .card { width:100vw; max-width:100vw; margin:0 !important; border-radius:0; }
      #map { width:100%; max-width:100%; border-radius:0; }
    }
    /* --- Fullscreen map (custom) --- */
    body.map-expanded { overflow:hidden; }
    body.map-expanded .navbar { display:none; }
    body.map-expanded .main-content { padding:0 !important; margin:0 !important; }
    body.map-expanded .map-card { position:fixed; inset:0; z-index:500; width:100vw !important; height:100vh !important; border-radius:0 !important; }
    body.map-expanded #map { height:100vh !important; width:100vw !important; border-radius:0 !important; }
    body.map-expanded .card:not(.map-card) { display:none !important; }
    /* Dynamic viewport height for mobile browsers supporting dvh */
    @supports (height: 100dvh) {
      body.map-expanded .map-card { height:100dvh !important; }
      body.map-expanded #map { height:100dvh !important; }
    }
    /* Ensure controls stay above map in fullscreen */
  body.map-expanded .map-controls { z-index:1200; top:0.75rem; right:0.75rem; }
  /* Force-hide any default Google fullscreen control if Google re-injects it */
  .gm-fullscreen-control { display:none !important; }
  /* --- Disclaimer bar --- */
  .disclaimer-bar {position:sticky;top:0;z-index:1200;display:flex;gap:.85rem;align-items:flex-start;background:linear-gradient(90deg,#1e293b,#0f172a);color:#e2e8f0;padding:.9rem 1.15rem;border-bottom:1px solid #334155;font-size:.8rem;line-height:1.35;font-weight:500;letter-spacing:.2px;box-shadow:0 4px 18px -6px rgba(0,0,0,.55);backdrop-filter:blur(6px);} 
  .disclaimer-bar.hidden {display:none !important;}
  .disclaimer-bar b {color:#fbbf24;font-weight:700;}
  .disclaimer-icon {flex:0 0 auto;width:32px;height:32px;border-radius:10px;background:radial-gradient(circle at 30% 30%,#f59e0b,#b45309);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:#fff;box-shadow:0 0 0 1px rgba(255,255,255,.08),0 6px 14px -4px rgba(0,0,0,.55);} 
  .disclaimer-close {margin-left:auto;background:#1e293b;border:1px solid #334155;color:#cbd5e1;width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;font-weight:600;transition:.18s;} 
  .disclaimer-close:hover{background:#334155;color:#fff;}
  .disclaimer-actions {margin-top:.4rem;display:flex;flex-wrap:wrap;gap:.6rem;}
  .disclaimer-actions a {text-decoration:none;background:#334155;color:#e2e8f0;font-size:.65rem;padding:.35rem .6rem;border-radius:.5rem;text-transform:uppercase;letter-spacing:.5px;font-weight:600;display:inline-flex;align-items:center;gap:.25rem;box-shadow:0 2px 6px -2px rgba(0,0,0,.5);transition:.18s;}
  .disclaimer-actions a:hover {background:#3b4b63;color:#fff;}
  @media (max-width:720px){.disclaimer-bar{flex-direction:row;align-items:flex-start;font-size:.72rem;padding:.75rem .85rem;} .disclaimer-icon{width:26px;height:26px;font-size:14px;} .disclaimer-close{width:26px;height:26px;font-size:12px;} }
  </style>
</head>
<body>
  <!-- Floating Support Button & Donation Modal -->
  <style>
    .support-fab{position:fixed;bottom:1.4rem;right:1.4rem;z-index:1300;background:linear-gradient(135deg,#2563eb,#7c3aed);color:#fff;border:none;border-radius:1.1rem;padding:.95rem 1.15rem;display:flex;align-items:center;gap:.55rem;font-weight:600;font-size:.85rem;cursor:pointer;letter-spacing:.5px;box-shadow:0 10px 28px -8px rgba(37,99,235,.55),0 0 0 1px rgba(255,255,255,.12) inset;transition:.25s;backdrop-filter:blur(6px) saturate(1.2);} 
    .support-fab i{font-size:18px;}
    .support-fab:hover{transform:translateY(-4px) scale(1.03);box-shadow:0 14px 34px -8px rgba(37,99,235,.65),0 0 0 1px rgba(255,255,255,.18) inset;}
    .support-fab:active{transform:translateY(0) scale(.98);}    
    @media (max-width:700px){.support-fab{bottom:1rem;right:.9rem;padding:.8rem .95rem;border-radius:.9rem;font-size:.75rem;}}
    .donate-modal-overlay{position:fixed;inset:0;background:radial-gradient(circle at 30% 30%,rgba(15,23,42,.92),rgba(2,6,23,.94));backdrop-filter:blur(14px) saturate(1.4);display:none;align-items:center;justify-content:center;z-index:1400;}
    .donate-modal-overlay.active{display:flex;animation:fadeIn .35s ease;}
    .donate-modal{width:min(600px,92vw);background:linear-gradient(145deg,#0f172a,#1e293b 55%,#0f172a);border:1px solid #233247;border-radius:1.35rem;padding:1.85rem 1.75rem 1.6rem;position:relative;box-shadow:0 18px 48px -12px rgba(0,0,0,.65),0 0 0 1px rgba(59,130,246,.25);font-family:inherit;color:#e2e8f0;}
  .donate-modal:before{content:"";position:absolute;inset:0;border-radius:inherit;padding:1px;background:linear-gradient(135deg,rgba(59,130,246,.65),rgba(147,51,234,.5),rgba(14,165,233,.45));-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;}
  .donate-title{margin:0 0 .9rem;font-size:1.4rem;letter-spacing:.5px;font-weight:700;background:linear-gradient(90deg,#3b82f6,#8b5cf6 40%,#06b6d4);-webkit-background-clip:text;background-clip:text;color:transparent;display:flex;align-items:center;gap:.55rem;}
    .donate-sub{margin:0 0 1.1rem;font-size:.85rem;color:#94a3b8;line-height:1.5;}
    .donate-grid{display:grid;gap:.85rem;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));margin:0 0 1.15rem;}
    .donate-card{position:relative;background:linear-gradient(160deg,rgba(30,41,59,.75),rgba(17,24,39,.85));border:1px solid #253447;border-radius:.95rem;padding:.9rem .95rem .95rem;display:flex;flex-direction:column;gap:.55rem;overflow:hidden;min-height:118px;}
    .donate-card:before{content:"";position:absolute;inset:0;background:radial-gradient(circle at 80% 15%,rgba(59,130,246,.35),rgba(59,130,246,0) 70%);pointer-events:none;opacity:.75;}
    .donate-label{font-size:.65rem;text-transform:uppercase;letter-spacing:1.2px;font-weight:700;color:#60a5fa;}
    .donate-value{font-family:'JetBrains Mono',monospace,Consolas,monospace;font-weight:600;font-size:.95rem;word-break:break-all;color:#f1f5f9;}
    .donate-actions{margin-top:auto;display:flex;gap:.5rem;flex-wrap:wrap;}
    .btn-mini{background:#1d4ed8;color:#fff;border:none;border-radius:.55rem;padding:.45rem .75rem;font-size:.65rem;font-weight:600;letter-spacing:.5px;cursor:pointer;display:inline-flex;align-items:center;gap:.35rem;box-shadow:0 4px 12px -4px rgba(29,78,216,.55);transition:.2s;}
    .btn-mini.alt{background:#334155;box-shadow:none;}
    .btn-mini:hover{background:#2563eb;}
    .btn-mini.alt:hover{background:#3b4b63;}
    .donate-close{position:absolute;top:.7rem;right:.7rem;width:40px;height:40px;background:#1e293b;border:1px solid #2a3a4d;border-radius:.85rem;display:flex;align-items:center;justify-content:center;color:#94a3b8;cursor:pointer;font-weight:600;font-size:15px;transition:.2s;}
    .donate-close:hover{background:#243349;color:#fff;}
    .jar-link-button{background:linear-gradient(90deg,#3b82f6,#8b5cf6);color:#fff;border:none;border-radius:.9rem;padding:.85rem 1.2rem;font-size:.8rem;font-weight:600;letter-spacing:.6px;display:inline-flex;align-items:center;gap:.5rem;margin-top:.5rem;cursor:pointer;box-shadow:0 6px 22px -8px rgba(59,130,246,.55);transition:.25s;}
    .jar-link-button:hover{transform:translateY(-3px);box-shadow:0 10px 30px -8px rgba(59,130,246,.65);}    
    .donate-footer{font-size:.6rem;color:#64748b;margin-top:.6rem;letter-spacing:.5px;}
    .copy-toast{position:fixed;bottom:calc(1.4rem + 64px);right:1.4rem;background:#1e293b;border:1px solid #334155;color:#e2e8f0;padding:.6rem .85rem;border-radius:.7rem;font-size:.7rem;font-weight:600;letter-spacing:.5px;box-shadow:0 8px 24px -8px rgba(0,0,0,.55);display:none;z-index:1500;}
    .copy-toast.show{display:block;animation:fadeIn .25s ease, fadeOut .4s linear 2.4s forwards;}
    @keyframes fadeOut{to{opacity:0;transform:translateY(4px);}}
  </style>
  <button class="support-fab" id="supportFab" aria-haspopup="dialog" aria-controls="donateModal" onclick="toggleDonate()"><i class="material-icons">volunteer_activism</i><span>Підтримати</span></button>
  <div class="donate-modal-overlay" id="donateModal" role="dialog" aria-labelledby="donateTitle" aria-modal="true">
    <div class="donate-modal">
      <button class="donate-close" aria-label="Закрити" onclick="toggleDonate(false)">×</button>
      <h3 class="donate-title" id="donateTitle"><i class="material-icons" style="font-size:22px;">favorite</i>Підтримати розробку</h3>
      <p class="donate-sub">Ваша допомога пришвидшує розвиток точності та функцій мапи. Кожна гривня = краща аналітика загроз.</p>
      <div class="donate-grid">
        <div class="donate-card">
          <div class="donate-label">Моно (UAH)</div>
          <div class="donate-value" data-val="4441111121107290">4441 1111 2110 7290</div>
          <div class="donate-actions">
            <button class="btn-mini" onclick="copyDonate('4441111121107290', this)"><i class="material-icons" style="font-size:14px;">content_copy</i>Копіювати</button>
          </div>
        </div>
        <div class="donate-card">
          <div class="donate-label">Приват (UAH)</div>
          <div class="donate-value" data-val="5168745153133886">5168 7451 5313 3886</div>
          <div class="donate-actions">
            <button class="btn-mini" onclick="copyDonate('5168745153133886', this)"><i class="material-icons" style="font-size:14px;">content_copy</i>Копіювати</button>
          </div>
        </div>
        <div class="donate-card">
          <div class="donate-label">Monobank Банка</div>
          <div class="donate-value" style="font-size:.8rem;line-height:1.25;word-break:break-word;">send.monobank.ua/jar/6Vi9TVzJZQ</div>
          <div class="donate-actions">
            <button class="btn-mini" onclick="openJar()"><i class="material-icons" style="font-size:14px;">open_in_new</i>Відкрити</button>
            <button class="btn-mini alt" onclick="copyDonate('https://send.monobank.ua/jar/6Vi9TVzJZQ', this)"><i class="material-icons" style="font-size:14px;">content_copy</i>Лінк</button>
          </div>
        </div>
      </div>
      <button class="jar-link-button" onclick="openJar()"><i class="material-icons">rocket_launch</i><span>Задонатити зараз</span></button>
      <div class="donate-footer">Фінансова підтримка не створює зобов'язань. Звіти й оновлення у спільноті Telegram.</div>
    </div>
  </div>
  <div class="copy-toast" id="copyToast">Скопійовано</div>
  <div id="disclaimerBar" class="disclaimer-bar" role="note" aria-label="Важливе застереження" style="display:none;">
    <div class="disclaimer-icon">!</div>
    <div class="disclaimer-text">
      <div><b>УВАГА:</b> Дані формуються автоматично з відкритих джерел (Telegram тощо) та можуть містити похибки. Сервіс <b>не є</b> офіційною системою оповіщення і не замінює сигналів Повітряної тривоги. Не використовуйте інформацію для коригування вогню чи розкриття позицій Сил Оборони. Завжди дотримуйтесь вказівок офіційних органів.</div>
      <div class="disclaimer-actions">
        <a href="#about"><span class="material-icons" style="font-size:14px;">info</span> Докладніше</a>
        <a href="https://t.me/+zFxu_4W_ishiNjli" target="_blank" rel="noopener"><span class="material-icons" style="font-size:14px;">group</span> Спільнота</a>
      </div>
    </div>
    <button class="disclaimer-close" aria-label="Закрити" onclick="hideDisclaimer()">×</button>
  </div>
  <div class="navbar">
    <div class="logo">
  <img src="/static/neptun.jpg" alt="NEPTUN">
  <span>NEPTUN</span>
    </div>
    <div class="nav-links">
      <a href="#map" class="active"><i class="material-icons">map</i> Карта</a>
      <a href="#events"><i class="material-icons">notifications</i> Події</a>
      <a href="#about"><i class="material-icons">info</i> Інфо</a>
    </div>
  <div class="live-users" id="liveUsers" title="Активні відвідувачі / Beta"><span>онлайн</span><strong>0</strong><span style="margin-left:.5rem;color:#fbbf24;font-weight:700;letter-spacing:.5px;">ТЕСТОВИЙ РЕЖИМ</span></div>
  </div>

  <!-- Warning Modal -->
  <div class="modal-overlay" id="warnModal" style="display:none;">
    <div class="modal" role="alertdialog" aria-modal="true" aria-labelledby="warnTitle">
      <button class="modal-close" onclick="closeWarn()" aria-label="Закрити">×</button>
      <h3 id="warnTitle">Попередження!</h3>
      <p>Мапу <strong>не можна використовувати</strong> в прямих трансляціях TikTok та інших соцмережах.</p>
      <p>Використання <strong>тільки в інформативних цілях.</strong></p>
  <p style="margin-top:.6rem;color:#fca5a5;"><strong>Увага:</strong> В разі виявлення порушення ваш тікток акаунт буде заблокований модераторами.</p>
      <button onclick="ackWarn()">Зрозуміло</button>
    </div>
  </div>

  <div class="main-content">
    <!-- Map moved to top -->
    <div class="map-card">
      <div class="map-controls">
        <button class="map-control-btn" onclick="map.setZoom(map.getZoom() + 1)">
          <i class="material-icons">add</i>
        </button>
        <button class="map-control-btn" onclick="map.setZoom(map.getZoom() - 1)">
          <i class="material-icons">remove</i>
        </button>
        <button class="map-control-btn" onclick="map.setCenter({lat: 48.3794, lng: 31.1656})">
          <i class="material-icons">center_focus_strong</i>
        </button>
        <button class="map-control-btn" id="expandBtn" onclick="toggleMapExpand()" title="Розгорнути карту" aria-label="Розгорнути карту">
          <i class="material-icons" id="expandIcon">fullscreen</i>
        </button>
      </div>
      <div id="map"></div>
    </div>
    <div class="card" id="events">
      <h2>Останні події</h2>
      <div class="filters">
        <label>
          Період моніторингу
          <div class="input-group">
            <input type="number" id="timeRange" value="0" readonly disabled style="opacity:.6;cursor:not-allowed;" title="Фіксовано адміністратором">
            <span class="input-suffix">хв</span>
          </div>
        </label>
        <label>
          Тип загрози
          <select id="threatTypeSelect">
            <option value="">Всі типи</option>
            <option value="shahed">Шахед/БПЛА</option>
            <option value="raketa">Ракета</option>
            <option value="avia">Авіація</option>
            <option value="pvo">ППО</option>
          </select>
        </label>
        <button onclick="updateMarkers()">
          <i class="material-icons">refresh</i>
          Оновити дані
        </button>
      </div>
      <div class="event-list" id="eventList"></div>
    </div>

    <div class="card" id="about">
      <h2>Про систему</h2>
      <div class="info-content">
        <div class="info-section">
          <h3><i class="material-icons">security</i> Призначення</h3>
          <p>Система показує географію повідомлень про повітряні та інші загрози (ракети, БпЛА, артилерія) у режимі близькому до реального часу.</p>
        </div>
        <div class="info-section">
          <h3><i class="material-icons">update</i> Оновлення</h3>
          <p>Дані оновлюються автоматично кожну хвилину з перевірених джерел.</p>
        </div>
        <div class="info-section">
          <h3><i class="material-icons">warning</i> Важливо</h3>
          <p>Координати та типи загроз визначаються автоматично. Можливі похибки у визначенні місць.</p>
        </div>
        <div class="info-section">
          <h3><i class="material-icons">code</i> Розробка</h3>
          <p>Проєкт <a href="https://t.me/+zFxu_4W_ishiNjli" target="_blank" class="accent-link">НЕПТУН <i class="material-icons">open_in_new</i></a></p>
        </div>
      </div>
    </div>

  </div>
  <!-- Leaflet (OpenStreetMap) JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- Turf.js for geometry operations -->
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script>
    // Disclaimer persistence
    function hideDisclaimer(){
      const el = document.getElementById('disclaimerBar');
      if(el){ el.classList.add('hidden'); }
      try { localStorage.setItem('disclaimer_ack','1'); } catch(e){}
    }
    function showDisclaimer(){
      const el = document.getElementById('disclaimerBar');
      if(!el) return;
      if(localStorage.getItem('disclaimer_ack')==='1') return; // already acknowledged
      el.style.display='flex';
    }
    document.addEventListener('DOMContentLoaded', showDisclaimer);
    // Donation modal logic
    function toggleDonate(force){
      const ov = document.getElementById('donateModal');
      if(!ov) return;
      let show;
      if(typeof force === 'boolean') show = force; else show = !ov.classList.contains('active');
      ov.classList.toggle('active', show);
      if(show){
        try { document.body.style.overflow='hidden'; } catch(e){}
      } else {
        try { document.body.style.overflow=''; } catch(e){}
      }
    }
    function copyDonate(val, btn){
      try { navigator.clipboard.writeText(val); } catch(e){
        const ta=document.createElement('textarea'); ta.value=val; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e2){} document.body.removeChild(ta);
      }
      const toast = document.getElementById('copyToast');
      if(toast){ toast.classList.remove('show'); void toast.offsetWidth; toast.classList.add('show'); }
      if(btn){
        const orig = btn.innerHTML;
        btn.innerHTML = '<i class="material-icons" style="font-size:14px;">check_circle</i>Готово';
        setTimeout(()=>{ btn.innerHTML = orig; }, 2200);
      }
    }
    function openJar(){ window.open('https://send.monobank.ua/jar/6Vi9TVzJZQ','_blank','noopener'); }
    document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ toggleDonate(false); } });
    // Константы и настройки
    const UKRAINE_CENTER = { lat: 48.3794, lng: 31.1656 };
    const ICONS = {
      shahed: '/static/shahed.png',
      raketa: '/static/raketa.png',
      avia: '/static/avia.png',
      pvo: '/static/rozved.png',
  vibuh: '/static/vibuh.png',
  alarm: '/static/trivoga.png',
  alarm_cancel: '/static/vidboi.png',
  mlrs: '/static/mlrs.png',
  artillery: '/static/artillery.png',
  obstril: '/static/obstril.png',
  fpv: '/static/fpv.png',
      default: '/static/default.png'
    };
    // Fallback tiny red dot if icon 404
    function preloadIcons(){
      Object.keys(ICONS).forEach(k=>{const url=ICONS[k]; const img=new Image(); img.onload=()=>{}; img.onerror=()=>{ICONS[k]='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAALElEQVQokWP8////fwY0wAgjGJgGLABWMMRAFEg0gGE0GoBmGuwmCkYBAGmxD/dzJvLRwAAAABJRU5ErkJggg==';}; img.src=url;});
    }
    // Состояние приложения
  let map;
    let markerLayer = null;
    let markers = [];
    // Проста мапа транслітерації/перекладу російських / застарілих назв на українські
    const PLACE_UA_MAP = (()=>{
      const m = new Map([
        ['киев','Київ'],['київ','Київ'],['kiev','Київ'],
        ['одесса','Одеса'],['odesa','Одеса'],
        ['харьков','Харків'],['kharkov','Харків'],['харків','Харків'],
        ['днепропетровск','Дніпро'],['дніпропетровськ','Дніпро'],['днепр','Дніпро'],['дніпр','Дніпро'],['dnipro','Дніпро'],
        ['чернигов','Чернігів'],['чернигів','Чернігів'],
        ['запорожье','Запоріжжя'],['запорожье','Запоріжжя'],['запоріжье','Запоріжжя'],['запоріжжя','Запоріжжя'],
        ['николаев','Миколаїв'],['миколаев','Миколаїв'],['миколаїв','Миколаїв'],
        ['житомир','Житомир'],
        ['полтава','Полтава'],
        ['херсон','Херсон'],
        ['луганск','Луганськ'],['луганськ','Луганськ'],
        ['донецк','Донецьк'],['донецьк','Донецьк'],
        ['суми','Суми'],['сумы','Суми'],
        ['черкассы','Черкаси'],['черкасі','Черкаси'],
        ['черновцы','Чернівці'],['чернівці','Чернівці'],
        ['ивано-франковск','Івано-Франківськ'],['івано-франківськ','Івано-Франківськ'],
        ['львов','Львів'],['львів','Львів'],
        ['ужгород','Ужгород'],
        ['тернополь','Тернопіль'],['тернопіль','Тернопіль'],
        ['винница','Вінниця'],['вінниця','Вінниця'],
        ['ровно','Рівне'],['ровне','Рівне'],['рівне','Рівне'],
        ['кропивницкий','Кропивницький'],['кропивницький','Кропивницький'],
        ['севастополь','Севастополь'],
        ['симферополь','Сімферополь'],
        ['мариуполь','Маріуполь'],['маріуполь','Маріуполь'],
        ['горловка','Горлівка'],['горлівка','Горлівка'],
        ['алчевск','Алчевськ'],['алчевськ','Алчевськ']
      ]);
      return m;
    })();
    function normalizeKey(s){ return s.toLowerCase().replace(/\s+/g,' ').trim(); }
    function translatePlace(name){
      if(!name || typeof name !== 'string') return name;
      const key = normalizeKey(name);
      if(PLACE_UA_MAP.has(key)) return PLACE_UA_MAP.get(key);
      // Якщо вже містить українські специфічні літери – залишаємо
      if(/[іїєґ]/i.test(name)) return name;
      // Легка заміна рос. літер на укр. приблизно
      let t = name
        .replace(/ё/g,'йо').replace(/ы/g,'и').replace(/э/g,'е')
        .replace(/ъ/g,'ʼ');
      return t;
    }
    // Удаляем лишние звездочки / markdown-звезды из текста
    function cleanMessage(t){
      if(!t) return t;
      // убрать тройные/двойные звездочки и одиночные вокруг эмодзи/слов
      let s = t.replace(/\*{2,}/g,'');
      // убрать звездочки, прилегающие к началу/концу строки
      s = s.replace(/^\*+/,'').replace(/\*+$/,'');
      return s.trim();
    }
    // Цільові міста для відображення спеціальної іконки FPV при загрозі БПЛА
    const FPV_CITIES = ['херсон','білозерка','марганець','нікополь'];
    function isFPVThreat(place, text, threatType){
      const combined = (place ? place + ' ' : '') + (text || '');
      const lower = combined.toLowerCase();
      if(!FPV_CITIES.some(c => lower.includes(c))) return false;
      const tt = (threatType||'').toLowerCase();
      if (tt === 'shahed') return true;
      if (/бпла|fpv/i.test(text || '')) return true;
      return false;
    }
    // Helper: build semi-circle polygon (returns array of [lat,lng])
    function buildSemiCircle(lat, lng, startBearing, endBearing, radiusKm, segments){
      const pts=[]; const R=6371; const toRad=d=>d*Math.PI/180; const toDeg=r=>r*180/Math.PI;
      const lat1=toRad(lat); const lon1=toRad(lng); const angDist=radiusKm/R;
      let span = (endBearing - startBearing); if (span < 0) span += 360;
      for(let i=0;i<=segments;i++){
        const brg = (startBearing + span*(i/segments)) % 360;
        const br = toRad(brg);
        const lat2 = Math.asin(Math.sin(lat1)*Math.cos(angDist)+Math.cos(lat1)*Math.sin(angDist)*Math.cos(br));
        const lon2 = lon1 + Math.atan2(Math.sin(br)*Math.sin(angDist)*Math.cos(lat1), Math.cos(angDist)-Math.sin(lat1)*Math.sin(lat2));
        pts.push([toDeg(lat2), ((toDeg(lon2)+540)%360)-180]);
      }
      pts.unshift([lat,lng]);
      return pts;
    }
    async function updateMarkers() {
      const timeRange = 50; // fixed
      const threatType = document.getElementById('threatTypeSelect').value;
      const params = new URLSearchParams({ timeRange, confRange: 0 });
      const res = await fetch(`/data?${params.toString()}`);
      const data = await res.json();
      let points = (data.tracks || []).filter(p => {
        if (typeof p.lat !== 'number' || typeof p.lng !== 'number') return false;
        if (isNaN(p.lat) || isNaN(p.lng)) return false;
        if (Math.abs(p.lat) < 1 && Math.abs(p.lng) < 1) return false;
        if (p.lat < 43 || p.lat > 53.5 || p.lng < 21 || p.lng > 41) return false;
        const vague = ['схід','захід','північ','південь','восток','запад','север','юг'];
        if (!p.place || vague.includes(p.place.toLowerCase())) return false;
        return true;
      });
      if (threatType) points = points.filter(p => (p.threat_type || '').toLowerCase() === threatType);
      if (markerLayer) { markerLayer.clearLayers(); }
      else { markerLayer = L.layerGroup().addTo(map); }
      markers = [];
  // Container for border-shelling overlays (semi-circles)
  let borderShellingDrawn = false;
      points.forEach(p => {
        let iconUrl = ICONS[p.threat_type] || ICONS.default;
        if (p.marker_icon) {
          iconUrl = (p.marker_icon.startsWith('http') || p.marker_icon.startsWith('/')) ? p.marker_icon : '/static/' + p.marker_icon;
        }
        // Override for FPV targeted settlements
        if (isFPVThreat(p.place, p.text, p.threat_type)) {
          iconUrl = ICONS.fpv || iconUrl;
        }
        // Extract inline count / direction from place label pattern 'Name (N) ←півдня'
        if (!p.count && p.place) {
          const m = p.place.match(/\((\d{1,3})\)/);
          if (m) { p.count = parseInt(m[1]); }
        }
        let arrowDir = null;
        if (p.place && p.place.includes('←')) {
          arrowDir = p.place.split('←').pop().trim();
        }
  const threatClass = (p.threat_type||'default').toLowerCase();
  const countBadge = p.count && p.count>1 ? `<div class="tm-badge">${p.count}×</div>` : '';
  const html = `<div class='threat-marker'><div class='tm-core ${threatClass}'><img src='${iconUrl}' alt=''></div>${countBadge}</div>`;
  const icon = L.divIcon({ html, className:'', iconSize:[38,50], iconAnchor:[19,46], popupAnchor:[0,-44] });
  const m = L.marker([p.lat, p.lng], { icon, riseOnHover:true });
        // Optional short polyline showing nominal approach direction (simple cardinal/ordinal mapping)
        if (arrowDir) {
          const dir = arrowDir.toLowerCase();
          let dx=0, dy=0;
          if (dir.includes('півд') ) dy = -0.25; // from south -> line ending at marker
          if (dir.includes('північ')) dy = 0.25;
          if (dir.includes('сход')) dx = -0.25; // from east -> westwards line tail
          if (dir.includes('зах')) dx = 0.25;
          if (dx !==0 || dy !==0) {
            const line = L.polyline([[p.lat+dy, p.lng+dx],[p.lat, p.lng]], {color:'#f59e0b', weight:2, opacity:0.7, dashArray:'4 3'});
            line.addTo(markerLayer);
          }
        }
        const placeUA = translatePlace(p.place);
        const popupHtml = `<div style=\"background:#ffffff;color:#1e293b;border:1px solid #d7dde3;border-radius:12px;padding:10px 10px;min-width:190px;font-size:.8rem;line-height:1.35;box-shadow:0 4px 14px -4px rgba(0,0,0,.18);\">`
          + (placeUA ? `<div style='font-size:.9rem;font-weight:600;margin-bottom:4px;'>${placeUA}</div>` : '')
          + (p.count ? `<div style='margin-bottom:4px;font-weight:600;color:#b91c1c;'>Кількість: ${p.count}×</div>` : '')
          + `<div style='white-space:pre-wrap;'>${cleanMessage(p.text||'')}</div>`
          + `<div style='margin-top:6px;font-size:.6rem;opacity:.55;'>${p.date || ''}</div>`
          + `</div>`;
        m.bindPopup(popupHtml, { closeButton:false, autoPan:true });
  if (p.count && p.count > 1) { m.openPopup(); }
        markerLayer.addLayer(m);
        markers.push(m);

        // Red semi-circle (sector) for border shelling alerts (visualizing incoming danger from external border)
        if (p.border_shelling && !borderShellingDrawn) {
          borderShellingDrawn = true; // only one large overlay per update to avoid clutter
          try {
            // Draw a semi-circle (180°) oriented toward likely hostile border (east / north-east for Харківська / Сумська, adjust by longitude)
            const centerLat = p.lat; const centerLng = p.lng;
            const spanKm = 120; // radius
            const segments = 80; // smoothness
            // Bearing range depending on oblast heuristic
            let startBearing = 315; // NW
            let endBearing = 135;  // SE
            if (centerLng > 35) { startBearing = 290; endBearing = 110; }
            const pts = [];
            const R = 6371; // km
            const toRad = d=>d*Math.PI/180; const toDeg = r=>r*180/Math.PI;
            for(let i=0;i<=segments;i++){
              const brg = startBearing + (endBearing-startBearing)* (i/segments);
              const d = spanKm / R; // angular distance
              const br = toRad(brg);
              const lat1 = toRad(centerLat);
              const lon1 = toRad(centerLng);
              const lat2 = Math.asin(Math.sin(lat1)*Math.cos(d)+Math.cos(lat1)*Math.sin(d)*Math.cos(br));
              const lon2 = lon1 + Math.atan2(Math.sin(br)*Math.sin(d)*Math.cos(lat1), Math.cos(d)-Math.sin(lat1)*Math.sin(lat2));
              pts.push([toDeg(lat2), ((toDeg(lon2)+540)%360)-180]);
            }
            pts.unshift([centerLat, centerLng]);
            const poly = L.polygon(pts, {color:'#b91c1c', weight:1, fillColor:'#dc2626', fillOpacity:0.18, stroke:true});
            poly.addTo(markerLayer);
          } catch(e){}
        }
        // KAB guided bomb threat zone (semi-circle) for raketa markers whose text mentions 'каб'
        if (!p.border_shelling && p.threat_type && p.threat_type.toLowerCase()==='raketa' && /каб/i.test(p.text||'')) {
          try {
            const centerLat = p.lat; const centerLng = p.lng;
            // Orientation heuristic
            let startBearing = 300; let endBearing = 60; // NE focus
            if (centerLng > 34.5) { startBearing = 270; endBearing = 90; }
            const baseRadius = 70; // base outer radius km (larger than before)
            const segments = 90;
            const layers = [
              { r: baseRadius, cls:'kab-zone', fill:'#dc2626', fillOpacity:0.10 },
              { r: baseRadius*0.68, cls:'kab-zone-layer2', fill:'#ef4444', fillOpacity:0.14 },
              { r: baseRadius*0.42, cls:'kab-zone-layer3', fill:'#f87171', fillOpacity:0.18 }
            ];
            layers.forEach(def => {
              const pts = buildSemiCircle(centerLat, centerLng, startBearing, endBearing, def.r, segments);
              const poly = L.polygon(pts, {color:def.fill, weight:0.8, fillColor:def.fill, fillOpacity:def.fillOpacity, stroke:true, interactive:false}).addTo(markerLayer);
              // Add CSS class for animation / glow after path is in DOM
              setTimeout(()=>{ try { poly._path.classList.add(def.cls); } catch(e){} }, 0);
            });
            // Thin inner outline arc (no fill) emphasising direction
            const innerPts = buildSemiCircle(centerLat, centerLng, startBearing, endBearing, baseRadius*0.9, segments);
            const outline = L.polygon(innerPts, {color:'#fee2e2', weight:1, fill:false, dashArray:'8 6', opacity:0.7, interactive:false}).addTo(markerLayer);
            setTimeout(()=>{ try { outline._path.classList.add('kab-zone'); } catch(e){} },0);
          } catch(e){}
        }
      });
      updateEventList(data.events || []);
    }
    function updateEventList(points) {
      const el = document.getElementById('eventList');
      if (!el) return;
      if (!points || !points.length) {
        el.innerHTML = '<div style="color:#888;padding:12px;">Подій не знайдено</div>';
        return;
      }
      el.innerHTML = points.slice(0, 20).map(ev => {
        let iconUrl = ICONS[ev.threat_type] || ICONS.default;
        if (ev.marker_icon) {
          if (ev.marker_icon.startsWith('http') || ev.marker_icon.startsWith('/')) {
            iconUrl = ev.marker_icon;
          } else {
            iconUrl = '/static/' + ev.marker_icon;
          }
        }
        if (isFPVThreat(ev.place, ev.text, ev.threat_type)) {
          iconUrl = ICONS.fpv || iconUrl;
        }
  const isCancel = ev.threat_type === 'alarm_cancel';
  const placeLine = (ev.place && !isCancel) ? `<b>${translatePlace(ev.place)}</b><br>` : '';
  return `<div class='event'><img class='event-icon' src='${iconUrl}' alt='${ev.threat_type || ''}'><div class='event-info'>${placeLine}${cleanMessage(ev.text||'')}<div class='event-time'>${ev.date || ''}</div></div></div>`;
      }).join('');
    }
    async function initMap() {
      map = L.map('map', { zoomControl:false, attributionControl:false }).setView([48.3794,31.1656], 6);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        tileSize: 256,
        crossOrigin:true,
        attribution:''
      }).addTo(map);
      // ---- Presence (active users) ----
      const uid = localStorage.getItem('presence_id') || (self.crypto?.randomUUID ? crypto.randomUUID() : (Date.now()+""+Math.random()).replace(/\D/g,''));
      localStorage.setItem('presence_id', uid);
      async function pingPresence(){
        try {
          const r = await fetch('/presence', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id:uid})});
          const j = await r.json();
          if(j.status === 'blocked'){
            // Show overlay and stop further updates
            const ov = document.createElement('div');
            ov.style.cssText='position:fixed;inset:0;background:#0a0f1f;display:flex;align-items:center;justify-content:center;z-index:9999;font-family:Inter,sans-serif;color:#fff;padding:2rem;text-align:center;';
            ov.innerHTML='<div style="max-width:480px;">Ваш доступ тимчасово обмежено.</div>';
            document.body.appendChild(ov);
            return;
          }
          if(j.visitors !== undefined){
            const el = document.getElementById('liveUsers');
            if(el){ el.querySelector('strong').textContent = j.visitors; }
          }
        } catch(e){}
      }
      pingPresence();
  setInterval(pingPresence, 5000);

      // --- Интеграция с alerts.in.ua ---
      let airAlarmLayer = null;
      let ukrBorderLayer = null;
  let raionAlarmLayer = null;
      async function fetchAirAlarms(){
        try { const r = await fetch('https://alerts.com.ua/api/states'); const j = await r.json(); return j.regions || {}; } catch(e){ return {}; }
      }
      async function showAirAlarmsOnMap(){
        const regions = await fetchAirAlarms();
        const geoRes = await fetch('https://alerts.com.ua/static/geo/ukraine_regions.json');
        const geo = await geoRes.json();
        if (airAlarmLayer) { airAlarmLayer.remove(); }
        airAlarmLayer = L.geoJSON(geo, {
          style: feature => {
            let code = feature.properties.id || feature.properties.ISO_3166_2;
            if (code) code = code.toUpperCase();
            let alarm = false;
            if (code && regions[code]) alarm = regions[code].alert;
            if (!alarm && code && regions[code.toLowerCase()]) alarm = regions[code.toLowerCase()].alert;
            return {
              color: alarm ? '#d93025' : '#c9d0d6',
              weight: alarm ? 2 : 1,
              fillColor: alarm ? '#ffd54f' : '#f1f3f6',
              fillOpacity: alarm ? 0.5 : 0.15
            };
          }
        }).addTo(map);
        // Draw a clear national border outline (union of all regions)
        try {
          if (turf && geo && geo.features && geo.features.length){
            let unionGeom = null;
            for(const f of geo.features){
              unionGeom = unionGeom ? turf.union(unionGeom, f) : f;
            }
            if (ukrBorderLayer) { ukrBorderLayer.remove(); }
            if (unionGeom){
              // Outer glow effect: two strokes
              const outer = L.geoJSON(unionGeom, { style:{ color:'rgba(17,24,39,0.55)', weight:8, opacity:0.7, fill:false } });
              const inner = L.geoJSON(unionGeom, { style:{ color:'#111827', weight:3, opacity:0.95, fill:false } });
              ukrBorderLayer = L.layerGroup([outer, inner]).addTo(map);
              ukrBorderLayer.bringToFront();
            }
          }
        } catch(e){}
      }
      showAirAlarmsOnMap();
      setInterval(showAirAlarmsOnMap, 20000);

      // ---- Dynamic raion alarm overlay (district-level) ----
      async function fetchRaionAlarms(){
        try { const r = await fetch('/raion_alarms'); return (await r.json()).alarms || []; } catch(e){ return []; }
      }
      async function updateRaionAlarms(){
        const alarms = await fetchRaionAlarms();
        if (raionAlarmLayer){ raionAlarmLayer.remove(); raionAlarmLayer = null; }
        if(!alarms.length) return;
        // Build circle-ish polygons (approx) or simple circles since we lack exact raion geometry right now
        const feats = alarms.map(a=>({
          type:'Feature', properties:{ raion:a.raion, place:a.place, since:a.since },
          geometry:{ type:'Point', coordinates:[a.lng, a.lat] }
        }));
        raionAlarmLayer = L.layerGroup();
        feats.forEach(f=>{
          const lat = f.geometry.coordinates[1];
          const lng = f.geometry.coordinates[0];
          // Represent district area with a translucent red circle (radius ~20km) placeholder
            const circle = L.circle([lat,lng], { radius: 20000, color:'#b91c1c', weight:1, fillColor:'#dc2626', fillOpacity:0.25 });
            circle.bindPopup(`<b>${f.properties.place}</b><br>Повітряна тривога (район)`);
            circle.addTo(raionAlarmLayer);
        });
        raionAlarmLayer.addTo(map);
      }
      updateRaionAlarms();
      setInterval(updateRaionAlarms, 15000);

      await updateMarkers();
      try {
    const es = new EventSource('/stream');
    const uid2 = localStorage.getItem('presence_id');
    es.onmessage = ev => {
          try {
            const p = JSON.parse(ev.data);
      if (p.tracks && p.tracks.length) { updateMarkers(); }
      if (p.control && p.control.type === 'block' && p.control.id && uid2 && p.control.id === uid2) {
               // show block overlay instantly
               const ov = document.createElement('div');
               ov.style.cssText='position:fixed;inset:0;background:#0a0f1f;display:flex;align-items:center;justify-content:center;z-index:9999;font-family:Inter,sans-serif;color:#fff;padding:2rem;text-align:center;';
               ov.innerHTML='<div style="max-width:480px;">Ваш доступ тимчасово обмежено.</div>';
               document.body.appendChild(ov);
               try { es.close(); } catch(e){}
            }
          } catch(e){}
        };
      } catch(e) {}
      setInterval(updateMarkers, 10000);
    }
  function openWarn(){const o=document.getElementById('warnModal'); if(o) o.style.display='flex';}
  function closeWarn(){const o=document.getElementById('warnModal'); if(o) o.style.display='none';}
  function ackWarn(){ closeWarn(); }
  function toggleMapExpand(){
    const body = document.body;
    const btn = document.getElementById('expandBtn');
    const icon = document.getElementById('expandIcon');
    const mapCard = document.querySelector('.map-card');
    const wasExpanded = body.classList.contains('map-expanded');
    if(wasExpanded){
      body.classList.remove('map-expanded');
      if(btn){ btn.title='Розгорнути карту'; btn.setAttribute('aria-label','Розгорнути карту'); }
      if(icon){ icon.textContent='fullscreen'; }
  if(mapCard){ mapCard.style.height=''; }
      // restore map size
  setTimeout(()=>{ if(map){ map.invalidateSize(); } },150);
    } else {
      body.classList.add('map-expanded');
      if(btn){ btn.title='Згорнути карту'; btn.setAttribute('aria-label','Згорнути карту'); }
      if(icon){ icon.textContent='fullscreen_exit'; }
      // Set explicit height for iOS Safari dynamic bars
      if(mapCard){ mapCard.style.height= window.innerHeight + 'px'; }
  setTimeout(()=>{ if(map){ map.invalidateSize(); map.setView([UKRAINE_CENTER.lat, UKRAINE_CENTER.lng]); } },200);
    }
  }
  // Adjust fullscreen height on orientation / resize for mobile
  window.addEventListener('orientationchange', ()=>{ if(document.body.classList.contains('map-expanded')){ const mapCard=document.querySelector('.map-card'); if(mapCard){ mapCard.style.height=window.innerHeight+'px'; if(map){ map.invalidateSize(); } } } });
  window.addEventListener('resize', ()=>{ if(document.body.classList.contains('map-expanded')){ const mapCard=document.querySelector('.map-card'); if(mapCard){ mapCard.style.height=window.innerHeight+'px'; if(map){ map.invalidateSize(); } } } });
  window.onload = () => { preloadIcons(); initMap(); openWarn(); };
  </script>
  <!-- Google Maps script removed after migration to Leaflet / OpenStreetMap -->
</body>
</html>
